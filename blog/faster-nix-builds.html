<!DOCTYPE html><html><head><meta charSet="utf-8" data-next-head=""/><meta name="viewport" content="width=device-width, initial-scale=1" data-next-head=""/><meta name="theme-color" content="#000000" data-next-head=""/><meta name="author" content="OpenFaaS Ltd" data-next-head=""/><meta name="twitter:card" content="summary_large_image" data-next-head=""/><title data-next-head="">Faster Nix builds with GitHub Actions and actuated</title><meta name="description" content="Speed up your Nix project builds on GitHub Actions with runners powered by Firecracker." data-next-head=""/><meta property="twitter:title" content="Faster Nix builds with GitHub Actions and actuated" data-next-head=""/><meta property="twitter:description" content="Speed up your Nix project builds on GitHub Actions with runners powered by Firecracker." data-next-head=""/><meta property="og:title" content="Faster Nix builds with GitHub Actions and actuated" data-next-head=""/><meta property="og:description" content="Speed up your Nix project builds on GitHub Actions with runners powered by Firecracker." data-next-head=""/><meta name="twitter:image:src" content="https://actuated.com/images/2023-06-faster-nix-builds/background.png" data-next-head=""/><meta property="og:image" content="https://actuated.com/images/2023-06-faster-nix-builds/background.png" data-next-head=""/><meta charSet="utf-8"/><link rel="icon" type="image/png" href="/images/actuated.png"/><link rel="stylesheet" href="https://rsms.me/inter/inter.css"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css"/><link rel="manifest" href="/manifest.json"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-M5YNDNX7VT"></script><script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'G-M5YNDNX7VT');
          </script><link rel="apple-touch-icon" href="/images/actuated.png"/><link rel="preload" href="/_next/static/css/7ac77be5c64ccb4f.css" as="style"/><link rel="stylesheet" href="/_next/static/css/7ac77be5c64ccb4f.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-fbb920bddf9bf0a6.js" defer=""></script><script src="/_next/static/chunks/framework-5757d75364ce2279.js" defer=""></script><script src="/_next/static/chunks/main-ef55e8b75fd0cd35.js" defer=""></script><script src="/_next/static/chunks/pages/_app-381d430d4a735a5d.js" defer=""></script><script src="/_next/static/chunks/762-703a014cadea8bf4.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bslug%5D-053ab830ac6cb307.js" defer=""></script><script src="/_next/static/DetXrL7nOwq_JVqM2VMRg/_buildManifest.js" defer=""></script><script src="/_next/static/DetXrL7nOwq_JVqM2VMRg/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="bg-white"><header><div class="relative bg-white" data-headlessui-state=""><div class="mx-auto flex max-w-7xl items-center justify-between px-4 py-6 sm:px-6 md:justify-start md:space-x-10 lg:px-8"><div class="flex justify-start lg:w-0 lg:flex-1"><a href="/"><span class="sr-only">Actuated</span><img class="h-8 w-auto sm:h-10" src="/images/actuated.png" alt="Actuated logo"/></a></div><div class="-my-2 -mr-2 md:hidden"><button class="inline-flex items-center justify-center rounded-md bg-white p-2 text-gray-400 hover:bg-gray-100 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500" type="button" aria-expanded="false" data-headlessui-state=""><span class="sr-only">Open menu</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" class="h-6 w-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"></path></svg></button></div><nav class="hidden space-x-10 md:flex"><div class="relative" data-headlessui-state=""><button class="text-gray-500 group inline-flex items-center rounded-md bg-white text-base font-medium hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" type="button" aria-expanded="false" data-headlessui-state=""><span>Solutions</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="text-gray-400 ml-2 h-5 w-5 group-hover:text-gray-500"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"></path></svg></button></div><span hidden="" style="position:fixed;top:1px;left:1px;width:1px;height:0;padding:0;margin:-1px;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border-width:0;display:none"></span><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/blog">Blog</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/blog/blazing-fast-ci-with-microvms">Announcement</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/pricing">Pricing</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="https://docs.actuated.com/">Docs</a></nav><span hidden="" style="position:fixed;top:1px;left:1px;width:1px;height:0;padding:0;margin:-1px;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border-width:0;display:none"></span><div class="hidden items-center justify-end md:flex md:flex-1 lg:w-0"><a href="https://dashboard.actuated.com" class="whitespace-nowrap text-base font-medium text-gray-500 hover:text-gray-900">Sign in</a><a href="/pricing" class="ml-8 inline-flex items-center justify-center whitespace-nowrap rounded-md border border-transparent bg-indigo-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-indigo-700">Sign-up</a></div></div></div><span hidden="" style="position:fixed;top:1px;left:1px;width:1px;height:0;padding:0;margin:-1px;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border-width:0;display:none"></span></header><main><div class="container mx-auto max-w-4xl bg-white mt-4 px-4 sm:px-6"><h1 id="post_title" class="text-3xl mb-3 leading-8 font-extrabold tracking-tight text-gray-900 sm:text-4xl sm:leading-10 text-center">Faster Nix builds with GitHub Actions and actuated</h1></div><div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-4xl"><div class="border-b border-gray-200 py-4 flex items-center text-gray-500 mx-auto"><div><img class="h-10 w-10 rounded-full" src="/images/welteki.jpg" alt=""/></div><div class="ml-3"><p id="post_author" class="text-sm leading-5 font-medium text-gray-900"></p><div class="flex text-sm leading-5 text-gray-500"><time dateTime="2023-06-12" id="post_date">June 12, 2023</time><span class="mx-1"></span></div></div></div><div class="mt-6 prose sm:prose-lg max-w-none"><p id="post_description" class="mb-4">Speed up your Nix project builds on GitHub Actions with runners powered by Firecracker.</p></div><div id="post_content" class="mt-6 prose sm:prose-lg max-w-none"><p><a href="https://github.com/openfaas/faasd">faasd</a> is a lightweight and portable version of <a href="https://www.openfaas.com/">OpenFaaS</a> that was created to run on a single host. In my spare time I maintain <a href="https://github.com/welteki/faasd-nix">faasd-nix</a>, a project that packages faasd and exposes a NixOS module so it can be run with NixOS.</p>
<p>The module itself depends on faasd, containerd and the CNI plugins and all of these binaries are built in CI with Nix and then cached using <a href="https://www.cachix.org/">Cachix</a> to save time on subsequent builds.</p>
<p>I often deploy faasd with NixOS on a Raspberry Pi and to the cloud, so I build binaries for both <code>x86_64</code> and <code>aarch64</code>. The build usually runs on the default GitHub hosted action runners. Now because GitHub currently doesn't have Arm support, I use QEMU instead which can emulate them. The drawback of this approach is that builds can sometimes be several times slower.</p>
<blockquote>
<p>For some of our customers, their builds couldn't even complete in 6 hours using QEMU, and only took between 5-20 minutes using native Arm hardware. Alex Ellis, Founder of Actuated.</p>
</blockquote>
<p>While upgrading to the latest nixpkgs release recently I decided to try and build the project on runners managed with Actuated to see the improvements that can be made by switching to both bigger <code>x86_64</code> iron and native Arm hardware.</p>
<h2 id="nix-and-github-actions">Nix and GitHub actions</h2>
<p>One of the features Nix offers are reproducible builds. Once a package is declared it can be built on any system. There is no need to prepare your machine with all the build dependencies. The only requirement is that Nix is installed.</p>
<blockquote>
<p>If you are new to Nix, then I'd recommend you read the <a href="https://zero-to-nix.com/start/install">Zero to Nix</a> guide. It's what got me excited about the project.</p>
</blockquote>
<p>Because Nix is declarative and offers reproducible builds, it is easy to setup a concise build pipeline for GitHub actions. A lot of steps usually required to setup the build environment can be left out. For instance, faasd requires Go, but there's no need to install it onto the build machine, and you'd normally have to install btrfs-progs to build containerd, but that's not something you have to think about, because Nix will take care of it for you.</p>
<p>Another advantage of the reproducible builds is that if it works on your local machine it most likely also works in CI. No need to debug and find any discrepancies between your local and CI environment.</p>
<blockquote>
<p>Of course, if you ever do get frustrated and want to debug a build, you can use the built-in <a href="https://docs.actuated.com/tasks/debug-ssh/">SSH feature in Actuated</a>. Alex Ellis, Founder of Actuated.</p>
</blockquote>
<p>This is what the workflow looks like for building faasd and its related packages:</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">build:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">cachix/install-nix-action@v21</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">faasd</span> <span class="hljs-string">🔧</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          nix build -L .#faasd
</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">containerd</span> <span class="hljs-string">🔧</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          nix build -L .#faasd-containerd
</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">cni-plugin</span> <span class="hljs-string">🔧</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          nix build -L .#faasd-cni-plugins
</span></code></pre>
<p>All this pipeline does is install Nix, using the <a href="https://github.com/marketplace/actions/install-nix">cachix/install-nix-action</a> and run the <code>nix build</code> command for the packages that need to be built.</p>
<h2 id="notes-on-the-nix-build-for-aarch64">Notes on the nix build for aarch64</h2>
<p>To build the packages for multiple architectures there are a couple of options:</p>
<ul>
<li>cross-compiling, Nix has great support for cross compilation.</li>
<li>compiling through binfmt QEMU.</li>
<li>compiling natively on an aarch64 machine.</li>
</ul>
<p>The preferred option would be to compile everything natively on an aarch64 machine as that would result in the best performance. However, at the time of writing GitHub does not provide Arm runners. That is why QEMU is used by many people to compile binaries in CI.</p>
<p>Enabling the binfmt wrapper on NixOS can be done easily through the NixOS configuration. On non-NixOS machines, like on the GitHub runner VM, the QEMU static binaries need to be installed and the Nix daemon configuration updated.</p>
<p>Instructions to configure Nix for compilation with QEMU can be found on the <a href="https://nixos.wiki/wiki/NixOS_on_ARM#Compiling_through_binfmt_QEMU">NixOS wiki</a></p>
<p>The workflow for building aarch64 packages with QEMU on GitHub Actions looks like this:</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">build:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">docker/setup-qemu-action@v2</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">cachix/install-nix-action@v21</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">extra_nix_config:</span> <span class="hljs-string">|
            extra-platforms = aarch64-linux
</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">faasd</span> <span class="hljs-string">🔧</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          nix build -L .#packages.aarch64-linux.faasd
</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">containerd</span> <span class="hljs-string">🔧</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          nix build -L .#packages.aarch64-linux.faasd-containerd
</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">cni-plugin</span> <span class="hljs-string">🔧</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          nix build -L .#packages.aarch64-linux.faasd-cni-plugins
</span>
</code></pre>
<p>Install the QEMU static binaries using <a href="https://github.com/docker/setup-qemu-action">docker/setup-qemu-action</a>. Let the nix daemon know that it can build for aarch64 by adding <code>extra-platforms = aarch64-linux</code> via the <code>extra_nix_config</code> input on the install nix action. Update the nix build commands to specify platform e.g. <code>nix build .#packages.aarch64-linux.faasd</code>.</p>
<h2 id="speeding-up-the-build-with-a-raspberry-pi">Speeding up the build with a Raspberry Pi</h2>
<p>Nix has great support for caching and build speeds can be improved greatly by never building things twice. This project normally uses <a href="https://www.cachix.org/">Cachix</a> for caching and charing binaries across systems. For this comparison caching was disabled. All packages and their dependencies are built from scratch again each time.</p>
<p>Building the project takes around 4 minutes and 20 seconds on the standard GitHub hosted runner. After switching to a more powerful Actuated runner with 4CPUs and 8GB of RAM the build time dropped to 2 minutes and 15 seconds.</p>
<p><img src="/images/2023-06-faster-nix-builds/amd64-build-comparison.png" alt="Comparison of more powerful Actuated runner with GitHub hosted runner"></p>
<blockquote>
<p>Comparison of more powerful Actuated runner with GitHub hosted runner.</p>
</blockquote>
<p>While build times are still acceptable for x86_64 this is not the case for the aarch64 build. It takes around 55 minutes to complete the Arm build with QEMU on a GitHub runner.</p>
<p>Running the same build with QEMU on the Actuated runner already brings down the build time to 19 minutes and 40 seconds. Running the build natively on a Raspberry Pi 4 (8GB) completed in 11 minutes and 47 seconds. Building on a more powerful Arm machine would potentially reduce this time to a couple of minutes.</p>
<p><img src="/images/2023-06-faster-nix-builds/arm64-build-comparison.png" alt="Results of the matrix build comparing the GitHub hosted runner and the 2 Actuated runners"></p>
<blockquote>
<p>Results of the matrix build comparing the GitHub hosted runner and the 2 Actuated runners.</p>
</blockquote>
<p>Running the build natively on the Pi did even beat the fast bare-metal machine that is using QEMU.</p>
<p>My colleague Alex ran the same build on his Raspberry Pi using Actuated and an NVMe mounted over USB-C, he got the build time down even further. Why? Because it increased the I/O performance. In fact, if you build this on server-grade Arm like the Ampere Altra, it would be about 4x faster than the Pi 4.</p>
<p>Building for Arm:</p>
<ul>
<li>Alex's Raspberry Pi with NVMe: 10m49s</li>
<li>An Ampere Altra on Equinix Metal: 3m29s</li>
</ul>
<p>Building for x86_64</p>
<ul>
<li>AMD Epyc on Equinix Metal: 1m57s</li>
</ul>
<p><img src="/images/2023-06-faster-nix-builds/alex-results.png" alt="Alex&#x27;s results"></p>
<p>These results show that whatever the Arm hardware you pick, it'll likely be faster than QEMU, even when QEMU is run on the fastest bare-metal available, the slowest Arm hardware will beat it by minutes.</p>
<h2 id="wrapping-up">Wrapping up</h2>
<p>Building your projects with Nix allows your GitHub actions pipelines to be concise and easy to maintain.</p>
<p>Even when you are not using Nix to build your project it can still help you to create concise and easy to maintain GitHub Action workflows. With Nix shell environments you can use Nix to declare which dependencies you want to make available inside an isolated shell environment for your project: <a href="https://determinate.systems/posts/nix-github-actions">Streamline your GitHub Actions dependencies using Nix</a></p>
<p>Building Nix packages or entire NixOS systems on GitHub Actions can be slow especially if you need to build for Arm. Bringing your own metal to GitHub actions can speed up your builds. If you need Arm runners, Actuated is one of the only options for securely isolated CI that is safe for Open Source and public repositories. Alex explains why in: <a href="/blog/is-the-self-hosted-runner-safe-github-actions">Is the GitHub Actions self-hosted runner safe for Open Source?</a></p>
<p>Another powerful feature of the Nix ecosystem is the ability to run integration tests using virtual machines (NixOS test). This feature requires hardware acceleration to be available in the CI runner. Actuated makes it possible to run these tests in GitHub Actions CI pipelines: <a href="/blog/kvm-in-github-actions">how to run KVM guests in your GitHub Actions</a>.</p>
<p>See also:</p>
<ul>
<li><a href="/blog/case-study-bring-your-own-bare-metal-to-actions">Bring Your Own Metal - Case Study with GitHub Actions</a></li>
<li><a href="/blog/native-arm64-for-github-actions">How to make GitHub Actions 22x faster with bare-metal Arm</a></li>
</ul></div></div></main><footer class="bg-white"><div class="mx-auto max-w-7xl py-12 px-4 sm:px-6 md:flex md:items-center md:justify-between lg:px-8"><div class="flex justify-center space-x-6 md:order-2"><a class="text-gray-400 hover:text-gray-500" href="https://twitter.com/selfactuated"><span class="sr-only">Twitter</span><svg fill="currentColor" viewBox="0 0 24 24" class="h-6 w-6" aria-hidden="true"><path d="M8.29 20.251c7.547 0 11.675-6.253 11.675-11.675 0-.178 0-.355-.012-.53A8.348 8.348 0 0022 5.92a8.19 8.19 0 01-2.357.646 4.118 4.118 0 001.804-2.27 8.224 8.224 0 01-2.605.996 4.107 4.107 0 00-6.993 3.743 11.65 11.65 0 01-8.457-4.287 4.106 4.106 0 001.27 5.477A4.072 4.072 0 012.8 9.713v.052a4.105 4.105 0 003.292 4.022 4.095 4.095 0 01-1.853.07 4.108 4.108 0 003.834 2.85A8.233 8.233 0 012 18.407a11.616 11.616 0 006.29 1.84"></path></svg></a><a class="text-gray-400 hover:text-gray-500" href="https://github.com/self-actuated"><span class="sr-only">GitHub</span><svg fill="currentColor" viewBox="0 0 24 24" class="h-6 w-6" aria-hidden="true"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"></path></svg></a><a class="text-gray-400 hover:text-gray-500" href="/rss.xml"><span class="sr-only">RSS</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M12.75 19.5v-.75a7.5 7.5 0 00-7.5-7.5H4.5m0-6.75h.75c7.87 0 14.25 6.38 14.25 14.25v.75M6 18.75a.75.75 0 11-1.5 0 .75.75 0 011.5 0z"></path></svg></a></div><div class="mt-8 md:order-1 md:mt-0"><p class="text-center text-base text-gray-400">© 2024 <a href="https://openfaas.com">OpenFaaS Ltd</a>. All rights reserved. <a class="hover:underline" href="/terms">Terms &amp; Conditions.</a></p></div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"faster-nix-builds","fileName":"2023-06-12-faster-nix-builds.md","contentHtml":"\u003cp\u003e\u003ca href=\"https://github.com/openfaas/faasd\"\u003efaasd\u003c/a\u003e is a lightweight and portable version of \u003ca href=\"https://www.openfaas.com/\"\u003eOpenFaaS\u003c/a\u003e that was created to run on a single host. In my spare time I maintain \u003ca href=\"https://github.com/welteki/faasd-nix\"\u003efaasd-nix\u003c/a\u003e, a project that packages faasd and exposes a NixOS module so it can be run with NixOS.\u003c/p\u003e\n\u003cp\u003eThe module itself depends on faasd, containerd and the CNI plugins and all of these binaries are built in CI with Nix and then cached using \u003ca href=\"https://www.cachix.org/\"\u003eCachix\u003c/a\u003e to save time on subsequent builds.\u003c/p\u003e\n\u003cp\u003eI often deploy faasd with NixOS on a Raspberry Pi and to the cloud, so I build binaries for both \u003ccode\u003ex86_64\u003c/code\u003e and \u003ccode\u003eaarch64\u003c/code\u003e. The build usually runs on the default GitHub hosted action runners. Now because GitHub currently doesn't have Arm support, I use QEMU instead which can emulate them. The drawback of this approach is that builds can sometimes be several times slower.\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eFor some of our customers, their builds couldn't even complete in 6 hours using QEMU, and only took between 5-20 minutes using native Arm hardware. Alex Ellis, Founder of Actuated.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eWhile upgrading to the latest nixpkgs release recently I decided to try and build the project on runners managed with Actuated to see the improvements that can be made by switching to both bigger \u003ccode\u003ex86_64\u003c/code\u003e iron and native Arm hardware.\u003c/p\u003e\n\u003ch2 id=\"nix-and-github-actions\"\u003eNix and GitHub actions\u003c/h2\u003e\n\u003cp\u003eOne of the features Nix offers are reproducible builds. Once a package is declared it can be built on any system. There is no need to prepare your machine with all the build dependencies. The only requirement is that Nix is installed.\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eIf you are new to Nix, then I'd recommend you read the \u003ca href=\"https://zero-to-nix.com/start/install\"\u003eZero to Nix\u003c/a\u003e guide. It's what got me excited about the project.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eBecause Nix is declarative and offers reproducible builds, it is easy to setup a concise build pipeline for GitHub actions. A lot of steps usually required to setup the build environment can be left out. For instance, faasd requires Go, but there's no need to install it onto the build machine, and you'd normally have to install btrfs-progs to build containerd, but that's not something you have to think about, because Nix will take care of it for you.\u003c/p\u003e\n\u003cp\u003eAnother advantage of the reproducible builds is that if it works on your local machine it most likely also works in CI. No need to debug and find any discrepancies between your local and CI environment.\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eOf course, if you ever do get frustrated and want to debug a build, you can use the built-in \u003ca href=\"https://docs.actuated.com/tasks/debug-ssh/\"\u003eSSH feature in Actuated\u003c/a\u003e. Alex Ellis, Founder of Actuated.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eThis is what the workflow looks like for building faasd and its related packages:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-attr\"\u003ejobs:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003ebuild:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003eruns-on:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eubuntu-latest\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003esteps:\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eactions/checkout@v3\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ecachix/install-nix-action@v21\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eBuild\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003efaasd\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e🔧\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003erun:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e|\n          nix build -L .#faasd\n\u003c/span\u003e      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eBuild\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003econtainerd\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e🔧\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003erun:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e|\n          nix build -L .#faasd-containerd\n\u003c/span\u003e      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eBuild\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ecni-plugin\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e🔧\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003erun:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e|\n          nix build -L .#faasd-cni-plugins\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAll this pipeline does is install Nix, using the \u003ca href=\"https://github.com/marketplace/actions/install-nix\"\u003ecachix/install-nix-action\u003c/a\u003e and run the \u003ccode\u003enix build\u003c/code\u003e command for the packages that need to be built.\u003c/p\u003e\n\u003ch2 id=\"notes-on-the-nix-build-for-aarch64\"\u003eNotes on the nix build for aarch64\u003c/h2\u003e\n\u003cp\u003eTo build the packages for multiple architectures there are a couple of options:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ecross-compiling, Nix has great support for cross compilation.\u003c/li\u003e\n\u003cli\u003ecompiling through binfmt QEMU.\u003c/li\u003e\n\u003cli\u003ecompiling natively on an aarch64 machine.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThe preferred option would be to compile everything natively on an aarch64 machine as that would result in the best performance. However, at the time of writing GitHub does not provide Arm runners. That is why QEMU is used by many people to compile binaries in CI.\u003c/p\u003e\n\u003cp\u003eEnabling the binfmt wrapper on NixOS can be done easily through the NixOS configuration. On non-NixOS machines, like on the GitHub runner VM, the QEMU static binaries need to be installed and the Nix daemon configuration updated.\u003c/p\u003e\n\u003cp\u003eInstructions to configure Nix for compilation with QEMU can be found on the \u003ca href=\"https://nixos.wiki/wiki/NixOS_on_ARM#Compiling_through_binfmt_QEMU\"\u003eNixOS wiki\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eThe workflow for building aarch64 packages with QEMU on GitHub Actions looks like this:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-attr\"\u003ejobs:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003ebuild:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003eruns-on:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eubuntu-latest\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003esteps:\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eactions/checkout@v3\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edocker/setup-qemu-action@v2\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ecachix/install-nix-action@v21\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003ewith:\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003eextra_nix_config:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e|\n            extra-platforms = aarch64-linux\n\u003c/span\u003e      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eBuild\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003efaasd\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e🔧\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003erun:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e|\n          nix build -L .#packages.aarch64-linux.faasd\n\u003c/span\u003e      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eBuild\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003econtainerd\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e🔧\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003erun:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e|\n          nix build -L .#packages.aarch64-linux.faasd-containerd\n\u003c/span\u003e      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eBuild\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ecni-plugin\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e🔧\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003erun:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e|\n          nix build -L .#packages.aarch64-linux.faasd-cni-plugins\n\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eInstall the QEMU static binaries using \u003ca href=\"https://github.com/docker/setup-qemu-action\"\u003edocker/setup-qemu-action\u003c/a\u003e. Let the nix daemon know that it can build for aarch64 by adding \u003ccode\u003eextra-platforms = aarch64-linux\u003c/code\u003e via the \u003ccode\u003eextra_nix_config\u003c/code\u003e input on the install nix action. Update the nix build commands to specify platform e.g. \u003ccode\u003enix build .#packages.aarch64-linux.faasd\u003c/code\u003e.\u003c/p\u003e\n\u003ch2 id=\"speeding-up-the-build-with-a-raspberry-pi\"\u003eSpeeding up the build with a Raspberry Pi\u003c/h2\u003e\n\u003cp\u003eNix has great support for caching and build speeds can be improved greatly by never building things twice. This project normally uses \u003ca href=\"https://www.cachix.org/\"\u003eCachix\u003c/a\u003e for caching and charing binaries across systems. For this comparison caching was disabled. All packages and their dependencies are built from scratch again each time.\u003c/p\u003e\n\u003cp\u003eBuilding the project takes around 4 minutes and 20 seconds on the standard GitHub hosted runner. After switching to a more powerful Actuated runner with 4CPUs and 8GB of RAM the build time dropped to 2 minutes and 15 seconds.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/2023-06-faster-nix-builds/amd64-build-comparison.png\" alt=\"Comparison of more powerful Actuated runner with GitHub hosted runner\"\u003e\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eComparison of more powerful Actuated runner with GitHub hosted runner.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eWhile build times are still acceptable for x86_64 this is not the case for the aarch64 build. It takes around 55 minutes to complete the Arm build with QEMU on a GitHub runner.\u003c/p\u003e\n\u003cp\u003eRunning the same build with QEMU on the Actuated runner already brings down the build time to 19 minutes and 40 seconds. Running the build natively on a Raspberry Pi 4 (8GB) completed in 11 minutes and 47 seconds. Building on a more powerful Arm machine would potentially reduce this time to a couple of minutes.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/2023-06-faster-nix-builds/arm64-build-comparison.png\" alt=\"Results of the matrix build comparing the GitHub hosted runner and the 2 Actuated runners\"\u003e\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eResults of the matrix build comparing the GitHub hosted runner and the 2 Actuated runners.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eRunning the build natively on the Pi did even beat the fast bare-metal machine that is using QEMU.\u003c/p\u003e\n\u003cp\u003eMy colleague Alex ran the same build on his Raspberry Pi using Actuated and an NVMe mounted over USB-C, he got the build time down even further. Why? Because it increased the I/O performance. In fact, if you build this on server-grade Arm like the Ampere Altra, it would be about 4x faster than the Pi 4.\u003c/p\u003e\n\u003cp\u003eBuilding for Arm:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eAlex's Raspberry Pi with NVMe: 10m49s\u003c/li\u003e\n\u003cli\u003eAn Ampere Altra on Equinix Metal: 3m29s\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eBuilding for x86_64\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eAMD Epyc on Equinix Metal: 1m57s\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/images/2023-06-faster-nix-builds/alex-results.png\" alt=\"Alex\u0026#x27;s results\"\u003e\u003c/p\u003e\n\u003cp\u003eThese results show that whatever the Arm hardware you pick, it'll likely be faster than QEMU, even when QEMU is run on the fastest bare-metal available, the slowest Arm hardware will beat it by minutes.\u003c/p\u003e\n\u003ch2 id=\"wrapping-up\"\u003eWrapping up\u003c/h2\u003e\n\u003cp\u003eBuilding your projects with Nix allows your GitHub actions pipelines to be concise and easy to maintain.\u003c/p\u003e\n\u003cp\u003eEven when you are not using Nix to build your project it can still help you to create concise and easy to maintain GitHub Action workflows. With Nix shell environments you can use Nix to declare which dependencies you want to make available inside an isolated shell environment for your project: \u003ca href=\"https://determinate.systems/posts/nix-github-actions\"\u003eStreamline your GitHub Actions dependencies using Nix\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eBuilding Nix packages or entire NixOS systems on GitHub Actions can be slow especially if you need to build for Arm. Bringing your own metal to GitHub actions can speed up your builds. If you need Arm runners, Actuated is one of the only options for securely isolated CI that is safe for Open Source and public repositories. Alex explains why in: \u003ca href=\"/blog/is-the-self-hosted-runner-safe-github-actions\"\u003eIs the GitHub Actions self-hosted runner safe for Open Source?\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eAnother powerful feature of the Nix ecosystem is the ability to run integration tests using virtual machines (NixOS test). This feature requires hardware acceleration to be available in the CI runner. Actuated makes it possible to run these tests in GitHub Actions CI pipelines: \u003ca href=\"/blog/kvm-in-github-actions\"\u003ehow to run KVM guests in your GitHub Actions\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eSee also:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"/blog/case-study-bring-your-own-bare-metal-to-actions\"\u003eBring Your Own Metal - Case Study with GitHub Actions\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"/blog/native-arm64-for-github-actions\"\u003eHow to make GitHub Actions 22x faster with bare-metal Arm\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e","title":"Faster Nix builds with GitHub Actions and actuated","description":"Speed up your Nix project builds on GitHub Actions with runners powered by Firecracker.","tags":["cicd","githubactions","nix","nixos","faasd","openfaas"],"author_img":"welteki","image":"/images/2023-06-faster-nix-builds/background.png","date":"2023-06-12"}},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"faster-nix-builds"},"buildId":"DetXrL7nOwq_JVqM2VMRg","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>