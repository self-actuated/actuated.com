<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="theme-color" content="#000000"/><meta name="author" content="OpenFaaS Ltd"/><meta name="twitter:card" content="summary_large_image"/><title>How to run KVM guests in your GitHub Actions</title><meta name="description" content="From building cloud images, to running NixOS tests and the android emulator, we look at how and why you&#x27;d want to run a VM in GitHub Actions."/><meta property="twitter:title" content="How to run KVM guests in your GitHub Actions"/><meta property="twitter:description" content="From building cloud images, to running NixOS tests and the android emulator, we look at how and why you&#x27;d want to run a VM in GitHub Actions."/><meta property="og:title" content="How to run KVM guests in your GitHub Actions"/><meta property="og:description" content="From building cloud images, to running NixOS tests and the android emulator, we look at how and why you&#x27;d want to run a VM in GitHub Actions."/><meta name="twitter:image:src" content="https://actuated.com/images/2023-02-17-kvm-in-github-actions/nested-firecracker.png"/><meta property="og:image" content="https://actuated.com/images/2023-02-17-kvm-in-github-actions/nested-firecracker.png"/><meta name="next-head-count" content="13"/><meta charSet="utf-8"/><link rel="icon" type="image/png" href="/images/actuated.png"/><link rel="stylesheet" href="https://rsms.me/inter/inter.css"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css"/><link rel="manifest" href="/manifest.json"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-M5YNDNX7VT"></script><script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'G-M5YNDNX7VT');
          </script><link rel="apple-touch-icon" href="/images/actuated.png"/><link rel="preload" href="/_next/static/css/931f0fc3815fa31d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/931f0fc3815fa31d.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-8fa1640cc84ba8fe.js" defer=""></script><script src="/_next/static/chunks/framework-114634acb84f8baa.js" defer=""></script><script src="/_next/static/chunks/main-34e2100d07ae5757.js" defer=""></script><script src="/_next/static/chunks/pages/_app-a058602dc4f1b3be.js" defer=""></script><script src="/_next/static/chunks/552-542f150c917a7625.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bslug%5D-386521db085c1ba3.js" defer=""></script><script src="/_next/static/qP6XrePfh_ktdNhbSnok_/_buildManifest.js" defer=""></script><script src="/_next/static/qP6XrePfh_ktdNhbSnok_/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="bg-white"><header><div class="relative bg-white" data-headlessui-state=""><div class="mx-auto flex max-w-7xl items-center justify-between px-4 py-6 sm:px-6 md:justify-start md:space-x-10 lg:px-8"><div class="flex justify-start lg:w-0 lg:flex-1"><a href="/"><span class="sr-only">Actuated</span><img class="h-8 w-auto sm:h-10" src="/images/actuated.png" alt="Actuated logo"/></a></div><div class="-my-2 -mr-2 md:hidden"><button class="inline-flex items-center justify-center rounded-md bg-white p-2 text-gray-400 hover:bg-gray-100 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500" type="button" aria-expanded="false" data-headlessui-state=""><span class="sr-only">Open menu</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" class="h-6 w-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"></path></svg></button></div><nav class="hidden space-x-10 md:flex"><div class="relative" data-headlessui-state=""><button class="text-gray-500 group inline-flex items-center rounded-md bg-white text-base font-medium hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" type="button" aria-expanded="false" data-headlessui-state=""><span>Solutions</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="text-gray-400 ml-2 h-5 w-5 group-hover:text-gray-500"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"></path></svg></button></div><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/blog">Blog</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/blog/blazing-fast-ci-with-microvms">Announcement</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/pricing">Pricing</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="https://docs.actuated.dev/">Docs</a></nav><div class="hidden items-center justify-end md:flex md:flex-1 lg:w-0"><a href="https://dashboard.actuated.dev" class="whitespace-nowrap text-base font-medium text-gray-500 hover:text-gray-900">Sign in</a><a href="/pricing" class="ml-8 inline-flex items-center justify-center whitespace-nowrap rounded-md border border-transparent bg-indigo-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-indigo-700">Sign-up</a></div></div></div></header><main><div class="container mx-auto max-w-4xl bg-white mt-4 px-4 sm:px-6"><h1 id="post_title" class="text-3xl mb-3 leading-8 font-extrabold tracking-tight text-gray-900 sm:text-4xl sm:leading-10 text-center">How to run KVM guests in your GitHub Actions</h1></div><div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-4xl"><div class="border-b border-gray-200 py-4 flex items-center text-gray-500 mx-auto"><div><img class="h-10 w-10 rounded-full" src="/images/welteki.jpg" alt=""/></div><div class="ml-3"><p id="post_author" class="text-sm leading-5 font-medium text-gray-900">Han Verstraete</p><div class="flex text-sm leading-5 text-gray-500"><time dateTime="2023-02-17" id="post_date">February 17, 2023</time><span class="mx-1"></span></div></div></div><div class="mt-6 prose sm:prose-lg max-w-none"><p id="post_description" class="mb-4">From building cloud images, to running NixOS tests and the android emulator, we look at how and why you&#x27;d want to run a VM in GitHub Actions.</p></div><div id="post_content" class="mt-6 prose sm:prose-lg max-w-none"><p>GitHub's hosted runners do not support nested virtualization. This means some frequently used tools that require KVM like packer, the Android emulator, etc can not be used in GitHub Actions CI pipelines.</p>
<p>We noticed there are quite a few issues for people requesting KVM support for GitHub Actions:</p>
<ul>
<li><a href="https://github.com/actions/runner-images/issues/183">Enable nested virtualization · Issue #183 · actions/runner-images</a></li>
<li><a href="https://github.com/community/community/discussions/8305">Revisiting KVM support for Hosted GitHub Actions · Discussion #8305 · community/community</a></li>
<li><a href="https://github.com/WikiWatershed/model-my-watershed/pull/3586">[Experimental] Add CI GitHub Actions workflow by rajadain · Pull Request #3586 · WikiWatershed/model-my-watershed</a></li>
</ul>
<p>As mentioned in some of these issues, an alternative would be to run your own self-hosted runner on a bare metal host. This comes with the downside that builds can conflict and cause side effects to system-level packages. On top if this self-hosted runners are considered <a href="https://docs.github.com/en/actions/hosting-your-own-runners/about-self-hosted-runners#self-hosted-runner-security">insecure for public repositories</a>.</p>
<p>Solutions like the "actions-runtime-controller" or ARC that use Kubernetes to orchestrate and run self-hosted runners in Pods are also out of scope if you need to run VMs.</p>
<p>With Actuated we make it possible to launch a Virtual Machine (VM) within a GitHub Action. Jobs are launched in isolated VMs just like GitHub hosted runners but with support for nested virtualization.</p>
<h2>Case Study: Githedgehog</h2>
<p>One of our customers Sergei Lukianov, founding engineer at <a href="https://githedgehog.com">Githedgehog</a> told us he needed somewhere to build Docker images and to test them with Kubernetes, he uses KinD for that.</p>
<p>Prior to adopting Actuated, his team used hosted runners which are considerably slower, and paid on a per minute basis. Actuated made his builds both faster, and more secure than using any of the alternatives for self-hosted runners.</p>
<p>It turned out that he also needed to launch VMs in those jobs, and that's something else that hosted runners cannot cater for right now. Actuated’s KVM guest support means he can run all of his workloads on fast hardware.</p>
<p>Some other common use cases that require KVM support on the CI runner:</p>
<ul>
<li>Running <a href="https://www.packer.io/">Packer</a> for creating Amazon Machine Images (AMI) or VM images for other cloud platforms.</li>
<li>Accelerating the <a href="https://developer.android.com/studio/run/emulator-commandline">Android Emulator</a> via KVM.</li>
<li>Running <a href="https://nixos.org/">NixOS</a> tests or builds that depend on VMs.</li>
<li>Testing software that can only be done with <a href="https://www.linux-kvm.org/page/Main_Page">KVM</a> or in a VM.</li>
</ul>
<h2>Running VMs in GitHub Actions</h2>
<p>In this section we will walk you through a couple of hands-on examples.</p>
<h3>Firecracker microVM</h3>
<p>In this example we are going to follow the Firecracker quickstart guide to boot up a Firecracker VM but instead of running it on our local machine we will run it from within a GitHub Actions workflow.</p>
<p>The workflow instals Firecracker, configures and boots a guest VM and then waits 20 seconds before shutting down the VM and exiting the workflow. The image below shows the run logs of the workflow. We see the login prompt of the running microVM.</p>
<p><img src="/images/2023-02-17-kvm-in-github-actions/nested-firecracker.png" alt="Running a firecracker microVM in a GitHub Actions job"></p>
<blockquote>
<p>Running a firecracker microVM in a GitHub Actions job</p>
</blockquote>
<p>Here is the workflow file used by this job:</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">run-vm</span>

<span class="hljs-attr">on:</span> <span class="hljs-string">push</span>
<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">vm-run:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">actuated-4cpu-8gb</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@master</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">fetch-depth:</span> <span class="hljs-number">1</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">arkade</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">alexellis/setup-arkade@v2</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">firecracker</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          sudo arkade system install firecracker
</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">microVM</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">sudo</span> <span class="hljs-string">-E</span> <span class="hljs-string">./run-vm.sh</span>
</code></pre>
<p>The <a href="https://github.com/alexellis/setup-arkade">setup-arkade</a> is to install arkade on the runner. Next firecracker is installed from the arkade system apps.</p>
<p>As a last step we run a firecracker microVM. The <code>run-vm.sh</code> script is based on the <a href="https://github.com/firecracker-microvm/firecracker/blob/main/docs/getting-started.md">firecracker quickstart</a> and collects all the steps into a single script that can be run in the CI pipeline.</p>
<p>It script will:</p>
<ul>
<li>Get the kernel and rootfs for the microVM</li>
<li>Start fireckracker and configure the guest kernel and rootfs</li>
<li>Start the guest machine</li>
<li>Wait for 20 seconds and kill the firecracker process so workflow finishes.</li>
</ul>
<p>The <code>run-vm.sh</code> script:</p>
<pre><code class="hljs language-sh"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># Get a kernel and rootfs</span>
<span class="hljs-built_in">arch</span>=`<span class="hljs-built_in">uname</span> -m`
dest_kernel=<span class="hljs-string">"hello-vmlinux.bin"</span>
dest_rootfs=<span class="hljs-string">"hello-rootfs.ext4"</span>
image_bucket_url=<span class="hljs-string">"https://s3.amazonaws.com/spec.ccfc.min/img/quickstart_guide/<span class="hljs-variable">$arch</span>"</span>

<span class="hljs-keyword">if</span> [ <span class="hljs-variable">${arch}</span> = <span class="hljs-string">"x86_64"</span> ]; <span class="hljs-keyword">then</span>
    kernel=<span class="hljs-string">"<span class="hljs-variable">${image_bucket_url}</span>/kernels/vmlinux.bin"</span>
    rootfs=<span class="hljs-string">"<span class="hljs-variable">${image_bucket_url}</span>/rootfs/bionic.rootfs.ext4"</span>
<span class="hljs-keyword">elif</span> [ <span class="hljs-variable">${arch}</span> = <span class="hljs-string">"aarch64"</span> ]; <span class="hljs-keyword">then</span>
    kernel=<span class="hljs-string">"<span class="hljs-variable">${image_bucket_url}</span>/kernels/vmlinux.bin"</span>
    rootfs=<span class="hljs-string">"<span class="hljs-variable">${image_bucket_url}</span>/rootfs/bionic.rootfs.ext4"</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Cannot run firecracker on <span class="hljs-variable">$arch</span> architecture!"</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"Downloading <span class="hljs-variable">$kernel</span>..."</span>
curl -fsSL -o <span class="hljs-variable">$dest_kernel</span> <span class="hljs-variable">$kernel</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"Downloading <span class="hljs-variable">$rootfs</span>..."</span>
curl -fsSL -o <span class="hljs-variable">$dest_rootfs</span> <span class="hljs-variable">$rootfs</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"Saved kernel file to <span class="hljs-variable">$dest_kernel</span> and root block device to <span class="hljs-variable">$dest_rootfs</span>."</span>

<span class="hljs-comment"># Start firecracker</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Starting firecracker"</span>
firecracker --api-sock /tmp/firecracker.socket &#x26;
firecracker_pid=$!

<span class="hljs-comment"># Set the guest kernel and rootfs</span>
rch=`<span class="hljs-built_in">uname</span> -m`
kernel_path=$(<span class="hljs-built_in">pwd</span>)<span class="hljs-string">"/hello-vmlinux.bin"</span>

<span class="hljs-keyword">if</span> [ <span class="hljs-variable">${arch}</span> = <span class="hljs-string">"x86_64"</span> ]; <span class="hljs-keyword">then</span>
    curl --unix-socket /tmp/firecracker.socket -i \
      -X PUT <span class="hljs-string">'http://localhost/boot-source'</span>   \
      -H <span class="hljs-string">'Accept: application/json'</span>           \
      -H <span class="hljs-string">'Content-Type: application/json'</span>     \
      -d <span class="hljs-string">"{
            \"kernel_image_path\": \"<span class="hljs-variable">${kernel_path}</span>\",
            \"boot_args\": \"console=ttyS0 reboot=k panic=1 pci=off\"
       }"</span>
<span class="hljs-keyword">elif</span> [ <span class="hljs-variable">${arch}</span> = <span class="hljs-string">"aarch64"</span> ]; <span class="hljs-keyword">then</span>
    curl --unix-socket /tmp/firecracker.socket -i \
      -X PUT <span class="hljs-string">'http://localhost/boot-source'</span>   \
      -H <span class="hljs-string">'Accept: application/json'</span>           \
      -H <span class="hljs-string">'Content-Type: application/json'</span>     \
      -d <span class="hljs-string">"{
            \"kernel_image_path\": \"<span class="hljs-variable">${kernel_path}</span>\",
            \"boot_args\": \"keep_bootcon console=ttyS0 reboot=k panic=1 pci=off\"
       }"</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Cannot run firecracker on <span class="hljs-variable">$arch</span> architecture!"</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

rootfs_path=$(<span class="hljs-built_in">pwd</span>)<span class="hljs-string">"/hello-rootfs.ext4"</span>
curl --unix-socket /tmp/firecracker.socket -i \
  -X PUT <span class="hljs-string">'http://localhost/drives/rootfs'</span> \
  -H <span class="hljs-string">'Accept: application/json'</span>           \
  -H <span class="hljs-string">'Content-Type: application/json'</span>     \
  -d <span class="hljs-string">"{
        \"drive_id\": \"rootfs\",
        \"path_on_host\": \"<span class="hljs-variable">${rootfs_path}</span>\",
        \"is_root_device\": true,
        \"is_read_only\": false
   }"</span>

<span class="hljs-comment"># Start the guest machine</span>
curl --unix-socket /tmp/firecracker.socket -i \
  -X PUT <span class="hljs-string">'http://localhost/actions'</span>       \
  -H  <span class="hljs-string">'Accept: application/json'</span>          \
  -H  <span class="hljs-string">'Content-Type: application/json'</span>    \
  -d <span class="hljs-string">'{
      "action_type": "InstanceStart"
   }'</span>

<span class="hljs-comment"># Kill the firecracker process to exit the workflow</span>
<span class="hljs-built_in">sleep</span> 20
<span class="hljs-built_in">kill</span> -9 <span class="hljs-variable">$firecracker_pid</span>

</code></pre>
<p>The full example can be found on <a href="https://github.com/skatolo/nested-firecracker">GitHub</a></p>
<p>If you'd like to know more about how Firecracker works and how it compares to traditional VMs and Docker you can watch Alex's webinar on the topic.</p>
<iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/CYCsa5e2vqg" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
<blockquote>
<p>Join Alex and Richard Case for a cracking time. The pair share what's got them so excited about Firecracker, the kinds of use-cases they see for microVMs, fundamentals of Linux Operating Systems and plenty of demos.</p>
</blockquote>
<h3>NixOS integration tests</h3>
<p>With nix there is the ability to provide a set of declarative configuration to define integration tests that spin up virtual machines using <a href="https://www.qemu.org/">QEMU</a> as the backend. While running these tests in CI without hardware acceleration is supported this is considerably slower.</p>
<p>For a more detailed overview of the test setup and configuration see the original tutorial on nix.dev:</p>
<ul>
<li><a href="https://nix.dev/tutorials/nixos/build-and-deploy/integration-testing-using-virtual-machines">Integration testing using virtual machines (VMs)</a></li>
</ul>
<p>The workflow file for running NixOS tests on  GitHub Actions:</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">nixos-tests</span>

<span class="hljs-attr">on:</span> <span class="hljs-string">push</span>
<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">nixos-test:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">actuated</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@master</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">fetch-depth:</span> <span class="hljs-number">1</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-python@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">python-version:</span> <span class="hljs-string">'3.x'</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">cachix/install-nix-action@v16</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">extra_nix_config:</span> <span class="hljs-string">"system-features = nixos-test benchmark big-parallel kvm"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">NixOS</span> <span class="hljs-string">test</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">nix</span> <span class="hljs-string">build</span> <span class="hljs-string">-L</span> <span class="hljs-string">.#checks.x86_64-linux.postgres</span>
</code></pre>
<p>We just install Nix using the <a href="https://github.com/cachix/install-nix-action">install-nix-action</a> and run the tests in the next step.</p>
<p>The full example is available on <a href="https://github.com/skatolo/gh-actions-nixos-tests">GitHub</a></p>
<h3>Other examples of using a VM</h3>
<p>In the previous section we showed you some brief examples for the kind of workflows you can run. Here are some other resources and tutorials that should be easy to adapt and run in CI.</p>
<ul>
<li>Create KVM virtual machine images with the <a href="https://developer.hashicorp.com/packer/plugins/builders/qemu">Packer QEMU Builder</a></li>
<li>Launching an Ubuntu cloud image with cloud-init: <a href="https://fabianlee.org/2020/02/23/kvm-testing-cloud-init-locally-using-kvm-for-an-ubuntu-cloud-image/">KVM: Testing cloud-init locally using KVM for an Ubuntu cloud image</a></li>
</ul>
<h2>Conclusion</h2>
<p>Hosted runners do not support nested virtualization. That makes them unsuitable for running CI jobs that require KVM support.</p>
<p>For Actuated runners we provide a custom Kernel that enables KVM support. This will allow you to run Virtual Machines within your CI jobs.</p>
<p>At time of writing there is no support for aarch64 runners. Only Intel and AMD CPUs support nested virtualisation.</p>
<p>While it is possible to deploy your own self-hosted runners to run jobs that need KVM support, this is not recommended:</p>
<ul>
<li><a href="/blog/is-the-self-hosted-runner-safe-github-actions">Is the GitHub Actions self-hosted runner safe for Open Source?</a></li>
</ul>
<p>Want to see a demo or talk to our team? <a href="https://forms.gle/8XmpTTWXbZwWkfqT6">Contact us here</a></p>
<p>Just want to try it out instead? <a href="/pricing">Register your GitHub Organisation and set-up a subscription</a></p></div></div></main><footer class="bg-white"><div class="mx-auto max-w-7xl py-12 px-4 sm:px-6 md:flex md:items-center md:justify-between lg:px-8"><div class="flex justify-center space-x-6 md:order-2"><a class="text-gray-400 hover:text-gray-500" href="https://twitter.com/selfactuated"><span class="sr-only">Twitter</span><svg fill="currentColor" viewBox="0 0 24 24" class="h-6 w-6" aria-hidden="true"><path d="M8.29 20.251c7.547 0 11.675-6.253 11.675-11.675 0-.178 0-.355-.012-.53A8.348 8.348 0 0022 5.92a8.19 8.19 0 01-2.357.646 4.118 4.118 0 001.804-2.27 8.224 8.224 0 01-2.605.996 4.107 4.107 0 00-6.993 3.743 11.65 11.65 0 01-8.457-4.287 4.106 4.106 0 001.27 5.477A4.072 4.072 0 012.8 9.713v.052a4.105 4.105 0 003.292 4.022 4.095 4.095 0 01-1.853.07 4.108 4.108 0 003.834 2.85A8.233 8.233 0 012 18.407a11.616 11.616 0 006.29 1.84"></path></svg></a><a class="text-gray-400 hover:text-gray-500" href="https://github.com/self-actuated"><span class="sr-only">GitHub</span><svg fill="currentColor" viewBox="0 0 24 24" class="h-6 w-6" aria-hidden="true"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"></path></svg></a><a class="text-gray-400 hover:text-gray-500" href="/rss.xml"><span class="sr-only">RSS</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M12.75 19.5v-.75a7.5 7.5 0 00-7.5-7.5H4.5m0-6.75h.75c7.87 0 14.25 6.38 14.25 14.25v.75M6 18.75a.75.75 0 11-1.5 0 .75.75 0 011.5 0z"></path></svg></a></div><div class="mt-8 md:order-1 md:mt-0"><p class="text-center text-base text-gray-400">© 2024 <a href="https://openfaas.com">OpenFaaS Ltd</a>. All rights reserved. <a class="hover:underline" href="/terms">Terms &amp; Conditions.</a></p></div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"kvm-in-github-actions","fileName":"2023-02-17-kvm-in-github-actions.md","contentHtml":"\u003cp\u003eGitHub's hosted runners do not support nested virtualization. This means some frequently used tools that require KVM like packer, the Android emulator, etc can not be used in GitHub Actions CI pipelines.\u003c/p\u003e\n\u003cp\u003eWe noticed there are quite a few issues for people requesting KVM support for GitHub Actions:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/actions/runner-images/issues/183\"\u003eEnable nested virtualization · Issue #183 · actions/runner-images\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/community/community/discussions/8305\"\u003eRevisiting KVM support for Hosted GitHub Actions · Discussion #8305 · community/community\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/WikiWatershed/model-my-watershed/pull/3586\"\u003e[Experimental] Add CI GitHub Actions workflow by rajadain · Pull Request #3586 · WikiWatershed/model-my-watershed\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eAs mentioned in some of these issues, an alternative would be to run your own self-hosted runner on a bare metal host. This comes with the downside that builds can conflict and cause side effects to system-level packages. On top if this self-hosted runners are considered \u003ca href=\"https://docs.github.com/en/actions/hosting-your-own-runners/about-self-hosted-runners#self-hosted-runner-security\"\u003einsecure for public repositories\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eSolutions like the \"actions-runtime-controller\" or ARC that use Kubernetes to orchestrate and run self-hosted runners in Pods are also out of scope if you need to run VMs.\u003c/p\u003e\n\u003cp\u003eWith Actuated we make it possible to launch a Virtual Machine (VM) within a GitHub Action. Jobs are launched in isolated VMs just like GitHub hosted runners but with support for nested virtualization.\u003c/p\u003e\n\u003ch2\u003eCase Study: Githedgehog\u003c/h2\u003e\n\u003cp\u003eOne of our customers Sergei Lukianov, founding engineer at \u003ca href=\"https://githedgehog.com\"\u003eGithedgehog\u003c/a\u003e told us he needed somewhere to build Docker images and to test them with Kubernetes, he uses KinD for that.\u003c/p\u003e\n\u003cp\u003ePrior to adopting Actuated, his team used hosted runners which are considerably slower, and paid on a per minute basis. Actuated made his builds both faster, and more secure than using any of the alternatives for self-hosted runners.\u003c/p\u003e\n\u003cp\u003eIt turned out that he also needed to launch VMs in those jobs, and that's something else that hosted runners cannot cater for right now. Actuated’s KVM guest support means he can run all of his workloads on fast hardware.\u003c/p\u003e\n\u003cp\u003eSome other common use cases that require KVM support on the CI runner:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eRunning \u003ca href=\"https://www.packer.io/\"\u003ePacker\u003c/a\u003e for creating Amazon Machine Images (AMI) or VM images for other cloud platforms.\u003c/li\u003e\n\u003cli\u003eAccelerating the \u003ca href=\"https://developer.android.com/studio/run/emulator-commandline\"\u003eAndroid Emulator\u003c/a\u003e via KVM.\u003c/li\u003e\n\u003cli\u003eRunning \u003ca href=\"https://nixos.org/\"\u003eNixOS\u003c/a\u003e tests or builds that depend on VMs.\u003c/li\u003e\n\u003cli\u003eTesting software that can only be done with \u003ca href=\"https://www.linux-kvm.org/page/Main_Page\"\u003eKVM\u003c/a\u003e or in a VM.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eRunning VMs in GitHub Actions\u003c/h2\u003e\n\u003cp\u003eIn this section we will walk you through a couple of hands-on examples.\u003c/p\u003e\n\u003ch3\u003eFirecracker microVM\u003c/h3\u003e\n\u003cp\u003eIn this example we are going to follow the Firecracker quickstart guide to boot up a Firecracker VM but instead of running it on our local machine we will run it from within a GitHub Actions workflow.\u003c/p\u003e\n\u003cp\u003eThe workflow instals Firecracker, configures and boots a guest VM and then waits 20 seconds before shutting down the VM and exiting the workflow. The image below shows the run logs of the workflow. We see the login prompt of the running microVM.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/2023-02-17-kvm-in-github-actions/nested-firecracker.png\" alt=\"Running a firecracker microVM in a GitHub Actions job\"\u003e\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eRunning a firecracker microVM in a GitHub Actions job\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eHere is the workflow file used by this job:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003erun-vm\u003c/span\u003e\n\n\u003cspan class=\"hljs-attr\"\u003eon:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003epush\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003ejobs:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003evm-run:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003eruns-on:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eactuated-4cpu-8gb\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003esteps:\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eactions/checkout@master\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003ewith:\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003efetch-depth:\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eInstall\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003earkade\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ealexellis/setup-arkade@v2\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eInstall\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003efirecracker\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003erun:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e|\n          sudo arkade system install firecracker\n\u003c/span\u003e      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eRun\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003emicroVM\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003erun:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esudo\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e-E\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e./run-vm.sh\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe \u003ca href=\"https://github.com/alexellis/setup-arkade\"\u003esetup-arkade\u003c/a\u003e is to install arkade on the runner. Next firecracker is installed from the arkade system apps.\u003c/p\u003e\n\u003cp\u003eAs a last step we run a firecracker microVM. The \u003ccode\u003erun-vm.sh\u003c/code\u003e script is based on the \u003ca href=\"https://github.com/firecracker-microvm/firecracker/blob/main/docs/getting-started.md\"\u003efirecracker quickstart\u003c/a\u003e and collects all the steps into a single script that can be run in the CI pipeline.\u003c/p\u003e\n\u003cp\u003eIt script will:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eGet the kernel and rootfs for the microVM\u003c/li\u003e\n\u003cli\u003eStart fireckracker and configure the guest kernel and rootfs\u003c/li\u003e\n\u003cli\u003eStart the guest machine\u003c/li\u003e\n\u003cli\u003eWait for 20 seconds and kill the firecracker process so workflow finishes.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThe \u003ccode\u003erun-vm.sh\u003c/code\u003e script:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sh\"\u003e\u003cspan class=\"hljs-meta\"\u003e#!/bin/bash\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment\"\u003e# Get a kernel and rootfs\u003c/span\u003e\n\u003cspan class=\"hljs-built_in\"\u003earch\u003c/span\u003e=`\u003cspan class=\"hljs-built_in\"\u003euname\u003c/span\u003e -m`\ndest_kernel=\u003cspan class=\"hljs-string\"\u003e\"hello-vmlinux.bin\"\u003c/span\u003e\ndest_rootfs=\u003cspan class=\"hljs-string\"\u003e\"hello-rootfs.ext4\"\u003c/span\u003e\nimage_bucket_url=\u003cspan class=\"hljs-string\"\u003e\"https://s3.amazonaws.com/spec.ccfc.min/img/quickstart_guide/\u003cspan class=\"hljs-variable\"\u003e$arch\u003c/span\u003e\"\u003c/span\u003e\n\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e [ \u003cspan class=\"hljs-variable\"\u003e${arch}\u003c/span\u003e = \u003cspan class=\"hljs-string\"\u003e\"x86_64\"\u003c/span\u003e ]; \u003cspan class=\"hljs-keyword\"\u003ethen\u003c/span\u003e\n    kernel=\u003cspan class=\"hljs-string\"\u003e\"\u003cspan class=\"hljs-variable\"\u003e${image_bucket_url}\u003c/span\u003e/kernels/vmlinux.bin\"\u003c/span\u003e\n    rootfs=\u003cspan class=\"hljs-string\"\u003e\"\u003cspan class=\"hljs-variable\"\u003e${image_bucket_url}\u003c/span\u003e/rootfs/bionic.rootfs.ext4\"\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eelif\u003c/span\u003e [ \u003cspan class=\"hljs-variable\"\u003e${arch}\u003c/span\u003e = \u003cspan class=\"hljs-string\"\u003e\"aarch64\"\u003c/span\u003e ]; \u003cspan class=\"hljs-keyword\"\u003ethen\u003c/span\u003e\n    kernel=\u003cspan class=\"hljs-string\"\u003e\"\u003cspan class=\"hljs-variable\"\u003e${image_bucket_url}\u003c/span\u003e/kernels/vmlinux.bin\"\u003c/span\u003e\n    rootfs=\u003cspan class=\"hljs-string\"\u003e\"\u003cspan class=\"hljs-variable\"\u003e${image_bucket_url}\u003c/span\u003e/rootfs/bionic.rootfs.ext4\"\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e\n    \u003cspan class=\"hljs-built_in\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"Cannot run firecracker on \u003cspan class=\"hljs-variable\"\u003e$arch\u003c/span\u003e architecture!\"\u003c/span\u003e\n    \u003cspan class=\"hljs-built_in\"\u003eexit\u003c/span\u003e 1\n\u003cspan class=\"hljs-keyword\"\u003efi\u003c/span\u003e\n\n\u003cspan class=\"hljs-built_in\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"Downloading \u003cspan class=\"hljs-variable\"\u003e$kernel\u003c/span\u003e...\"\u003c/span\u003e\ncurl -fsSL -o \u003cspan class=\"hljs-variable\"\u003e$dest_kernel\u003c/span\u003e \u003cspan class=\"hljs-variable\"\u003e$kernel\u003c/span\u003e\n\n\u003cspan class=\"hljs-built_in\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"Downloading \u003cspan class=\"hljs-variable\"\u003e$rootfs\u003c/span\u003e...\"\u003c/span\u003e\ncurl -fsSL -o \u003cspan class=\"hljs-variable\"\u003e$dest_rootfs\u003c/span\u003e \u003cspan class=\"hljs-variable\"\u003e$rootfs\u003c/span\u003e\n\n\u003cspan class=\"hljs-built_in\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"Saved kernel file to \u003cspan class=\"hljs-variable\"\u003e$dest_kernel\u003c/span\u003e and root block device to \u003cspan class=\"hljs-variable\"\u003e$dest_rootfs\u003c/span\u003e.\"\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment\"\u003e# Start firecracker\u003c/span\u003e\n\u003cspan class=\"hljs-built_in\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"Starting firecracker\"\u003c/span\u003e\nfirecracker --api-sock /tmp/firecracker.socket \u0026#x26;\nfirecracker_pid=$!\n\n\u003cspan class=\"hljs-comment\"\u003e# Set the guest kernel and rootfs\u003c/span\u003e\nrch=`\u003cspan class=\"hljs-built_in\"\u003euname\u003c/span\u003e -m`\nkernel_path=$(\u003cspan class=\"hljs-built_in\"\u003epwd\u003c/span\u003e)\u003cspan class=\"hljs-string\"\u003e\"/hello-vmlinux.bin\"\u003c/span\u003e\n\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e [ \u003cspan class=\"hljs-variable\"\u003e${arch}\u003c/span\u003e = \u003cspan class=\"hljs-string\"\u003e\"x86_64\"\u003c/span\u003e ]; \u003cspan class=\"hljs-keyword\"\u003ethen\u003c/span\u003e\n    curl --unix-socket /tmp/firecracker.socket -i \\\n      -X PUT \u003cspan class=\"hljs-string\"\u003e'http://localhost/boot-source'\u003c/span\u003e   \\\n      -H \u003cspan class=\"hljs-string\"\u003e'Accept: application/json'\u003c/span\u003e           \\\n      -H \u003cspan class=\"hljs-string\"\u003e'Content-Type: application/json'\u003c/span\u003e     \\\n      -d \u003cspan class=\"hljs-string\"\u003e\"{\n            \\\"kernel_image_path\\\": \\\"\u003cspan class=\"hljs-variable\"\u003e${kernel_path}\u003c/span\u003e\\\",\n            \\\"boot_args\\\": \\\"console=ttyS0 reboot=k panic=1 pci=off\\\"\n       }\"\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eelif\u003c/span\u003e [ \u003cspan class=\"hljs-variable\"\u003e${arch}\u003c/span\u003e = \u003cspan class=\"hljs-string\"\u003e\"aarch64\"\u003c/span\u003e ]; \u003cspan class=\"hljs-keyword\"\u003ethen\u003c/span\u003e\n    curl --unix-socket /tmp/firecracker.socket -i \\\n      -X PUT \u003cspan class=\"hljs-string\"\u003e'http://localhost/boot-source'\u003c/span\u003e   \\\n      -H \u003cspan class=\"hljs-string\"\u003e'Accept: application/json'\u003c/span\u003e           \\\n      -H \u003cspan class=\"hljs-string\"\u003e'Content-Type: application/json'\u003c/span\u003e     \\\n      -d \u003cspan class=\"hljs-string\"\u003e\"{\n            \\\"kernel_image_path\\\": \\\"\u003cspan class=\"hljs-variable\"\u003e${kernel_path}\u003c/span\u003e\\\",\n            \\\"boot_args\\\": \\\"keep_bootcon console=ttyS0 reboot=k panic=1 pci=off\\\"\n       }\"\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e\n    \u003cspan class=\"hljs-built_in\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"Cannot run firecracker on \u003cspan class=\"hljs-variable\"\u003e$arch\u003c/span\u003e architecture!\"\u003c/span\u003e\n    \u003cspan class=\"hljs-built_in\"\u003eexit\u003c/span\u003e 1\n\u003cspan class=\"hljs-keyword\"\u003efi\u003c/span\u003e\n\nrootfs_path=$(\u003cspan class=\"hljs-built_in\"\u003epwd\u003c/span\u003e)\u003cspan class=\"hljs-string\"\u003e\"/hello-rootfs.ext4\"\u003c/span\u003e\ncurl --unix-socket /tmp/firecracker.socket -i \\\n  -X PUT \u003cspan class=\"hljs-string\"\u003e'http://localhost/drives/rootfs'\u003c/span\u003e \\\n  -H \u003cspan class=\"hljs-string\"\u003e'Accept: application/json'\u003c/span\u003e           \\\n  -H \u003cspan class=\"hljs-string\"\u003e'Content-Type: application/json'\u003c/span\u003e     \\\n  -d \u003cspan class=\"hljs-string\"\u003e\"{\n        \\\"drive_id\\\": \\\"rootfs\\\",\n        \\\"path_on_host\\\": \\\"\u003cspan class=\"hljs-variable\"\u003e${rootfs_path}\u003c/span\u003e\\\",\n        \\\"is_root_device\\\": true,\n        \\\"is_read_only\\\": false\n   }\"\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment\"\u003e# Start the guest machine\u003c/span\u003e\ncurl --unix-socket /tmp/firecracker.socket -i \\\n  -X PUT \u003cspan class=\"hljs-string\"\u003e'http://localhost/actions'\u003c/span\u003e       \\\n  -H  \u003cspan class=\"hljs-string\"\u003e'Accept: application/json'\u003c/span\u003e          \\\n  -H  \u003cspan class=\"hljs-string\"\u003e'Content-Type: application/json'\u003c/span\u003e    \\\n  -d \u003cspan class=\"hljs-string\"\u003e'{\n      \"action_type\": \"InstanceStart\"\n   }'\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment\"\u003e# Kill the firecracker process to exit the workflow\u003c/span\u003e\n\u003cspan class=\"hljs-built_in\"\u003esleep\u003c/span\u003e 20\n\u003cspan class=\"hljs-built_in\"\u003ekill\u003c/span\u003e -9 \u003cspan class=\"hljs-variable\"\u003e$firecracker_pid\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe full example can be found on \u003ca href=\"https://github.com/skatolo/nested-firecracker\"\u003eGitHub\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eIf you'd like to know more about how Firecracker works and how it compares to traditional VMs and Docker you can watch Alex's webinar on the topic.\u003c/p\u003e\n\u003ciframe width=\"560\" height=\"315\" src=\"https://www.youtube-nocookie.com/embed/CYCsa5e2vqg\" title=\"YouTube video player\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share\" allowfullscreen\u003e\u003c/iframe\u003e\n\u003cblockquote\u003e\n\u003cp\u003eJoin Alex and Richard Case for a cracking time. The pair share what's got them so excited about Firecracker, the kinds of use-cases they see for microVMs, fundamentals of Linux Operating Systems and plenty of demos.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch3\u003eNixOS integration tests\u003c/h3\u003e\n\u003cp\u003eWith nix there is the ability to provide a set of declarative configuration to define integration tests that spin up virtual machines using \u003ca href=\"https://www.qemu.org/\"\u003eQEMU\u003c/a\u003e as the backend. While running these tests in CI without hardware acceleration is supported this is considerably slower.\u003c/p\u003e\n\u003cp\u003eFor a more detailed overview of the test setup and configuration see the original tutorial on nix.dev:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://nix.dev/tutorials/nixos/build-and-deploy/integration-testing-using-virtual-machines\"\u003eIntegration testing using virtual machines (VMs)\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThe workflow file for running NixOS tests on  GitHub Actions:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003enixos-tests\u003c/span\u003e\n\n\u003cspan class=\"hljs-attr\"\u003eon:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003epush\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003ejobs:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003enixos-test:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003eruns-on:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eactuated\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003esteps:\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eactions/checkout@master\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003ewith:\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003efetch-depth:\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eactions/setup-python@v3\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003ewith:\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003epython-version:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'3.x'\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ecachix/install-nix-action@v16\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003ewith:\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003eextra_nix_config:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"system-features = nixos-test benchmark big-parallel kvm\"\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eNixOS\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003etest\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003erun:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003enix\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ebuild\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e-L\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e.#checks.x86_64-linux.postgres\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWe just install Nix using the \u003ca href=\"https://github.com/cachix/install-nix-action\"\u003einstall-nix-action\u003c/a\u003e and run the tests in the next step.\u003c/p\u003e\n\u003cp\u003eThe full example is available on \u003ca href=\"https://github.com/skatolo/gh-actions-nixos-tests\"\u003eGitHub\u003c/a\u003e\u003c/p\u003e\n\u003ch3\u003eOther examples of using a VM\u003c/h3\u003e\n\u003cp\u003eIn the previous section we showed you some brief examples for the kind of workflows you can run. Here are some other resources and tutorials that should be easy to adapt and run in CI.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eCreate KVM virtual machine images with the \u003ca href=\"https://developer.hashicorp.com/packer/plugins/builders/qemu\"\u003ePacker QEMU Builder\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eLaunching an Ubuntu cloud image with cloud-init: \u003ca href=\"https://fabianlee.org/2020/02/23/kvm-testing-cloud-init-locally-using-kvm-for-an-ubuntu-cloud-image/\"\u003eKVM: Testing cloud-init locally using KVM for an Ubuntu cloud image\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eConclusion\u003c/h2\u003e\n\u003cp\u003eHosted runners do not support nested virtualization. That makes them unsuitable for running CI jobs that require KVM support.\u003c/p\u003e\n\u003cp\u003eFor Actuated runners we provide a custom Kernel that enables KVM support. This will allow you to run Virtual Machines within your CI jobs.\u003c/p\u003e\n\u003cp\u003eAt time of writing there is no support for aarch64 runners. Only Intel and AMD CPUs support nested virtualisation.\u003c/p\u003e\n\u003cp\u003eWhile it is possible to deploy your own self-hosted runners to run jobs that need KVM support, this is not recommended:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"/blog/is-the-self-hosted-runner-safe-github-actions\"\u003eIs the GitHub Actions self-hosted runner safe for Open Source?\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eWant to see a demo or talk to our team? \u003ca href=\"https://forms.gle/8XmpTTWXbZwWkfqT6\"\u003eContact us here\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eJust want to try it out instead? \u003ca href=\"/pricing\"\u003eRegister your GitHub Organisation and set-up a subscription\u003c/a\u003e\u003c/p\u003e","title":"How to run KVM guests in your GitHub Actions","description":"From building cloud images, to running NixOS tests and the android emulator, we look at how and why you'd want to run a VM in GitHub Actions.","author":"Han Verstraete","tags":["virtualization","kvm","githubactions","nestedvirt","cicd"],"author_img":"welteki","image":"/images/2023-02-17-kvm-in-github-actions/nested-firecracker.png","date":"2023-02-17"}},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"kvm-in-github-actions"},"buildId":"qP6XrePfh_ktdNhbSnok_","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>