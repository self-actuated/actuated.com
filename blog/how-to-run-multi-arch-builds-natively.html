<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="theme-color" content="#000000"/><meta name="author" content="OpenFaaS Ltd"/><meta name="twitter:card" content="summary_large_image"/><title>How to split up multi-arch Docker builds to run natively</title><meta name="description" content="QEMU is a convenient way to publish containers for multiple architectures, but it can be incredibly slow. Native is much faster."/><meta property="twitter:title" content="How to split up multi-arch Docker builds to run natively"/><meta property="twitter:description" content="QEMU is a convenient way to publish containers for multiple architectures, but it can be incredibly slow. Native is much faster."/><meta property="og:title" content="How to split up multi-arch Docker builds to run natively"/><meta property="og:description" content="QEMU is a convenient way to publish containers for multiple architectures, but it can be incredibly slow. Native is much faster."/><meta name="twitter:image:src" content="https://actuated.dev/images/2023-split-native/background.jpg"/><meta property="og:image" content="https://actuated.dev/images/2023-split-native/background.jpg"/><meta name="next-head-count" content="13"/><meta charSet="utf-8"/><link rel="icon" type="image/png" href="/images/actuated.png"/><link rel="stylesheet" href="https://rsms.me/inter/inter.css"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css"/><link rel="manifest" href="/manifest.json"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-M5YNDNX7VT"></script><script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'G-M5YNDNX7VT');
          </script><link rel="apple-touch-icon" href="/images/actuated.png"/><link rel="preload" href="/_next/static/css/af91c5ff992635f2.css" as="style"/><link rel="stylesheet" href="/_next/static/css/af91c5ff992635f2.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-8fa1640cc84ba8fe.js" defer=""></script><script src="/_next/static/chunks/framework-114634acb84f8baa.js" defer=""></script><script src="/_next/static/chunks/main-34e2100d07ae5757.js" defer=""></script><script src="/_next/static/chunks/pages/_app-a8c1061b210f7f21.js" defer=""></script><script src="/_next/static/chunks/552-542f150c917a7625.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bslug%5D-109b0d2eddac75b5.js" defer=""></script><script src="/_next/static/6SqFQR6vKMqgSah7Piaor/_buildManifest.js" defer=""></script><script src="/_next/static/6SqFQR6vKMqgSah7Piaor/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="bg-white"><header><div class="relative bg-white" data-headlessui-state=""><div class="mx-auto flex max-w-7xl items-center justify-between px-4 py-6 sm:px-6 md:justify-start md:space-x-10 lg:px-8"><div class="flex justify-start lg:w-0 lg:flex-1"><a href="/"><span class="sr-only">Actuated</span><img class="h-8 w-auto sm:h-10" src="/images/actuated.png" alt="Actuated logo"/></a></div><div class="-my-2 -mr-2 md:hidden"><button class="inline-flex items-center justify-center rounded-md bg-white p-2 text-gray-400 hover:bg-gray-100 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500" type="button" aria-expanded="false" data-headlessui-state=""><span class="sr-only">Open menu</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" class="h-6 w-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"></path></svg></button></div><nav class="hidden space-x-10 md:flex"><div class="relative" data-headlessui-state=""><button class="text-gray-500 group inline-flex items-center rounded-md bg-white text-base font-medium hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" type="button" aria-expanded="false" data-headlessui-state=""><span>Solutions</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="text-gray-400 ml-2 h-5 w-5 group-hover:text-gray-500"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"></path></svg></button></div><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/blog">Blog</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="https://actuated.dev/blog/blazing-fast-ci-with-microvms">Announcement</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="https://docs.actuated.dev/">Docs</a></nav><div class="hidden items-center justify-end md:flex md:flex-1 lg:w-0"><a href="https://dashboard.actuated.dev" class="whitespace-nowrap text-base font-medium text-gray-500 hover:text-gray-900">Sign in</a><a href="https://docs.google.com/forms/d/e/1FAIpQLScA12IGyVFrZtSAp2Oj24OdaSMloqARSwoxx3AZbQbs0wpGww/viewform" class="ml-8 inline-flex items-center justify-center whitespace-nowrap rounded-md border border-transparent bg-indigo-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-indigo-700">Sign-up</a></div></div></div></header><main><div class="container mx-auto max-w-4xl bg-white mt-4 px-4 sm:px-6"><h1 id="post_title" class="text-3xl mb-3 leading-8 font-extrabold tracking-tight text-gray-900 sm:text-4xl sm:leading-10 text-center">How to split up multi-arch Docker builds to run natively</h1></div><div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-4xl"><div class="border-b border-gray-200 py-4 flex items-center text-gray-500 mx-auto"><div><img class="h-10 w-10 rounded-full" src="/images/alex.jpg" alt=""/></div><div class="ml-3"><p id="post_author" class="text-sm leading-5 font-medium text-gray-900">Alex Ellis</p><div class="flex text-sm leading-5 text-gray-500"><time dateTime="2023-03-24" id="post_date">March 24, 2023</time><span class="mx-1"></span></div></div></div><div class="mt-6 prose sm:prose-lg max-w-none"><p id="post_description" class="mb-4">QEMU is a convenient way to publish containers for multiple architectures, but it can be incredibly slow. Native is much faster.</p></div><div id="post_content" class="mt-6 prose sm:prose-lg max-w-none"><p>In two previous articles, we covered huge improvements in performance for the Parca project and VPP (Network Service Mesh) simply by switching to actuated with Arm64 runners instead of using QEMU and hosted runners.</p>
<p>In the <a href="http://actuated.dev/blog/native-arm64-for-github-actions">first case</a>, using QEMU took over 33 minutes, and bare-metal Arm showed a 22x improvement at only 1 minute 26 seconds. For Network Service Mesh, <a href="http://actuated.dev/blog/case-study-bring-your-own-bare-metal-to-actions">VPP</a> couldn't even complete a build in 6 hours using QEMU - and I got it down to 9 minutes flat using a bare-metal <a href="https://amperecomputing.com/processors/ampere-altra">Ampere Altra server</a>.</p>
<h2>What are we going to see and why is it better?</h2>
<p>In this article, I'll show you how to run multi-arch builds natively on bare-metal hardware using GitHub Actions and actuated.</p>
<p><a href="https://actuated.dev/">Actuated</a> is a SaaS service that we built so that you can Bring Your Own compute to GitHub Actions, and have every build run in an immutable, single-use VM.</p>
<p><a href="https://twitter.com/alexellisuk/status/1639232258887372801?s=20"><img src="https://pbs.twimg.com/media/Fr_CcVJWIAEY1gL?format=png&#x26;name=medium" alt="Comparison of the two builds"></a></p>
<blockquote>
<p>Comparison of splitting out to run in parallel on native hardware and QEMU.</p>
</blockquote>
<p>Not every build will see such a dramatic increase as the ones I mentioned in the introduction. Here, with the inlets-operator, we gained 4 minutes on each commit. But I often speak to users who are running past 30 minutes to over an hour because of QEMU.</p>
<p>Three things got us a speed bump here:</p>
<ul>
<li>We ran on bare-metal, native hardware - not the standard hosted runner from GitHub</li>
<li>We split up the work and ran in parallel - rather than waiting for two builds to run in serial</li>
<li>Finally, we did away with QEMU and ran the Arm build directly on an Arm server</li>
</ul>
<p>Only last week an engineer at Calyptia (the team behind <a href="https://fluentbit.io/">fluent-bit</a>) reached out for help after telling me they had to disable and stop publishing open source images for Arm, it was simply timing out at the 6 hour mark.</p>
<p>So how does this thing work, and is QEMU actually "OK"?</p>
<h2>QEMU can be slow, but it's actually "OK"</h2>
<p>So if the timings are so bad, why does anyone use QEMU?</p>
<p>Well it's free - as in beer, there's no cost at all to use it. And many builds can complete in a reasonable amount of time using QEMU, even if it's not as fast as native.</p>
<p>That's why we wrote up how we build 80+ multi-arch images for various products like OpenFaaS and Inlets:</p>
<p><a href="https://actuated.dev/blog/multi-arch-docker-github-actions">The efficient way to publish multi-arch containers from GitHub Actions</a></p>
<p>Here's what the build looks like with QEMU:</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">split-operator</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span> [ <span class="hljs-string">master</span>, <span class="hljs-string">qemu</span> ]

<span class="hljs-attr">jobs:</span>

  <span class="hljs-attr">publish_qemu:</span>
    <span class="hljs-attr">concurrency:</span> 
      <span class="hljs-attr">group:</span> <span class="hljs-string">${{</span> <span class="hljs-string">github.ref</span> <span class="hljs-string">}}-qemu</span>
      <span class="hljs-attr">cancel-in-progress:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">permissions:</span>
      <span class="hljs-attr">packages:</span> <span class="hljs-string">write</span>

    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@master</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">repository:</span> <span class="hljs-string">inlets/inlets-operator</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">"./"</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Get</span> <span class="hljs-string">Repo</span> <span class="hljs-string">Owner</span>
        <span class="hljs-attr">id:</span> <span class="hljs-string">get_repo_owner</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">echo</span> <span class="hljs-string">"REPO_OWNER=$(echo $<span class="hljs-template-variable">{{ github.repository_owner }}</span> | tr '[:upper:]' '[:lower:]')"</span> <span class="hljs-string">></span> <span class="hljs-string">$GITHUB_ENV</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Set</span> <span class="hljs-string">up</span> <span class="hljs-string">QEMU</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">docker/setup-qemu-action@v2</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Set</span> <span class="hljs-string">up</span> <span class="hljs-string">Docker</span> <span class="hljs-string">Buildx</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">docker/setup-buildx-action@v2</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Login</span> <span class="hljs-string">to</span> <span class="hljs-string">container</span> <span class="hljs-string">Registry</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">docker/login-action@v2</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">username:</span> <span class="hljs-string">${{</span> <span class="hljs-string">github.repository_owner</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">password:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.GITHUB_TOKEN</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">registry:</span> <span class="hljs-string">ghcr.io</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Release</span> <span class="hljs-string">build</span>
        <span class="hljs-attr">id:</span> <span class="hljs-string">release_build</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">docker/build-push-action@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">outputs:</span> <span class="hljs-string">"type=registry,push=true"</span>
          <span class="hljs-attr">platforms:</span> <span class="hljs-string">linux/amd64,linux/arm64</span>
          <span class="hljs-attr">file:</span> <span class="hljs-string">./Dockerfile</span>
          <span class="hljs-attr">context:</span> <span class="hljs-string">.</span>
          <span class="hljs-attr">build-args:</span> <span class="hljs-string">|
            Version=dev
            GitCommit=${{ github.sha }}
</span>          <span class="hljs-attr">tags:</span> <span class="hljs-string">|
            ghcr.io/${{ env.REPO_OWNER }}/inlets-operator:${{ github.sha }}-qemu
</span></code></pre>
<p>This is the kind of build that is failing or causing serious delays for projects like Parca, VPP and Fluent Bit.</p>
<p>Let's look at the alternative.</p>
<h2>Building on native hardware</h2>
<p>Whilst QEMU emulates the architecture you need within a build, it's not the same as running on the real hardware. This is why we see such a big difference in performance.</p>
<p>The downside is that we have to write a bit more CI configuration and run two builds instead of one, but there is some good news - we can now run them in parallel.</p>
<p>In parallel we:</p>
<ol>
<li>We publish the x86_64 image - <code>ghcr.io/owner/repo:sha-amd64</code></li>
<li>We publish the ARM image - <code>ghcr.io/owner/repo:sha-arm64</code></li>
</ol>
<p>Then:</p>
<ol start="3">
<li>We create a manifest with its own name - <code>ghcr.io/owner/repo:sha</code></li>
<li>We annotate the manifest with the images we built earlier</li>
<li>We push the manifest</li>
</ol>
<p>In this way, anyone can pull the image with the name <code>ghcr.io/owner/repo:sha</code> and it will map to either of the two images for Arm64 or Amd64.</p>
<p><img src="/images/2023-split-native/parallel.jpg" alt="Parallel execution"></p>
<blockquote>
<p>The two builds on the left ran on two separate bare-metal hosts, and the manifest was published using one of GitHub's hosted runners.</p>
</blockquote>
<p>Here's a sample for the inlets-operator, a Go binary which connects to the Kubernetes API.</p>
<p>First up, we have the x86 build:</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">split-operator</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span> [ <span class="hljs-string">master</span> ]

<span class="hljs-attr">jobs:</span>

  <span class="hljs-attr">publish_x86:</span>
    <span class="hljs-attr">concurrency:</span> 
      <span class="hljs-attr">group:</span> <span class="hljs-string">${{</span> <span class="hljs-string">github.ref</span> <span class="hljs-string">}}-x86</span>
      <span class="hljs-attr">cancel-in-progress:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">permissions:</span>
      <span class="hljs-attr">packages:</span> <span class="hljs-string">write</span>

    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">actuated</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@master</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">repository:</span> <span class="hljs-string">inlets/inlets-operator</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">"./"</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">mirror</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">self-actuated/hub-mirror@master</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Get</span> <span class="hljs-string">Repo</span> <span class="hljs-string">Owner</span>
        <span class="hljs-attr">id:</span> <span class="hljs-string">get_repo_owner</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">echo</span> <span class="hljs-string">"REPO_OWNER=$(echo $<span class="hljs-template-variable">{{ github.repository_owner }}</span> | tr '[:upper:]' '[:lower:]')"</span> <span class="hljs-string">></span> <span class="hljs-string">$GITHUB_ENV</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Set</span> <span class="hljs-string">up</span> <span class="hljs-string">Docker</span> <span class="hljs-string">Buildx</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">docker/setup-buildx-action@v2</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Login</span> <span class="hljs-string">to</span> <span class="hljs-string">container</span> <span class="hljs-string">Registry</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">docker/login-action@v2</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">username:</span> <span class="hljs-string">${{</span> <span class="hljs-string">github.repository_owner</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">password:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.GITHUB_TOKEN</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">registry:</span> <span class="hljs-string">ghcr.io</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Release</span> <span class="hljs-string">build</span>
        <span class="hljs-attr">id:</span> <span class="hljs-string">release_build</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">docker/build-push-action@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">outputs:</span> <span class="hljs-string">"type=registry,push=true"</span>
          <span class="hljs-attr">platforms:</span> <span class="hljs-string">linux/amd64</span>
          <span class="hljs-attr">file:</span> <span class="hljs-string">./Dockerfile</span>
          <span class="hljs-attr">context:</span> <span class="hljs-string">.</span>
          <span class="hljs-attr">build-args:</span> <span class="hljs-string">|
            Version=dev
            GitCommit=${{ github.sha }}
</span>          <span class="hljs-attr">tags:</span> <span class="hljs-string">|
            ghcr.io/${{ env.REPO_OWNER }}/inlets-operator:${{ github.sha }}-amd64
</span></code></pre>
<p>Then we have the arm64 build which is almost identical, but we specify a different value for <code>platforms</code> and the <code>runs-on</code> field.</p>
<pre><code class="hljs language-yaml">
  <span class="hljs-attr">publish_aarch64:</span>
    <span class="hljs-attr">concurrency:</span> 
      <span class="hljs-attr">group:</span> <span class="hljs-string">${{</span> <span class="hljs-string">github.ref</span> <span class="hljs-string">}}-aarch64</span>
      <span class="hljs-attr">cancel-in-progress:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">permissions:</span>
      <span class="hljs-attr">packages:</span> <span class="hljs-string">write</span>

    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">actuated-aarch64</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@master</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">repository:</span> <span class="hljs-string">inlets/inlets-operator</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">"./"</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">mirror</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">self-actuated/hub-mirror@master</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Get</span> <span class="hljs-string">Repo</span> <span class="hljs-string">Owner</span>
        <span class="hljs-attr">id:</span> <span class="hljs-string">get_repo_owner</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">echo</span> <span class="hljs-string">"REPO_OWNER=$(echo $<span class="hljs-template-variable">{{ github.repository_owner }}</span> | tr '[:upper:]' '[:lower:]')"</span> <span class="hljs-string">></span> <span class="hljs-string">$GITHUB_ENV</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Set</span> <span class="hljs-string">up</span> <span class="hljs-string">Docker</span> <span class="hljs-string">Buildx</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">docker/setup-buildx-action@v2</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Login</span> <span class="hljs-string">to</span> <span class="hljs-string">container</span> <span class="hljs-string">Registry</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">docker/login-action@v2</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">username:</span> <span class="hljs-string">${{</span> <span class="hljs-string">github.repository_owner</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">password:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.GITHUB_TOKEN</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">registry:</span> <span class="hljs-string">ghcr.io</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Release</span> <span class="hljs-string">build</span>
        <span class="hljs-attr">id:</span> <span class="hljs-string">release_build</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">docker/build-push-action@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">outputs:</span> <span class="hljs-string">"type=registry,push=true"</span>
          <span class="hljs-attr">platforms:</span> <span class="hljs-string">linux/arm64</span>
          <span class="hljs-attr">file:</span> <span class="hljs-string">./Dockerfile</span>
          <span class="hljs-attr">context:</span> <span class="hljs-string">.</span>
          <span class="hljs-attr">build-args:</span> <span class="hljs-string">|
            Version=dev
            GitCommit=${{ github.sha }}
</span>          <span class="hljs-attr">tags:</span> <span class="hljs-string">|
            ghcr.io/${{ env.REPO_OWNER }}/inlets-operator:${{ github.sha }}-aarch64
</span></code></pre>
<p>Finally, we need to create the manifest. GitHub Actions has a <code>needs</code> variable that we can set to control the execution order:</p>
<pre><code class="hljs language-yaml">  <span class="hljs-attr">publish_manifest:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">needs:</span> [<span class="hljs-string">publish_x86</span>, <span class="hljs-string">publish_aarch64</span>]
    <span class="hljs-attr">steps:</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Get</span> <span class="hljs-string">Repo</span> <span class="hljs-string">Owner</span>
      <span class="hljs-attr">id:</span> <span class="hljs-string">get_repo_owner</span>
      <span class="hljs-attr">run:</span> <span class="hljs-string">echo</span> <span class="hljs-string">"REPO_OWNER=$(echo $<span class="hljs-template-variable">{{ github.repository_owner }}</span> | tr '[:upper:]' '[:lower:]')"</span> <span class="hljs-string">></span> <span class="hljs-string">$GITHUB_ENV</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Login</span> <span class="hljs-string">to</span> <span class="hljs-string">container</span> <span class="hljs-string">Registry</span>
      <span class="hljs-attr">uses:</span> <span class="hljs-string">docker/login-action@v2</span>
      <span class="hljs-attr">with:</span>
        <span class="hljs-attr">username:</span> <span class="hljs-string">${{</span> <span class="hljs-string">github.repository_owner</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">password:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.GITHUB_TOKEN</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">registry:</span> <span class="hljs-string">ghcr.io</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Create</span> <span class="hljs-string">manifest</span>
      <span class="hljs-attr">run:</span> <span class="hljs-string">|
        docker manifest create ghcr.io/${{ env.REPO_OWNER }}/inlets-operator:${{ github.sha }} \
          --amend ghcr.io/${{ env.REPO_OWNER }}/inlets-operator:${{ github.sha }}-amd64 \
          --amend ghcr.io/${{ env.REPO_OWNER }}/inlets-operator:${{ github.sha }}-aarch64
        docker manifest annotate --arch amd64 --os linux ghcr.io/${{ env.REPO_OWNER }}/inlets-operator:${{ github.sha }} ghcr.io/${{ env.REPO_OWNER }}/inlets-operator:${{ github.sha }}-amd64
        docker manifest annotate --arch arm64 --os linux ghcr.io/${{ env.REPO_OWNER }}/inlets-operator:${{ github.sha }} ghcr.io/${{ env.REPO_OWNER }}/inlets-operator:${{ github.sha }}-aarch64
        docker manifest inspect ghcr.io/${{ env.REPO_OWNER }}/inlets-operator:${{ github.sha }}
</span>
        <span class="hljs-string">docker</span> <span class="hljs-string">manifest</span> <span class="hljs-string">push</span> <span class="hljs-string">ghcr.io/${{</span> <span class="hljs-string">env.REPO_OWNER</span> <span class="hljs-string">}}/inlets-operator:${{</span> <span class="hljs-string">github.sha</span> <span class="hljs-string">}}</span>
</code></pre>
<p>One thing I really dislike about this final stage is how much repetition we get. Fortunately, it's relatively simple to hide this complexity behind a custom GitHub Action.</p>
<p>Note that this is just an example at the moment, but I could make a custom composite action in Bash in about 30 minutes, including testing. So it's not a lot of work and it would make our whole workflow a lot less repetitive.</p>
<pre><code class="hljs language-yaml">   <span class="hljs-attr">uses:</span> <span class="hljs-string">self-actuated/compile-manifest@master</span>
    <span class="hljs-attr">with:</span>
      <span class="hljs-attr">image:</span> <span class="hljs-string">ghcr.io/${{</span> <span class="hljs-string">env.REPO_OWNER</span> <span class="hljs-string">}}/inlets-operator</span>
      <span class="hljs-attr">sha:</span> <span class="hljs-string">${{</span> <span class="hljs-string">github.sha</span> <span class="hljs-string">}}</span>
      <span class="hljs-attr">platforms:</span> <span class="hljs-string">amd64,arm64</span>
</code></pre>
<h2>Wrapping up</h2>
<p>Yesterday we took a new customer on for actuated who wanted to improve the speed of Arm builds, but on the call we both knew they would need to leave QEMU behind. I put this write-up together to show what would be involved, and I hope it's useful to you.</p>
<p>Where can you run these builds?</p>
<p>Couldn't you just add a low-cost Arm VM from AWS, Oracle Cloud, Azure or Google Cloud?</p>
<p>The answer unfortunately is no.</p>
<p>The self-hosted runner is not suitable for open source / public repositories, the GitHub documentation has a stark warning about this.</p>
<p>The Kubernetes controller that's available has the same issues, because it re-uses the Pods by default, and runs in a dangerous Docker In Docker Mode as a privileged container or by mounting the Docker Socket. I'm not sure which is worse, but both mean that code in CI can take over the host, potentially even the whole cluster.</p>
<p>Hosted runners solve this by creating a fresh VM per job, and destroying it immediately. That's the same approach that we took with actuated, but you get to bring your own metal along, so that you keep costs from growing out of control. Actuated also supports Arm, out of the box.</p>
<p>Want to know more about the security of self-hosted runners? <a href="https://docs.actuated.dev/faq/">Read more in our FAQ</a>.</p>
<p>Want to talk to us about your CI/CD needs? We're happy to help.</p>
<ul>
<li><a href="https://docs.actuated.dev/register/#sign-up-for-the-pilot">Contact us about a PoC</a></li>
</ul></div></div></main><footer class="bg-white"><div class="mx-auto max-w-7xl py-12 px-4 sm:px-6 md:flex md:items-center md:justify-between lg:px-8"><div class="flex justify-center space-x-6 md:order-2"><a class="text-gray-400 hover:text-gray-500" href="https://twitter.com/selfactuated"><span class="sr-only">Twitter</span><svg fill="currentColor" viewBox="0 0 24 24" class="h-6 w-6" aria-hidden="true"><path d="M8.29 20.251c7.547 0 11.675-6.253 11.675-11.675 0-.178 0-.355-.012-.53A8.348 8.348 0 0022 5.92a8.19 8.19 0 01-2.357.646 4.118 4.118 0 001.804-2.27 8.224 8.224 0 01-2.605.996 4.107 4.107 0 00-6.993 3.743 11.65 11.65 0 01-8.457-4.287 4.106 4.106 0 001.27 5.477A4.072 4.072 0 012.8 9.713v.052a4.105 4.105 0 003.292 4.022 4.095 4.095 0 01-1.853.07 4.108 4.108 0 003.834 2.85A8.233 8.233 0 012 18.407a11.616 11.616 0 006.29 1.84"></path></svg></a><a class="text-gray-400 hover:text-gray-500" href="https://github.com/self-actuated"><span class="sr-only">GitHub</span><svg fill="currentColor" viewBox="0 0 24 24" class="h-6 w-6" aria-hidden="true"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"></path></svg></a><a class="text-gray-400 hover:text-gray-500" href="/rss.xml"><span class="sr-only">RSS</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M12.75 19.5v-.75a7.5 7.5 0 00-7.5-7.5H4.5m0-6.75h.75c7.87 0 14.25 6.38 14.25 14.25v.75M6 18.75a.75.75 0 11-1.5 0 .75.75 0 011.5 0z"></path></svg></a></div><div class="mt-8 md:order-1 md:mt-0"><p class="text-center text-base text-gray-400">Â© 2022 <a href="https://openfaas.com">OpenFaaS Ltd</a>, Inc. All rights reserved.</p></div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"how-to-run-multi-arch-builds-natively","fileName":"2023-03-24-how-to-run-multi-arch-builds-natively.md","contentHtml":"\u003cp\u003eIn two previous articles, we covered huge improvements in performance for the Parca project and VPP (Network Service Mesh) simply by switching to actuated with Arm64 runners instead of using QEMU and hosted runners.\u003c/p\u003e\n\u003cp\u003eIn the \u003ca href=\"http://actuated.dev/blog/native-arm64-for-github-actions\"\u003efirst case\u003c/a\u003e, using QEMU took over 33 minutes, and bare-metal Arm showed a 22x improvement at only 1 minute 26 seconds. For Network Service Mesh, \u003ca href=\"http://actuated.dev/blog/case-study-bring-your-own-bare-metal-to-actions\"\u003eVPP\u003c/a\u003e couldn't even complete a build in 6 hours using QEMU - and I got it down to 9 minutes flat using a bare-metal \u003ca href=\"https://amperecomputing.com/processors/ampere-altra\"\u003eAmpere Altra server\u003c/a\u003e.\u003c/p\u003e\n\u003ch2\u003eWhat are we going to see and why is it better?\u003c/h2\u003e\n\u003cp\u003eIn this article, I'll show you how to run multi-arch builds natively on bare-metal hardware using GitHub Actions and actuated.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://actuated.dev/\"\u003eActuated\u003c/a\u003e is a SaaS service that we built so that you can Bring Your Own compute to GitHub Actions, and have every build run in an immutable, single-use VM.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://twitter.com/alexellisuk/status/1639232258887372801?s=20\"\u003e\u003cimg src=\"https://pbs.twimg.com/media/Fr_CcVJWIAEY1gL?format=png\u0026#x26;name=medium\" alt=\"Comparison of the two builds\"\u003e\u003c/a\u003e\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eComparison of splitting out to run in parallel on native hardware and QEMU.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eNot every build will see such a dramatic increase as the ones I mentioned in the introduction. Here, with the inlets-operator, we gained 4 minutes on each commit. But I often speak to users who are running past 30 minutes to over an hour because of QEMU.\u003c/p\u003e\n\u003cp\u003eThree things got us a speed bump here:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eWe ran on bare-metal, native hardware - not the standard hosted runner from GitHub\u003c/li\u003e\n\u003cli\u003eWe split up the work and ran in parallel - rather than waiting for two builds to run in serial\u003c/li\u003e\n\u003cli\u003eFinally, we did away with QEMU and ran the Arm build directly on an Arm server\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eOnly last week an engineer at Calyptia (the team behind \u003ca href=\"https://fluentbit.io/\"\u003efluent-bit\u003c/a\u003e) reached out for help after telling me they had to disable and stop publishing open source images for Arm, it was simply timing out at the 6 hour mark.\u003c/p\u003e\n\u003cp\u003eSo how does this thing work, and is QEMU actually \"OK\"?\u003c/p\u003e\n\u003ch2\u003eQEMU can be slow, but it's actually \"OK\"\u003c/h2\u003e\n\u003cp\u003eSo if the timings are so bad, why does anyone use QEMU?\u003c/p\u003e\n\u003cp\u003eWell it's free - as in beer, there's no cost at all to use it. And many builds can complete in a reasonable amount of time using QEMU, even if it's not as fast as native.\u003c/p\u003e\n\u003cp\u003eThat's why we wrote up how we build 80+ multi-arch images for various products like OpenFaaS and Inlets:\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://actuated.dev/blog/multi-arch-docker-github-actions\"\u003eThe efficient way to publish multi-arch containers from GitHub Actions\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eHere's what the build looks like with QEMU:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esplit-operator\u003c/span\u003e\n\n\u003cspan class=\"hljs-attr\"\u003eon:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003epush:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003ebranches:\u003c/span\u003e [ \u003cspan class=\"hljs-string\"\u003emaster\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003eqemu\u003c/span\u003e ]\n\n\u003cspan class=\"hljs-attr\"\u003ejobs:\u003c/span\u003e\n\n  \u003cspan class=\"hljs-attr\"\u003epublish_qemu:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003econcurrency:\u003c/span\u003e \n      \u003cspan class=\"hljs-attr\"\u003egroup:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003egithub.ref\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}-qemu\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003ecancel-in-progress:\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003epermissions:\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003epackages:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ewrite\u003c/span\u003e\n\n    \u003cspan class=\"hljs-attr\"\u003eruns-on:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eubuntu-latest\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003esteps:\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eactions/checkout@master\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003ewith:\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003erepository:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003einlets/inlets-operator\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003epath:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"./\"\u003c/span\u003e\n\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eGet\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eRepo\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eOwner\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003eid:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eget_repo_owner\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003erun:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"REPO_OWNER=$(echo $\u003cspan class=\"hljs-template-variable\"\u003e{{ github.repository_owner }}\u003c/span\u003e | tr '[:upper:]' '[:lower:]')\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e$GITHUB_ENV\u003c/span\u003e\n\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eSet\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eup\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eQEMU\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edocker/setup-qemu-action@v2\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eSet\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eup\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eDocker\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eBuildx\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edocker/setup-buildx-action@v2\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eLogin\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eto\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003econtainer\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eRegistry\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edocker/login-action@v2\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003ewith:\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003eusername:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003egithub.repository_owner\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003epassword:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esecrets.GITHUB_TOKEN\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003eregistry:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eghcr.io\u003c/span\u003e\n\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eRelease\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ebuild\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003eid:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003erelease_build\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edocker/build-push-action@v3\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003ewith:\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003eoutputs:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"type=registry,push=true\"\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003eplatforms:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003elinux/amd64,linux/arm64\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003efile:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e./Dockerfile\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003econtext:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e.\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003ebuild-args:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e|\n            Version=dev\n            GitCommit=${{ github.sha }}\n\u003c/span\u003e          \u003cspan class=\"hljs-attr\"\u003etags:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e|\n            ghcr.io/${{ env.REPO_OWNER }}/inlets-operator:${{ github.sha }}-qemu\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis is the kind of build that is failing or causing serious delays for projects like Parca, VPP and Fluent Bit.\u003c/p\u003e\n\u003cp\u003eLet's look at the alternative.\u003c/p\u003e\n\u003ch2\u003eBuilding on native hardware\u003c/h2\u003e\n\u003cp\u003eWhilst QEMU emulates the architecture you need within a build, it's not the same as running on the real hardware. This is why we see such a big difference in performance.\u003c/p\u003e\n\u003cp\u003eThe downside is that we have to write a bit more CI configuration and run two builds instead of one, but there is some good news - we can now run them in parallel.\u003c/p\u003e\n\u003cp\u003eIn parallel we:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eWe publish the x86_64 image - \u003ccode\u003eghcr.io/owner/repo:sha-amd64\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eWe publish the ARM image - \u003ccode\u003eghcr.io/owner/repo:sha-arm64\u003c/code\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eThen:\u003c/p\u003e\n\u003col start=\"3\"\u003e\n\u003cli\u003eWe create a manifest with its own name - \u003ccode\u003eghcr.io/owner/repo:sha\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eWe annotate the manifest with the images we built earlier\u003c/li\u003e\n\u003cli\u003eWe push the manifest\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eIn this way, anyone can pull the image with the name \u003ccode\u003eghcr.io/owner/repo:sha\u003c/code\u003e and it will map to either of the two images for Arm64 or Amd64.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/2023-split-native/parallel.jpg\" alt=\"Parallel execution\"\u003e\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eThe two builds on the left ran on two separate bare-metal hosts, and the manifest was published using one of GitHub's hosted runners.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eHere's a sample for the inlets-operator, a Go binary which connects to the Kubernetes API.\u003c/p\u003e\n\u003cp\u003eFirst up, we have the x86 build:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esplit-operator\u003c/span\u003e\n\n\u003cspan class=\"hljs-attr\"\u003eon:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003epush:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003ebranches:\u003c/span\u003e [ \u003cspan class=\"hljs-string\"\u003emaster\u003c/span\u003e ]\n\n\u003cspan class=\"hljs-attr\"\u003ejobs:\u003c/span\u003e\n\n  \u003cspan class=\"hljs-attr\"\u003epublish_x86:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003econcurrency:\u003c/span\u003e \n      \u003cspan class=\"hljs-attr\"\u003egroup:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003egithub.ref\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}-x86\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003ecancel-in-progress:\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003epermissions:\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003epackages:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ewrite\u003c/span\u003e\n\n    \u003cspan class=\"hljs-attr\"\u003eruns-on:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eactuated\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003esteps:\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eactions/checkout@master\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003ewith:\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003erepository:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003einlets/inlets-operator\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003epath:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"./\"\u003c/span\u003e\n\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eSetup\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003emirror\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eself-actuated/hub-mirror@master\u003c/span\u003e\n\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eGet\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eRepo\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eOwner\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003eid:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eget_repo_owner\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003erun:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"REPO_OWNER=$(echo $\u003cspan class=\"hljs-template-variable\"\u003e{{ github.repository_owner }}\u003c/span\u003e | tr '[:upper:]' '[:lower:]')\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e$GITHUB_ENV\u003c/span\u003e\n\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eSet\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eup\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eDocker\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eBuildx\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edocker/setup-buildx-action@v2\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eLogin\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eto\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003econtainer\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eRegistry\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edocker/login-action@v2\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003ewith:\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003eusername:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003egithub.repository_owner\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003epassword:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esecrets.GITHUB_TOKEN\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003eregistry:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eghcr.io\u003c/span\u003e\n\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eRelease\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ebuild\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003eid:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003erelease_build\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edocker/build-push-action@v3\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003ewith:\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003eoutputs:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"type=registry,push=true\"\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003eplatforms:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003elinux/amd64\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003efile:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e./Dockerfile\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003econtext:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e.\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003ebuild-args:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e|\n            Version=dev\n            GitCommit=${{ github.sha }}\n\u003c/span\u003e          \u003cspan class=\"hljs-attr\"\u003etags:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e|\n            ghcr.io/${{ env.REPO_OWNER }}/inlets-operator:${{ github.sha }}-amd64\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThen we have the arm64 build which is almost identical, but we specify a different value for \u003ccode\u003eplatforms\u003c/code\u003e and the \u003ccode\u003eruns-on\u003c/code\u003e field.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\n  \u003cspan class=\"hljs-attr\"\u003epublish_aarch64:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003econcurrency:\u003c/span\u003e \n      \u003cspan class=\"hljs-attr\"\u003egroup:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003egithub.ref\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}-aarch64\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003ecancel-in-progress:\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003epermissions:\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003epackages:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ewrite\u003c/span\u003e\n\n    \u003cspan class=\"hljs-attr\"\u003eruns-on:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eactuated-aarch64\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003esteps:\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eactions/checkout@master\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003ewith:\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003erepository:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003einlets/inlets-operator\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003epath:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"./\"\u003c/span\u003e\n\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eSetup\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003emirror\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eself-actuated/hub-mirror@master\u003c/span\u003e\n\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eGet\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eRepo\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eOwner\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003eid:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eget_repo_owner\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003erun:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"REPO_OWNER=$(echo $\u003cspan class=\"hljs-template-variable\"\u003e{{ github.repository_owner }}\u003c/span\u003e | tr '[:upper:]' '[:lower:]')\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e$GITHUB_ENV\u003c/span\u003e\n\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eSet\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eup\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eDocker\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eBuildx\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edocker/setup-buildx-action@v2\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eLogin\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eto\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003econtainer\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eRegistry\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edocker/login-action@v2\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003ewith:\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003eusername:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003egithub.repository_owner\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003epassword:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esecrets.GITHUB_TOKEN\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003eregistry:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eghcr.io\u003c/span\u003e\n\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eRelease\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ebuild\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003eid:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003erelease_build\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edocker/build-push-action@v3\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003ewith:\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003eoutputs:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"type=registry,push=true\"\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003eplatforms:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003elinux/arm64\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003efile:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e./Dockerfile\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003econtext:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e.\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003ebuild-args:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e|\n            Version=dev\n            GitCommit=${{ github.sha }}\n\u003c/span\u003e          \u003cspan class=\"hljs-attr\"\u003etags:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e|\n            ghcr.io/${{ env.REPO_OWNER }}/inlets-operator:${{ github.sha }}-aarch64\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eFinally, we need to create the manifest. GitHub Actions has a \u003ccode\u003eneeds\u003c/code\u003e variable that we can set to control the execution order:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e  \u003cspan class=\"hljs-attr\"\u003epublish_manifest:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003eruns-on:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eubuntu-latest\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003eneeds:\u003c/span\u003e [\u003cspan class=\"hljs-string\"\u003epublish_x86\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003epublish_aarch64\u003c/span\u003e]\n    \u003cspan class=\"hljs-attr\"\u003esteps:\u003c/span\u003e\n\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eGet\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eRepo\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eOwner\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003eid:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eget_repo_owner\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003erun:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"REPO_OWNER=$(echo $\u003cspan class=\"hljs-template-variable\"\u003e{{ github.repository_owner }}\u003c/span\u003e | tr '[:upper:]' '[:lower:]')\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e$GITHUB_ENV\u003c/span\u003e\n\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eLogin\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eto\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003econtainer\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eRegistry\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edocker/login-action@v2\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003ewith:\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003eusername:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003egithub.repository_owner\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003epassword:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esecrets.GITHUB_TOKEN\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003eregistry:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eghcr.io\u003c/span\u003e\n\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eCreate\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003emanifest\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003erun:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e|\n        docker manifest create ghcr.io/${{ env.REPO_OWNER }}/inlets-operator:${{ github.sha }} \\\n          --amend ghcr.io/${{ env.REPO_OWNER }}/inlets-operator:${{ github.sha }}-amd64 \\\n          --amend ghcr.io/${{ env.REPO_OWNER }}/inlets-operator:${{ github.sha }}-aarch64\n        docker manifest annotate --arch amd64 --os linux ghcr.io/${{ env.REPO_OWNER }}/inlets-operator:${{ github.sha }} ghcr.io/${{ env.REPO_OWNER }}/inlets-operator:${{ github.sha }}-amd64\n        docker manifest annotate --arch arm64 --os linux ghcr.io/${{ env.REPO_OWNER }}/inlets-operator:${{ github.sha }} ghcr.io/${{ env.REPO_OWNER }}/inlets-operator:${{ github.sha }}-aarch64\n        docker manifest inspect ghcr.io/${{ env.REPO_OWNER }}/inlets-operator:${{ github.sha }}\n\u003c/span\u003e\n        \u003cspan class=\"hljs-string\"\u003edocker\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003emanifest\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003epush\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eghcr.io/${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eenv.REPO_OWNER\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}/inlets-operator:${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003egithub.sha\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eOne thing I really dislike about this final stage is how much repetition we get. Fortunately, it's relatively simple to hide this complexity behind a custom GitHub Action.\u003c/p\u003e\n\u003cp\u003eNote that this is just an example at the moment, but I could make a custom composite action in Bash in about 30 minutes, including testing. So it's not a lot of work and it would make our whole workflow a lot less repetitive.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e   \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eself-actuated/compile-manifest@master\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003ewith:\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003eimage:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eghcr.io/${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eenv.REPO_OWNER\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}/inlets-operator\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003esha:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003egithub.sha\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003eplatforms:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eamd64,arm64\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eWrapping up\u003c/h2\u003e\n\u003cp\u003eYesterday we took a new customer on for actuated who wanted to improve the speed of Arm builds, but on the call we both knew they would need to leave QEMU behind. I put this write-up together to show what would be involved, and I hope it's useful to you.\u003c/p\u003e\n\u003cp\u003eWhere can you run these builds?\u003c/p\u003e\n\u003cp\u003eCouldn't you just add a low-cost Arm VM from AWS, Oracle Cloud, Azure or Google Cloud?\u003c/p\u003e\n\u003cp\u003eThe answer unfortunately is no.\u003c/p\u003e\n\u003cp\u003eThe self-hosted runner is not suitable for open source / public repositories, the GitHub documentation has a stark warning about this.\u003c/p\u003e\n\u003cp\u003eThe Kubernetes controller that's available has the same issues, because it re-uses the Pods by default, and runs in a dangerous Docker In Docker Mode as a privileged container or by mounting the Docker Socket. I'm not sure which is worse, but both mean that code in CI can take over the host, potentially even the whole cluster.\u003c/p\u003e\n\u003cp\u003eHosted runners solve this by creating a fresh VM per job, and destroying it immediately. That's the same approach that we took with actuated, but you get to bring your own metal along, so that you keep costs from growing out of control. Actuated also supports Arm, out of the box.\u003c/p\u003e\n\u003cp\u003eWant to know more about the security of self-hosted runners? \u003ca href=\"https://docs.actuated.dev/faq/\"\u003eRead more in our FAQ\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eWant to talk to us about your CI/CD needs? We're happy to help.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://docs.actuated.dev/register/#sign-up-for-the-pilot\"\u003eContact us about a PoC\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e","title":"How to split up multi-arch Docker builds to run natively","description":"QEMU is a convenient way to publish containers for multiple architectures, but it can be incredibly slow. Native is much faster.","author":"Alex Ellis","tags":["baremetal","githubactions","multiarch","arm"],"author_img":"alex","image":"/images/2023-split-native/background.jpg","date":"2023-03-24"}},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"how-to-run-multi-arch-builds-natively"},"buildId":"6SqFQR6vKMqgSah7Piaor","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>