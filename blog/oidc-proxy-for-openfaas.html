<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="theme-color" content="#000000"/><meta name="author" content="OpenFaaS Ltd"/><meta name="twitter:card" content="summary_large_image"/><title>Keyless deployment to OpenFaaS with OIDC and GitHub Actions</title><meta name="description" content="We&#x27;re announcing a new OIDC proxy for OpenFaaS for keyless deployments from GitHub Actions."/><meta property="twitter:title" content="Keyless deployment to OpenFaaS with OIDC and GitHub Actions"/><meta property="twitter:description" content="We&#x27;re announcing a new OIDC proxy for OpenFaaS for keyless deployments from GitHub Actions."/><meta property="og:title" content="Keyless deployment to OpenFaaS with OIDC and GitHub Actions"/><meta property="og:description" content="We&#x27;re announcing a new OIDC proxy for OpenFaaS for keyless deployments from GitHub Actions."/><meta name="twitter:image:src" content="https://actuated.dev/images/2023-05-openfaas-oidc-proxy/background.png"/><meta property="og:image" content="https://actuated.dev/images/2023-05-openfaas-oidc-proxy/background.png"/><meta name="next-head-count" content="13"/><meta charSet="utf-8"/><link rel="icon" type="image/png" href="/images/actuated.png"/><link rel="stylesheet" href="https://rsms.me/inter/inter.css"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css"/><link rel="manifest" href="/manifest.json"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-M5YNDNX7VT"></script><script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'G-M5YNDNX7VT');
          </script><link rel="apple-touch-icon" href="/images/actuated.png"/><link rel="preload" href="/_next/static/css/931f0fc3815fa31d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/931f0fc3815fa31d.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-8fa1640cc84ba8fe.js" defer=""></script><script src="/_next/static/chunks/framework-114634acb84f8baa.js" defer=""></script><script src="/_next/static/chunks/main-34e2100d07ae5757.js" defer=""></script><script src="/_next/static/chunks/pages/_app-ba4f0f0b110ca3d9.js" defer=""></script><script src="/_next/static/chunks/552-542f150c917a7625.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bslug%5D-109b0d2eddac75b5.js" defer=""></script><script src="/_next/static/52Y1rMJ_CD_ZYNhon-dm0/_buildManifest.js" defer=""></script><script src="/_next/static/52Y1rMJ_CD_ZYNhon-dm0/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="bg-white"><header><div class="relative bg-white" data-headlessui-state=""><div class="mx-auto flex max-w-7xl items-center justify-between px-4 py-6 sm:px-6 md:justify-start md:space-x-10 lg:px-8"><div class="flex justify-start lg:w-0 lg:flex-1"><a href="/"><span class="sr-only">Actuated</span><img class="h-8 w-auto sm:h-10" src="/images/actuated.png" alt="Actuated logo"/></a></div><div class="-my-2 -mr-2 md:hidden"><button class="inline-flex items-center justify-center rounded-md bg-white p-2 text-gray-400 hover:bg-gray-100 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500" type="button" aria-expanded="false" data-headlessui-state=""><span class="sr-only">Open menu</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" class="h-6 w-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"></path></svg></button></div><nav class="hidden space-x-10 md:flex"><div class="relative" data-headlessui-state=""><button class="text-gray-500 group inline-flex items-center rounded-md bg-white text-base font-medium hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" type="button" aria-expanded="false" data-headlessui-state=""><span>Solutions</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="text-gray-400 ml-2 h-5 w-5 group-hover:text-gray-500"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"></path></svg></button></div><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/blog">Blog</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="https://actuated.dev/blog/blazing-fast-ci-with-microvms">Announcement</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/pricing">Pricing</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="https://docs.actuated.dev/">Docs</a></nav><div class="hidden items-center justify-end md:flex md:flex-1 lg:w-0"><a href="https://dashboard.actuated.dev" class="whitespace-nowrap text-base font-medium text-gray-500 hover:text-gray-900">Sign in</a><a href="/pricing" class="ml-8 inline-flex items-center justify-center whitespace-nowrap rounded-md border border-transparent bg-indigo-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-indigo-700">Sign-up</a></div></div></div></header><main><div class="container mx-auto max-w-4xl bg-white mt-4 px-4 sm:px-6"><h1 id="post_title" class="text-3xl mb-3 leading-8 font-extrabold tracking-tight text-gray-900 sm:text-4xl sm:leading-10 text-center">Keyless deployment to OpenFaaS with OIDC and GitHub Actions</h1></div><div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-4xl"><div class="border-b border-gray-200 py-4 flex items-center text-gray-500 mx-auto"><div><img class="h-10 w-10 rounded-full" src="/images/alex.jpg" alt=""/></div><div class="ml-3"><p id="post_author" class="text-sm leading-5 font-medium text-gray-900">Alex Ellis</p><div class="flex text-sm leading-5 text-gray-500"><time dateTime="2023-05-05" id="post_date">May 5, 2023</time><span class="mx-1"></span></div></div></div><div class="mt-6 prose sm:prose-lg max-w-none"><p id="post_description" class="mb-4">We&#x27;re announcing a new OIDC proxy for OpenFaaS for keyless deployments from GitHub Actions.</p></div><div id="post_content" class="mt-6 prose sm:prose-lg max-w-none"><p>In 2021, GitHub released <a href="https://openid.net/connect/">OpenID Connect (OIDC)</a> support for CI jobs running under GitHub Actions. This was a huge step forward for security meaning that any GitHub Action could mint an OIDC token and use it to securely federate into another system without having to store long-lived credentials in the repository.</p>
<p>I wrote a prototype for OpenFaaS shortly after the announcement and a deep dive explaining how it works. I used <a href="https://inlets.dev/blog/2022/11/16/automate-a-self-hosted-https-tunnel.html">inlets</a> to set up a HTTPS tunnel, and send the token to my machine for inspection. Various individuals and technical teams have used my content as <a href="https://twitter.com/mlbiam/status/1653391969110900741?s=20">a reference guide</a> when working with GitHub Actions and OIDC.</p>
<p>See the article: <a href="https://blog.alexellis.io/deploy-without-credentials-using-oidc-and-github-actions/">Deploy without credentials with GitHub Actions and OIDC</a></p>
<p>Since then, custom actions for GCP, AWS and Azure have been created which allow an OIDC token from a GitHub Action to be exchanged for a short-lived access token for their API - meaning you can manage cloud resources securely. For example, see: <a href="https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services">Configuring OpenID Connect in Amazon Web Services</a> - we have actuated customers who use this approach to deploy to ECR from their self-hosted runners without having to store long-lived credentials in their repositories.</p>
<h2>Why OIDC is important for OpenFaaS customers</h2>
<p>Before we talk about the new OIDC proxy for OpenFaaS, I should say that <a href="https://openfaas.com/pricing">OpenFaaS Enterprise</a> <em>also has</em> an IAM feature which includes OIDC support for the CLI, dashboard and API. It supports any trusted OIDC provider, not just GitHub Actions. Rather than acting as a proxy, it actually implements a full fine-grained authorization and permissions policy language that resembles the one you'll be used to from AWS.</p>
<p>However, not everyone needs this level of granularity.</p>
<p><a href="https://il.linkedin.com/in/shaked-askayo-18403714a">Shaked, the CTO of Kubiya.ai</a> is an <a href="https://openfaas.com/">OpenFaaS</a> &#x26; <a href="https://inlets.dev">inlets</a> customer. His team at <a href="https://kubiya.ai">Kubiya</a> is building a conversational AI for DevOps - if you're ever tried ChatGPT, imagine that it was hooked up to your infrastructure and had superpowers. On a recent call, he told me that their team now has 30 different repositories which deploy OpenFaaS functions to their various AWS EKS clusters. That means that a secret has to be maintained at the organisation level and then consumed via <code>faas-cli login</code> in each job.</p>
<p>It gets a little worse for them - because different branches deploy to different OpenFaaS gateways and to different EKS clusters.</p>
<p>In addition to managing various credentials for each cluster they add - they were uncomfortable with exposing all of their functions on the Internet.</p>
<p>So today the team working on actuated is releasing a new OIDC proxy which can be deployed to any OpenFaaS cluster to avoid the need to manage and share long-lived credentials with GitHub.</p>
<p><img src="/images/2023-05-openfaas-oidc-proxy/conceptual.png" alt="Conceptual design of the OIDC proxy for OpenFaaS"></p>
<blockquote>
<p>Conceptual design of the OIDC proxy for OpenFaaS</p>
</blockquote>
<p><strong>About the OIDC proxy for OpenFaaS</strong></p>
<ul>
<li>It can be deployed via Helm</li>
<li>Only allows access to a given set of GitHub organisations</li>
<li>Uses a standard Ingress record</li>
<li>It only accepts OIDC tokens signed from GitHub Actions</li>
<li>It only allows requests to the <code>/system</code> endpoints of the OpenFaaS REST API - keeping your functions safe</li>
</ul>
<p>Best of all, unlike OpenFaaS Enterprise, it's free for all actuated customers - whether they're using OpenFaaS CE, Standard or Enterprise.</p>
<p>Here's what Shaked had to say about the new proxy:</p>
<blockquote>
<p>That's great - thank you! Looking forward to it as it will simplify our usage of the openfaas templates and will speed up our development process
Shaked, CTO, Kubiya.ai</p>
</blockquote>
<h2>How to deploy the proxy for OpenFaaS</h2>
<p>Here's what you need to do:</p>
<ul>
<li>Install OpenFaaS on a Kubernetes cluster</li>
<li>Create a new DNS A or CNAME record for the Ingress to the proxy i.e. <code>oidc-proxy.example.com</code></li>
<li>Install the OIDC proxy using Helm</li>
<li>Update your GitHub Actions workflow to use the OIDC token</li>
</ul>
<blockquote>
<p>My cluster is not publicly exposed on the Internet, so I'm using an <a href="https://inlets.dev/blog/2022/11/16/automate-a-self-hosted-https-tunnel.html">inlets tunnel</a> to expose the OIDC Proxy from my local KinD cluster. I'll be using the domain <code>minty.exit.o6s.io</code> but you'd create something more like <code>oidc-proxy.example.com</code> for your own cluster.</p>
</blockquote>
<p>First Set up your values.yaml for Helm:</p>
<pre><code class="hljs language-yaml"><span class="hljs-comment"># The public URL to access the proxy</span>
<span class="hljs-attr">publicURL:</span> <span class="hljs-string">https://oidc-proxy.example.com</span>

<span class="hljs-comment"># Comma separated list of repository owners for which short-lived OIDC tokens are authorized.</span>
<span class="hljs-comment"># For example: alexellis,self-actuated</span>
<span class="hljs-attr">repositoryOwners:</span> <span class="hljs-string">'alexellis,self-actuated'</span>
<span class="hljs-attr">ingress:</span>
    <span class="hljs-attr">host:</span> <span class="hljs-string">oidc-proxy.example.com</span>
    <span class="hljs-attr">issuer:</span> <span class="hljs-string">letsencrypt-prod</span>
</code></pre>
<p>The chart will create an Ingress record for you using an existing issuer. If you want to use something else like Inlets or Istio to expose the OIDC proxy, then simply set <code>enabled: false</code> under the <code>ingress:</code> section.</p>
<p>Create a secret for the actuated subscription key:</p>
<pre><code class="hljs language-bash">kubectl create secret generic actuated-license \
  -n openfaas \
  --from-file=actuated-license=<span class="hljs-variable">$HOME</span>/.actuated/LICENSE
</code></pre>
<p>Then run:</p>
<pre><code class="hljs language-bash">helm repo add actuated https://self-actuated.github.io/charts/
helm repo update

helm upgrade --install actuated/openfaas-oidc-proxy \
    -f ./values.yaml
</code></pre>
<p>For the full setup - <a href="https://github.com/self-actuated/charts/tree/master/chart/openfaas-oidc-proxy">see the README for the Helm chart</a></p>
<p>You can now go to one of your repositories and update the workflow to authenticate to the REST API via an OIDC token.</p>
<p>In order to get an OIDC token within a build, add the <code>id_token: write</code> permission to the permissions list.</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">keyless_deploy</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">workflow_dispatch:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">'*'</span>
<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">keyless_deploy:</span>
    <span class="hljs-attr">permissions:</span>
      <span class="hljs-attr">contents:</span> <span class="hljs-string">'read'</span>
      <span class="hljs-attr">id-token:</span> <span class="hljs-string">'write'</span>
</code></pre>
<p>Then set <code>runs-on</code> to <code>actuated</code> to use your faster actuated servers:</p>
<pre><code class="hljs language-diff"><span class="hljs-deletion">-   runs-on: ubuntu-latest</span>
<span class="hljs-addition">+   runs-on: actuated</span>
</code></pre>
<p>Then in the workflow, install the OpenFaaS CLI:</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">steps:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@master</span>
    <span class="hljs-attr">with:</span>
        <span class="hljs-attr">fetch-depth:</span> <span class="hljs-number">1</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">faas-cli</span>
    <span class="hljs-attr">run:</span> <span class="hljs-string">curl</span> <span class="hljs-string">-sLS</span> <span class="hljs-string">https://cli.openfaas.com</span> <span class="hljs-string">|</span> <span class="hljs-string">sudo</span> <span class="hljs-string">sh</span>
</code></pre>
<p>Then get a token:</p>
<pre><code class="hljs language-yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Get</span> <span class="hljs-string">token</span> <span class="hljs-string">and</span> <span class="hljs-string">use</span> <span class="hljs-string">the</span> <span class="hljs-string">CLI</span>
    <span class="hljs-attr">run:</span> <span class="hljs-string">|
        OPENFAAS_URL=https://minty.exit.o6s.io
        OIDC_TOKEN=$(curl -sLS "${ACTIONS_ID_TOKEN_REQUEST_URL}&#x26;audience=$OPENFAAS_URL" -H "User-Agent: actions/oidc-client" -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN")
        JWT=$(echo $OIDC_TOKEN | jq -j '.value')
</span></code></pre>
<p>Finally, use the token whenever you need it by passing in the <code>--token</code> flag to any of the <code>faas-cli</code> commands:</p>
<pre><code class="hljs language-yaml"><span class="hljs-string">faas-cli</span> <span class="hljs-string">list</span> <span class="hljs-string">-n</span> <span class="hljs-string">openfaas-fn</span> <span class="hljs-string">--token</span> <span class="hljs-string">"$JWT"</span>
<span class="hljs-string">faas-cli</span> <span class="hljs-string">ns</span> <span class="hljs-string">--token</span> <span class="hljs-string">"$JWT"</span>
<span class="hljs-string">faas-cli</span> <span class="hljs-string">store</span> <span class="hljs-string">deploy</span> <span class="hljs-string">printer</span> <span class="hljs-string">--name</span> <span class="hljs-string">p1</span> <span class="hljs-string">--token</span> <span class="hljs-string">"$JWT"</span>

<span class="hljs-string">faas-cli</span> <span class="hljs-string">describe</span> <span class="hljs-string">p1</span> <span class="hljs-string">--token</span> <span class="hljs-string">"$JWT"</span>
</code></pre>
<p>Since we have a lot of experience with GitHub Actions, we decided to make the above simpler by creating a custom <a href="https://docs.github.com/en/actions/creating-actions/creating-a-composite-action">Composite Action</a>. If you check out the code for <a href="https://github.com/self-actuated/openfaas-oidc">self-actuated/openfaas-oidc</a> you'll see that it obtains a token, then writes it into an openfaaas config file, so that the <code>--token</code> flag isn't required.</p>
<p>Here's how it changes:</p>
<pre><code class="hljs language-yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">self-actuated/openfaas-oidc@v1</span>
  <span class="hljs-attr">with:</span> 
    <span class="hljs-attr">gateway:</span> <span class="hljs-string">https://minty.exit.o6s.io</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Check</span> <span class="hljs-string">OpenFaaS</span> <span class="hljs-string">version</span>
  <span class="hljs-attr">run:</span> <span class="hljs-string">|
    OPENFAAS_CONFIG=$HOME/.openfaas/
    faas-cli version
</span></code></pre>
<p>Here's the complete example:</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">federate</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">workflow_dispatch:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">'*'</span>
<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">auth:</span>
    <span class="hljs-comment"># Add "id-token" with the intended permissions.</span>
    <span class="hljs-attr">permissions:</span>
      <span class="hljs-attr">contents:</span> <span class="hljs-string">'read'</span>
      <span class="hljs-attr">id-token:</span> <span class="hljs-string">'write'</span>

    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">actuated</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@master</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">fetch-depth:</span> <span class="hljs-number">1</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">faas-cli</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">curl</span> <span class="hljs-string">-sLS</span> <span class="hljs-string">https://cli.openfaas.com</span> <span class="hljs-string">|</span> <span class="hljs-string">sudo</span> <span class="hljs-string">sh</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">self-actuated/openfaas-oidc@v1</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">gateway:</span> <span class="hljs-string">https://minty.exit.o6s.io</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Get</span> <span class="hljs-string">token</span> <span class="hljs-string">and</span> <span class="hljs-string">use</span> <span class="hljs-string">the</span> <span class="hljs-string">CLI</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          export OPENFAAS_URL=https://minty.exit.o6s.io
          faas-cli store deploy env --name http-header-printer
          faas-cli list
</span></code></pre>
<p>How can we be sure that our functions cannot be invoked over the proxy?</p>
<p>Just add an extra line to test it out:</p>
<pre><code class="hljs language-yaml">      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Get</span> <span class="hljs-string">token</span> <span class="hljs-string">and</span> <span class="hljs-string">use</span> <span class="hljs-string">the</span> <span class="hljs-string">CLI</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          export OPENFAAS_URL=https://minty.exit.o6s.io
          faas-cli store deploy env --name http-header-printer
          sleep 5
</span>
          <span class="hljs-string">echo</span> <span class="hljs-string">|</span> <span class="hljs-string">faas-cli</span> <span class="hljs-string">invoke</span> <span class="hljs-string">http-header-printer</span>
</code></pre>
<p><img src="/images/2023-05-openfaas-oidc-proxy/failed-invoke.png" alt="A failed invocation over the proxy"></p>
<blockquote>
<p>A failed invocation over the proxy</p>
</blockquote>
<p>Best of all, now that you're using OIDC, you can now go and delete any of those long lived basic auth credentials from your secrets!</p>
<h2>Wrapping up</h2>
<p>The new OIDC proxy for OpenFaaS is available for all actuated customers and works with OpenFaaS CE, Standard and Enterprise. You can use it on as many clusters as you like, whilst you have an active subscription for actuated at no extra cost.</p>
<p>In a short period of time, you can set up the Helm chart for the OIDC proxy and no longer have to worry about storing various secrets in GitHub Actions for all your clusters, simply obtain a token and use it to deploy to any cluster - securely. There's no risk that your functions will be exposed on the Internet, because the OIDC proxy only works for the <code>/system</code> endpoints of the OpenFaaS REST API.</p>
<p><strong>An alternative for those who need it</strong></p>
<p><a href="https://openfaas.com/pricing">OpenFaaS Enterprise</a> has its own OIDC integration with much more fine-grained permissions implemented. It means that team members using the CLI, Dashboard or API do not need to memorise or share basic authentication credentials with each other, or worry about getting the right password for the right cluster.</p>
<p>An OpenFaaS Enterprise policy can restrict all the way down to read/write permissions on a number of namespaces, and also integrates with OIDC.</p>
<p>See an example:</p>
<ul>
<li><a href="https://docs.openfaas.com/openfaas-pro/iam/github-actions-federation/">OpenFaaS Enterprise - IAM with GitHub Actions</a></li>
<li><a href="https://docs.openfaas.com/openfaas-pro/iam/gitlab-federation/">OpenFaaS Enterprise - IAM with GitLab</a></li>
</ul></div></div></main><footer class="bg-white"><div class="mx-auto max-w-7xl py-12 px-4 sm:px-6 md:flex md:items-center md:justify-between lg:px-8"><div class="flex justify-center space-x-6 md:order-2"><a class="text-gray-400 hover:text-gray-500" href="https://twitter.com/selfactuated"><span class="sr-only">Twitter</span><svg fill="currentColor" viewBox="0 0 24 24" class="h-6 w-6" aria-hidden="true"><path d="M8.29 20.251c7.547 0 11.675-6.253 11.675-11.675 0-.178 0-.355-.012-.53A8.348 8.348 0 0022 5.92a8.19 8.19 0 01-2.357.646 4.118 4.118 0 001.804-2.27 8.224 8.224 0 01-2.605.996 4.107 4.107 0 00-6.993 3.743 11.65 11.65 0 01-8.457-4.287 4.106 4.106 0 001.27 5.477A4.072 4.072 0 012.8 9.713v.052a4.105 4.105 0 003.292 4.022 4.095 4.095 0 01-1.853.07 4.108 4.108 0 003.834 2.85A8.233 8.233 0 012 18.407a11.616 11.616 0 006.29 1.84"></path></svg></a><a class="text-gray-400 hover:text-gray-500" href="https://github.com/self-actuated"><span class="sr-only">GitHub</span><svg fill="currentColor" viewBox="0 0 24 24" class="h-6 w-6" aria-hidden="true"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"></path></svg></a><a class="text-gray-400 hover:text-gray-500" href="/rss.xml"><span class="sr-only">RSS</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M12.75 19.5v-.75a7.5 7.5 0 00-7.5-7.5H4.5m0-6.75h.75c7.87 0 14.25 6.38 14.25 14.25v.75M6 18.75a.75.75 0 11-1.5 0 .75.75 0 011.5 0z"></path></svg></a></div><div class="mt-8 md:order-1 md:mt-0"><p class="text-center text-base text-gray-400">© 2022 <a href="https://openfaas.com">OpenFaaS Ltd</a>, Inc. All rights reserved.</p></div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"oidc-proxy-for-openfaas","fileName":"2023-05-05-oidc-proxy-for-openfaas.md","contentHtml":"\u003cp\u003eIn 2021, GitHub released \u003ca href=\"https://openid.net/connect/\"\u003eOpenID Connect (OIDC)\u003c/a\u003e support for CI jobs running under GitHub Actions. This was a huge step forward for security meaning that any GitHub Action could mint an OIDC token and use it to securely federate into another system without having to store long-lived credentials in the repository.\u003c/p\u003e\n\u003cp\u003eI wrote a prototype for OpenFaaS shortly after the announcement and a deep dive explaining how it works. I used \u003ca href=\"https://inlets.dev/blog/2022/11/16/automate-a-self-hosted-https-tunnel.html\"\u003einlets\u003c/a\u003e to set up a HTTPS tunnel, and send the token to my machine for inspection. Various individuals and technical teams have used my content as \u003ca href=\"https://twitter.com/mlbiam/status/1653391969110900741?s=20\"\u003ea reference guide\u003c/a\u003e when working with GitHub Actions and OIDC.\u003c/p\u003e\n\u003cp\u003eSee the article: \u003ca href=\"https://blog.alexellis.io/deploy-without-credentials-using-oidc-and-github-actions/\"\u003eDeploy without credentials with GitHub Actions and OIDC\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eSince then, custom actions for GCP, AWS and Azure have been created which allow an OIDC token from a GitHub Action to be exchanged for a short-lived access token for their API - meaning you can manage cloud resources securely. For example, see: \u003ca href=\"https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services\"\u003eConfiguring OpenID Connect in Amazon Web Services\u003c/a\u003e - we have actuated customers who use this approach to deploy to ECR from their self-hosted runners without having to store long-lived credentials in their repositories.\u003c/p\u003e\n\u003ch2\u003eWhy OIDC is important for OpenFaaS customers\u003c/h2\u003e\n\u003cp\u003eBefore we talk about the new OIDC proxy for OpenFaaS, I should say that \u003ca href=\"https://openfaas.com/pricing\"\u003eOpenFaaS Enterprise\u003c/a\u003e \u003cem\u003ealso has\u003c/em\u003e an IAM feature which includes OIDC support for the CLI, dashboard and API. It supports any trusted OIDC provider, not just GitHub Actions. Rather than acting as a proxy, it actually implements a full fine-grained authorization and permissions policy language that resembles the one you'll be used to from AWS.\u003c/p\u003e\n\u003cp\u003eHowever, not everyone needs this level of granularity.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://il.linkedin.com/in/shaked-askayo-18403714a\"\u003eShaked, the CTO of Kubiya.ai\u003c/a\u003e is an \u003ca href=\"https://openfaas.com/\"\u003eOpenFaaS\u003c/a\u003e \u0026#x26; \u003ca href=\"https://inlets.dev\"\u003einlets\u003c/a\u003e customer. His team at \u003ca href=\"https://kubiya.ai\"\u003eKubiya\u003c/a\u003e is building a conversational AI for DevOps - if you're ever tried ChatGPT, imagine that it was hooked up to your infrastructure and had superpowers. On a recent call, he told me that their team now has 30 different repositories which deploy OpenFaaS functions to their various AWS EKS clusters. That means that a secret has to be maintained at the organisation level and then consumed via \u003ccode\u003efaas-cli login\u003c/code\u003e in each job.\u003c/p\u003e\n\u003cp\u003eIt gets a little worse for them - because different branches deploy to different OpenFaaS gateways and to different EKS clusters.\u003c/p\u003e\n\u003cp\u003eIn addition to managing various credentials for each cluster they add - they were uncomfortable with exposing all of their functions on the Internet.\u003c/p\u003e\n\u003cp\u003eSo today the team working on actuated is releasing a new OIDC proxy which can be deployed to any OpenFaaS cluster to avoid the need to manage and share long-lived credentials with GitHub.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/2023-05-openfaas-oidc-proxy/conceptual.png\" alt=\"Conceptual design of the OIDC proxy for OpenFaaS\"\u003e\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eConceptual design of the OIDC proxy for OpenFaaS\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e\u003cstrong\u003eAbout the OIDC proxy for OpenFaaS\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eIt can be deployed via Helm\u003c/li\u003e\n\u003cli\u003eOnly allows access to a given set of GitHub organisations\u003c/li\u003e\n\u003cli\u003eUses a standard Ingress record\u003c/li\u003e\n\u003cli\u003eIt only accepts OIDC tokens signed from GitHub Actions\u003c/li\u003e\n\u003cli\u003eIt only allows requests to the \u003ccode\u003e/system\u003c/code\u003e endpoints of the OpenFaaS REST API - keeping your functions safe\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eBest of all, unlike OpenFaaS Enterprise, it's free for all actuated customers - whether they're using OpenFaaS CE, Standard or Enterprise.\u003c/p\u003e\n\u003cp\u003eHere's what Shaked had to say about the new proxy:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eThat's great - thank you! Looking forward to it as it will simplify our usage of the openfaas templates and will speed up our development process\nShaked, CTO, Kubiya.ai\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch2\u003eHow to deploy the proxy for OpenFaaS\u003c/h2\u003e\n\u003cp\u003eHere's what you need to do:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eInstall OpenFaaS on a Kubernetes cluster\u003c/li\u003e\n\u003cli\u003eCreate a new DNS A or CNAME record for the Ingress to the proxy i.e. \u003ccode\u003eoidc-proxy.example.com\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eInstall the OIDC proxy using Helm\u003c/li\u003e\n\u003cli\u003eUpdate your GitHub Actions workflow to use the OIDC token\u003c/li\u003e\n\u003c/ul\u003e\n\u003cblockquote\u003e\n\u003cp\u003eMy cluster is not publicly exposed on the Internet, so I'm using an \u003ca href=\"https://inlets.dev/blog/2022/11/16/automate-a-self-hosted-https-tunnel.html\"\u003einlets tunnel\u003c/a\u003e to expose the OIDC Proxy from my local KinD cluster. I'll be using the domain \u003ccode\u003eminty.exit.o6s.io\u003c/code\u003e but you'd create something more like \u003ccode\u003eoidc-proxy.example.com\u003c/code\u003e for your own cluster.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eFirst Set up your values.yaml for Helm:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-comment\"\u003e# The public URL to access the proxy\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003epublicURL:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ehttps://oidc-proxy.example.com\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment\"\u003e# Comma separated list of repository owners for which short-lived OIDC tokens are authorized.\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# For example: alexellis,self-actuated\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003erepositoryOwners:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'alexellis,self-actuated'\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003eingress:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003ehost:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eoidc-proxy.example.com\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003eissuer:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eletsencrypt-prod\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe chart will create an Ingress record for you using an existing issuer. If you want to use something else like Inlets or Istio to expose the OIDC proxy, then simply set \u003ccode\u003eenabled: false\u003c/code\u003e under the \u003ccode\u003eingress:\u003c/code\u003e section.\u003c/p\u003e\n\u003cp\u003eCreate a secret for the actuated subscription key:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003ekubectl create secret generic actuated-license \\\n  -n openfaas \\\n  --from-file=actuated-license=\u003cspan class=\"hljs-variable\"\u003e$HOME\u003c/span\u003e/.actuated/LICENSE\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThen run:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003ehelm repo add actuated https://self-actuated.github.io/charts/\nhelm repo update\n\nhelm upgrade --install actuated/openfaas-oidc-proxy \\\n    -f ./values.yaml\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eFor the full setup - \u003ca href=\"https://github.com/self-actuated/charts/tree/master/chart/openfaas-oidc-proxy\"\u003esee the README for the Helm chart\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eYou can now go to one of your repositories and update the workflow to authenticate to the REST API via an OIDC token.\u003c/p\u003e\n\u003cp\u003eIn order to get an OIDC token within a build, add the \u003ccode\u003eid_token: write\u003c/code\u003e permission to the permissions list.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ekeyless_deploy\u003c/span\u003e\n\n\u003cspan class=\"hljs-attr\"\u003eon:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003eworkflow_dispatch:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003epush:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003ebranches:\u003c/span\u003e\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'*'\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003ejobs:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003ekeyless_deploy:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003epermissions:\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003econtents:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'read'\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003eid-token:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'write'\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThen set \u003ccode\u003eruns-on\u003c/code\u003e to \u003ccode\u003eactuated\u003c/code\u003e to use your faster actuated servers:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-diff\"\u003e\u003cspan class=\"hljs-deletion\"\u003e-   runs-on: ubuntu-latest\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+   runs-on: actuated\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThen in the workflow, install the OpenFaaS CLI:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-attr\"\u003esteps:\u003c/span\u003e\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eactions/checkout@master\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003ewith:\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003efetch-depth:\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eInstall\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003efaas-cli\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003erun:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ecurl\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e-sLS\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ehttps://cli.openfaas.com\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e|\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esudo\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esh\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThen get a token:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eGet\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003etoken\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eand\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003euse\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ethe\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eCLI\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003erun:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e|\n        OPENFAAS_URL=https://minty.exit.o6s.io\n        OIDC_TOKEN=$(curl -sLS \"${ACTIONS_ID_TOKEN_REQUEST_URL}\u0026#x26;audience=$OPENFAAS_URL\" -H \"User-Agent: actions/oidc-client\" -H \"Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN\")\n        JWT=$(echo $OIDC_TOKEN | jq -j '.value')\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eFinally, use the token whenever you need it by passing in the \u003ccode\u003e--token\u003c/code\u003e flag to any of the \u003ccode\u003efaas-cli\u003c/code\u003e commands:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-string\"\u003efaas-cli\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003elist\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e-n\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eopenfaas-fn\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e--token\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"$JWT\"\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003efaas-cli\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ens\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e--token\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"$JWT\"\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003efaas-cli\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003estore\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edeploy\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eprinter\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e--name\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ep1\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e--token\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"$JWT\"\u003c/span\u003e\n\n\u003cspan class=\"hljs-string\"\u003efaas-cli\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edescribe\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ep1\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e--token\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"$JWT\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSince we have a lot of experience with GitHub Actions, we decided to make the above simpler by creating a custom \u003ca href=\"https://docs.github.com/en/actions/creating-actions/creating-a-composite-action\"\u003eComposite Action\u003c/a\u003e. If you check out the code for \u003ca href=\"https://github.com/self-actuated/openfaas-oidc\"\u003eself-actuated/openfaas-oidc\u003c/a\u003e you'll see that it obtains a token, then writes it into an openfaaas config file, so that the \u003ccode\u003e--token\u003c/code\u003e flag isn't required.\u003c/p\u003e\n\u003cp\u003eHere's how it changes:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eself-actuated/openfaas-oidc@v1\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003ewith:\u003c/span\u003e \n    \u003cspan class=\"hljs-attr\"\u003egateway:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ehttps://minty.exit.o6s.io\u003c/span\u003e\n\u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eCheck\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eOpenFaaS\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eversion\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003erun:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e|\n    OPENFAAS_CONFIG=$HOME/.openfaas/\n    faas-cli version\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eHere's the complete example:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003efederate\u003c/span\u003e\n\n\u003cspan class=\"hljs-attr\"\u003eon:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003eworkflow_dispatch:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003epush:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003ebranches:\u003c/span\u003e\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'*'\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003ejobs:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003eauth:\u003c/span\u003e\n    \u003cspan class=\"hljs-comment\"\u003e# Add \"id-token\" with the intended permissions.\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003epermissions:\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003econtents:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'read'\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003eid-token:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'write'\u003c/span\u003e\n\n    \u003cspan class=\"hljs-attr\"\u003eruns-on:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eactuated\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003esteps:\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eactions/checkout@master\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003ewith:\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003efetch-depth:\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eInstall\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003efaas-cli\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003erun:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ecurl\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e-sLS\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ehttps://cli.openfaas.com\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e|\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esudo\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esh\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eself-actuated/openfaas-oidc@v1\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003ewith:\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003egateway:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ehttps://minty.exit.o6s.io\u003c/span\u003e\n\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eGet\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003etoken\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eand\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003euse\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ethe\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eCLI\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003erun:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e|\n          export OPENFAAS_URL=https://minty.exit.o6s.io\n          faas-cli store deploy env --name http-header-printer\n          faas-cli list\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eHow can we be sure that our functions cannot be invoked over the proxy?\u003c/p\u003e\n\u003cp\u003eJust add an extra line to test it out:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eGet\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003etoken\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eand\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003euse\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ethe\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eCLI\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003erun:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e|\n          export OPENFAAS_URL=https://minty.exit.o6s.io\n          faas-cli store deploy env --name http-header-printer\n          sleep 5\n\u003c/span\u003e\n          \u003cspan class=\"hljs-string\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e|\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003efaas-cli\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003einvoke\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ehttp-header-printer\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cimg src=\"/images/2023-05-openfaas-oidc-proxy/failed-invoke.png\" alt=\"A failed invocation over the proxy\"\u003e\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eA failed invocation over the proxy\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eBest of all, now that you're using OIDC, you can now go and delete any of those long lived basic auth credentials from your secrets!\u003c/p\u003e\n\u003ch2\u003eWrapping up\u003c/h2\u003e\n\u003cp\u003eThe new OIDC proxy for OpenFaaS is available for all actuated customers and works with OpenFaaS CE, Standard and Enterprise. You can use it on as many clusters as you like, whilst you have an active subscription for actuated at no extra cost.\u003c/p\u003e\n\u003cp\u003eIn a short period of time, you can set up the Helm chart for the OIDC proxy and no longer have to worry about storing various secrets in GitHub Actions for all your clusters, simply obtain a token and use it to deploy to any cluster - securely. There's no risk that your functions will be exposed on the Internet, because the OIDC proxy only works for the \u003ccode\u003e/system\u003c/code\u003e endpoints of the OpenFaaS REST API.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eAn alternative for those who need it\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://openfaas.com/pricing\"\u003eOpenFaaS Enterprise\u003c/a\u003e has its own OIDC integration with much more fine-grained permissions implemented. It means that team members using the CLI, Dashboard or API do not need to memorise or share basic authentication credentials with each other, or worry about getting the right password for the right cluster.\u003c/p\u003e\n\u003cp\u003eAn OpenFaaS Enterprise policy can restrict all the way down to read/write permissions on a number of namespaces, and also integrates with OIDC.\u003c/p\u003e\n\u003cp\u003eSee an example:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://docs.openfaas.com/openfaas-pro/iam/github-actions-federation/\"\u003eOpenFaaS Enterprise - IAM with GitHub Actions\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://docs.openfaas.com/openfaas-pro/iam/gitlab-federation/\"\u003eOpenFaaS Enterprise - IAM with GitLab\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e","title":"Keyless deployment to OpenFaaS with OIDC and GitHub Actions","description":"We're announcing a new OIDC proxy for OpenFaaS for keyless deployments from GitHub Actions.","author":"Alex Ellis","tags":["oidc","githubactions","security","federation","iam"],"author_img":"alex","image":"/images/2023-05-openfaas-oidc-proxy/background.png","date":"2023-05-05"}},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"oidc-proxy-for-openfaas"},"buildId":"52Y1rMJ_CD_ZYNhon-dm0","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>