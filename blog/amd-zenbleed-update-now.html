<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="theme-color" content="#000000"/><meta name="author" content="OpenFaaS Ltd"/><meta name="twitter:card" content="summary_large_image"/><title>Update your AMD hosts now to mitigate the Zenbleed exploit</title><meta name="description" content="Learn how to update the microcode on your AMD CPU to avoid the Zenbleed exploit."/><meta property="twitter:title" content="Update your AMD hosts now to mitigate the Zenbleed exploit"/><meta property="twitter:description" content="Learn how to update the microcode on your AMD CPU to avoid the Zenbleed exploit."/><meta property="og:title" content="Update your AMD hosts now to mitigate the Zenbleed exploit"/><meta property="og:description" content="Learn how to update the microcode on your AMD CPU to avoid the Zenbleed exploit."/><meta name="twitter:image:src" content="https://actuated.dev/images/2023-07-zenbleed/background.png"/><meta property="og:image" content="https://actuated.dev/images/2023-07-zenbleed/background.png"/><meta name="next-head-count" content="13"/><meta charSet="utf-8"/><link rel="icon" type="image/png" href="/images/actuated.png"/><link rel="stylesheet" href="https://rsms.me/inter/inter.css"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css"/><link rel="manifest" href="/manifest.json"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-M5YNDNX7VT"></script><script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'G-M5YNDNX7VT');
          </script><link rel="apple-touch-icon" href="/images/actuated.png"/><link rel="preload" href="/_next/static/css/835182c647a0329c.css" as="style"/><link rel="stylesheet" href="/_next/static/css/835182c647a0329c.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-8fa1640cc84ba8fe.js" defer=""></script><script src="/_next/static/chunks/framework-114634acb84f8baa.js" defer=""></script><script src="/_next/static/chunks/main-34e2100d07ae5757.js" defer=""></script><script src="/_next/static/chunks/pages/_app-ba4f0f0b110ca3d9.js" defer=""></script><script src="/_next/static/chunks/552-542f150c917a7625.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bslug%5D-109b0d2eddac75b5.js" defer=""></script><script src="/_next/static/RtuzClOr7buia8xWyHkqT/_buildManifest.js" defer=""></script><script src="/_next/static/RtuzClOr7buia8xWyHkqT/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="bg-white"><header><div class="relative bg-white" data-headlessui-state=""><div class="mx-auto flex max-w-7xl items-center justify-between px-4 py-6 sm:px-6 md:justify-start md:space-x-10 lg:px-8"><div class="flex justify-start lg:w-0 lg:flex-1"><a href="/"><span class="sr-only">Actuated</span><img class="h-8 w-auto sm:h-10" src="/images/actuated.png" alt="Actuated logo"/></a></div><div class="-my-2 -mr-2 md:hidden"><button class="inline-flex items-center justify-center rounded-md bg-white p-2 text-gray-400 hover:bg-gray-100 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500" type="button" aria-expanded="false" data-headlessui-state=""><span class="sr-only">Open menu</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" class="h-6 w-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"></path></svg></button></div><nav class="hidden space-x-10 md:flex"><div class="relative" data-headlessui-state=""><button class="text-gray-500 group inline-flex items-center rounded-md bg-white text-base font-medium hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" type="button" aria-expanded="false" data-headlessui-state=""><span>Solutions</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="text-gray-400 ml-2 h-5 w-5 group-hover:text-gray-500"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"></path></svg></button></div><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/blog">Blog</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="https://actuated.dev/blog/blazing-fast-ci-with-microvms">Announcement</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/pricing">Pricing</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="https://docs.actuated.dev/">Docs</a></nav><div class="hidden items-center justify-end md:flex md:flex-1 lg:w-0"><a href="https://dashboard.actuated.dev" class="whitespace-nowrap text-base font-medium text-gray-500 hover:text-gray-900">Sign in</a><a href="/pricing" class="ml-8 inline-flex items-center justify-center whitespace-nowrap rounded-md border border-transparent bg-indigo-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-indigo-700">Sign-up</a></div></div></div></header><main><div class="container mx-auto max-w-4xl bg-white mt-4 px-4 sm:px-6"><h1 id="post_title" class="text-3xl mb-3 leading-8 font-extrabold tracking-tight text-gray-900 sm:text-4xl sm:leading-10 text-center">Update your AMD hosts now to mitigate the Zenbleed exploit</h1></div><div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-4xl"><div class="border-b border-gray-200 py-4 flex items-center text-gray-500 mx-auto"><div><img class="h-10 w-10 rounded-full" src="/images/alex.jpg" alt=""/></div><div class="ml-3"><p id="post_author" class="text-sm leading-5 font-medium text-gray-900"></p><div class="flex text-sm leading-5 text-gray-500"><time dateTime="2023-07-31" id="post_date">July 31, 2023</time><span class="mx-1"></span></div></div></div><div class="mt-6 prose sm:prose-lg max-w-none"><p id="post_description" class="mb-4">Learn how to update the microcode on your AMD CPU to avoid the Zenbleed exploit.</p></div><div id="post_content" class="mt-6 prose sm:prose-lg max-w-none"><p>On 24th July 2023, <a href="https://www.theregister.com/2023/07/24/amd_zenbleed_bug/">The Register covered a new exploit</a> for certain AMD CPUs based upon the Zen architecture. The exploit, dubbed Zenbleed, allows an attacker to read arbitrary physical memory locations on the host system. It works by allowing memory to be read after it's been set to be freed up aka "use-after-free". This is a serious vulnerability, and you should update your AMD hosts as soon as possible.</p>
<p>The Register made the claim that "any level of emulation such as QEMU" would prevent the exploit from working. This is misleading because QEMU only makes sense in production when used with hardware acceleration (KVM). We were able to run the exploit with a GitHub Action using actuated on an AMD Epyc server from Equinix Metal using Firecracker and KVM.</p>
<blockquote>
<p>"If you stick any emulation layer in between, such as Qemu, then the exploit understandably fails."</p>
</blockquote>
<p>The editors at The Register have since reached out and updated their article.</p>
<p>Even Firecracker with its isolated guest Kernel is vulnerable, which shows how serious the bug is, it's within the hardware itself. Of course it goes without saying that this also affects containerd, Docker (and by virtue Kubernetes) which share the host Kernel.</p>
<p>To test this, we ran a GitHub Actions matrix build that creates many VMs running different versions of K3s. About the same time, we triggered a build which runs a Zenbleed exploit PoC written by <a href="https://twitter.com/taviso">Tavis Ormandy</a>, a security researcher at Google.</p>
<p>We found that the exploit was able to read the memory of the host system, and that the exploit was able to read the memory of other VMs running on the same host.</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">build</span>

<span class="hljs-attr">on:</span>
    <span class="hljs-attr">pull_request:</span>
        <span class="hljs-attr">branches:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">'*'</span>
    <span class="hljs-attr">push:</span>
        <span class="hljs-attr">branches:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">master</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">main</span>
    <span class="hljs-attr">workflow_dispatch:</span>

<span class="hljs-attr">jobs:</span>
    <span class="hljs-attr">build:</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">specs</span>
        <span class="hljs-attr">runs-on:</span> <span class="hljs-string">actuated</span>
        <span class="hljs-attr">steps:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v1</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Download</span> <span class="hljs-string">exploit</span>
          <span class="hljs-attr">run:</span> <span class="hljs-string">|
            curl -L -S -s -O https://lock.cmpxchg8b.com/files/zenbleed-v5.tar.gz
            tar -xvf zenbleed-v5.tar.gz
            sudo apt install -qy build-essential make nasm
</span>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">exploit</span>
          <span class="hljs-attr">run:</span> <span class="hljs-string">|
            cd zenbleed
            make
            chmod +x ./zenbleed
</span>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">exploit</span> <span class="hljs-string">for</span> <span class="hljs-number">1000 </span><span class="hljs-string">pieces</span> <span class="hljs-string">of</span> <span class="hljs-string">data</span>
          <span class="hljs-attr">run:</span> <span class="hljs-string">|
            ./zenbleed/zenbleed -m 1000
</span></code></pre>
<p>Full details of the exploit can be found on a microsite created by the security researcher who discovered the vulnerability. The <code>-m 1000</code> flag reads 1000 pieces of memory and then exits.</p>
<p><a href="https://lock.cmpxchg8b.com/zenbleed.html#vulnerability">Zenbleed by Tavis Ormandy</a></p>
<p>We didn't see any secrets printed out during the scan, but we did see part of a public SSH key, console output from etcd running within K3s, and instructions from containerd. So we can assume anything that was within memory within one of the other VMs on the host, or even the host itself, could be read by the exploit.</p>
<p><img src="/images/2023-07-zenbleed/gha.png" alt="GHA output from the zenbleed exploit"></p>
<blockquote>
<p>GHA output from the zenbleed exploit</p>
</blockquote>
<h2>Mitigation</h2>
<p>AMD has already released a mitigation for the Zenbleed exploit, which requires an update to the CPU's microcode.</p>
<p><a href="https://www.linkedin.com/in/edwardvielmetti/">Ed Vielmetti</a>, Developer Partner Manager at Equinix told us that mitigation is three-fold:</p>
<ol>
<li>There is an incoming BIOS update from certain vendors that will update the microcode.</li>
<li>Updating some OSes like the Ubuntu 20.04 and 22.04 will upgrade the microcode of the CPU.</li>
<li>There is a <a href="https://www.reddit.com/r/linux/comments/15903hr/zenbleed_a_useafterfree_in_amd_zen2_processors/">"chicken bit"</a> that can be enabled which prevents the exploit from working.</li>
</ol>
<p>I probably don't need to spell this out, but a system update looks like the following, and the reboot is required:</p>
<pre><code class="hljs language-bash">sudo apt update -qy &#x26;&#x26; \
    sudo apt upgrade -yq &#x26;&#x26; \
    sudo reboot 
</code></pre>
<p><img src="/images/2023-07-zenbleed/microcode.png" alt="An update to the CPU microcode is required"></p>
<p>For some unknown reason, both of the Equinix AMD hosts that we use internally broke after running the OS upgrade, so I had to reinstall Ubuntu 22.04 using the dashboard. If for whatever reason the machine won't come up after the microcode update, then you should reinstall the Operating System (OS) using your vendor's rescue system or out of band console, both Equinix Metal and Hetzner have an "easy button" that you can click for this. If there is still an issue after that, reach out to your vendor's support team.</p>
<p>New machines provisioned after this date should already contain the microcode fix or have the "chicken bit" enabled. We provisioned a new AMD Epyc server on Equinix Metal to make sure, and as expected, thanks to their hard work - it was not vulnerable.</p>
<p>We offer 500 USD of free credit for new Equinix Metal customers to use with actuated, and Equinix Metal have also written up their own guide on workaround here:</p>
<ul>
<li><a href="https://deploy.equinix.com/blog/an-update-on-the-amd-zen-2-cpu-vulnerability/">An Update On the AMD Zen 2 CPU Vulnerability</a></li>
</ul>
<h2>Verifying the mitigation</h2>
<p>Since actuated VMs use Firecracker, you should run the above workflow before and after to verify the exploit was a) present and b) mitigated.</p>
<p><img src="/images/2023-07-zenbleed/mitigated.png" alt="What it looks like when the mitigation is in place"></p>
<blockquote>
<p>Above: What it looks like when the mitigation is in place</p>
</blockquote>
<p>You can also run the exploit on the host by copying and pasting the commands from the GitHub Action above.</p>
<p>My workstation uses a Ryzen 9 CPU, so when I ran the exploit I just saw a blocking message instead of memory regions:</p>
<pre><code class="hljs language-bash">$ grep <span class="hljs-string">"model name"</span> /proc/cpuinfo |<span class="hljs-built_in">uniq</span>
model name	: AMD Ryzen 9 5950X 16-Core Processor

./zenbleed -m 100
*** EMBARGOED SECURITY ISSUE --  DO NOT DISTRIBUTE! ***
ZenBleed Testcase -- taviso@google.com

NOTE: Try -h to see configuration options

Spawning 32 Threads...
Thread 0x7fd0d40e8700 running on CPU 0
Thread 0x7fd0d38e7700 running on CPU 1
...
</code></pre>
<p>You can also run the following command to print out the microcode version. This is the output from the Equinix Metal server (c3.medium) that ran an OS update on:</p>
<pre><code class="hljs language-bash">$ grep <span class="hljs-string">'microcode'</span> /proc/cpuinfo
microcode	: 0x830107a
</code></pre>
<h2>Wrapping up</h2>
<p>Actuated uses <a href="https://firecracker-microvm.github.io/">Firecracker</a>, an open source Virtual Machine Manager (VMM) that works with Linux KVM to run isolated systems on a host. We have verified that the exploit works on Firecracker, and that the mitigation works too. So whilst VM-level isolation and an immutable filesystem is much more appropriate than a container for CI, this is an example of why we must still be vigilant and ready to respond to security vulnerabilities.</p>
<p>This is an unfortunate, and serious vulnerability. It affects bare-metal, VMs and containers, which is why it's important to update your systems as soon as possible.</p></div></div></main><footer class="bg-white"><div class="mx-auto max-w-7xl py-12 px-4 sm:px-6 md:flex md:items-center md:justify-between lg:px-8"><div class="flex justify-center space-x-6 md:order-2"><a class="text-gray-400 hover:text-gray-500" href="https://twitter.com/selfactuated"><span class="sr-only">Twitter</span><svg fill="currentColor" viewBox="0 0 24 24" class="h-6 w-6" aria-hidden="true"><path d="M8.29 20.251c7.547 0 11.675-6.253 11.675-11.675 0-.178 0-.355-.012-.53A8.348 8.348 0 0022 5.92a8.19 8.19 0 01-2.357.646 4.118 4.118 0 001.804-2.27 8.224 8.224 0 01-2.605.996 4.107 4.107 0 00-6.993 3.743 11.65 11.65 0 01-8.457-4.287 4.106 4.106 0 001.27 5.477A4.072 4.072 0 012.8 9.713v.052a4.105 4.105 0 003.292 4.022 4.095 4.095 0 01-1.853.07 4.108 4.108 0 003.834 2.85A8.233 8.233 0 012 18.407a11.616 11.616 0 006.29 1.84"></path></svg></a><a class="text-gray-400 hover:text-gray-500" href="https://github.com/self-actuated"><span class="sr-only">GitHub</span><svg fill="currentColor" viewBox="0 0 24 24" class="h-6 w-6" aria-hidden="true"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"></path></svg></a><a class="text-gray-400 hover:text-gray-500" href="/rss.xml"><span class="sr-only">RSS</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M12.75 19.5v-.75a7.5 7.5 0 00-7.5-7.5H4.5m0-6.75h.75c7.87 0 14.25 6.38 14.25 14.25v.75M6 18.75a.75.75 0 11-1.5 0 .75.75 0 011.5 0z"></path></svg></a></div><div class="mt-8 md:order-1 md:mt-0"><p class="text-center text-base text-gray-400">Â© 2022 <a href="https://openfaas.com">OpenFaaS Ltd</a>, Inc. All rights reserved.</p></div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"amd-zenbleed-update-now","fileName":"2023-07-31-amd-zenbleed-update-now.md","contentHtml":"\u003cp\u003eOn 24th July 2023, \u003ca href=\"https://www.theregister.com/2023/07/24/amd_zenbleed_bug/\"\u003eThe Register covered a new exploit\u003c/a\u003e for certain AMD CPUs based upon the Zen architecture. The exploit, dubbed Zenbleed, allows an attacker to read arbitrary physical memory locations on the host system. It works by allowing memory to be read after it's been set to be freed up aka \"use-after-free\". This is a serious vulnerability, and you should update your AMD hosts as soon as possible.\u003c/p\u003e\n\u003cp\u003eThe Register made the claim that \"any level of emulation such as QEMU\" would prevent the exploit from working. This is misleading because QEMU only makes sense in production when used with hardware acceleration (KVM). We were able to run the exploit with a GitHub Action using actuated on an AMD Epyc server from Equinix Metal using Firecracker and KVM.\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\"If you stick any emulation layer in between, such as Qemu, then the exploit understandably fails.\"\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eThe editors at The Register have since reached out and updated their article.\u003c/p\u003e\n\u003cp\u003eEven Firecracker with its isolated guest Kernel is vulnerable, which shows how serious the bug is, it's within the hardware itself. Of course it goes without saying that this also affects containerd, Docker (and by virtue Kubernetes) which share the host Kernel.\u003c/p\u003e\n\u003cp\u003eTo test this, we ran a GitHub Actions matrix build that creates many VMs running different versions of K3s. About the same time, we triggered a build which runs a Zenbleed exploit PoC written by \u003ca href=\"https://twitter.com/taviso\"\u003eTavis Ormandy\u003c/a\u003e, a security researcher at Google.\u003c/p\u003e\n\u003cp\u003eWe found that the exploit was able to read the memory of the host system, and that the exploit was able to read the memory of other VMs running on the same host.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ebuild\u003c/span\u003e\n\n\u003cspan class=\"hljs-attr\"\u003eon:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003epull_request:\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003ebranches:\u003c/span\u003e\n        \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'*'\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003epush:\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003ebranches:\u003c/span\u003e\n        \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003emaster\u003c/span\u003e\n        \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003emain\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003eworkflow_dispatch:\u003c/span\u003e\n\n\u003cspan class=\"hljs-attr\"\u003ejobs:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003ebuild:\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003especs\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003eruns-on:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eactuated\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003esteps:\u003c/span\u003e\n        \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eactions/checkout@v1\u003c/span\u003e\n        \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eDownload\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eexploit\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003erun:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e|\n            curl -L -S -s -O https://lock.cmpxchg8b.com/files/zenbleed-v5.tar.gz\n            tar -xvf zenbleed-v5.tar.gz\n            sudo apt install -qy build-essential make nasm\n\u003c/span\u003e        \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eBuild\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eexploit\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003erun:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e|\n            cd zenbleed\n            make\n            chmod +x ./zenbleed\n\u003c/span\u003e        \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eRun\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eexploit\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003efor\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1000 \u003c/span\u003e\u003cspan class=\"hljs-string\"\u003epieces\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eof\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edata\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003erun:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e|\n            ./zenbleed/zenbleed -m 1000\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eFull details of the exploit can be found on a microsite created by the security researcher who discovered the vulnerability. The \u003ccode\u003e-m 1000\u003c/code\u003e flag reads 1000 pieces of memory and then exits.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://lock.cmpxchg8b.com/zenbleed.html#vulnerability\"\u003eZenbleed by Tavis Ormandy\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eWe didn't see any secrets printed out during the scan, but we did see part of a public SSH key, console output from etcd running within K3s, and instructions from containerd. So we can assume anything that was within memory within one of the other VMs on the host, or even the host itself, could be read by the exploit.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/2023-07-zenbleed/gha.png\" alt=\"GHA output from the zenbleed exploit\"\u003e\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eGHA output from the zenbleed exploit\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch2\u003eMitigation\u003c/h2\u003e\n\u003cp\u003eAMD has already released a mitigation for the Zenbleed exploit, which requires an update to the CPU's microcode.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://www.linkedin.com/in/edwardvielmetti/\"\u003eEd Vielmetti\u003c/a\u003e, Developer Partner Manager at Equinix told us that mitigation is three-fold:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eThere is an incoming BIOS update from certain vendors that will update the microcode.\u003c/li\u003e\n\u003cli\u003eUpdating some OSes like the Ubuntu 20.04 and 22.04 will upgrade the microcode of the CPU.\u003c/li\u003e\n\u003cli\u003eThere is a \u003ca href=\"https://www.reddit.com/r/linux/comments/15903hr/zenbleed_a_useafterfree_in_amd_zen2_processors/\"\u003e\"chicken bit\"\u003c/a\u003e that can be enabled which prevents the exploit from working.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eI probably don't need to spell this out, but a system update looks like the following, and the reboot is required:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003esudo apt update -qy \u0026#x26;\u0026#x26; \\\n    sudo apt upgrade -yq \u0026#x26;\u0026#x26; \\\n    sudo reboot \n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cimg src=\"/images/2023-07-zenbleed/microcode.png\" alt=\"An update to the CPU microcode is required\"\u003e\u003c/p\u003e\n\u003cp\u003eFor some unknown reason, both of the Equinix AMD hosts that we use internally broke after running the OS upgrade, so I had to reinstall Ubuntu 22.04 using the dashboard. If for whatever reason the machine won't come up after the microcode update, then you should reinstall the Operating System (OS) using your vendor's rescue system or out of band console, both Equinix Metal and Hetzner have an \"easy button\" that you can click for this. If there is still an issue after that, reach out to your vendor's support team.\u003c/p\u003e\n\u003cp\u003eNew machines provisioned after this date should already contain the microcode fix or have the \"chicken bit\" enabled. We provisioned a new AMD Epyc server on Equinix Metal to make sure, and as expected, thanks to their hard work - it was not vulnerable.\u003c/p\u003e\n\u003cp\u003eWe offer 500 USD of free credit for new Equinix Metal customers to use with actuated, and Equinix Metal have also written up their own guide on workaround here:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://deploy.equinix.com/blog/an-update-on-the-amd-zen-2-cpu-vulnerability/\"\u003eAn Update On the AMD Zen 2 CPU Vulnerability\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eVerifying the mitigation\u003c/h2\u003e\n\u003cp\u003eSince actuated VMs use Firecracker, you should run the above workflow before and after to verify the exploit was a) present and b) mitigated.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/2023-07-zenbleed/mitigated.png\" alt=\"What it looks like when the mitigation is in place\"\u003e\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eAbove: What it looks like when the mitigation is in place\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eYou can also run the exploit on the host by copying and pasting the commands from the GitHub Action above.\u003c/p\u003e\n\u003cp\u003eMy workstation uses a Ryzen 9 CPU, so when I ran the exploit I just saw a blocking message instead of memory regions:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e$ grep \u003cspan class=\"hljs-string\"\u003e\"model name\"\u003c/span\u003e /proc/cpuinfo |\u003cspan class=\"hljs-built_in\"\u003euniq\u003c/span\u003e\nmodel name\t: AMD Ryzen 9 5950X 16-Core Processor\n\n./zenbleed -m 100\n*** EMBARGOED SECURITY ISSUE --  DO NOT DISTRIBUTE! ***\nZenBleed Testcase -- taviso@google.com\n\nNOTE: Try -h to see configuration options\n\nSpawning 32 Threads...\nThread 0x7fd0d40e8700 running on CPU 0\nThread 0x7fd0d38e7700 running on CPU 1\n...\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eYou can also run the following command to print out the microcode version. This is the output from the Equinix Metal server (c3.medium) that ran an OS update on:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e$ grep \u003cspan class=\"hljs-string\"\u003e'microcode'\u003c/span\u003e /proc/cpuinfo\nmicrocode\t: 0x830107a\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eWrapping up\u003c/h2\u003e\n\u003cp\u003eActuated uses \u003ca href=\"https://firecracker-microvm.github.io/\"\u003eFirecracker\u003c/a\u003e, an open source Virtual Machine Manager (VMM) that works with Linux KVM to run isolated systems on a host. We have verified that the exploit works on Firecracker, and that the mitigation works too. So whilst VM-level isolation and an immutable filesystem is much more appropriate than a container for CI, this is an example of why we must still be vigilant and ready to respond to security vulnerabilities.\u003c/p\u003e\n\u003cp\u003eThis is an unfortunate, and serious vulnerability. It affects bare-metal, VMs and containers, which is why it's important to update your systems as soon as possible.\u003c/p\u003e","title":"Update your AMD hosts now to mitigate the Zenbleed exploit","description":"Learn how to update the microcode on your AMD CPU to avoid the Zenbleed exploit.","tags":["images","packer","qemu","kvm"],"author_img":"alex","image":"/images/2023-07-zenbleed/background.png","date":"2023-07-31"}},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"amd-zenbleed-update-now"},"buildId":"RtuzClOr7buia8xWyHkqT","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>