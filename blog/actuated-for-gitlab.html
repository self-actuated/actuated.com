<!DOCTYPE html><html><head><meta charSet="utf-8" data-next-head=""/><meta name="viewport" content="width=device-width, initial-scale=1" data-next-head=""/><meta name="theme-color" content="#000000" data-next-head=""/><meta name="author" content="OpenFaaS Ltd" data-next-head=""/><meta name="twitter:card" content="summary_large_image" data-next-head=""/><title data-next-head="">Secure your GitLab jobs with microVMs and Actuated</title><meta name="description" content="Learn how microVMs provide more flexibility and security for CI workloads, by removing the need for privileged containers or Docker In Docker." data-next-head=""/><meta property="twitter:title" content="Secure your GitLab jobs with microVMs and Actuated" data-next-head=""/><meta property="twitter:description" content="Learn how microVMs provide more flexibility and security for CI workloads, by removing the need for privileged containers or Docker In Docker." data-next-head=""/><meta property="og:title" content="Secure your GitLab jobs with microVMs and Actuated" data-next-head=""/><meta property="og:description" content="Learn how microVMs provide more flexibility and security for CI workloads, by removing the need for privileged containers or Docker In Docker." data-next-head=""/><meta name="twitter:image:src" content="https://actuated.com/images/2024-07-gitlab/background.png" data-next-head=""/><meta property="og:image" content="https://actuated.com/images/2024-07-gitlab/background.png" data-next-head=""/><meta charSet="utf-8"/><link rel="icon" type="image/png" href="/images/actuated.png"/><link rel="stylesheet" href="https://rsms.me/inter/inter.css"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css"/><link rel="manifest" href="/manifest.json"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-M5YNDNX7VT"></script><script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'G-M5YNDNX7VT');
          </script><link rel="apple-touch-icon" href="/images/actuated.png"/><link rel="preload" href="/_next/static/css/827de7745fe30666.css" as="style"/><link rel="stylesheet" href="/_next/static/css/827de7745fe30666.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-fbb920bddf9bf0a6.js" defer=""></script><script src="/_next/static/chunks/framework-5757d75364ce2279.js" defer=""></script><script src="/_next/static/chunks/main-ef55e8b75fd0cd35.js" defer=""></script><script src="/_next/static/chunks/pages/_app-381d430d4a735a5d.js" defer=""></script><script src="/_next/static/chunks/762-703a014cadea8bf4.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bslug%5D-053ab830ac6cb307.js" defer=""></script><script src="/_next/static/duavaopCiT1mUkZ8QbzHi/_buildManifest.js" defer=""></script><script src="/_next/static/duavaopCiT1mUkZ8QbzHi/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="bg-white"><header><div class="relative bg-white" data-headlessui-state=""><div class="mx-auto flex max-w-7xl items-center justify-between px-4 py-6 sm:px-6 md:justify-start md:space-x-10 lg:px-8"><div class="flex justify-start lg:w-0 lg:flex-1"><a href="/"><span class="sr-only">Actuated</span><img class="h-8 w-auto sm:h-10" src="/images/actuated.png" alt="Actuated logo"/></a></div><div class="-my-2 -mr-2 md:hidden"><button class="inline-flex items-center justify-center rounded-md bg-white p-2 text-gray-400 hover:bg-gray-100 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500" type="button" aria-expanded="false" data-headlessui-state=""><span class="sr-only">Open menu</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" class="h-6 w-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"></path></svg></button></div><nav class="hidden space-x-10 md:flex"><div class="relative" data-headlessui-state=""><button class="text-gray-500 group inline-flex items-center rounded-md bg-white text-base font-medium hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" type="button" aria-expanded="false" data-headlessui-state=""><span>Solutions</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="text-gray-400 ml-2 h-5 w-5 group-hover:text-gray-500"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"></path></svg></button></div><span hidden="" style="position:fixed;top:1px;left:1px;width:1px;height:0;padding:0;margin:-1px;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border-width:0;display:none"></span><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/blog">Blog</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/blog/blazing-fast-ci-with-microvms">Announcement</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/pricing">Pricing</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="https://docs.actuated.com/">Docs</a></nav><span hidden="" style="position:fixed;top:1px;left:1px;width:1px;height:0;padding:0;margin:-1px;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border-width:0;display:none"></span><div class="hidden items-center justify-end md:flex md:flex-1 lg:w-0"><a href="https://dashboard.actuated.com" class="whitespace-nowrap text-base font-medium text-gray-500 hover:text-gray-900">Sign in</a><a href="/pricing" class="ml-8 inline-flex items-center justify-center whitespace-nowrap rounded-md border border-transparent bg-indigo-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-indigo-700">Sign-up</a></div></div></div><span hidden="" style="position:fixed;top:1px;left:1px;width:1px;height:0;padding:0;margin:-1px;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border-width:0;display:none"></span></header><main><div class="container mx-auto max-w-4xl bg-white mt-4 px-4 sm:px-6"><h1 id="post_title" class="text-3xl mb-3 leading-8 font-extrabold tracking-tight text-gray-900 sm:text-4xl sm:leading-10 text-center">Secure your GitLab jobs with microVMs and Actuated</h1></div><div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-4xl"><div class="border-b border-gray-200 py-4 flex items-center text-gray-500 mx-auto"><div><img class="h-10 w-10 rounded-full" src="/images/welteki.jpg" alt=""/></div><div class="ml-3"><p id="post_author" class="text-sm leading-5 font-medium text-gray-900"></p><div class="flex text-sm leading-5 text-gray-500"><time dateTime="2024-07-26" id="post_date">July 26, 2024</time><span class="mx-1"></span></div></div></div><div class="mt-6 prose sm:prose-lg max-w-none"><p id="post_description" class="mb-4">Learn how microVMs provide more flexibility and security for CI workloads, by removing the need for privileged containers or Docker In Docker.</p></div><div id="post_content" class="mt-6 prose sm:prose-lg max-w-none"><p>Last year we introduced the <a href="/blog/secure-microvm-ci-gitlab">tech preview for Actuated for GitLab CI</a>, since then we've had customer interest from enterprise companies who wanted to improve their security posture and to lower overheads. Actuated reduces management overheads of self-hosted runners and provides a secure, ephemeral microVM for every job.</p>
<p>We've made a lot of progress since the original version and are looking for additional customers who want to deliver an improved CI experience. In this article we will give you an overview of some of the available features and how they can benefit your GitLab CI.</p>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#run-jobs-in-microvms-with-actuated">Run jobs in microVMs with Actuated</a></li>
<li><a href="#mixed-docker-and-shell-executors">Mixed docker and shell executors</a></li>
<li><a href="#what-does-an-actuated-server-look-like">What does an actuated server look like?</a></li>
<li><a href="#private-peering">Private peering</a></li>
</ul>
<h2 id="why-are-microvms-the-future-of-ci">Why are microVMs the future of CI?</h2>
<p>It can be challenging to run GitLab CI/CD jobs that build and publish Docker images or jobs that require extensive system access in a safe way. Docker-in-Docker (DIND) requires the docker executor to run containers in privileged mode. Using the shell executor would give a job full access to the runner host and network. They can also leave behind side effects between builds as the runner is reused.</p>
<p>Using both approaches causes a significant security concern and the <a href="https://docs.gitlab.com/runner/security/">GitLab runner security docs</a> warn against it.</p>
<p><img src="/images/2024-07-gitlab/chart-warning.png" alt="Docker in Docker security notice printed out by the GitLab helm chart"></p>
<blockquote>
<p>Security notice displayed by the GitLab Helm chart to explain why docker in docker is disabled by default for security purposes.</p>
</blockquote>
<p>With Actuated, jobs run in ephemeral microVMs using Linux KVM for secure isolation. After the job is completed, the VM will be destroyed and removed from the GitLab instance. This allows us to safely run DIND and the shell executor in a fresh isolated environment for each job.</p>
<p>There are no horrible Kernel tricks or workarounds required to be able to use user namespaces, no need to change your tooling from what developers love - Docker, to <a href="https://github.com/GoogleContainerTools/kaniko">Kaniko</a> or <a href="https://buildah.io/">Buildah</a> or similar. You have <code>sudo</code> access and full VM with systemd available, things like <a href="https://kubernetes.io/">Kubernetes</a> will also work out of the box if you need them for end to end testing.</p>
<p><img src="/images/2024-07-gitlab/project-runners.png" alt="GitLab UI showing Actuated project runners"></p>
<blockquote>
<p>Runners get automatically added to a project and are removed again when they finish running a job.</p>
</blockquote>
<h2 id="run-jobs-in-microvms-with-actuated">Run jobs in microVMs with Actuated</h2>
<p>When a pipeline is triggered through a commit, merge request or in the UI the Actuated control plane gets notified through a webhook. For every job we schedule and run a new microVM and register it as a runner to the project. After the job is completed, the VM will be destroyed and removed from the GitLab instance. Scheduling and launching VMs is very fast. On average a new VM is booting up and running the job within 1 second.</p>
<p><img src="/images/2023-06-gitlab-preview/conceptual.png" alt="actuated for GitLab CI"></p>
<p>The agent will use either <a href="https://github.com/firecracker-microvm/firecracker">Firecracker</a> or <a href="https://www.cloudhypervisor.org/">Cloud Hypervisor</a> to launch microVMS depending on whether GPU support is required. microVMs boot almost instantly and in most cases will be faster than Kubernetes since the image is optimized and already available on each server.</p>
<p>To run jobs on Actuated the <code>actuated</code> tag has to be added to a job. One feature our customers like is the ability to configure the VM size for a job through the tag. Using the tag <code>actuated-4cpu-8gb</code> will schedule a VM with 4 vCPUs and 8 gigabytes of RAM.</p>
<p>You can pick any combination for vCPU and RAM. There's no need to pick a predefined runner size. This means that runners can be sized accordingly for the job they need to run so that the available CPU and memory resources can be used more efficiently.</p>
<p>Example <code>.gitlab-ci.yaml</code> that runs a job on Actuated runners using the docker executor:</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">image:</span> <span class="hljs-string">ruby:2.7</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">postgres:9.3</span>

<span class="hljs-attr">before_script:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">bundle</span> <span class="hljs-string">install</span>
<span class="hljs-attr">test:</span>
  <span class="hljs-attr">script:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">bundle</span> <span class="hljs-string">exec</span> <span class="hljs-string">rake</span> <span class="hljs-string">spec</span>
  <span class="hljs-attr">tags:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">actuated-4cpu-8gb</span>
</code></pre>
<h2 id="mixed-docker-and-shell-executors">Mixed Docker and Shell executors</h2>
<p>GitLab supports a number of executors to run builds in different environments. With Actuated we support running jobs with the <a href="https://docs.gitlab.com/runner/executors/docker.html">docker</a> and <a href="https://docs.gitlab.com/runner/executors/shell.html">shell</a> executor.</p>
<p>There is no need to pre-configure the type of executors you want to use. Actuated allows you to quickly select the executor for a job by adding an additional tag. Adding the <code>shell</code> tag to a job will launch a VM and register the GitLab runners using the shell executor. If no tag is provided the docker executor is used by default.</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">build-job:</span>
  <span class="hljs-attr">stage:</span> <span class="hljs-string">build</span>
  <span class="hljs-attr">script:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">echo</span> <span class="hljs-string">"Hi $GITLAB_USER_LOGIN!"</span>
  <span class="hljs-attr">tags:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">actuated-2cpu-4gb</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">shell</span>
</code></pre>
<p>With Actuated the shell executor can be used securely without leaving side effects behind that can influence job execution. A clean isolated build environment is provided for every job since the GitLab runner is started on an ephemeral VM that is removed as soon as the job has completed.</p>
<p>Using the shell executor in an isolated VM lets you safely run workloads like:</p>
<ul>
<li>Jobs that benefit from or need hardware acceleration e.g. the android emulator.</li>
<li>Jobs that require extensive system access.</li>
<li>Run a <a href="https://kind.sigs.k8s.io/">KinD</a> or <a href="https://k3s.io">K3s</a> cluster in CI for E2E testing.</li>
</ul>
<p>These kinds of jobs can be difficult to run in a docker container or would require the container to run in privileged mode which is unsafe and advised against in <a href="https://docs.gitlab.com/runner/security/#usage-of-docker-executor">GitLab runner security guidelines</a>.</p>
<p>Since jobs run in ephemeral VMs with Actuated it is also possible to run the docker executor safely in privileged mode. If you are already using the docker executor in privileged mode Actuated can improve the security of your jobs without making changes to your existing pipelines.</p>
<p>The following <code>.gitlab-ci.yaml</code> runs two jobs. The first job uses the docker executor to build and push a container image for an OpenFaaS function with Docker and the faas-cli. The second job sets the additional <code>shell</code> tag to request Actuated to run the job with the shell executor. By running the jobs with the shell executor we get access to the full ephemeral VM that is launched for the job. This makes it easy to bootstrap a K3s Kubernetes cluster with <a href="https://github.com/alexellis/k3sup">k3sup</a> for E2E testing the function with OpenFaaS.</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">stages:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">push</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">e2e</span>

<span class="hljs-attr">variables:</span>
  <span class="hljs-attr">DOCKER_DRIVER:</span> <span class="hljs-string">overlay2</span>
  <span class="hljs-attr">DOCKER_TLS_CERT_DIR:</span> <span class="hljs-string">""</span>

<span class="hljs-attr">push_job:</span>
  <span class="hljs-attr">stage:</span> <span class="hljs-string">push</span>
  <span class="hljs-attr">image:</span> <span class="hljs-string">docker:latest</span>
  <span class="hljs-attr">before_script:</span>
    <span class="hljs-comment"># Install dependencies: faas-cli</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">apk</span> <span class="hljs-string">add</span> <span class="hljs-string">--no-cache</span> <span class="hljs-string">git</span> <span class="hljs-string">curl</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">if</span> [ <span class="hljs-string">-f</span> <span class="hljs-string">"./faas-cli"</span> ] <span class="hljs-string">;</span> <span class="hljs-string">then</span> <span class="hljs-string">cp</span> <span class="hljs-string">./faas-cli</span> <span class="hljs-string">/usr/local/bin/faas-cli</span> <span class="hljs-string">||</span> <span class="hljs-number">0</span> <span class="hljs-string">;</span> <span class="hljs-string">fi</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">if</span> [ <span class="hljs-string">!</span> <span class="hljs-string">-f</span> <span class="hljs-string">"/usr/local/bin/faas-cli"</span> ] <span class="hljs-string">;</span> <span class="hljs-string">then</span> <span class="hljs-string">apk</span> <span class="hljs-string">add</span> <span class="hljs-string">--no-cache</span> <span class="hljs-string">curl</span> <span class="hljs-string">git</span> <span class="hljs-string">&#x26;&#x26;</span>
      <span class="hljs-string">curl</span> <span class="hljs-string">-sSL</span> <span class="hljs-string">https://cli.openfaas.com</span> <span class="hljs-string">|
      sh &#x26;&#x26; chmod +x /usr/local/bin/faas-cli &#x26;&#x26;
      cp /usr/local/bin/faas-cli ./faas-cli ; fi
</span>  <span class="hljs-attr">script:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">echo</span> <span class="hljs-string">$CI_JOB_TOKEN</span> <span class="hljs-string">|</span> <span class="hljs-string">docker</span> <span class="hljs-string">login</span> <span class="hljs-string">$CI_REGISTRY</span> <span class="hljs-string">\</span>
        <span class="hljs-string">-u</span> <span class="hljs-string">$CI_REGISTRY_USER</span> <span class="hljs-string">\</span>
        <span class="hljs-string">--password-stdin</span>

    <span class="hljs-comment"># Build and push an OpenFaaS function</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">/usr/local/bin/faas-cli</span> <span class="hljs-string">template</span> <span class="hljs-string">pull</span> <span class="hljs-string">stack</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">/usr/local/bin/faas-cli</span> <span class="hljs-string">publish</span>

  <span class="hljs-attr">tags:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">actuated-4cpu-8gb</span>

<span class="hljs-attr">e2e_job:</span>
  <span class="hljs-attr">stage:</span> <span class="hljs-string">e2e</span>
  <span class="hljs-attr">before_script:</span>
    <span class="hljs-comment"># Install dependencies: faas-cli kubectl kubectx k3sup</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">curl</span> <span class="hljs-string">-SLs</span> <span class="hljs-string">https://get.arkade.dev</span> <span class="hljs-string">|</span> <span class="hljs-string">sh</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">export</span> <span class="hljs-string">PATH=$PATH:$HOME/.arkade/bin/</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">arkade</span> <span class="hljs-string">get</span> <span class="hljs-string">faas-cli</span> <span class="hljs-string">kubectl</span> <span class="hljs-string">kubectx</span> <span class="hljs-string">k3sup</span> <span class="hljs-string">--progress=false</span>
  <span class="hljs-attr">script:</span>
    <span class="hljs-comment"># Deploy a K3s cluster.</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">|
      mkdir -p ~/.kube/
      k3sup install --local --local-path ~/.kube/config
      k3sup ready
</span>    <span class="hljs-bullet">-</span> <span class="hljs-string">kubectl</span> <span class="hljs-string">get</span> <span class="hljs-string">nodes</span>

    <span class="hljs-comment"># Install OpenFaaS on the local cluster.</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">mkdir</span> <span class="hljs-string">-p</span> <span class="hljs-string">~/.openfaas</span> <span class="hljs-string">&#x26;&#x26;</span> <span class="hljs-string">echo</span> <span class="hljs-string">$OPENFAAS_LICENSE</span> <span class="hljs-string">></span> <span class="hljs-string">~/.openfaas/LICENSE</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">|
      arkade install openfaas \
        --license-file ~/.openfaas/LICENSE \
        --operator \
        --clusterrole \
        --jetstream \
        --autoscaler
      kubectl get secret -n openfaas
      echo $OPENFAAS_LICENSE | wc
</span>    <span class="hljs-bullet">-</span> <span class="hljs-string">kubectl</span> <span class="hljs-string">create</span> <span class="hljs-string">secret</span> <span class="hljs-string">docker-registry</span> <span class="hljs-string">gitlab-ci-pull</span> <span class="hljs-string">\</span>
        <span class="hljs-string">--docker-server=$CI_REGISTRY</span> <span class="hljs-string">\</span>
        <span class="hljs-string">--docker-username=$CI_REGISTRY_USER</span> <span class="hljs-string">\</span>
        <span class="hljs-string">--docker-password=$CI_JOB_TOKEN</span> <span class="hljs-string">\</span>
        <span class="hljs-string">--docker-email=docker@example.com</span> <span class="hljs-string">\</span>
        <span class="hljs-string">--namespace</span> <span class="hljs-string">openfaas-fn</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">kubectl</span> <span class="hljs-string">rollout</span> <span class="hljs-string">status</span> <span class="hljs-string">-n</span> <span class="hljs-string">openfaas</span> <span class="hljs-string">deploy/gateway</span> <span class="hljs-string">--timeout=60s</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">|
      kubectl port-forward -n openfaas svc/gateway 8080:8080 &#x26;>/dev/null &#x26;
      echo -n "$!" > kubectl-pid.txt
</span>
      <span class="hljs-attr">echo PID for port-fowarding:</span> <span class="hljs-string">$(cat</span> <span class="hljs-string">kubectl-pid.txt)</span>

    <span class="hljs-bullet">-</span> <span class="hljs-string">faas-cli</span> <span class="hljs-string">ready</span> <span class="hljs-string">--attempts</span> <span class="hljs-number">120</span>

    <span class="hljs-bullet">-</span> <span class="hljs-string">|
      kubectl patch serviceaccount \
        -n openfaas-fn default \
        -p '{"imagePullSecrets": [{"name": "gitlab-ci-pull"}]}'
</span>
    <span class="hljs-comment"># Deploy the function that we build and pushed in the previous stage.</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">|
      echo $(kubectl get secret \
        -n openfaas basic-auth \
        -o jsonpath="{.data.basic-auth-password}" | base64 --decode; echo) |
      faas-cli login --username admin --password-stdin
</span>    <span class="hljs-bullet">-</span> <span class="hljs-string">faas-cli</span> <span class="hljs-string">template</span> <span class="hljs-string">pull</span> <span class="hljs-string">stack</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">CI_REGISTRY=$CI_REGISTRY</span> <span class="hljs-string">CI_COMMIT_SHORT_SHA=$CI_COMMIT_SHORT_SHA</span> <span class="hljs-string">faas-cli</span> <span class="hljs-string">deploy</span>

    <span class="hljs-comment"># Test the OpenFaaS function by invoking it.</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">faas-cli</span> <span class="hljs-string">ready</span> <span class="hljs-string">bcrypt</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">curl</span> <span class="hljs-string">-i</span> <span class="hljs-string">http://127.0.0.1:8080/function/bcrypt</span> <span class="hljs-string">-d</span> <span class="hljs-string">""</span>

    <span class="hljs-bullet">-</span> <span class="hljs-string">kill</span> <span class="hljs-number">-9</span> <span class="hljs-string">"$(cat kubectl-pid.txt)"</span>

  <span class="hljs-attr">tags:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">actuated-4cpu-8gb</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">shell</span>
</code></pre>
<h2 id="what-does-an-actuated-server-look-like">What does an actuated server look like?</h2>
<p>An actuated server is where VMs are run for your CI jobs. It needs a minimal server operating system, and there's rarely a reason to even log into the host once it's setup and connected to our control plane.</p>
<p>Actuated servers need to make use of <code>/dev/kvm</code>, so the processor and Kernel must support virtualization, most bare-metal servers support this without any additional configuration. Certain cloud VMs, OpenStack and VMware support KVM through nested virtualization.</p>
<p>The recommended Operating System is the LTS version of Ubuntu Server, then you just need to install our agent and enroll it with the actuated control plane.</p>
<p>If there happens to be some serious hardware failure or a major OS upgrade is required, then you can just re-image the disk and install the agent again, the whole process takes a couple of minutes.</p>
<h2 id="private-peering">Private peering</h2>
<p>You can host your actuated servers on the public cloud or on-premises in your own data center. For Internet facing hosts, just open port 80 and 443.</p>
<p>For hosts behind a private network, you can enable peering, which makes an outbound connection that passes through most firewalls, NAT, HTTP Proxies and VPNs without any additional configuration.</p>
<p>Agent peering simplifies agent setup and improves security:</p>
<ul>
<li>No additional networking, firewall, or routing changes</li>
<li>The agent is only available to the actuated control-plane</li>
<li>All traffic between the agent and the control plane is encrypted with TLS</li>
</ul>
<p><img src="/images/2024-07-gitlab/peering.png" alt="Private peering diagram"></p>
<blockquote>
<p>Peering example for an enterprise with two agents within their own private firewalls.</p>
</blockquote>
<h2 id="wrapping-up">Wrapping up</h2>
<p>Compared to GitLab CI's built-in solution, there is no Kubernetes cluster required. VMs are densely packed into a fleet of servers efficiently or kept in a queue until capacity becomes available.</p>
<p>Each VM is destroyed after the job has completed, so there are no side-effects to be concerned about, or server maintenance to be done.</p>
<p>Docker can be used natively without any of the risks with the built-in Kubernetes runners which use privileged Pods.</p>
<p>There is no need to add side-cars for BuildKit, Kaniko or to have to fight with the issues surrounding user-namespaces.</p>
<p>Everything is tested by our team, so you don't have to fine-tune or configure a Kernel, we ship the OS image and Kernel together and update them remotely.</p>
<p>Actuated for GitLab is available for self-hosted GitLab instances hosted on-premise or on the public cloud.</p>
<p><a href="https://docs.google.com/forms/d/e/1FAIpQLScA12IGyVFrZtSAp2Oj24OdaSMloqARSwoxx3AZbQbs0wpGww/viewform">Talk to us</a>, if you would like to see how Actuated can improve your GitLab CI.</p></div></div></main><footer class="bg-white"><div class="mx-auto max-w-7xl py-12 px-4 sm:px-6 md:flex md:items-center md:justify-between lg:px-8"><div class="flex justify-center space-x-6 md:order-2"><a class="text-gray-400 hover:text-gray-500" href="https://twitter.com/selfactuated"><span class="sr-only">Twitter</span><svg fill="currentColor" viewBox="0 0 24 24" class="h-6 w-6" aria-hidden="true"><path d="M8.29 20.251c7.547 0 11.675-6.253 11.675-11.675 0-.178 0-.355-.012-.53A8.348 8.348 0 0022 5.92a8.19 8.19 0 01-2.357.646 4.118 4.118 0 001.804-2.27 8.224 8.224 0 01-2.605.996 4.107 4.107 0 00-6.993 3.743 11.65 11.65 0 01-8.457-4.287 4.106 4.106 0 001.27 5.477A4.072 4.072 0 012.8 9.713v.052a4.105 4.105 0 003.292 4.022 4.095 4.095 0 01-1.853.07 4.108 4.108 0 003.834 2.85A8.233 8.233 0 012 18.407a11.616 11.616 0 006.29 1.84"></path></svg></a><a class="text-gray-400 hover:text-gray-500" href="https://github.com/self-actuated"><span class="sr-only">GitHub</span><svg fill="currentColor" viewBox="0 0 24 24" class="h-6 w-6" aria-hidden="true"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"></path></svg></a><a class="text-gray-400 hover:text-gray-500" href="/rss.xml"><span class="sr-only">RSS</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M12.75 19.5v-.75a7.5 7.5 0 00-7.5-7.5H4.5m0-6.75h.75c7.87 0 14.25 6.38 14.25 14.25v.75M6 18.75a.75.75 0 11-1.5 0 .75.75 0 011.5 0z"></path></svg></a></div><div class="mt-8 md:order-1 md:mt-0"><p class="text-center text-base text-gray-400">© 2024 <a href="https://openfaas.com">OpenFaaS Ltd</a>. All rights reserved. <a class="hover:underline" href="/terms">Terms &amp; Conditions.</a></p></div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"actuated-for-gitlab","fileName":"2024-07-26-actuated-for-gitlab.md","contentHtml":"\u003cp\u003eLast year we introduced the \u003ca href=\"/blog/secure-microvm-ci-gitlab\"\u003etech preview for Actuated for GitLab CI\u003c/a\u003e, since then we've had customer interest from enterprise companies who wanted to improve their security posture and to lower overheads. Actuated reduces management overheads of self-hosted runners and provides a secure, ephemeral microVM for every job.\u003c/p\u003e\n\u003cp\u003eWe've made a lot of progress since the original version and are looking for additional customers who want to deliver an improved CI experience. In this article we will give you an overview of some of the available features and how they can benefit your GitLab CI.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#introduction\"\u003eIntroduction\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#run-jobs-in-microvms-with-actuated\"\u003eRun jobs in microVMs with Actuated\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#mixed-docker-and-shell-executors\"\u003eMixed docker and shell executors\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#what-does-an-actuated-server-look-like\"\u003eWhat does an actuated server look like?\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#private-peering\"\u003ePrivate peering\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"why-are-microvms-the-future-of-ci\"\u003eWhy are microVMs the future of CI?\u003c/h2\u003e\n\u003cp\u003eIt can be challenging to run GitLab CI/CD jobs that build and publish Docker images or jobs that require extensive system access in a safe way. Docker-in-Docker (DIND) requires the docker executor to run containers in privileged mode. Using the shell executor would give a job full access to the runner host and network. They can also leave behind side effects between builds as the runner is reused.\u003c/p\u003e\n\u003cp\u003eUsing both approaches causes a significant security concern and the \u003ca href=\"https://docs.gitlab.com/runner/security/\"\u003eGitLab runner security docs\u003c/a\u003e warn against it.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/2024-07-gitlab/chart-warning.png\" alt=\"Docker in Docker security notice printed out by the GitLab helm chart\"\u003e\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eSecurity notice displayed by the GitLab Helm chart to explain why docker in docker is disabled by default for security purposes.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eWith Actuated, jobs run in ephemeral microVMs using Linux KVM for secure isolation. After the job is completed, the VM will be destroyed and removed from the GitLab instance. This allows us to safely run DIND and the shell executor in a fresh isolated environment for each job.\u003c/p\u003e\n\u003cp\u003eThere are no horrible Kernel tricks or workarounds required to be able to use user namespaces, no need to change your tooling from what developers love - Docker, to \u003ca href=\"https://github.com/GoogleContainerTools/kaniko\"\u003eKaniko\u003c/a\u003e or \u003ca href=\"https://buildah.io/\"\u003eBuildah\u003c/a\u003e or similar. You have \u003ccode\u003esudo\u003c/code\u003e access and full VM with systemd available, things like \u003ca href=\"https://kubernetes.io/\"\u003eKubernetes\u003c/a\u003e will also work out of the box if you need them for end to end testing.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/2024-07-gitlab/project-runners.png\" alt=\"GitLab UI showing Actuated project runners\"\u003e\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eRunners get automatically added to a project and are removed again when they finish running a job.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch2 id=\"run-jobs-in-microvms-with-actuated\"\u003eRun jobs in microVMs with Actuated\u003c/h2\u003e\n\u003cp\u003eWhen a pipeline is triggered through a commit, merge request or in the UI the Actuated control plane gets notified through a webhook. For every job we schedule and run a new microVM and register it as a runner to the project. After the job is completed, the VM will be destroyed and removed from the GitLab instance. Scheduling and launching VMs is very fast. On average a new VM is booting up and running the job within 1 second.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/2023-06-gitlab-preview/conceptual.png\" alt=\"actuated for GitLab CI\"\u003e\u003c/p\u003e\n\u003cp\u003eThe agent will use either \u003ca href=\"https://github.com/firecracker-microvm/firecracker\"\u003eFirecracker\u003c/a\u003e or \u003ca href=\"https://www.cloudhypervisor.org/\"\u003eCloud Hypervisor\u003c/a\u003e to launch microVMS depending on whether GPU support is required. microVMs boot almost instantly and in most cases will be faster than Kubernetes since the image is optimized and already available on each server.\u003c/p\u003e\n\u003cp\u003eTo run jobs on Actuated the \u003ccode\u003eactuated\u003c/code\u003e tag has to be added to a job. One feature our customers like is the ability to configure the VM size for a job through the tag. Using the tag \u003ccode\u003eactuated-4cpu-8gb\u003c/code\u003e will schedule a VM with 4 vCPUs and 8 gigabytes of RAM.\u003c/p\u003e\n\u003cp\u003eYou can pick any combination for vCPU and RAM. There's no need to pick a predefined runner size. This means that runners can be sized accordingly for the job they need to run so that the available CPU and memory resources can be used more efficiently.\u003c/p\u003e\n\u003cp\u003eExample \u003ccode\u003e.gitlab-ci.yaml\u003c/code\u003e that runs a job on Actuated runners using the docker executor:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-attr\"\u003eimage:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eruby:2.7\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003eservices:\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003epostgres:9.3\u003c/span\u003e\n\n\u003cspan class=\"hljs-attr\"\u003ebefore_script:\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ebundle\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003einstall\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003etest:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003escript:\u003c/span\u003e\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ebundle\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eexec\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003erake\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003espec\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003etags:\u003c/span\u003e\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eactuated-4cpu-8gb\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"mixed-docker-and-shell-executors\"\u003eMixed Docker and Shell executors\u003c/h2\u003e\n\u003cp\u003eGitLab supports a number of executors to run builds in different environments. With Actuated we support running jobs with the \u003ca href=\"https://docs.gitlab.com/runner/executors/docker.html\"\u003edocker\u003c/a\u003e and \u003ca href=\"https://docs.gitlab.com/runner/executors/shell.html\"\u003eshell\u003c/a\u003e executor.\u003c/p\u003e\n\u003cp\u003eThere is no need to pre-configure the type of executors you want to use. Actuated allows you to quickly select the executor for a job by adding an additional tag. Adding the \u003ccode\u003eshell\u003c/code\u003e tag to a job will launch a VM and register the GitLab runners using the shell executor. If no tag is provided the docker executor is used by default.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-attr\"\u003ebuild-job:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003estage:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ebuild\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003escript:\u003c/span\u003e\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"Hi $GITLAB_USER_LOGIN!\"\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003etags:\u003c/span\u003e\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eactuated-2cpu-4gb\u003c/span\u003e\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eshell\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWith Actuated the shell executor can be used securely without leaving side effects behind that can influence job execution. A clean isolated build environment is provided for every job since the GitLab runner is started on an ephemeral VM that is removed as soon as the job has completed.\u003c/p\u003e\n\u003cp\u003eUsing the shell executor in an isolated VM lets you safely run workloads like:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eJobs that benefit from or need hardware acceleration e.g. the android emulator.\u003c/li\u003e\n\u003cli\u003eJobs that require extensive system access.\u003c/li\u003e\n\u003cli\u003eRun a \u003ca href=\"https://kind.sigs.k8s.io/\"\u003eKinD\u003c/a\u003e or \u003ca href=\"https://k3s.io\"\u003eK3s\u003c/a\u003e cluster in CI for E2E testing.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThese kinds of jobs can be difficult to run in a docker container or would require the container to run in privileged mode which is unsafe and advised against in \u003ca href=\"https://docs.gitlab.com/runner/security/#usage-of-docker-executor\"\u003eGitLab runner security guidelines\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eSince jobs run in ephemeral VMs with Actuated it is also possible to run the docker executor safely in privileged mode. If you are already using the docker executor in privileged mode Actuated can improve the security of your jobs without making changes to your existing pipelines.\u003c/p\u003e\n\u003cp\u003eThe following \u003ccode\u003e.gitlab-ci.yaml\u003c/code\u003e runs two jobs. The first job uses the docker executor to build and push a container image for an OpenFaaS function with Docker and the faas-cli. The second job sets the additional \u003ccode\u003eshell\u003c/code\u003e tag to request Actuated to run the job with the shell executor. By running the jobs with the shell executor we get access to the full ephemeral VM that is launched for the job. This makes it easy to bootstrap a K3s Kubernetes cluster with \u003ca href=\"https://github.com/alexellis/k3sup\"\u003ek3sup\u003c/a\u003e for E2E testing the function with OpenFaaS.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-attr\"\u003estages:\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003epush\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ee2e\u003c/span\u003e\n\n\u003cspan class=\"hljs-attr\"\u003evariables:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003eDOCKER_DRIVER:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eoverlay2\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003eDOCKER_TLS_CERT_DIR:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"\"\u003c/span\u003e\n\n\u003cspan class=\"hljs-attr\"\u003epush_job:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003estage:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003epush\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003eimage:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edocker:latest\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003ebefore_script:\u003c/span\u003e\n    \u003cspan class=\"hljs-comment\"\u003e# Install dependencies: faas-cli\u003c/span\u003e\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eapk\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eadd\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e--no-cache\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003egit\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ecurl\u003c/span\u003e\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eif\u003c/span\u003e [ \u003cspan class=\"hljs-string\"\u003e-f\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"./faas-cli\"\u003c/span\u003e ] \u003cspan class=\"hljs-string\"\u003e;\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ethen\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ecp\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e./faas-cli\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e/usr/local/bin/faas-cli\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e||\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e;\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003efi\u003c/span\u003e\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eif\u003c/span\u003e [ \u003cspan class=\"hljs-string\"\u003e!\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e-f\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"/usr/local/bin/faas-cli\"\u003c/span\u003e ] \u003cspan class=\"hljs-string\"\u003e;\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ethen\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eapk\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eadd\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e--no-cache\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ecurl\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003egit\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e\n      \u003cspan class=\"hljs-string\"\u003ecurl\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e-sSL\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ehttps://cli.openfaas.com\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e|\n      sh \u0026#x26;\u0026#x26; chmod +x /usr/local/bin/faas-cli \u0026#x26;\u0026#x26;\n      cp /usr/local/bin/faas-cli ./faas-cli ; fi\n\u003c/span\u003e  \u003cspan class=\"hljs-attr\"\u003escript:\u003c/span\u003e\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e$CI_JOB_TOKEN\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e|\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edocker\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003elogin\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e$CI_REGISTRY\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\\\u003c/span\u003e\n        \u003cspan class=\"hljs-string\"\u003e-u\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e$CI_REGISTRY_USER\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\\\u003c/span\u003e\n        \u003cspan class=\"hljs-string\"\u003e--password-stdin\u003c/span\u003e\n\n    \u003cspan class=\"hljs-comment\"\u003e# Build and push an OpenFaaS function\u003c/span\u003e\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e/usr/local/bin/faas-cli\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003etemplate\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003epull\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003estack\u003c/span\u003e\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e/usr/local/bin/faas-cli\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003epublish\u003c/span\u003e\n\n  \u003cspan class=\"hljs-attr\"\u003etags:\u003c/span\u003e\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eactuated-4cpu-8gb\u003c/span\u003e\n\n\u003cspan class=\"hljs-attr\"\u003ee2e_job:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003estage:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ee2e\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003ebefore_script:\u003c/span\u003e\n    \u003cspan class=\"hljs-comment\"\u003e# Install dependencies: faas-cli kubectl kubectx k3sup\u003c/span\u003e\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ecurl\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e-SLs\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ehttps://get.arkade.dev\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e|\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esh\u003c/span\u003e\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ePATH=$PATH:$HOME/.arkade/bin/\u003c/span\u003e\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003earkade\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eget\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003efaas-cli\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ekubectl\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ekubectx\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ek3sup\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e--progress=false\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003escript:\u003c/span\u003e\n    \u003cspan class=\"hljs-comment\"\u003e# Deploy a K3s cluster.\u003c/span\u003e\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e|\n      mkdir -p ~/.kube/\n      k3sup install --local --local-path ~/.kube/config\n      k3sup ready\n\u003c/span\u003e    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ekubectl\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eget\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003enodes\u003c/span\u003e\n\n    \u003cspan class=\"hljs-comment\"\u003e# Install OpenFaaS on the local cluster.\u003c/span\u003e\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003emkdir\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e-p\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e~/.openfaas\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e$OPENFAAS_LICENSE\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e~/.openfaas/LICENSE\u003c/span\u003e\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e|\n      arkade install openfaas \\\n        --license-file ~/.openfaas/LICENSE \\\n        --operator \\\n        --clusterrole \\\n        --jetstream \\\n        --autoscaler\n      kubectl get secret -n openfaas\n      echo $OPENFAAS_LICENSE | wc\n\u003c/span\u003e    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ekubectl\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ecreate\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esecret\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edocker-registry\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003egitlab-ci-pull\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\\\u003c/span\u003e\n        \u003cspan class=\"hljs-string\"\u003e--docker-server=$CI_REGISTRY\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\\\u003c/span\u003e\n        \u003cspan class=\"hljs-string\"\u003e--docker-username=$CI_REGISTRY_USER\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\\\u003c/span\u003e\n        \u003cspan class=\"hljs-string\"\u003e--docker-password=$CI_JOB_TOKEN\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\\\u003c/span\u003e\n        \u003cspan class=\"hljs-string\"\u003e--docker-email=docker@example.com\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\\\u003c/span\u003e\n        \u003cspan class=\"hljs-string\"\u003e--namespace\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eopenfaas-fn\u003c/span\u003e\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ekubectl\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003erollout\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003estatus\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e-n\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eopenfaas\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edeploy/gateway\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e--timeout=60s\u003c/span\u003e\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e|\n      kubectl port-forward -n openfaas svc/gateway 8080:8080 \u0026#x26;\u003e/dev/null \u0026#x26;\n      echo -n \"$!\" \u003e kubectl-pid.txt\n\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003eecho PID for port-fowarding:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e$(cat\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ekubectl-pid.txt)\u003c/span\u003e\n\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003efaas-cli\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eready\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e--attempts\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e120\u003c/span\u003e\n\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e|\n      kubectl patch serviceaccount \\\n        -n openfaas-fn default \\\n        -p '{\"imagePullSecrets\": [{\"name\": \"gitlab-ci-pull\"}]}'\n\u003c/span\u003e\n    \u003cspan class=\"hljs-comment\"\u003e# Deploy the function that we build and pushed in the previous stage.\u003c/span\u003e\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e|\n      echo $(kubectl get secret \\\n        -n openfaas basic-auth \\\n        -o jsonpath=\"{.data.basic-auth-password}\" | base64 --decode; echo) |\n      faas-cli login --username admin --password-stdin\n\u003c/span\u003e    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003efaas-cli\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003etemplate\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003epull\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003estack\u003c/span\u003e\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eCI_REGISTRY=$CI_REGISTRY\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eCI_COMMIT_SHORT_SHA=$CI_COMMIT_SHORT_SHA\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003efaas-cli\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edeploy\u003c/span\u003e\n\n    \u003cspan class=\"hljs-comment\"\u003e# Test the OpenFaaS function by invoking it.\u003c/span\u003e\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003efaas-cli\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eready\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ebcrypt\u003c/span\u003e\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ecurl\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e-i\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ehttp://127.0.0.1:8080/function/bcrypt\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e-d\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"\"\u003c/span\u003e\n\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ekill\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e-9\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"$(cat kubectl-pid.txt)\"\u003c/span\u003e\n\n  \u003cspan class=\"hljs-attr\"\u003etags:\u003c/span\u003e\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eactuated-4cpu-8gb\u003c/span\u003e\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eshell\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"what-does-an-actuated-server-look-like\"\u003eWhat does an actuated server look like?\u003c/h2\u003e\n\u003cp\u003eAn actuated server is where VMs are run for your CI jobs. It needs a minimal server operating system, and there's rarely a reason to even log into the host once it's setup and connected to our control plane.\u003c/p\u003e\n\u003cp\u003eActuated servers need to make use of \u003ccode\u003e/dev/kvm\u003c/code\u003e, so the processor and Kernel must support virtualization, most bare-metal servers support this without any additional configuration. Certain cloud VMs, OpenStack and VMware support KVM through nested virtualization.\u003c/p\u003e\n\u003cp\u003eThe recommended Operating System is the LTS version of Ubuntu Server, then you just need to install our agent and enroll it with the actuated control plane.\u003c/p\u003e\n\u003cp\u003eIf there happens to be some serious hardware failure or a major OS upgrade is required, then you can just re-image the disk and install the agent again, the whole process takes a couple of minutes.\u003c/p\u003e\n\u003ch2 id=\"private-peering\"\u003ePrivate peering\u003c/h2\u003e\n\u003cp\u003eYou can host your actuated servers on the public cloud or on-premises in your own data center. For Internet facing hosts, just open port 80 and 443.\u003c/p\u003e\n\u003cp\u003eFor hosts behind a private network, you can enable peering, which makes an outbound connection that passes through most firewalls, NAT, HTTP Proxies and VPNs without any additional configuration.\u003c/p\u003e\n\u003cp\u003eAgent peering simplifies agent setup and improves security:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eNo additional networking, firewall, or routing changes\u003c/li\u003e\n\u003cli\u003eThe agent is only available to the actuated control-plane\u003c/li\u003e\n\u003cli\u003eAll traffic between the agent and the control plane is encrypted with TLS\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/images/2024-07-gitlab/peering.png\" alt=\"Private peering diagram\"\u003e\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003ePeering example for an enterprise with two agents within their own private firewalls.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch2 id=\"wrapping-up\"\u003eWrapping up\u003c/h2\u003e\n\u003cp\u003eCompared to GitLab CI's built-in solution, there is no Kubernetes cluster required. VMs are densely packed into a fleet of servers efficiently or kept in a queue until capacity becomes available.\u003c/p\u003e\n\u003cp\u003eEach VM is destroyed after the job has completed, so there are no side-effects to be concerned about, or server maintenance to be done.\u003c/p\u003e\n\u003cp\u003eDocker can be used natively without any of the risks with the built-in Kubernetes runners which use privileged Pods.\u003c/p\u003e\n\u003cp\u003eThere is no need to add side-cars for BuildKit, Kaniko or to have to fight with the issues surrounding user-namespaces.\u003c/p\u003e\n\u003cp\u003eEverything is tested by our team, so you don't have to fine-tune or configure a Kernel, we ship the OS image and Kernel together and update them remotely.\u003c/p\u003e\n\u003cp\u003eActuated for GitLab is available for self-hosted GitLab instances hosted on-premise or on the public cloud.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://docs.google.com/forms/d/e/1FAIpQLScA12IGyVFrZtSAp2Oj24OdaSMloqARSwoxx3AZbQbs0wpGww/viewform\"\u003eTalk to us\u003c/a\u003e, if you would like to see how Actuated can improve your GitLab CI.\u003c/p\u003e","title":"Secure your GitLab jobs with microVMs and Actuated","description":"Learn how microVMs provide more flexibility and security for CI workloads, by removing the need for privileged containers or Docker In Docker.","tags":["gitlab","security","docker"],"author_img":"welteki","image":"/images/2024-07-gitlab/background.png","date":"2024-07-26"}},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"actuated-for-gitlab"},"buildId":"duavaopCiT1mUkZ8QbzHi","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>