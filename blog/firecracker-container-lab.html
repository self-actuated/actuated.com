<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="theme-color" content="#000000"/><meta name="author" content="OpenFaaS Ltd"/><meta name="twitter:card" content="summary_large_image"/><title>Grab your lab coat - we&#x27;re building a microVM from a container</title><meta name="description" content="No more broken tutorials, build a microVM from a container, boot it, access the Internet"/><meta property="twitter:title" content="Grab your lab coat - we&#x27;re building a microVM from a container"/><meta property="twitter:description" content="No more broken tutorials, build a microVM from a container, boot it, access the Internet"/><meta property="og:title" content="Grab your lab coat - we&#x27;re building a microVM from a container"/><meta property="og:description" content="No more broken tutorials, build a microVM from a container, boot it, access the Internet"/><meta name="twitter:image:src" content="https://actuated.dev/images/2023-09-firecracker-lab/background.png"/><meta property="og:image" content="https://actuated.dev/images/2023-09-firecracker-lab/background.png"/><meta name="next-head-count" content="13"/><meta charSet="utf-8"/><link rel="icon" type="image/png" href="/images/actuated.png"/><link rel="stylesheet" href="https://rsms.me/inter/inter.css"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css"/><link rel="manifest" href="/manifest.json"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-M5YNDNX7VT"></script><script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'G-M5YNDNX7VT');
          </script><link rel="apple-touch-icon" href="/images/actuated.png"/><link rel="preload" href="/_next/static/css/276d48e5793b405e.css" as="style"/><link rel="stylesheet" href="/_next/static/css/276d48e5793b405e.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-8fa1640cc84ba8fe.js" defer=""></script><script src="/_next/static/chunks/framework-114634acb84f8baa.js" defer=""></script><script src="/_next/static/chunks/main-34e2100d07ae5757.js" defer=""></script><script src="/_next/static/chunks/pages/_app-c5247403fc8e2604.js" defer=""></script><script src="/_next/static/chunks/552-542f150c917a7625.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bslug%5D-109b0d2eddac75b5.js" defer=""></script><script src="/_next/static/iwf6Rhft0sDPfFlkRFSYB/_buildManifest.js" defer=""></script><script src="/_next/static/iwf6Rhft0sDPfFlkRFSYB/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="bg-white"><header><div class="relative bg-white" data-headlessui-state=""><div class="mx-auto flex max-w-7xl items-center justify-between px-4 py-6 sm:px-6 md:justify-start md:space-x-10 lg:px-8"><div class="flex justify-start lg:w-0 lg:flex-1"><a href="/"><span class="sr-only">Actuated</span><img class="h-8 w-auto sm:h-10" src="/images/actuated.png" alt="Actuated logo"/></a></div><div class="-my-2 -mr-2 md:hidden"><button class="inline-flex items-center justify-center rounded-md bg-white p-2 text-gray-400 hover:bg-gray-100 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500" type="button" aria-expanded="false" data-headlessui-state=""><span class="sr-only">Open menu</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" class="h-6 w-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"></path></svg></button></div><nav class="hidden space-x-10 md:flex"><div class="relative" data-headlessui-state=""><button class="text-gray-500 group inline-flex items-center rounded-md bg-white text-base font-medium hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" type="button" aria-expanded="false" data-headlessui-state=""><span>Solutions</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="text-gray-400 ml-2 h-5 w-5 group-hover:text-gray-500"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"></path></svg></button></div><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/blog">Blog</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="https://actuated.dev/blog/blazing-fast-ci-with-microvms">Announcement</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="https://docs.actuated.dev/">Docs</a></nav><div class="hidden items-center justify-end md:flex md:flex-1 lg:w-0"><a href="https://dashboard.actuated.dev" class="whitespace-nowrap text-base font-medium text-gray-500 hover:text-gray-900">Sign in</a><a href="https://docs.actuated.dev/register/" class="ml-8 inline-flex items-center justify-center whitespace-nowrap rounded-md border border-transparent bg-indigo-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-indigo-700">Sign-up</a></div></div></div></header><main><div class="container mx-auto max-w-4xl bg-white mt-4 px-4 sm:px-6"><h1 id="post_title" class="text-3xl mb-3 leading-8 font-extrabold tracking-tight text-gray-900 sm:text-4xl sm:leading-10 text-center">Grab your lab coat - we&#x27;re building a microVM from a container</h1></div><div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-4xl"><div class="border-b border-gray-200 py-4 flex items-center text-gray-500 mx-auto"><div><img class="h-10 w-10 rounded-full" src="/images/alex.jpg" alt=""/></div><div class="ml-3"><p id="post_author" class="text-sm leading-5 font-medium text-gray-900"></p><div class="flex text-sm leading-5 text-gray-500"><time dateTime="2023-09-05" id="post_date">September 5, 2023</time><span class="mx-1"></span></div></div></div><div class="mt-6 prose sm:prose-lg max-w-none"><p id="post_description" class="mb-4">No more broken tutorials, build a microVM from a container, boot it, access the Internet</p></div><div id="post_content" class="mt-6 prose sm:prose-lg max-w-none"><p>When I started learning <a href="https://github.com/firecracker-microvm/firecracker">Firecracker</a>, I ran into frustration after frustration with broken tutorials that were popular in their day, but just hadn't been kept up to date. Almost nothing worked, or was far too complex for the level of interest I had at the time. Most recently, one of the Firecracker maintainers in an effort to make the quickstart better, made it even harder to use. (You can still get a copy of the <a href="https://actuated.dev/blog/kvm-in-github-actions">original Firecracker quickstart in our tutorial on nested virtualisation</a>)</p>
<p>So I wrote a lab that takes a container image and converts it to a microVM. You'll get your hands dirty, you'll run a microVM, you'll be able to use <code>curl</code> and <code>ssh</code>, even expose a HTTP server to the Internet via inlets, if (like me), you find that kind of thing fun.</p>
<p>Why would you want to explore Firecracker? A friend of mine, <a href="https://iximiuz.com/en/about/">Ivan Velichko</a> is a prolific writer on containers, and Docker. He is one of the biggest independent evangelists for containers and Kubernetes that I know.</p>
<p>So when he wanted to build an <a href="https://labs.iximiuz.com/">online labs and training environment</a>, why did he pick Firecracker instead? Simply put, he told us that containers don't cut it. He needed something that would mirror the type of machine that you'd encounter in production, when you provision an EC2 instance or a GCP VM. Running Docker, Kubernetes, and performing are hard to do securely within a container, and he knew that was important for his students.</p>
<p>For us - we had very similar reasons for picking Firecracker for a secure CI solution. Too often the security issues around running privileged containers, and the slow speed of <a href="https://jpetazzo.github.io/2015/09/03/do-not-use-docker-in-docker-for-ci/">Docker In Docker's (DIND)</a> Virtual Filesystem Driver (VFS), are ignored. Heads are put into the sand. We couldn't do that and <a href="https://actuated.dev/blog/blazing-fast-ci-with-microvms">developed actuated.dev</a> as a result. Since we launched the pilot, we've now run over 110k VMs for customer CI jobs on GitHub Actions, and have a <a href="https://actuated.dev/blog/secure-microvm-ci-gitlab">tech preview for GitLab CI</a> where a job can be running within 1 second of pushing a "commit".</p>
<p>So let's get that microVM running for you?</p>
<h2>How it works ðŸ”¬</h2>
<p>How to build a microVM from a container</p>
<p><img src="/images/2023-09-firecracker-lab/conceptual.png" alt="/images/2023-09-firecracker-lab/conceptual.png"></p>
<blockquote>
<p>Conceptual archicture of the lab</p>
</blockquote>
<p>Here's what we'll be doing:</p>
<ul>
<li>Build a root-filesystem from a container image from the Docker Hub</li>
<li>Download a pre-built Linux Kernel from the Firecracker team</li>
<li>Build an init system written in Go</li>
<li>Build a disk image with the init system and root-filesystem</li>
<li>Configure a networking tap device and IP masquerading</li>
<li>Start a Firecracker process in the background</li>
<li>Configure the Firecracker process via curl statements to a UNIX socket</li>
<li>Finally, issue a boot command and try it out</li>
</ul>
<p>Let's look at why we need a init, instead of just running the entrypoint of a container.</p>
<p>Whilst in theory, you can start a microVM where the first process (PID 1) is your workload, in the same way as Docker, it will leave you with a system which is not properly initialised with things like a /proc/ filesystem, tempfs, hostname, and other things that you'd expect to find in a Linux system.</p>
<p>For that reason, you'll need to either install systemd into the container image you want to use, or build your own basic init system, which sets up the machine, then starts your workload.</p>
<p>We're doing the latter here.</p>
<p>In the below program, you'll see key devices and files mounted, to make a functional system. The hostname is then set by using a syscall, and finally <code>/bin/sh</code> is started. You could also start a specific binary, or build an agent into the init for Remote Procedure Calls (RPC) to start and stop your workload, and to query metrics.</p>
<p>The team at <a href="https://fly.io">Fly.io</a> built their own init and agent combined, and opened-sourced a very early version: <a href="https://github.com/superfly/init-snapshot">github.com/superfly/init-snapshot</a>.</p>
<p>You'll find my init in: <code>./init/main.go</code>:</p>
<pre><code class="hljs language-go"><span class="hljs-comment">// Copyright Alex Ellis 2023</span>

<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"fmt"</span>
	<span class="hljs-string">"log"</span>
	<span class="hljs-string">"os"</span>
	<span class="hljs-string">"os/exec"</span>

	<span class="hljs-string">"syscall"</span>
)

<span class="hljs-keyword">const</span> paths = <span class="hljs-string">"PATH=/usr/local/bin:/usr/local/sbin:/usr/bin:/usr/sbin:/bin:/sbin"</span>

<span class="hljs-comment">// main starts an init process that can prepare an environment and start a shell</span>
<span class="hljs-comment">// after the Kernel has started.</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	fmt.Printf(<span class="hljs-string">"Lab init booting\nCopyright Alex Ellis 2022, OpenFaaS Ltd\n"</span>)

	mount(<span class="hljs-string">"none"</span>, <span class="hljs-string">"/proc"</span>, <span class="hljs-string">"proc"</span>, <span class="hljs-number">0</span>)
	mount(<span class="hljs-string">"none"</span>, <span class="hljs-string">"/dev/pts"</span>, <span class="hljs-string">"devpts"</span>, <span class="hljs-number">0</span>)
	mount(<span class="hljs-string">"none"</span>, <span class="hljs-string">"/dev/mqueue"</span>, <span class="hljs-string">"mqueue"</span>, <span class="hljs-number">0</span>)
	mount(<span class="hljs-string">"none"</span>, <span class="hljs-string">"/dev/shm"</span>, <span class="hljs-string">"tmpfs"</span>, <span class="hljs-number">0</span>)
	mount(<span class="hljs-string">"none"</span>, <span class="hljs-string">"/sys"</span>, <span class="hljs-string">"sysfs"</span>, <span class="hljs-number">0</span>)
	mount(<span class="hljs-string">"none"</span>, <span class="hljs-string">"/sys/fs/cgroup"</span>, <span class="hljs-string">"cgroup"</span>, <span class="hljs-number">0</span>)

	setHostname(<span class="hljs-string">"lab-vm"</span>)

	fmt.Printf(<span class="hljs-string">"Lab starting /bin/sh\n"</span>)

	cmd := exec.Command(<span class="hljs-string">"/bin/sh"</span>)

	cmd.Env = <span class="hljs-built_in">append</span>(cmd.Env, paths)
	cmd.Stdin = os.Stdin
	cmd.Stdout = os.Stdout
	cmd.Stderr = os.Stderr

	err := cmd.Start()
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-built_in">panic</span>(fmt.Sprintf(<span class="hljs-string">"could not start /bin/sh, error: %s"</span>, err))
	}

	err = cmd.Wait()
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-built_in">panic</span>(fmt.Sprintf(<span class="hljs-string">"could not wait for /bin/sh, error: %s"</span>, err))
	}
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">setHostname</span><span class="hljs-params">(hostname <span class="hljs-type">string</span>)</span></span> {
	err := syscall.Sethostname([]<span class="hljs-type">byte</span>(hostname))
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-built_in">panic</span>(fmt.Sprintf(<span class="hljs-string">"cannot set hostname to %s, error: %s"</span>, hostname, err))
	}
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">mount</span><span class="hljs-params">(source, target, filesystemtype <span class="hljs-type">string</span>, flags <span class="hljs-type">uintptr</span>)</span></span> {

	<span class="hljs-keyword">if</span> _, err := os.Stat(target); os.IsNotExist(err) {
		err := os.MkdirAll(target, <span class="hljs-number">0755</span>)
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
			<span class="hljs-built_in">panic</span>(fmt.Sprintf(<span class="hljs-string">"error creating target folder: %s %s"</span>, target, err))
		}
	}

	err := syscall.Mount(source, target, filesystemtype, flags, <span class="hljs-string">""</span>)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Printf(<span class="hljs-string">"%s"</span>, fmt.Errorf(<span class="hljs-string">"error mounting %s to %s, error: %s"</span>, source, target, err))
	}
}
</code></pre>
<h2>What you'll need</h2>
<p><a href="https://github.com/firecracker-microvm/firecracker">Firecracker</a> is a Virtual Machine Monitor (VMM) that leans on Linux's KVM functionality to run VMs. Its beauty is in its simplicity, however even though it doesn't need a lot, you will need KVM to be available. If you have a bare-metal machine, like your own PC, or an old server or laptop, you're all set. There's also plenty of options for bare-metal in the cloud - billed either on a per minute/hour basis or per month.</p>
<p>And finally, for quick testing, <a href="https://m.do.co/c/8d4e75e9886f">DigitalOcean</a>, GCP, and Azure all support what is known as "Nested Virtualization". That's where you obtain a VM, which itself can start further VMs, it's not as fast as bare-metal, but it's cheap and works.</p>
<p>Finally, whilst Firecracker and actuated (our CI product) both support Arm, and Raspberry Pi, this tutorial is only available for `x86_64`` to keep the instructions simple.</p>
<h2>Provision the machine</h2>
<p>I'd recommend you use Ubuntu 22.04, so that you can copy and paste instructions from this tutorial.</p>
<p>Install Docker CE</p>
<pre><code class="hljs language-bash">curl -fsSL https://get.docker.com  | sudo sh
</code></pre>
<p>Docker will be used to fetch an initial Operating System, to build the init system, and to customise the root filesystem.</p>
<p>Install arkade, which gives you an easy way to install Firecracker:</p>
<pre><code class="hljs language-bash">curl -sLS https://get.arkade.dev | sudo sh
</code></pre>
<p>Install Firecracker:</p>
<pre><code class="hljs language-bash">sudo arkade system install firecracker
</code></pre>
<h2>Clone the lab</h2>
<p>Clone the lab onto the machine:</p>
<pre><code class="hljs language-bash">git <span class="hljs-built_in">clone</span> https://github.com/alexellis/firecracker-init-lab --depth=1

<span class="hljs-built_in">cd</span> firecracker-init-lab
</code></pre>
<h3>Update the networking script</h3>
<p>Find out what the primary interface is on the machine using <code>ip addr</code> or <code>ifconfig</code>.</p>
<p>Edit <code>./setup-networking.sh</code>:</p>
<pre><code>IFNAME=enp8s0
</code></pre>
<p>The script will configure a TAP device which bridges microVMs to your host, then sets up IP forwarding and masquerading so that the microVMs can access the Internet.</p>
<p>Run <code>./setup-networking.sh</code> to setup the TAP device.</p>
<h3>Download the Kernel</h3>
<p>Add <code>make</code> via <code>build-essential</code>:</p>
<pre><code class="hljs language-bash">sudo apt update &#x26;&#x26; sudo apt install -y build-essential
</code></pre>
<p>Run <code>make kernel</code> to download the quickstart Kernel made available by the Firecracker team. Of course, you can build your own, but bear in mind that Firecracker does not have PCI support, so many of the ones you'll find on the Internet will not be appropriate.</p>
<p>This Makefile target will not actually build a new Kernel, but wil download one that the Firecracker team have pre-built and uploaded to S3.</p>
<h3>Make the container image</h3>
<p>Here's the Dockerfile we'll use to build the init system in a multi-stage build, then derive from Alpine Linux for the runtime, this could of course be anything like Ubuntu 22.04, Python, or Node.</p>
<p><code>./Dockerfile</code>:</p>
<pre><code>FROM golang:1.20-alpine as build

WORKDIR /go/src/github.com/alexellis/firecracker-init-lab/init

COPY init .

RUN go build --tags netgo --ldflags '-s -w -extldflags "-lm -lstdc++ -static"' -o init main.go

FROM alpine:3.18 as runtime

RUN apk add --no-cache curl ca-certificates htop

COPY --from=build /go/src/github.com/alexellis/firecracker-init-lab/init/init /init
</code></pre>
<p>I've added in a few extra packages to play with.</p>
<p>Run <code>make root</code>, and you'll see an image in your library:</p>
<pre><code>docker images | grep alexellis2/custom-init

REPOSITORY                                                          TAG                                                                      IMAGE ID       CREATED         SIZE
alexellis2/custom-init                                              latest                                                                   f89aa7f3dd27   20 hours ago    13.7MB
</code></pre>
<h3>Build the disk image</h3>
<p>Firecracker needs a disk image, or an existing block device as its boot drive. You can make this dynamically as required, run <code>make extract</code> to extract the container image into the local filesystem as <code>rootfs.tar</code>.</p>
<p>This step uses <code>docker create</code> followed by <code>docker export</code> to create a temporary container, and then to save its filesystem contents into a tar file.</p>
<p>Run <code>make extract</code></p>
<p>If you want to see what a filesystem looks like, you could extract <code>rootfs.tar</code> into <code>/tmp</code> and have a poke around. This is not a required step.</p>
<p>Then run <code>make image</code>.</p>
<p>Here, a loopback file allocated with 5GB, then formatted as ext4, under the name <code>rootfs.img</code>. The script mounts the drive and then extracts the contents of the <code>rootfs.tar</code> file into it before unmounting the file.</p>
<h3>Start a Firecracker process</h3>
<p>Now, this may feel a little odd or different to Docker users. For each Firecracker VM you want to launch, you'll need to start a process, configure it via curl over a UNIX socket, then issue a boot command.</p>
<p>To run multiple Firecracker microVMs at once, configure a different socket path for each.</p>
<pre><code>make start
</code></pre>
<h3>Boot the microVM</h3>
<p>In another window, issue the boot command:</p>
<pre><code>make boot
</code></pre>
<h3>Explore the system</h3>
<p>You're now booted into a serial console, this isn't a fully functional TTY, so some things won't work like Control + C. The serial console is really just designed for showing boot-up information, not interactive use. For proper remote administration, you should install an OpenSSH server and then connect to the VM using its IP address.</p>
<p>That said, you can now explore a little.</p>
<p>Add a DNS server to <code>/etc/resolv.conf</code>:</p>
<pre><code>echo "nameserver 8.8.8.8" > /etc/resolv.conf
</code></pre>
<p>Then try to reach the Internet:</p>
<pre><code class="hljs language-bash">ping -c 1 8.8.8.8

ping -c 4 google.com

curl --connect-timeout 1 -4 -i http://captive.apple.com/

curl --connect-timeout 1 -4 -i https://inlets.dev
</code></pre>
<p>Check out the system specifications:</p>
<pre><code>free -m
cat /proc/cpuinfo
ip addr
ip route
</code></pre>
<p>When you're done, kill the firecracker process with <code>sudo killall firecracker</code>, or type in <code>halt</code> to the serial console.</p>
<h2>Wrapping up</h2>
<p>I was frustrated by the lack of a simple guide for tinkering with Firecracker, and so that's why I wrote this lab and am keeping it up to date.</p>
<p>For production use, you could use a HTTP client to make the API requests to the UNIX socket, or an SDK, which abstracts away some of the complexity. There's an <a href="https://github.com/firecracker-microvm/firecracker-go-sdk">official SDK for Go</a> and several <a href="https://lib.rs/crates/firec">unofficial ones for Rust</a>. If you look at the sample code for either, you'll see that they are doing the same things we did in the lab, so you should find it relatively easy to convert the lab to use an SDK instead.</p>
<p>Did you enjoy the lab? Have you got a use-case for Firecracker? Let me know on Twitter <a href="https://x.com/alexellisuk">@alexellisuk</a></p>
<p>If you'd like to see how we've applied Firecracker to bring fast and secure CI to teams, check out our product <a href="https://actuated.dev/">actuated.dev</a></p>
<p>Here's a quick demo of our control-plane, scheduler and bare-metal agent in action:</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/2o28iUC-J1w?si=xAt7YG4YCJ_ZleCA" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe></div></div></main><footer class="bg-white"><div class="mx-auto max-w-7xl py-12 px-4 sm:px-6 md:flex md:items-center md:justify-between lg:px-8"><div class="flex justify-center space-x-6 md:order-2"><a class="text-gray-400 hover:text-gray-500" href="https://twitter.com/selfactuated"><span class="sr-only">Twitter</span><svg fill="currentColor" viewBox="0 0 24 24" class="h-6 w-6" aria-hidden="true"><path d="M8.29 20.251c7.547 0 11.675-6.253 11.675-11.675 0-.178 0-.355-.012-.53A8.348 8.348 0 0022 5.92a8.19 8.19 0 01-2.357.646 4.118 4.118 0 001.804-2.27 8.224 8.224 0 01-2.605.996 4.107 4.107 0 00-6.993 3.743 11.65 11.65 0 01-8.457-4.287 4.106 4.106 0 001.27 5.477A4.072 4.072 0 012.8 9.713v.052a4.105 4.105 0 003.292 4.022 4.095 4.095 0 01-1.853.07 4.108 4.108 0 003.834 2.85A8.233 8.233 0 012 18.407a11.616 11.616 0 006.29 1.84"></path></svg></a><a class="text-gray-400 hover:text-gray-500" href="https://github.com/self-actuated"><span class="sr-only">GitHub</span><svg fill="currentColor" viewBox="0 0 24 24" class="h-6 w-6" aria-hidden="true"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"></path></svg></a><a class="text-gray-400 hover:text-gray-500" href="/rss.xml"><span class="sr-only">RSS</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M12.75 19.5v-.75a7.5 7.5 0 00-7.5-7.5H4.5m0-6.75h.75c7.87 0 14.25 6.38 14.25 14.25v.75M6 18.75a.75.75 0 11-1.5 0 .75.75 0 011.5 0z"></path></svg></a></div><div class="mt-8 md:order-1 md:mt-0"><p class="text-center text-base text-gray-400">Â© 2022 <a href="https://openfaas.com">OpenFaaS Ltd</a>, Inc. All rights reserved.</p></div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"firecracker-container-lab","fileName":"2023-09-05-firecracker-container-lab.md","contentHtml":"\u003cp\u003eWhen I started learning \u003ca href=\"https://github.com/firecracker-microvm/firecracker\"\u003eFirecracker\u003c/a\u003e, I ran into frustration after frustration with broken tutorials that were popular in their day, but just hadn't been kept up to date. Almost nothing worked, or was far too complex for the level of interest I had at the time. Most recently, one of the Firecracker maintainers in an effort to make the quickstart better, made it even harder to use. (You can still get a copy of the \u003ca href=\"https://actuated.dev/blog/kvm-in-github-actions\"\u003eoriginal Firecracker quickstart in our tutorial on nested virtualisation\u003c/a\u003e)\u003c/p\u003e\n\u003cp\u003eSo I wrote a lab that takes a container image and converts it to a microVM. You'll get your hands dirty, you'll run a microVM, you'll be able to use \u003ccode\u003ecurl\u003c/code\u003e and \u003ccode\u003essh\u003c/code\u003e, even expose a HTTP server to the Internet via inlets, if (like me), you find that kind of thing fun.\u003c/p\u003e\n\u003cp\u003eWhy would you want to explore Firecracker? A friend of mine, \u003ca href=\"https://iximiuz.com/en/about/\"\u003eIvan Velichko\u003c/a\u003e is a prolific writer on containers, and Docker. He is one of the biggest independent evangelists for containers and Kubernetes that I know.\u003c/p\u003e\n\u003cp\u003eSo when he wanted to build an \u003ca href=\"https://labs.iximiuz.com/\"\u003eonline labs and training environment\u003c/a\u003e, why did he pick Firecracker instead? Simply put, he told us that containers don't cut it. He needed something that would mirror the type of machine that you'd encounter in production, when you provision an EC2 instance or a GCP VM. Running Docker, Kubernetes, and performing are hard to do securely within a container, and he knew that was important for his students.\u003c/p\u003e\n\u003cp\u003eFor us - we had very similar reasons for picking Firecracker for a secure CI solution. Too often the security issues around running privileged containers, and the slow speed of \u003ca href=\"https://jpetazzo.github.io/2015/09/03/do-not-use-docker-in-docker-for-ci/\"\u003eDocker In Docker's (DIND)\u003c/a\u003e Virtual Filesystem Driver (VFS), are ignored. Heads are put into the sand. We couldn't do that and \u003ca href=\"https://actuated.dev/blog/blazing-fast-ci-with-microvms\"\u003edeveloped actuated.dev\u003c/a\u003e as a result. Since we launched the pilot, we've now run over 110k VMs for customer CI jobs on GitHub Actions, and have a \u003ca href=\"https://actuated.dev/blog/secure-microvm-ci-gitlab\"\u003etech preview for GitLab CI\u003c/a\u003e where a job can be running within 1 second of pushing a \"commit\".\u003c/p\u003e\n\u003cp\u003eSo let's get that microVM running for you?\u003c/p\u003e\n\u003ch2\u003eHow it works ðŸ”¬\u003c/h2\u003e\n\u003cp\u003eHow to build a microVM from a container\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/2023-09-firecracker-lab/conceptual.png\" alt=\"/images/2023-09-firecracker-lab/conceptual.png\"\u003e\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eConceptual archicture of the lab\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eHere's what we'll be doing:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eBuild a root-filesystem from a container image from the Docker Hub\u003c/li\u003e\n\u003cli\u003eDownload a pre-built Linux Kernel from the Firecracker team\u003c/li\u003e\n\u003cli\u003eBuild an init system written in Go\u003c/li\u003e\n\u003cli\u003eBuild a disk image with the init system and root-filesystem\u003c/li\u003e\n\u003cli\u003eConfigure a networking tap device and IP masquerading\u003c/li\u003e\n\u003cli\u003eStart a Firecracker process in the background\u003c/li\u003e\n\u003cli\u003eConfigure the Firecracker process via curl statements to a UNIX socket\u003c/li\u003e\n\u003cli\u003eFinally, issue a boot command and try it out\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eLet's look at why we need a init, instead of just running the entrypoint of a container.\u003c/p\u003e\n\u003cp\u003eWhilst in theory, you can start a microVM where the first process (PID 1) is your workload, in the same way as Docker, it will leave you with a system which is not properly initialised with things like a /proc/ filesystem, tempfs, hostname, and other things that you'd expect to find in a Linux system.\u003c/p\u003e\n\u003cp\u003eFor that reason, you'll need to either install systemd into the container image you want to use, or build your own basic init system, which sets up the machine, then starts your workload.\u003c/p\u003e\n\u003cp\u003eWe're doing the latter here.\u003c/p\u003e\n\u003cp\u003eIn the below program, you'll see key devices and files mounted, to make a functional system. The hostname is then set by using a syscall, and finally \u003ccode\u003e/bin/sh\u003c/code\u003e is started. You could also start a specific binary, or build an agent into the init for Remote Procedure Calls (RPC) to start and stop your workload, and to query metrics.\u003c/p\u003e\n\u003cp\u003eThe team at \u003ca href=\"https://fly.io\"\u003eFly.io\u003c/a\u003e built their own init and agent combined, and opened-sourced a very early version: \u003ca href=\"https://github.com/superfly/init-snapshot\"\u003egithub.com/superfly/init-snapshot\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eYou'll find my init in: \u003ccode\u003e./init/main.go\u003c/code\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-go\"\u003e\u003cspan class=\"hljs-comment\"\u003e// Copyright Alex Ellis 2023\u003c/span\u003e\n\n\u003cspan class=\"hljs-keyword\"\u003epackage\u003c/span\u003e main\n\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e (\n\t\u003cspan class=\"hljs-string\"\u003e\"fmt\"\u003c/span\u003e\n\t\u003cspan class=\"hljs-string\"\u003e\"log\"\u003c/span\u003e\n\t\u003cspan class=\"hljs-string\"\u003e\"os\"\u003c/span\u003e\n\t\u003cspan class=\"hljs-string\"\u003e\"os/exec\"\u003c/span\u003e\n\n\t\u003cspan class=\"hljs-string\"\u003e\"syscall\"\u003c/span\u003e\n)\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e paths = \u003cspan class=\"hljs-string\"\u003e\"PATH=/usr/local/bin:/usr/local/sbin:/usr/bin:/usr/sbin:/bin:/sbin\"\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment\"\u003e// main starts an init process that can prepare an environment and start a shell\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e// after the Kernel has started.\u003c/span\u003e\n\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003emain\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e()\u003c/span\u003e\u003c/span\u003e {\n\tfmt.Printf(\u003cspan class=\"hljs-string\"\u003e\"Lab init booting\\nCopyright Alex Ellis 2022, OpenFaaS Ltd\\n\"\u003c/span\u003e)\n\n\tmount(\u003cspan class=\"hljs-string\"\u003e\"none\"\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\"/proc\"\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\"proc\"\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e)\n\tmount(\u003cspan class=\"hljs-string\"\u003e\"none\"\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\"/dev/pts\"\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\"devpts\"\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e)\n\tmount(\u003cspan class=\"hljs-string\"\u003e\"none\"\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\"/dev/mqueue\"\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\"mqueue\"\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e)\n\tmount(\u003cspan class=\"hljs-string\"\u003e\"none\"\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\"/dev/shm\"\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\"tmpfs\"\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e)\n\tmount(\u003cspan class=\"hljs-string\"\u003e\"none\"\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\"/sys\"\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\"sysfs\"\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e)\n\tmount(\u003cspan class=\"hljs-string\"\u003e\"none\"\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\"/sys/fs/cgroup\"\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\"cgroup\"\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e)\n\n\tsetHostname(\u003cspan class=\"hljs-string\"\u003e\"lab-vm\"\u003c/span\u003e)\n\n\tfmt.Printf(\u003cspan class=\"hljs-string\"\u003e\"Lab starting /bin/sh\\n\"\u003c/span\u003e)\n\n\tcmd := exec.Command(\u003cspan class=\"hljs-string\"\u003e\"/bin/sh\"\u003c/span\u003e)\n\n\tcmd.Env = \u003cspan class=\"hljs-built_in\"\u003eappend\u003c/span\u003e(cmd.Env, paths)\n\tcmd.Stdin = os.Stdin\n\tcmd.Stdout = os.Stdout\n\tcmd.Stderr = os.Stderr\n\n\terr := cmd.Start()\n\t\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e err != \u003cspan class=\"hljs-literal\"\u003enil\u003c/span\u003e {\n\t\t\u003cspan class=\"hljs-built_in\"\u003epanic\u003c/span\u003e(fmt.Sprintf(\u003cspan class=\"hljs-string\"\u003e\"could not start /bin/sh, error: %s\"\u003c/span\u003e, err))\n\t}\n\n\terr = cmd.Wait()\n\t\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e err != \u003cspan class=\"hljs-literal\"\u003enil\u003c/span\u003e {\n\t\t\u003cspan class=\"hljs-built_in\"\u003epanic\u003c/span\u003e(fmt.Sprintf(\u003cspan class=\"hljs-string\"\u003e\"could not wait for /bin/sh, error: %s\"\u003c/span\u003e, err))\n\t}\n}\n\n\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003esetHostname\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(hostname \u003cspan class=\"hljs-type\"\u003estring\u003c/span\u003e)\u003c/span\u003e\u003c/span\u003e {\n\terr := syscall.Sethostname([]\u003cspan class=\"hljs-type\"\u003ebyte\u003c/span\u003e(hostname))\n\t\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e err != \u003cspan class=\"hljs-literal\"\u003enil\u003c/span\u003e {\n\t\t\u003cspan class=\"hljs-built_in\"\u003epanic\u003c/span\u003e(fmt.Sprintf(\u003cspan class=\"hljs-string\"\u003e\"cannot set hostname to %s, error: %s\"\u003c/span\u003e, hostname, err))\n\t}\n}\n\n\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003emount\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(source, target, filesystemtype \u003cspan class=\"hljs-type\"\u003estring\u003c/span\u003e, flags \u003cspan class=\"hljs-type\"\u003euintptr\u003c/span\u003e)\u003c/span\u003e\u003c/span\u003e {\n\n\t\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e _, err := os.Stat(target); os.IsNotExist(err) {\n\t\terr := os.MkdirAll(target, \u003cspan class=\"hljs-number\"\u003e0755\u003c/span\u003e)\n\t\t\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e err != \u003cspan class=\"hljs-literal\"\u003enil\u003c/span\u003e {\n\t\t\t\u003cspan class=\"hljs-built_in\"\u003epanic\u003c/span\u003e(fmt.Sprintf(\u003cspan class=\"hljs-string\"\u003e\"error creating target folder: %s %s\"\u003c/span\u003e, target, err))\n\t\t}\n\t}\n\n\terr := syscall.Mount(source, target, filesystemtype, flags, \u003cspan class=\"hljs-string\"\u003e\"\"\u003c/span\u003e)\n\t\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e err != \u003cspan class=\"hljs-literal\"\u003enil\u003c/span\u003e {\n\t\tlog.Printf(\u003cspan class=\"hljs-string\"\u003e\"%s\"\u003c/span\u003e, fmt.Errorf(\u003cspan class=\"hljs-string\"\u003e\"error mounting %s to %s, error: %s\"\u003c/span\u003e, source, target, err))\n\t}\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eWhat you'll need\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/firecracker-microvm/firecracker\"\u003eFirecracker\u003c/a\u003e is a Virtual Machine Monitor (VMM) that leans on Linux's KVM functionality to run VMs. Its beauty is in its simplicity, however even though it doesn't need a lot, you will need KVM to be available. If you have a bare-metal machine, like your own PC, or an old server or laptop, you're all set. There's also plenty of options for bare-metal in the cloud - billed either on a per minute/hour basis or per month.\u003c/p\u003e\n\u003cp\u003eAnd finally, for quick testing, \u003ca href=\"https://m.do.co/c/8d4e75e9886f\"\u003eDigitalOcean\u003c/a\u003e, GCP, and Azure all support what is known as \"Nested Virtualization\". That's where you obtain a VM, which itself can start further VMs, it's not as fast as bare-metal, but it's cheap and works.\u003c/p\u003e\n\u003cp\u003eFinally, whilst Firecracker and actuated (our CI product) both support Arm, and Raspberry Pi, this tutorial is only available for `x86_64`` to keep the instructions simple.\u003c/p\u003e\n\u003ch2\u003eProvision the machine\u003c/h2\u003e\n\u003cp\u003eI'd recommend you use Ubuntu 22.04, so that you can copy and paste instructions from this tutorial.\u003c/p\u003e\n\u003cp\u003eInstall Docker CE\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003ecurl -fsSL https://get.docker.com  | sudo sh\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eDocker will be used to fetch an initial Operating System, to build the init system, and to customise the root filesystem.\u003c/p\u003e\n\u003cp\u003eInstall arkade, which gives you an easy way to install Firecracker:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003ecurl -sLS https://get.arkade.dev | sudo sh\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eInstall Firecracker:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003esudo arkade system install firecracker\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eClone the lab\u003c/h2\u003e\n\u003cp\u003eClone the lab onto the machine:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003egit \u003cspan class=\"hljs-built_in\"\u003eclone\u003c/span\u003e https://github.com/alexellis/firecracker-init-lab --depth=1\n\n\u003cspan class=\"hljs-built_in\"\u003ecd\u003c/span\u003e firecracker-init-lab\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eUpdate the networking script\u003c/h3\u003e\n\u003cp\u003eFind out what the primary interface is on the machine using \u003ccode\u003eip addr\u003c/code\u003e or \u003ccode\u003eifconfig\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eEdit \u003ccode\u003e./setup-networking.sh\u003c/code\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eIFNAME=enp8s0\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe script will configure a TAP device which bridges microVMs to your host, then sets up IP forwarding and masquerading so that the microVMs can access the Internet.\u003c/p\u003e\n\u003cp\u003eRun \u003ccode\u003e./setup-networking.sh\u003c/code\u003e to setup the TAP device.\u003c/p\u003e\n\u003ch3\u003eDownload the Kernel\u003c/h3\u003e\n\u003cp\u003eAdd \u003ccode\u003emake\u003c/code\u003e via \u003ccode\u003ebuild-essential\u003c/code\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003esudo apt update \u0026#x26;\u0026#x26; sudo apt install -y build-essential\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eRun \u003ccode\u003emake kernel\u003c/code\u003e to download the quickstart Kernel made available by the Firecracker team. Of course, you can build your own, but bear in mind that Firecracker does not have PCI support, so many of the ones you'll find on the Internet will not be appropriate.\u003c/p\u003e\n\u003cp\u003eThis Makefile target will not actually build a new Kernel, but wil download one that the Firecracker team have pre-built and uploaded to S3.\u003c/p\u003e\n\u003ch3\u003eMake the container image\u003c/h3\u003e\n\u003cp\u003eHere's the Dockerfile we'll use to build the init system in a multi-stage build, then derive from Alpine Linux for the runtime, this could of course be anything like Ubuntu 22.04, Python, or Node.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e./Dockerfile\u003c/code\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eFROM golang:1.20-alpine as build\n\nWORKDIR /go/src/github.com/alexellis/firecracker-init-lab/init\n\nCOPY init .\n\nRUN go build --tags netgo --ldflags '-s -w -extldflags \"-lm -lstdc++ -static\"' -o init main.go\n\nFROM alpine:3.18 as runtime\n\nRUN apk add --no-cache curl ca-certificates htop\n\nCOPY --from=build /go/src/github.com/alexellis/firecracker-init-lab/init/init /init\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eI've added in a few extra packages to play with.\u003c/p\u003e\n\u003cp\u003eRun \u003ccode\u003emake root\u003c/code\u003e, and you'll see an image in your library:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003edocker images | grep alexellis2/custom-init\n\nREPOSITORY                                                          TAG                                                                      IMAGE ID       CREATED         SIZE\nalexellis2/custom-init                                              latest                                                                   f89aa7f3dd27   20 hours ago    13.7MB\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eBuild the disk image\u003c/h3\u003e\n\u003cp\u003eFirecracker needs a disk image, or an existing block device as its boot drive. You can make this dynamically as required, run \u003ccode\u003emake extract\u003c/code\u003e to extract the container image into the local filesystem as \u003ccode\u003erootfs.tar\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eThis step uses \u003ccode\u003edocker create\u003c/code\u003e followed by \u003ccode\u003edocker export\u003c/code\u003e to create a temporary container, and then to save its filesystem contents into a tar file.\u003c/p\u003e\n\u003cp\u003eRun \u003ccode\u003emake extract\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eIf you want to see what a filesystem looks like, you could extract \u003ccode\u003erootfs.tar\u003c/code\u003e into \u003ccode\u003e/tmp\u003c/code\u003e and have a poke around. This is not a required step.\u003c/p\u003e\n\u003cp\u003eThen run \u003ccode\u003emake image\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eHere, a loopback file allocated with 5GB, then formatted as ext4, under the name \u003ccode\u003erootfs.img\u003c/code\u003e. The script mounts the drive and then extracts the contents of the \u003ccode\u003erootfs.tar\u003c/code\u003e file into it before unmounting the file.\u003c/p\u003e\n\u003ch3\u003eStart a Firecracker process\u003c/h3\u003e\n\u003cp\u003eNow, this may feel a little odd or different to Docker users. For each Firecracker VM you want to launch, you'll need to start a process, configure it via curl over a UNIX socket, then issue a boot command.\u003c/p\u003e\n\u003cp\u003eTo run multiple Firecracker microVMs at once, configure a different socket path for each.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003emake start\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eBoot the microVM\u003c/h3\u003e\n\u003cp\u003eIn another window, issue the boot command:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003emake boot\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eExplore the system\u003c/h3\u003e\n\u003cp\u003eYou're now booted into a serial console, this isn't a fully functional TTY, so some things won't work like Control + C. The serial console is really just designed for showing boot-up information, not interactive use. For proper remote administration, you should install an OpenSSH server and then connect to the VM using its IP address.\u003c/p\u003e\n\u003cp\u003eThat said, you can now explore a little.\u003c/p\u003e\n\u003cp\u003eAdd a DNS server to \u003ccode\u003e/etc/resolv.conf\u003c/code\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eecho \"nameserver 8.8.8.8\" \u003e /etc/resolv.conf\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThen try to reach the Internet:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eping -c 1 8.8.8.8\n\nping -c 4 google.com\n\ncurl --connect-timeout 1 -4 -i http://captive.apple.com/\n\ncurl --connect-timeout 1 -4 -i https://inlets.dev\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eCheck out the system specifications:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003efree -m\ncat /proc/cpuinfo\nip addr\nip route\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWhen you're done, kill the firecracker process with \u003ccode\u003esudo killall firecracker\u003c/code\u003e, or type in \u003ccode\u003ehalt\u003c/code\u003e to the serial console.\u003c/p\u003e\n\u003ch2\u003eWrapping up\u003c/h2\u003e\n\u003cp\u003eI was frustrated by the lack of a simple guide for tinkering with Firecracker, and so that's why I wrote this lab and am keeping it up to date.\u003c/p\u003e\n\u003cp\u003eFor production use, you could use a HTTP client to make the API requests to the UNIX socket, or an SDK, which abstracts away some of the complexity. There's an \u003ca href=\"https://github.com/firecracker-microvm/firecracker-go-sdk\"\u003eofficial SDK for Go\u003c/a\u003e and several \u003ca href=\"https://lib.rs/crates/firec\"\u003eunofficial ones for Rust\u003c/a\u003e. If you look at the sample code for either, you'll see that they are doing the same things we did in the lab, so you should find it relatively easy to convert the lab to use an SDK instead.\u003c/p\u003e\n\u003cp\u003eDid you enjoy the lab? Have you got a use-case for Firecracker? Let me know on Twitter \u003ca href=\"https://x.com/alexellisuk\"\u003e@alexellisuk\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eIf you'd like to see how we've applied Firecracker to bring fast and secure CI to teams, check out our product \u003ca href=\"https://actuated.dev/\"\u003eactuated.dev\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eHere's a quick demo of our control-plane, scheduler and bare-metal agent in action:\u003c/p\u003e\n\u003ciframe width=\"560\" height=\"315\" src=\"https://www.youtube.com/embed/2o28iUC-J1w?si=xAt7YG4YCJ_ZleCA\" title=\"YouTube video player\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share\" allowfullscreen\u003e\u003c/iframe\u003e","title":"Grab your lab coat - we're building a microVM from a container","description":"No more broken tutorials, build a microVM from a container, boot it, access the Internet","tags":["firecracker","lab","tutorial"],"author_img":"alex","image":"/images/2023-09-firecracker-lab/background.png","date":"2023-09-05"}},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"firecracker-container-lab"},"buildId":"iwf6Rhft0sDPfFlkRFSYB","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>