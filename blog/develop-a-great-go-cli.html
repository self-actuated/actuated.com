<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="theme-color" content="#000000"/><meta name="author" content="OpenFaaS Ltd"/><meta name="twitter:card" content="summary_large_image"/><title>How to develop a great CLI with Go</title><meta name="description" content="Alex shares his insights from building half a dozen popular Go CLIs. Which can you apply to your projects?"/><meta property="twitter:title" content="How to develop a great CLI with Go"/><meta property="twitter:description" content="Alex shares his insights from building half a dozen popular Go CLIs. Which can you apply to your projects?"/><meta property="og:title" content="How to develop a great CLI with Go"/><meta property="og:description" content="Alex shares his insights from building half a dozen popular Go CLIs. Which can you apply to your projects?"/><meta name="twitter:image:src" content="https://actuated.dev/images/2023-08-great-cli/background.png"/><meta property="og:image" content="https://actuated.dev/images/2023-08-great-cli/background.png"/><meta name="next-head-count" content="13"/><meta charSet="utf-8"/><link rel="icon" type="image/png" href="/images/actuated.png"/><link rel="stylesheet" href="https://rsms.me/inter/inter.css"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css"/><link rel="manifest" href="/manifest.json"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-M5YNDNX7VT"></script><script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'G-M5YNDNX7VT');
          </script><link rel="apple-touch-icon" href="/images/actuated.png"/><link rel="preload" href="/_next/static/css/931f0fc3815fa31d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/931f0fc3815fa31d.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-8fa1640cc84ba8fe.js" defer=""></script><script src="/_next/static/chunks/framework-114634acb84f8baa.js" defer=""></script><script src="/_next/static/chunks/main-34e2100d07ae5757.js" defer=""></script><script src="/_next/static/chunks/pages/_app-380bfc772a8344bc.js" defer=""></script><script src="/_next/static/chunks/552-542f150c917a7625.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bslug%5D-109b0d2eddac75b5.js" defer=""></script><script src="/_next/static/4PQzJ-L1XAyTxxcve_Nyw/_buildManifest.js" defer=""></script><script src="/_next/static/4PQzJ-L1XAyTxxcve_Nyw/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="bg-white"><header><div class="relative bg-white" data-headlessui-state=""><div class="mx-auto flex max-w-7xl items-center justify-between px-4 py-6 sm:px-6 md:justify-start md:space-x-10 lg:px-8"><div class="flex justify-start lg:w-0 lg:flex-1"><a href="/"><span class="sr-only">Actuated</span><img class="h-8 w-auto sm:h-10" src="/images/actuated.png" alt="Actuated logo"/></a></div><div class="-my-2 -mr-2 md:hidden"><button class="inline-flex items-center justify-center rounded-md bg-white p-2 text-gray-400 hover:bg-gray-100 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500" type="button" aria-expanded="false" data-headlessui-state=""><span class="sr-only">Open menu</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" class="h-6 w-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"></path></svg></button></div><nav class="hidden space-x-10 md:flex"><div class="relative" data-headlessui-state=""><button class="text-gray-500 group inline-flex items-center rounded-md bg-white text-base font-medium hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" type="button" aria-expanded="false" data-headlessui-state=""><span>Solutions</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="text-gray-400 ml-2 h-5 w-5 group-hover:text-gray-500"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"></path></svg></button></div><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/blog">Blog</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="https://actuated.dev/blog/blazing-fast-ci-with-microvms">Announcement</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/pricing">Pricing</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="https://docs.actuated.dev/">Docs</a></nav><div class="hidden items-center justify-end md:flex md:flex-1 lg:w-0"><a href="https://dashboard.actuated.dev" class="whitespace-nowrap text-base font-medium text-gray-500 hover:text-gray-900">Sign in</a><a href="/pricing" class="ml-8 inline-flex items-center justify-center whitespace-nowrap rounded-md border border-transparent bg-indigo-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-indigo-700">Sign-up</a></div></div></div></header><main><div class="container mx-auto max-w-4xl bg-white mt-4 px-4 sm:px-6"><h1 id="post_title" class="text-3xl mb-3 leading-8 font-extrabold tracking-tight text-gray-900 sm:text-4xl sm:leading-10 text-center">How to develop a great CLI with Go</h1></div><div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-4xl"><div class="border-b border-gray-200 py-4 flex items-center text-gray-500 mx-auto"><div><img class="h-10 w-10 rounded-full" src="/images/alex.jpg" alt=""/></div><div class="ml-3"><p id="post_author" class="text-sm leading-5 font-medium text-gray-900"></p><div class="flex text-sm leading-5 text-gray-500"><time dateTime="2023-08-22" id="post_date">August 22, 2023</time><span class="mx-1"></span></div></div></div><div class="mt-6 prose sm:prose-lg max-w-none"><p id="post_description" class="mb-4">Alex shares his insights from building half a dozen popular Go CLIs. Which can you apply to your projects?</p></div><div id="post_content" class="mt-6 prose sm:prose-lg max-w-none"><p>Is your project's CLI growing with you? I'll cover some of the lessons learned writing the OpenFaaS, actuated, actions-usage, arkade and k3sup CLIs, going as far back as 2016. I hope you'll find some ideas or inspiration for your own projects - either to start them off, or to improve them as you go along.</p>
<blockquote>
<p>Just starting your journey, or want to go deeper?</p>
<p>You can master the fundamentals of Go (also called Golang) with my <a href="https://store.openfaas.com/l/everyday-golang">eBook Everyday Golang</a>, which includes chapters on Go routines, HTTP clients and servers, text templates, unit testing and crafting a CLI. If you're on a budget, I would recommend checkout out the official <a href="https://go.dev/tour/">Go tour</a>, too.</p>
</blockquote>
<h2 id="introduction">Introduction</h2>
<p>The earliest CLI I wrote was for OpenFaaS, called <a href="https://github.com/openfaas/faas-cli">faas-cli</a>. It's a client for a REST API exposed over HTTP, and I remember how it felt to add the first command <em>list functions</em>, then one more, and one more, until it was a fully working CLI with a dozen commands.</p>
<p>But it started with one command - something that was useful to us at the time, that was to list the available functions.</p>
<p>The initial version used Go's built-in flags parser, which is rudimentary, but perfectly functional.</p>
<pre><code>faas-cli -list
faas-cli -describe
faas-cli -deploy
</code></pre>
<p>Over time, you may outgrow this simple approach, and drift towards wanting sub-commands, each with their own set of options.</p>
<p>An early contributor <a href="https://github.com/johnmccabe">John McCabe</a> introduced me to <a href="https://github.com/spf13/cobra">Cobra</a> and asked if he could convert everything over.</p>
<pre><code>faas-cli list
faas-cli describe
faas-cli deploy
</code></pre>
<p>Now each sub-command can have its set of flags, and even sub-commands in the case of <code>faas-cli secret list/create/delete</code></p>
<p><a href="https://github.com/self-actuated/actions-usage">actions-usage</a> is a free analytics tool we wrote for GitHub Actions users to iterate GitHub's API and summarise your usage over a certain period of time. It's also written in Go, but because it's mostly single-purpose, it'll probably never need sub-commands.</p>
<pre><code>actions-usage -days 28 \
    -token-file ~/pat.txt \
    -org openfaasltd
</code></pre>
<p>Shortly after launching the tool for teams an open-source organisations, we had a feature request to run it on individual user accounts.</p>
<p>That meant switching up some API calls and adding new CLI flags:</p>
<pre><code>actions-usage -days 7 \
    -token-file ~/pat.txt \
    -user alexellis
</code></pre>
<p>We then got a bit clever and started adding some extra reports and details, you can see what it looks in the article <a href="https://actuated.dev/blog/github-actions-usage-cli">Understand your usage of GitHub Actions</a></p>
<h2 id="whats-new-for-actuated-cli">What's new for actuated-cli</h2>
<p>I'm very much a believer in a Minimal Viable Product (MVP). If you can create some value or utility to users, you should ship it as early as possible, especially if you have a good feedback loop with them.</p>
<p>A quick note about the <a href="https://github.com/self-actuated/actuated-cli">actuated-cli</a>, it's main use-cases are to:</p>
<ul>
<li>List the runners for an organisation</li>
<li>List the queued or in-progress jobs for an organisation</li>
<li>Update a remote server, or get the logs from a VM or the agent service</li>
</ul>
<h3 id="no-more-owner-flags">No more owner flags</h3>
<p>The <code>actuated-cli</code> was designed to work on a certain organisation, but it meant extra typing, so wherever possible, we've removed the flag completely.</p>
<pre><code>actuated-cli runners --owner openfaasltd
</code></pre>
<p>becomes:</p>
<pre><code>actuated-cli runners
</code></pre>
<p>How did we do this? We determine the intersection of organisations for which your account is authorized, and which are enrolled for actuated. It's much less typing and it's more intuitive.</p>
<h3 id="the-host-flag-became-a-positional-argument">The host flag became a positional argument</h3>
<p>This was another exercise in reducing typing. Let's say we wanted to upgrade the agent for a certain host, we'd have to type:</p>
<pre><code>actuated-cli upgrade --owner openfaasltd --host server-1
</code></pre>
<p>By looking at the "args" slice, instead of for a specific command, we can assume that any text after the flags is always the server name:</p>
<pre><code>actuated-cli upgrade --owner openfaasltd server-1
</code></pre>
<h3 id="token-management">Token management</h3>
<p>The actuated CLI uses a GitHub personal access token to authenticate with the API. This is a common pattern, but it's not always clear how to manage the token.</p>
<p>We took inspiration from the <code>gh</code> CLI, which is a wrapper around the GitHub API.</p>
<p>The <code>gh</code> CLI has a <code>gh auth</code> command which can be used to obtain a token, and save it to a local file, then any future usage of the CLI will use that token.</p>
<p>Before, you had to create a Personal Access Token in the GitHub UI, then copy and paste it into a file, and decide where to put it, and what to name it. What's more, if you missed a permission, then the token wouldn't work.</p>
<pre><code>actuated-cli --token ~/pat.txt
</code></pre>
<p>Now, you simply run:</p>
<pre><code>actuated-cli auth
</code></pre>
<p>And as you saw from the previous commands, there's no longer any need for the <code>--token</code> flag. Unless of course, you want to supply it, then you can.</p>
<p>A good way to have a default for a flag, and then an override, is to use the Cobra package's <code>Changed()</code> function. Read the default, unless <code>.Changed()</code> on the <code>--token</code> or <code>--token-value</code> flags return <code>true</code>.</p>
<h3 id="the---json-flag">The <code>--json</code> flag</h3>
<p>From early on, I knew that I would want to be able to pipe output into .jq, or perhaps even do some scripting. I've seen this in <code>docker</code>, <code>kubectl</code> and numerous other CLI tools written in Go.</p>
<pre><code>actuated-cli runners --json | jq '.[] | .name'

"m1m1"
"m1m2"
"of-epyc-lon1"
</code></pre>
<p>The JSON format also allows you to get access to certain fields which the API call returns, which may not be printed by the default command's text-based formatter:</p>
<pre><code>|         NAME         |  CUSTOMER   |   STATUS    | VMS  | PING  |   UP    | CPUS |   RAM   | FREE RAM | ARCH  |                 VERSION                  |
|----------------------|-------------|-------------|------|-------|---------|------|---------|----------|-------|------------------------------------------|
| of-epyc-lon1         | openfaasltd | running     | 0/5  | 7ms   | 6 days  |   48 | 65.42GB | 62.85GB  | amd64 | 5f702001a952e496a9873d2e37643bdf4a91c229 |
</code></pre>
<p>Instead, we get:</p>
<pre><code class="hljs language-json"><span class="hljs-punctuation">[</span>  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"of-epyc-lon1"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"customer"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"openfaasltd"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"pingNano"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">30994998</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"uptimeNano"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">579599000000000</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"cpus"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">48</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"memory"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">65423184000</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"memoryAvailable"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">62852432000</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"vms"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"maxVms"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"reachable"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"status"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"running"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"agentSHA"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"5f702001a952e496a9873d2e37643bdf4a91c229"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"arch"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"amd64"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">]</span>
</code></pre>
<h3 id="ssh-commands-and-doing-the-right-thing">SSH commands and doing the right thing</h3>
<p>Actuated has a <a href="https://docs.actuated.dev/tasks/debug-ssh/">built-in SSH gateway</a>, this means that any job can be debugged - whether running on a hosted or self-hosted runner, just by editing the workflow YAML.</p>
<p>Add the following to the <code>- steps:</code> section, and the <code>id_token: write</code> permission, and your workflow will pause, and then you can connect over SSH using the CLI or the UI.</p>
<pre><code class="hljs language-yaml">    <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">self-actuated/connect-ssh@master</span>
</code></pre>
<p>There are two sub-commands:</p>
<ul>
<li><code>actuated-cli ssh list</code> - list the available SSH sessions</li>
<li><code>actuated-cli ssh connect</code> - connect to an available session</li>
</ul>
<p>Here's an example of having only one connection:</p>
<pre><code>actuated-cli ssh list
| NO  |   ACTOR   |   HOSTNAME    | RX | TX | CONNECTED |
|-----|-----------|---------------|----|----|-----------|
|   1 | alexellis | fv-az1125-168 |  0 |  0 | 32s       |
</code></pre>
<p>Now how do you think the <code>ssh connect</code> command should work?</p>
<p>Here's the most obvious way:</p>
<pre><code>actuated-cli ssh connect --hostname fv-az1125-168
</code></pre>
<p>This is a little obtuse, since we only have one server to connect to, we can improve it for the user, with:</p>
<pre><code>actuated-cli ssh connect
</code></pre>
<p>That's right, we do the right thing, the obvious thing.</p>
<p>Then when there is more than one connection, instead of adding two flags <code>--no</code> or <code>--hostname</code>, we can simply take the positional argument:</p>
<pre><code>actuated-cli ssh connect 1
actuated-cli ssh connect fv-az1125-168
</code></pre>
<p>Are there any places where you could simplify your own CLI?</p>
<p>Read the source code here: <a href="https://github.com/self-actuated/actuated-cli/blob/master/cmd/ssh_connect.go">ssh_connect.go</a></p>
<h3 id="the---verbose-flag">The <code>--verbose</code> flag</h3>
<p>We haven't made any use of the <code>--verbose</code> flag yet in the CLI, but it's a common pattern which has been used in <code>faas-cli</code> and various others. Once your output gets to a certain width, it can be hard to view in a terminal, like the output from the previous command.</p>
<p>To implement <code>--verbose</code>, you should reduce the columns to the absolute minimum to be useful, so maybe we could give up the Version, customer, ping, and CPUs columns in the standard view, then add them back in with <code>--verbose</code>.</p>
<h3 id="table-printing">Table printing</h3>
<p>As you can see from the output of the commands above, we make heavy usage of a table printer.</p>
<p>You don't necessarily need a 3rd-party table printer, Go has a fairly good "tab writer" which can create nicely formatted code:</p>
<pre><code>faas-cli list -g https://openfaas.example.com
Function                        Invocations     Replicas
bcrypt                          9               1    
figlet                          0               1    
inception                       0               1    
nodeinfo                        2               1    
ping-url                        0               1  
</code></pre>
<p>You can find the standard <a href="https://pkg.go.dev/text/tabwriter">tabwriter package</a> here.</p>
<p>Or try out the <a href="https://github.com/olekukonko/tablewriter">tablewriter</a> package by Olekukonko. We've been able to make use of it in <a href="https://arkade.dev">arkade</a> too - a free marketplace for developer tools.</p>
<p>See usage in arkade here: <a href="https://github.com/alexellis/arkade/blob/master/pkg/get/table.go#L19">table.go</a></p>
<p>See usage in actuated-cli's SSH command here: <a href="https://github.com/self-actuated/actuated-cli/blob/master/cmd/ssh_ls.go">ssh_ls.go</a></p>
<h2 id="progress-bars">Progress bars</h2>
<p>One thing that has been great about having open-source CLIs, is that other people make suggestions and help you learn about new patterns.</p>
<p>For arkade, <a href="https://twitter.com/rberrelleza">Ramiro from Okteto</a> sent a PR to add a progress bar to show how long remained to download a big binary like the Kubernetes CLI.</p>
<pre><code class="hljs language-bash">arkade get kubectl
Downloading: kubectl
Downloading: https://storage.googleapis.com/kubernetes-release/release/v1.24.2/bin/linux/amd64/kubectl

15.28 MiB / 43.59 MiB [------------------------>____________________________________] 35.05%
</code></pre>
<p>It's simple, but gives enough feedback to stop you from thinking the program is stuck. In my Human Design Interaction course at university, I learned that anything over 7s triggers uncertainty in an end-user.</p>
<p>See how it's implemented: <a href="https://github.com/alexellis/arkade/blob/master/pkg/get/download.go#L191">download.go</a></p>
<h2 id="http-and-rest-are-not-the-only-option">HTTP and REST are not the only option</h2>
<p>When I wrote <a href="https://github.com/alexellis/k3sup">K3sup</a>, a tool to install K3s on remote servers, I turned to SSH to automate the process. So rather than making HTTP calls, a Go library for SSH is used to open a connection and run remote commands.</p>
<p>It also simplifies an annoying post-installation task - managing the kubeconfig file. By default this is a protected file on the initial server you set up, k3sup will download the file and merge it with your local kubeconfig.</p>
<pre><code>k3sup install \
    --host HOST1 \
    --user ubuntu \
    --merge \
    --local-path ~/.kube/config
</code></pre>
<p>I'd recommend trying out <a href="https://pkg.go.dev/golang.org/x/crypto/ssh">golang.org/x/crypto/ssh</a> in your own CLIs and tools. It's great for automation, and really simple to use.</p>
<h2 id="document-everything-as-best-as-you-can">Document everything as best as you can</h2>
<p>Here's an example of a command with good documentation:</p>
<pre><code>Schedule additional VMs to repair the build queue.
Use sparingly, check the build queue to see if there is a need for 
more VMs to be launched. Then, allow ample time for the new VMs to 
pick up a job by checking the build queue again for an in_progress
status.

Usage:
  actuated-cli repair [flags]

Examples:
  ## Launch VMs for queued jobs in a given organisation
  actuated repair OWNER

  ## Launch VMs for queued jobs in a given organisation for a customer
  actuated repair --staff OWNER


Flags:
  -h, --help    help for repair
  -s, --staff   List staff repair

Global Flags:
  -t, --token string         File to read for Personal Access Token (default "$HOME/.actuated/PAT")
      --token-value string   Personal Access Token
</code></pre>
<p>Not only does it show example usage, so users can understand <em>what can be done</em>, but it has a detailed explanation of when to use the command.</p>
<pre><code class="hljs language-golang">	cmd := &#x26;cobra.Command{
		Use:   <span class="hljs-string">"repair"</span>,
		Short: <span class="hljs-string">"Schedule additional VMs to repair the build queue"</span>,
		Long: <span class="hljs-string">`Schedule additional VMs to repair the build queue.
Use sparingly, check the build queue to see if there is a need for 
more VMs to be launched. Then, allow ample time for the new VMs to 
pick up a job by checking the build queue again for an in_progress
status.`</span>,
		Example: <span class="hljs-string">`  ## Launch VMs for queued jobs in a given organisation
  actuated repair OWNER

  ## Launch VMs for queued jobs in a given organisation for a customer
  actuated repair --staff OWNER
`</span>
    }
</code></pre>
<p>Browse the source code: <a href="https://github.com/self-actuated/actuated-cli/blob/master/cmd/repair.go">repair.go</a></p>
<h2 id="wrapping-up">Wrapping up</h2>
<p>I covered just a few of the recent changes - some were driven by end-user feedback, others were open source contributions, and in some cases, we just wanted to make the CLI easier to use. I've been writing CLIs for a long time, and I still have a lot to learn.</p>
<p>What CLIs do you maintain? Could you apply any of the above to them?</p>
<p>Do you want to learn how to master the fundamentals of Go? Check out my eBook: <a href="https://store.openfaas.com/l/everyday-golang">Everyday Go</a>.</p>
<p>If you're on a budget, I would recommend checkout out the official <a href="https://go.dev/tour/">Go tour</a>, too. It'll help you understand some of the basics of the language and is a good primer for the e-book.</p>
<p>Read the source code of the CLIs we mentioned:</p>
<ul>
<li><a href="https://github.com/self-actuated/actions-usage">actions-usage</a> - free analytics tool for GitHub Actions</li>
<li><a href="https://github.com/self-actuated/actuated-cli">actuated-cli</a> - CLI client for actuated customers</li>
<li><a href="https://github.com/openfaas/faas-cli">faas-cli</a> - CLI client for OpenFaaS</li>
<li><a href="https://github.com/alexellis/k3sup">k3sup</a> - Install K3s over SSH</li>
<li><a href="https://github.com/alexellis/arkade">arkade</a> - Download CLI tools from GitHub releases</li>
</ul></div></div></main><footer class="bg-white"><div class="mx-auto max-w-7xl py-12 px-4 sm:px-6 md:flex md:items-center md:justify-between lg:px-8"><div class="flex justify-center space-x-6 md:order-2"><a class="text-gray-400 hover:text-gray-500" href="https://twitter.com/selfactuated"><span class="sr-only">Twitter</span><svg fill="currentColor" viewBox="0 0 24 24" class="h-6 w-6" aria-hidden="true"><path d="M8.29 20.251c7.547 0 11.675-6.253 11.675-11.675 0-.178 0-.355-.012-.53A8.348 8.348 0 0022 5.92a8.19 8.19 0 01-2.357.646 4.118 4.118 0 001.804-2.27 8.224 8.224 0 01-2.605.996 4.107 4.107 0 00-6.993 3.743 11.65 11.65 0 01-8.457-4.287 4.106 4.106 0 001.27 5.477A4.072 4.072 0 012.8 9.713v.052a4.105 4.105 0 003.292 4.022 4.095 4.095 0 01-1.853.07 4.108 4.108 0 003.834 2.85A8.233 8.233 0 012 18.407a11.616 11.616 0 006.29 1.84"></path></svg></a><a class="text-gray-400 hover:text-gray-500" href="https://github.com/self-actuated"><span class="sr-only">GitHub</span><svg fill="currentColor" viewBox="0 0 24 24" class="h-6 w-6" aria-hidden="true"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"></path></svg></a><a class="text-gray-400 hover:text-gray-500" href="/rss.xml"><span class="sr-only">RSS</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M12.75 19.5v-.75a7.5 7.5 0 00-7.5-7.5H4.5m0-6.75h.75c7.87 0 14.25 6.38 14.25 14.25v.75M6 18.75a.75.75 0 11-1.5 0 .75.75 0 011.5 0z"></path></svg></a></div><div class="mt-8 md:order-1 md:mt-0"><p class="text-center text-base text-gray-400">© 2024 <a href="https://openfaas.com">OpenFaaS Ltd</a>. All rights reserved. <a class="hover:underline" href="/terms">Terms &amp; Conditions.</a></p></div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"develop-a-great-go-cli","fileName":"2023-08-22-develop-a-great-go-cli.md","contentHtml":"\u003cp\u003eIs your project's CLI growing with you? I'll cover some of the lessons learned writing the OpenFaaS, actuated, actions-usage, arkade and k3sup CLIs, going as far back as 2016. I hope you'll find some ideas or inspiration for your own projects - either to start them off, or to improve them as you go along.\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eJust starting your journey, or want to go deeper?\u003c/p\u003e\n\u003cp\u003eYou can master the fundamentals of Go (also called Golang) with my \u003ca href=\"https://store.openfaas.com/l/everyday-golang\"\u003eeBook Everyday Golang\u003c/a\u003e, which includes chapters on Go routines, HTTP clients and servers, text templates, unit testing and crafting a CLI. If you're on a budget, I would recommend checkout out the official \u003ca href=\"https://go.dev/tour/\"\u003eGo tour\u003c/a\u003e, too.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch2 id=\"introduction\"\u003eIntroduction\u003c/h2\u003e\n\u003cp\u003eThe earliest CLI I wrote was for OpenFaaS, called \u003ca href=\"https://github.com/openfaas/faas-cli\"\u003efaas-cli\u003c/a\u003e. It's a client for a REST API exposed over HTTP, and I remember how it felt to add the first command \u003cem\u003elist functions\u003c/em\u003e, then one more, and one more, until it was a fully working CLI with a dozen commands.\u003c/p\u003e\n\u003cp\u003eBut it started with one command - something that was useful to us at the time, that was to list the available functions.\u003c/p\u003e\n\u003cp\u003eThe initial version used Go's built-in flags parser, which is rudimentary, but perfectly functional.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003efaas-cli -list\nfaas-cli -describe\nfaas-cli -deploy\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eOver time, you may outgrow this simple approach, and drift towards wanting sub-commands, each with their own set of options.\u003c/p\u003e\n\u003cp\u003eAn early contributor \u003ca href=\"https://github.com/johnmccabe\"\u003eJohn McCabe\u003c/a\u003e introduced me to \u003ca href=\"https://github.com/spf13/cobra\"\u003eCobra\u003c/a\u003e and asked if he could convert everything over.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003efaas-cli list\nfaas-cli describe\nfaas-cli deploy\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow each sub-command can have its set of flags, and even sub-commands in the case of \u003ccode\u003efaas-cli secret list/create/delete\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/self-actuated/actions-usage\"\u003eactions-usage\u003c/a\u003e is a free analytics tool we wrote for GitHub Actions users to iterate GitHub's API and summarise your usage over a certain period of time. It's also written in Go, but because it's mostly single-purpose, it'll probably never need sub-commands.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eactions-usage -days 28 \\\n    -token-file ~/pat.txt \\\n    -org openfaasltd\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eShortly after launching the tool for teams an open-source organisations, we had a feature request to run it on individual user accounts.\u003c/p\u003e\n\u003cp\u003eThat meant switching up some API calls and adding new CLI flags:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eactions-usage -days 7 \\\n    -token-file ~/pat.txt \\\n    -user alexellis\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWe then got a bit clever and started adding some extra reports and details, you can see what it looks in the article \u003ca href=\"https://actuated.dev/blog/github-actions-usage-cli\"\u003eUnderstand your usage of GitHub Actions\u003c/a\u003e\u003c/p\u003e\n\u003ch2 id=\"whats-new-for-actuated-cli\"\u003eWhat's new for actuated-cli\u003c/h2\u003e\n\u003cp\u003eI'm very much a believer in a Minimal Viable Product (MVP). If you can create some value or utility to users, you should ship it as early as possible, especially if you have a good feedback loop with them.\u003c/p\u003e\n\u003cp\u003eA quick note about the \u003ca href=\"https://github.com/self-actuated/actuated-cli\"\u003eactuated-cli\u003c/a\u003e, it's main use-cases are to:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eList the runners for an organisation\u003c/li\u003e\n\u003cli\u003eList the queued or in-progress jobs for an organisation\u003c/li\u003e\n\u003cli\u003eUpdate a remote server, or get the logs from a VM or the agent service\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"no-more-owner-flags\"\u003eNo more owner flags\u003c/h3\u003e\n\u003cp\u003eThe \u003ccode\u003eactuated-cli\u003c/code\u003e was designed to work on a certain organisation, but it meant extra typing, so wherever possible, we've removed the flag completely.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eactuated-cli runners --owner openfaasltd\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003ebecomes:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eactuated-cli runners\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eHow did we do this? We determine the intersection of organisations for which your account is authorized, and which are enrolled for actuated. It's much less typing and it's more intuitive.\u003c/p\u003e\n\u003ch3 id=\"the-host-flag-became-a-positional-argument\"\u003eThe host flag became a positional argument\u003c/h3\u003e\n\u003cp\u003eThis was another exercise in reducing typing. Let's say we wanted to upgrade the agent for a certain host, we'd have to type:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eactuated-cli upgrade --owner openfaasltd --host server-1\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eBy looking at the \"args\" slice, instead of for a specific command, we can assume that any text after the flags is always the server name:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eactuated-cli upgrade --owner openfaasltd server-1\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"token-management\"\u003eToken management\u003c/h3\u003e\n\u003cp\u003eThe actuated CLI uses a GitHub personal access token to authenticate with the API. This is a common pattern, but it's not always clear how to manage the token.\u003c/p\u003e\n\u003cp\u003eWe took inspiration from the \u003ccode\u003egh\u003c/code\u003e CLI, which is a wrapper around the GitHub API.\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003egh\u003c/code\u003e CLI has a \u003ccode\u003egh auth\u003c/code\u003e command which can be used to obtain a token, and save it to a local file, then any future usage of the CLI will use that token.\u003c/p\u003e\n\u003cp\u003eBefore, you had to create a Personal Access Token in the GitHub UI, then copy and paste it into a file, and decide where to put it, and what to name it. What's more, if you missed a permission, then the token wouldn't work.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eactuated-cli --token ~/pat.txt\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow, you simply run:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eactuated-cli auth\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAnd as you saw from the previous commands, there's no longer any need for the \u003ccode\u003e--token\u003c/code\u003e flag. Unless of course, you want to supply it, then you can.\u003c/p\u003e\n\u003cp\u003eA good way to have a default for a flag, and then an override, is to use the Cobra package's \u003ccode\u003eChanged()\u003c/code\u003e function. Read the default, unless \u003ccode\u003e.Changed()\u003c/code\u003e on the \u003ccode\u003e--token\u003c/code\u003e or \u003ccode\u003e--token-value\u003c/code\u003e flags return \u003ccode\u003etrue\u003c/code\u003e.\u003c/p\u003e\n\u003ch3 id=\"the---json-flag\"\u003eThe \u003ccode\u003e--json\u003c/code\u003e flag\u003c/h3\u003e\n\u003cp\u003eFrom early on, I knew that I would want to be able to pipe output into .jq, or perhaps even do some scripting. I've seen this in \u003ccode\u003edocker\u003c/code\u003e, \u003ccode\u003ekubectl\u003c/code\u003e and numerous other CLI tools written in Go.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eactuated-cli runners --json | jq '.[] | .name'\n\n\"m1m1\"\n\"m1m2\"\n\"of-epyc-lon1\"\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe JSON format also allows you to get access to certain fields which the API call returns, which may not be printed by the default command's text-based formatter:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e|         NAME         |  CUSTOMER   |   STATUS    | VMS  | PING  |   UP    | CPUS |   RAM   | FREE RAM | ARCH  |                 VERSION                  |\n|----------------------|-------------|-------------|------|-------|---------|------|---------|----------|-------|------------------------------------------|\n| of-epyc-lon1         | openfaasltd | running     | 0/5  | 7ms   | 6 days  |   48 | 65.42GB | 62.85GB  | amd64 | 5f702001a952e496a9873d2e37643bdf4a91c229 |\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eInstead, we get:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-json\"\u003e\u003cspan class=\"hljs-punctuation\"\u003e[\u003c/span\u003e  \u003cspan class=\"hljs-punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003e\"name\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"of-epyc-lon1\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003e\"customer\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"openfaasltd\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003e\"pingNano\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e30994998\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003e\"uptimeNano\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e579599000000000\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003e\"cpus\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e48\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003e\"memory\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e65423184000\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003e\"memoryAvailable\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e62852432000\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003e\"vms\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003e\"maxVms\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003e\"reachable\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003e\u003cspan class=\"hljs-keyword\"\u003etrue\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003e\"status\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"running\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003e\"agentSHA\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"5f702001a952e496a9873d2e37643bdf4a91c229\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003e\"arch\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"amd64\"\u003c/span\u003e\n  \u003cspan class=\"hljs-punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"hljs-punctuation\"\u003e]\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"ssh-commands-and-doing-the-right-thing\"\u003eSSH commands and doing the right thing\u003c/h3\u003e\n\u003cp\u003eActuated has a \u003ca href=\"https://docs.actuated.dev/tasks/debug-ssh/\"\u003ebuilt-in SSH gateway\u003c/a\u003e, this means that any job can be debugged - whether running on a hosted or self-hosted runner, just by editing the workflow YAML.\u003c/p\u003e\n\u003cp\u003eAdd the following to the \u003ccode\u003e- steps:\u003c/code\u003e section, and the \u003ccode\u003eid_token: write\u003c/code\u003e permission, and your workflow will pause, and then you can connect over SSH using the CLI or the UI.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eself-actuated/connect-ssh@master\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThere are two sub-commands:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eactuated-cli ssh list\u003c/code\u003e - list the available SSH sessions\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eactuated-cli ssh connect\u003c/code\u003e - connect to an available session\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eHere's an example of having only one connection:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eactuated-cli ssh list\n| NO  |   ACTOR   |   HOSTNAME    | RX | TX | CONNECTED |\n|-----|-----------|---------------|----|----|-----------|\n|   1 | alexellis | fv-az1125-168 |  0 |  0 | 32s       |\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow how do you think the \u003ccode\u003essh connect\u003c/code\u003e command should work?\u003c/p\u003e\n\u003cp\u003eHere's the most obvious way:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eactuated-cli ssh connect --hostname fv-az1125-168\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis is a little obtuse, since we only have one server to connect to, we can improve it for the user, with:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eactuated-cli ssh connect\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThat's right, we do the right thing, the obvious thing.\u003c/p\u003e\n\u003cp\u003eThen when there is more than one connection, instead of adding two flags \u003ccode\u003e--no\u003c/code\u003e or \u003ccode\u003e--hostname\u003c/code\u003e, we can simply take the positional argument:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eactuated-cli ssh connect 1\nactuated-cli ssh connect fv-az1125-168\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAre there any places where you could simplify your own CLI?\u003c/p\u003e\n\u003cp\u003eRead the source code here: \u003ca href=\"https://github.com/self-actuated/actuated-cli/blob/master/cmd/ssh_connect.go\"\u003essh_connect.go\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"the---verbose-flag\"\u003eThe \u003ccode\u003e--verbose\u003c/code\u003e flag\u003c/h3\u003e\n\u003cp\u003eWe haven't made any use of the \u003ccode\u003e--verbose\u003c/code\u003e flag yet in the CLI, but it's a common pattern which has been used in \u003ccode\u003efaas-cli\u003c/code\u003e and various others. Once your output gets to a certain width, it can be hard to view in a terminal, like the output from the previous command.\u003c/p\u003e\n\u003cp\u003eTo implement \u003ccode\u003e--verbose\u003c/code\u003e, you should reduce the columns to the absolute minimum to be useful, so maybe we could give up the Version, customer, ping, and CPUs columns in the standard view, then add them back in with \u003ccode\u003e--verbose\u003c/code\u003e.\u003c/p\u003e\n\u003ch3 id=\"table-printing\"\u003eTable printing\u003c/h3\u003e\n\u003cp\u003eAs you can see from the output of the commands above, we make heavy usage of a table printer.\u003c/p\u003e\n\u003cp\u003eYou don't necessarily need a 3rd-party table printer, Go has a fairly good \"tab writer\" which can create nicely formatted code:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003efaas-cli list -g https://openfaas.example.com\nFunction                        Invocations     Replicas\nbcrypt                          9               1    \nfiglet                          0               1    \ninception                       0               1    \nnodeinfo                        2               1    \nping-url                        0               1  \n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eYou can find the standard \u003ca href=\"https://pkg.go.dev/text/tabwriter\"\u003etabwriter package\u003c/a\u003e here.\u003c/p\u003e\n\u003cp\u003eOr try out the \u003ca href=\"https://github.com/olekukonko/tablewriter\"\u003etablewriter\u003c/a\u003e package by Olekukonko. We've been able to make use of it in \u003ca href=\"https://arkade.dev\"\u003earkade\u003c/a\u003e too - a free marketplace for developer tools.\u003c/p\u003e\n\u003cp\u003eSee usage in arkade here: \u003ca href=\"https://github.com/alexellis/arkade/blob/master/pkg/get/table.go#L19\"\u003etable.go\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eSee usage in actuated-cli's SSH command here: \u003ca href=\"https://github.com/self-actuated/actuated-cli/blob/master/cmd/ssh_ls.go\"\u003essh_ls.go\u003c/a\u003e\u003c/p\u003e\n\u003ch2 id=\"progress-bars\"\u003eProgress bars\u003c/h2\u003e\n\u003cp\u003eOne thing that has been great about having open-source CLIs, is that other people make suggestions and help you learn about new patterns.\u003c/p\u003e\n\u003cp\u003eFor arkade, \u003ca href=\"https://twitter.com/rberrelleza\"\u003eRamiro from Okteto\u003c/a\u003e sent a PR to add a progress bar to show how long remained to download a big binary like the Kubernetes CLI.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003earkade get kubectl\nDownloading: kubectl\nDownloading: https://storage.googleapis.com/kubernetes-release/release/v1.24.2/bin/linux/amd64/kubectl\n\n15.28 MiB / 43.59 MiB [------------------------\u003e____________________________________] 35.05%\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIt's simple, but gives enough feedback to stop you from thinking the program is stuck. In my Human Design Interaction course at university, I learned that anything over 7s triggers uncertainty in an end-user.\u003c/p\u003e\n\u003cp\u003eSee how it's implemented: \u003ca href=\"https://github.com/alexellis/arkade/blob/master/pkg/get/download.go#L191\"\u003edownload.go\u003c/a\u003e\u003c/p\u003e\n\u003ch2 id=\"http-and-rest-are-not-the-only-option\"\u003eHTTP and REST are not the only option\u003c/h2\u003e\n\u003cp\u003eWhen I wrote \u003ca href=\"https://github.com/alexellis/k3sup\"\u003eK3sup\u003c/a\u003e, a tool to install K3s on remote servers, I turned to SSH to automate the process. So rather than making HTTP calls, a Go library for SSH is used to open a connection and run remote commands.\u003c/p\u003e\n\u003cp\u003eIt also simplifies an annoying post-installation task - managing the kubeconfig file. By default this is a protected file on the initial server you set up, k3sup will download the file and merge it with your local kubeconfig.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003ek3sup install \\\n    --host HOST1 \\\n    --user ubuntu \\\n    --merge \\\n    --local-path ~/.kube/config\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eI'd recommend trying out \u003ca href=\"https://pkg.go.dev/golang.org/x/crypto/ssh\"\u003egolang.org/x/crypto/ssh\u003c/a\u003e in your own CLIs and tools. It's great for automation, and really simple to use.\u003c/p\u003e\n\u003ch2 id=\"document-everything-as-best-as-you-can\"\u003eDocument everything as best as you can\u003c/h2\u003e\n\u003cp\u003eHere's an example of a command with good documentation:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eSchedule additional VMs to repair the build queue.\nUse sparingly, check the build queue to see if there is a need for \nmore VMs to be launched. Then, allow ample time for the new VMs to \npick up a job by checking the build queue again for an in_progress\nstatus.\n\nUsage:\n  actuated-cli repair [flags]\n\nExamples:\n  ## Launch VMs for queued jobs in a given organisation\n  actuated repair OWNER\n\n  ## Launch VMs for queued jobs in a given organisation for a customer\n  actuated repair --staff OWNER\n\n\nFlags:\n  -h, --help    help for repair\n  -s, --staff   List staff repair\n\nGlobal Flags:\n  -t, --token string         File to read for Personal Access Token (default \"$HOME/.actuated/PAT\")\n      --token-value string   Personal Access Token\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNot only does it show example usage, so users can understand \u003cem\u003ewhat can be done\u003c/em\u003e, but it has a detailed explanation of when to use the command.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-golang\"\u003e\tcmd := \u0026#x26;cobra.Command{\n\t\tUse:   \u003cspan class=\"hljs-string\"\u003e\"repair\"\u003c/span\u003e,\n\t\tShort: \u003cspan class=\"hljs-string\"\u003e\"Schedule additional VMs to repair the build queue\"\u003c/span\u003e,\n\t\tLong: \u003cspan class=\"hljs-string\"\u003e`Schedule additional VMs to repair the build queue.\nUse sparingly, check the build queue to see if there is a need for \nmore VMs to be launched. Then, allow ample time for the new VMs to \npick up a job by checking the build queue again for an in_progress\nstatus.`\u003c/span\u003e,\n\t\tExample: \u003cspan class=\"hljs-string\"\u003e`  ## Launch VMs for queued jobs in a given organisation\n  actuated repair OWNER\n\n  ## Launch VMs for queued jobs in a given organisation for a customer\n  actuated repair --staff OWNER\n`\u003c/span\u003e\n    }\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eBrowse the source code: \u003ca href=\"https://github.com/self-actuated/actuated-cli/blob/master/cmd/repair.go\"\u003erepair.go\u003c/a\u003e\u003c/p\u003e\n\u003ch2 id=\"wrapping-up\"\u003eWrapping up\u003c/h2\u003e\n\u003cp\u003eI covered just a few of the recent changes - some were driven by end-user feedback, others were open source contributions, and in some cases, we just wanted to make the CLI easier to use. I've been writing CLIs for a long time, and I still have a lot to learn.\u003c/p\u003e\n\u003cp\u003eWhat CLIs do you maintain? Could you apply any of the above to them?\u003c/p\u003e\n\u003cp\u003eDo you want to learn how to master the fundamentals of Go? Check out my eBook: \u003ca href=\"https://store.openfaas.com/l/everyday-golang\"\u003eEveryday Go\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eIf you're on a budget, I would recommend checkout out the official \u003ca href=\"https://go.dev/tour/\"\u003eGo tour\u003c/a\u003e, too. It'll help you understand some of the basics of the language and is a good primer for the e-book.\u003c/p\u003e\n\u003cp\u003eRead the source code of the CLIs we mentioned:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/self-actuated/actions-usage\"\u003eactions-usage\u003c/a\u003e - free analytics tool for GitHub Actions\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/self-actuated/actuated-cli\"\u003eactuated-cli\u003c/a\u003e - CLI client for actuated customers\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/openfaas/faas-cli\"\u003efaas-cli\u003c/a\u003e - CLI client for OpenFaaS\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/alexellis/k3sup\"\u003ek3sup\u003c/a\u003e - Install K3s over SSH\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/alexellis/arkade\"\u003earkade\u003c/a\u003e - Download CLI tools from GitHub releases\u003c/li\u003e\n\u003c/ul\u003e","title":"How to develop a great CLI with Go","description":"Alex shares his insights from building half a dozen popular Go CLIs. Which can you apply to your projects?","tags":["images","packer","qemu","kvm"],"author_img":"alex","image":"/images/2023-08-great-cli/background.png","date":"2023-08-22"}},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"develop-a-great-go-cli"},"buildId":"4PQzJ-L1XAyTxxcve_Nyw","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>