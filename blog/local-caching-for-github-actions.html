<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="theme-color" content="#000000"/><meta name="author" content="OpenFaaS Ltd"/><meta name="twitter:card" content="summary_large_image"/><title>Testing the impact of a local cache for building Discourse</title><meta name="description" content="We compare the impact of switching Discourse&#x27;s GitHub Actions from self-hosted runners and a hosted cache, to a local cache with S3."/><meta property="twitter:title" content="Testing the impact of a local cache for building Discourse"/><meta property="twitter:description" content="We compare the impact of switching Discourse&#x27;s GitHub Actions from self-hosted runners and a hosted cache, to a local cache with S3."/><meta property="og:title" content="Testing the impact of a local cache for building Discourse"/><meta property="og:description" content="We compare the impact of switching Discourse&#x27;s GitHub Actions from self-hosted runners and a hosted cache, to a local cache with S3."/><meta name="twitter:image:src" content="https://actuated.dev/images/2024-02-local-caching-for-github-actions/background.png"/><meta property="og:image" content="https://actuated.dev/images/2024-02-local-caching-for-github-actions/background.png"/><meta name="next-head-count" content="13"/><meta charSet="utf-8"/><link rel="icon" type="image/png" href="/images/actuated.png"/><link rel="stylesheet" href="https://rsms.me/inter/inter.css"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css"/><link rel="manifest" href="/manifest.json"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-M5YNDNX7VT"></script><script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'G-M5YNDNX7VT');
          </script><link rel="apple-touch-icon" href="/images/actuated.png"/><link rel="preload" href="/_next/static/css/835182c647a0329c.css" as="style"/><link rel="stylesheet" href="/_next/static/css/835182c647a0329c.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-8fa1640cc84ba8fe.js" defer=""></script><script src="/_next/static/chunks/framework-114634acb84f8baa.js" defer=""></script><script src="/_next/static/chunks/main-34e2100d07ae5757.js" defer=""></script><script src="/_next/static/chunks/pages/_app-ba4f0f0b110ca3d9.js" defer=""></script><script src="/_next/static/chunks/552-542f150c917a7625.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bslug%5D-109b0d2eddac75b5.js" defer=""></script><script src="/_next/static/bR4Jv3N8T_1-64ExyobFe/_buildManifest.js" defer=""></script><script src="/_next/static/bR4Jv3N8T_1-64ExyobFe/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="bg-white"><header><div class="relative bg-white" data-headlessui-state=""><div class="mx-auto flex max-w-7xl items-center justify-between px-4 py-6 sm:px-6 md:justify-start md:space-x-10 lg:px-8"><div class="flex justify-start lg:w-0 lg:flex-1"><a href="/"><span class="sr-only">Actuated</span><img class="h-8 w-auto sm:h-10" src="/images/actuated.png" alt="Actuated logo"/></a></div><div class="-my-2 -mr-2 md:hidden"><button class="inline-flex items-center justify-center rounded-md bg-white p-2 text-gray-400 hover:bg-gray-100 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500" type="button" aria-expanded="false" data-headlessui-state=""><span class="sr-only">Open menu</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" class="h-6 w-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"></path></svg></button></div><nav class="hidden space-x-10 md:flex"><div class="relative" data-headlessui-state=""><button class="text-gray-500 group inline-flex items-center rounded-md bg-white text-base font-medium hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" type="button" aria-expanded="false" data-headlessui-state=""><span>Solutions</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="text-gray-400 ml-2 h-5 w-5 group-hover:text-gray-500"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"></path></svg></button></div><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/blog">Blog</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="https://actuated.dev/blog/blazing-fast-ci-with-microvms">Announcement</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/pricing">Pricing</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="https://docs.actuated.dev/">Docs</a></nav><div class="hidden items-center justify-end md:flex md:flex-1 lg:w-0"><a href="https://dashboard.actuated.dev" class="whitespace-nowrap text-base font-medium text-gray-500 hover:text-gray-900">Sign in</a><a href="/pricing" class="ml-8 inline-flex items-center justify-center whitespace-nowrap rounded-md border border-transparent bg-indigo-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-indigo-700">Sign-up</a></div></div></div></header><main><div class="container mx-auto max-w-4xl bg-white mt-4 px-4 sm:px-6"><h1 id="post_title" class="text-3xl mb-3 leading-8 font-extrabold tracking-tight text-gray-900 sm:text-4xl sm:leading-10 text-center">Testing the impact of a local cache for building Discourse</h1></div><div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-4xl"><div class="border-b border-gray-200 py-4 flex items-center text-gray-500 mx-auto"><div><img class="h-10 w-10 rounded-full" src="/images/welteki.jpg" alt=""/></div><div class="ml-3"><p id="post_author" class="text-sm leading-5 font-medium text-gray-900"></p><div class="flex text-sm leading-5 text-gray-500"><time dateTime="2024-02-23" id="post_date">February 23, 2024</time><span class="mx-1"></span></div></div></div><div class="mt-6 prose sm:prose-lg max-w-none"><p id="post_description" class="mb-4">We compare the impact of switching Discourse&#x27;s GitHub Actions from self-hosted runners and a hosted cache, to a local cache with S3.</p></div><div id="post_content" class="mt-6 prose sm:prose-lg max-w-none"><p>We heard from the <a href="https://github.com/discourse/discourse">Discourse</a> project last year because they were looking to speed up their builds. After trying out a couple of solutions that automated self-hosted runners, they found out that whilst faster CPUs were nice, reliability was a problem and the cache hosted on GitHub's network became the new bottleneck. We ran some tests to compare the hosted cache with hosted runners, to self-hosted with a local cache running with S3. This post will cover what we found.</p>
<img src="/images/2024-02-local-caching-for-github-actions/discourse-readme-logo.png" width="200" alt="Discourse logo">
<blockquote>
<p>Discourse is the online home for your community. We offer a 100% open source community platform to those who want complete control over how and where their site is run.</p>
</blockquote>
<h2>Set up a local cache</h2>
<p>Hosted runners are placed close to the cache which means the latency is very low. Self-hosted runners can also make good use of this cache but the added latency can negate the advantage of switching to these faster runners. Running a local S3 cache with <a href="https://github.com/minio/minio">Minio</a> or <a href="https://github.com/seaweedfs/seaweedfs">Seaweedfs</a> on the self hosted runner or in the same region/network can solve this problem.</p>
<p>For this test we ran the cache on the runner host. <a href="https://docs.actuated.dev/tasks/local-github-cache/">Instructions</a> to set up a local S3 cache with Seaweedfs can be found in our docs.</p>
<p>The Discourse repo is already using the <code>actions/cache</code>in their tests workflow which makes it easy to switch out the official <a href="https://github.com/actions/cache">actions/cache</a> with <a href="https://github.com/tespkg/actions-cache">tespkg/actions-cache</a>.</p>
<p>The S3 cache is not directly compatible with the official <a href="https://github.com/actions/cache">actions/cache</a> and some changes to the workflows are required to start using the cache.</p>
<p>The <code>tespkg/actions-cache</code> supports the same properties as the actions cache and only requires some additional parameters to configure the S3 connection.</p>
<pre><code class="hljs language-diff"> - name: Bundler cache
<span class="hljs-deletion">-  uses: actions/cache@v3</span>
<span class="hljs-addition">+  uses: tespkg/actions-cache@v1</span>
   with:
<span class="hljs-addition">+    endpoint: "192.168.128.1"</span>
<span class="hljs-addition">+    port: 8333</span>
<span class="hljs-addition">+    insecure: true</span>
<span class="hljs-addition">+    accessKey: ${{ secrets.ACTIONS_CACHE_ACCESS_KEY }}</span>
<span class="hljs-addition">+    secretKey: ${{ secrets.ACTIONS_CACHE_SECRET_KEY }}</span>
<span class="hljs-addition">+    bucket: actuated-runners</span>
<span class="hljs-addition">+    region: local</span>
<span class="hljs-addition">+    use-fallback: false</span>

     path: vendor/bundle
     key: ${{ runner.os }}-${{ matrix.ruby }}-gem-${{ hashFiles('**/Gemfile.lock') }}-cachev2
</code></pre>
<p>The endpoint could also be a HTTPS URL to a S3 server hosted within the same network as the self-hosted runners.</p>
<p>If you are relying on the built-in cache support that is included in some actions like <a href="https://github.com/actions/setup-node#caching-global-packages-data">setup-node</a> and <a href="https://github.com/actions/setup-go">setup-go</a> you will need to add an additional caching step to your workflow as they are not directly compatible with the self-hosted S3 cache.</p>
<h2>The impact of switching to a local cache.</h2>
<p>The <a href="https://github.com/discourse/discourse/actions/workflows/tests.yml">Tests workflow</a> from the <a href="https://github.com/discourse/discourse">Discourse repository</a> was used to test the impact of switching to a local cache. We ran the workflow on a self-hosted Actuated runner, both with the S3 local cache and with the GitHub cache.</p>
<p>Next we looked at the time required to restore the caches in our two environments and compared it with the times we saw on GitHub hosted runners:</p>
<table>
<thead>
<tr>
<th></th>
<th>Bundler cache<br>(±273MB)</th>
<th>Yarn cache<br>(±433MB)</th>
<th>Plugins gems cache<br>(±51MB)</th>
<th>App state cache<br>(±1MB)</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Actuated with local cache</strong></td>
<td>5s</td>
<td>11s</td>
<td>1s</td>
<td>0s</td>
</tr>
<tr>
<td><strong>Actuated with hosted cache</strong></td>
<td>13s</td>
<td>19s</td>
<td>3s</td>
<td>2s</td>
</tr>
<tr>
<td><strong>Runner &#x26; cache hosted on GitHub</strong></td>
<td>6s</td>
<td>11s</td>
<td>3s</td>
<td>2s</td>
</tr>
</tbody>
</table>
<p>While the GitHub runner and the self-hosted runner with a local cache perform very similarly, cache restores on the self-hosted runner that uses the GitHub cache take a bit longer.</p>
<p>If we take a look at the yarn cache, which is the biggest cache, we can see that switching to the local S3 cache saved 8s for the cache size in this test vs using GitHub's cache from a self-hosted runner. This is a 42% improvement.</p>
<p>Depending on your workflow and the cache size this can add up quickly. If a pipeline has multiple steps or when you are running matrix builds a cache step may need to run multiple times. In the case of the Discourse repo this cache step runs nine times which adds up to 1m12s that can be saved per workflow run.</p>
<p>When Discourse approached us, we found that they had around a dozen jobs running for each pull request, all with varying sizes of caches. At busy times of the day, their global team could have 10 or more of those pull requests running, so these savings could add up to a significant amount.</p>
<p><strong>What if you also cached git checkout</strong></p>
<p>If your repository is a monorepo or has lots of large artifacts, you may get a speed boost caching the <code>git checkout</code> step too. Depending on where your runners are hosted, pulling from GitHub can take some time vs. restoring the same files from a local cache.</p>
<p>We demonstrated what impact that had for Settlemint's CTO in <a href="/blog/faster-self-hosted-cache">this case study</a>. They saw a cached checkout using a GitHub's hosted cache from from 2m40s to 11s.</p>
<p><strong>How we improved testpkg's custom action</strong></p>
<p>During our testing we noticed that every cache restore took a minimum of 10 seconds regardless of the cache size. It turned out to be an issue with timeouts in the <code>tespkg/actions-cache</code> action when listing objects in S3. We reported it and sent them <a href="https://github.com/tespkg/actions-cache/pull/44">a pull request with a fix</a>.</p>
<p>With the fix in place restoring small caches from the local cache dropped from 10s to sub 1s.</p>
<h2>Conclusion</h2>
<p>After switching to a local S3 cache we saw a very significant improvement in the cache latency. Depending on how the cache is used in your workflow and the size of your cache artifacts switching to a local S3 cache might even have a bigger impact.</p>
<p>Both Seaweedfs and Minio were tested in our setup and they performed in a very similar way. Both have different open source licenses, so we'd recommend reading those before picking one or the other. Of course you could also use AWS S3, Google Cloud Storage, or another S3 compatible hosted service.</p>
<p>In addition to the reduced latency, switching to a self hosted cache has a couple of other benefits.</p>
<ul>
<li>No limit on the cache size. The GitHub cache has a size limit of 10GB before the oldest cache entries start to get pruned.</li>
<li>No egress costs for pushing data to the cache from self-hosted runners.</li>
</ul>
<p>GitHub's caching action does not yet support using a custom S3 server, so we had to make some minor adjustments to the Discourse's workflow files. For this reason, if you use something like setup-go or setup-node, you won't be able to just set <code>cache: true</code>. Instead you'll need an independent caching step with the <code>testpkg/actions-cache</code> action.</p>
<p>If you'd like to reach out to us and see if we can advise you on how to optmise your builds, you can <a href="https://actuated.dev/pricing">set up a call with us here.</a>.</p>
<p>If you want to learn more about caching for GitHub Actions checkout some of our other blog posts:</p>
<p>You may also like:</p>
<ul>
<li><a href="https://actuated.dev/blog/caching-in-github-actions">Make your builds run faster with Caching for GitHub Actions</a></li>
<li><a href="https://actuated.dev/blog/faster-self-hosted-cache">Fixing the cache latency for self-hosted GitHub Actions</a></li>
<li><a href="https://actuated.dev/blog/is-the-self-hosted-runner-safe-github-actions">Is GitHub's self-hosted runner safe for open source?</a></li>
</ul></div></div></main><footer class="bg-white"><div class="mx-auto max-w-7xl py-12 px-4 sm:px-6 md:flex md:items-center md:justify-between lg:px-8"><div class="flex justify-center space-x-6 md:order-2"><a class="text-gray-400 hover:text-gray-500" href="https://twitter.com/selfactuated"><span class="sr-only">Twitter</span><svg fill="currentColor" viewBox="0 0 24 24" class="h-6 w-6" aria-hidden="true"><path d="M8.29 20.251c7.547 0 11.675-6.253 11.675-11.675 0-.178 0-.355-.012-.53A8.348 8.348 0 0022 5.92a8.19 8.19 0 01-2.357.646 4.118 4.118 0 001.804-2.27 8.224 8.224 0 01-2.605.996 4.107 4.107 0 00-6.993 3.743 11.65 11.65 0 01-8.457-4.287 4.106 4.106 0 001.27 5.477A4.072 4.072 0 012.8 9.713v.052a4.105 4.105 0 003.292 4.022 4.095 4.095 0 01-1.853.07 4.108 4.108 0 003.834 2.85A8.233 8.233 0 012 18.407a11.616 11.616 0 006.29 1.84"></path></svg></a><a class="text-gray-400 hover:text-gray-500" href="https://github.com/self-actuated"><span class="sr-only">GitHub</span><svg fill="currentColor" viewBox="0 0 24 24" class="h-6 w-6" aria-hidden="true"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"></path></svg></a><a class="text-gray-400 hover:text-gray-500" href="/rss.xml"><span class="sr-only">RSS</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M12.75 19.5v-.75a7.5 7.5 0 00-7.5-7.5H4.5m0-6.75h.75c7.87 0 14.25 6.38 14.25 14.25v.75M6 18.75a.75.75 0 11-1.5 0 .75.75 0 011.5 0z"></path></svg></a></div><div class="mt-8 md:order-1 md:mt-0"><p class="text-center text-base text-gray-400">© 2022 <a href="https://openfaas.com">OpenFaaS Ltd</a>, Inc. All rights reserved.</p></div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"local-caching-for-github-actions","fileName":"2024-02-23-local-caching-for-github-actions.md","contentHtml":"\u003cp\u003eWe heard from the \u003ca href=\"https://github.com/discourse/discourse\"\u003eDiscourse\u003c/a\u003e project last year because they were looking to speed up their builds. After trying out a couple of solutions that automated self-hosted runners, they found out that whilst faster CPUs were nice, reliability was a problem and the cache hosted on GitHub's network became the new bottleneck. We ran some tests to compare the hosted cache with hosted runners, to self-hosted with a local cache running with S3. This post will cover what we found.\u003c/p\u003e\n\u003cimg src=\"/images/2024-02-local-caching-for-github-actions/discourse-readme-logo.png\" width=\"200\" alt=\"Discourse logo\"\u003e\n\u003cblockquote\u003e\n\u003cp\u003eDiscourse is the online home for your community. We offer a 100% open source community platform to those who want complete control over how and where their site is run.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch2\u003eSet up a local cache\u003c/h2\u003e\n\u003cp\u003eHosted runners are placed close to the cache which means the latency is very low. Self-hosted runners can also make good use of this cache but the added latency can negate the advantage of switching to these faster runners. Running a local S3 cache with \u003ca href=\"https://github.com/minio/minio\"\u003eMinio\u003c/a\u003e or \u003ca href=\"https://github.com/seaweedfs/seaweedfs\"\u003eSeaweedfs\u003c/a\u003e on the self hosted runner or in the same region/network can solve this problem.\u003c/p\u003e\n\u003cp\u003eFor this test we ran the cache on the runner host. \u003ca href=\"https://docs.actuated.dev/tasks/local-github-cache/\"\u003eInstructions\u003c/a\u003e to set up a local S3 cache with Seaweedfs can be found in our docs.\u003c/p\u003e\n\u003cp\u003eThe Discourse repo is already using the \u003ccode\u003eactions/cache\u003c/code\u003ein their tests workflow which makes it easy to switch out the official \u003ca href=\"https://github.com/actions/cache\"\u003eactions/cache\u003c/a\u003e with \u003ca href=\"https://github.com/tespkg/actions-cache\"\u003etespkg/actions-cache\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eThe S3 cache is not directly compatible with the official \u003ca href=\"https://github.com/actions/cache\"\u003eactions/cache\u003c/a\u003e and some changes to the workflows are required to start using the cache.\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003etespkg/actions-cache\u003c/code\u003e supports the same properties as the actions cache and only requires some additional parameters to configure the S3 connection.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-diff\"\u003e - name: Bundler cache\n\u003cspan class=\"hljs-deletion\"\u003e-  uses: actions/cache@v3\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+  uses: tespkg/actions-cache@v1\u003c/span\u003e\n   with:\n\u003cspan class=\"hljs-addition\"\u003e+    endpoint: \"192.168.128.1\"\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+    port: 8333\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+    insecure: true\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+    accessKey: ${{ secrets.ACTIONS_CACHE_ACCESS_KEY }}\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+    secretKey: ${{ secrets.ACTIONS_CACHE_SECRET_KEY }}\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+    bucket: actuated-runners\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+    region: local\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+    use-fallback: false\u003c/span\u003e\n\n     path: vendor/bundle\n     key: ${{ runner.os }}-${{ matrix.ruby }}-gem-${{ hashFiles('**/Gemfile.lock') }}-cachev2\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe endpoint could also be a HTTPS URL to a S3 server hosted within the same network as the self-hosted runners.\u003c/p\u003e\n\u003cp\u003eIf you are relying on the built-in cache support that is included in some actions like \u003ca href=\"https://github.com/actions/setup-node#caching-global-packages-data\"\u003esetup-node\u003c/a\u003e and \u003ca href=\"https://github.com/actions/setup-go\"\u003esetup-go\u003c/a\u003e you will need to add an additional caching step to your workflow as they are not directly compatible with the self-hosted S3 cache.\u003c/p\u003e\n\u003ch2\u003eThe impact of switching to a local cache.\u003c/h2\u003e\n\u003cp\u003eThe \u003ca href=\"https://github.com/discourse/discourse/actions/workflows/tests.yml\"\u003eTests workflow\u003c/a\u003e from the \u003ca href=\"https://github.com/discourse/discourse\"\u003eDiscourse repository\u003c/a\u003e was used to test the impact of switching to a local cache. We ran the workflow on a self-hosted Actuated runner, both with the S3 local cache and with the GitHub cache.\u003c/p\u003e\n\u003cp\u003eNext we looked at the time required to restore the caches in our two environments and compared it with the times we saw on GitHub hosted runners:\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003e\u003c/th\u003e\n\u003cth\u003eBundler cache\u003cbr\u003e(±273MB)\u003c/th\u003e\n\u003cth\u003eYarn cache\u003cbr\u003e(±433MB)\u003c/th\u003e\n\u003cth\u003ePlugins gems cache\u003cbr\u003e(±51MB)\u003c/th\u003e\n\u003cth\u003eApp state cache\u003cbr\u003e(±1MB)\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003cstrong\u003eActuated with local cache\u003c/strong\u003e\u003c/td\u003e\n\u003ctd\u003e5s\u003c/td\u003e\n\u003ctd\u003e11s\u003c/td\u003e\n\u003ctd\u003e1s\u003c/td\u003e\n\u003ctd\u003e0s\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003cstrong\u003eActuated with hosted cache\u003c/strong\u003e\u003c/td\u003e\n\u003ctd\u003e13s\u003c/td\u003e\n\u003ctd\u003e19s\u003c/td\u003e\n\u003ctd\u003e3s\u003c/td\u003e\n\u003ctd\u003e2s\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003cstrong\u003eRunner \u0026#x26; cache hosted on GitHub\u003c/strong\u003e\u003c/td\u003e\n\u003ctd\u003e6s\u003c/td\u003e\n\u003ctd\u003e11s\u003c/td\u003e\n\u003ctd\u003e3s\u003c/td\u003e\n\u003ctd\u003e2s\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003eWhile the GitHub runner and the self-hosted runner with a local cache perform very similarly, cache restores on the self-hosted runner that uses the GitHub cache take a bit longer.\u003c/p\u003e\n\u003cp\u003eIf we take a look at the yarn cache, which is the biggest cache, we can see that switching to the local S3 cache saved 8s for the cache size in this test vs using GitHub's cache from a self-hosted runner. This is a 42% improvement.\u003c/p\u003e\n\u003cp\u003eDepending on your workflow and the cache size this can add up quickly. If a pipeline has multiple steps or when you are running matrix builds a cache step may need to run multiple times. In the case of the Discourse repo this cache step runs nine times which adds up to 1m12s that can be saved per workflow run.\u003c/p\u003e\n\u003cp\u003eWhen Discourse approached us, we found that they had around a dozen jobs running for each pull request, all with varying sizes of caches. At busy times of the day, their global team could have 10 or more of those pull requests running, so these savings could add up to a significant amount.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhat if you also cached git checkout\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eIf your repository is a monorepo or has lots of large artifacts, you may get a speed boost caching the \u003ccode\u003egit checkout\u003c/code\u003e step too. Depending on where your runners are hosted, pulling from GitHub can take some time vs. restoring the same files from a local cache.\u003c/p\u003e\n\u003cp\u003eWe demonstrated what impact that had for Settlemint's CTO in \u003ca href=\"/blog/faster-self-hosted-cache\"\u003ethis case study\u003c/a\u003e. They saw a cached checkout using a GitHub's hosted cache from from 2m40s to 11s.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eHow we improved testpkg's custom action\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eDuring our testing we noticed that every cache restore took a minimum of 10 seconds regardless of the cache size. It turned out to be an issue with timeouts in the \u003ccode\u003etespkg/actions-cache\u003c/code\u003e action when listing objects in S3. We reported it and sent them \u003ca href=\"https://github.com/tespkg/actions-cache/pull/44\"\u003ea pull request with a fix\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eWith the fix in place restoring small caches from the local cache dropped from 10s to sub 1s.\u003c/p\u003e\n\u003ch2\u003eConclusion\u003c/h2\u003e\n\u003cp\u003eAfter switching to a local S3 cache we saw a very significant improvement in the cache latency. Depending on how the cache is used in your workflow and the size of your cache artifacts switching to a local S3 cache might even have a bigger impact.\u003c/p\u003e\n\u003cp\u003eBoth Seaweedfs and Minio were tested in our setup and they performed in a very similar way. Both have different open source licenses, so we'd recommend reading those before picking one or the other. Of course you could also use AWS S3, Google Cloud Storage, or another S3 compatible hosted service.\u003c/p\u003e\n\u003cp\u003eIn addition to the reduced latency, switching to a self hosted cache has a couple of other benefits.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eNo limit on the cache size. The GitHub cache has a size limit of 10GB before the oldest cache entries start to get pruned.\u003c/li\u003e\n\u003cli\u003eNo egress costs for pushing data to the cache from self-hosted runners.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eGitHub's caching action does not yet support using a custom S3 server, so we had to make some minor adjustments to the Discourse's workflow files. For this reason, if you use something like setup-go or setup-node, you won't be able to just set \u003ccode\u003ecache: true\u003c/code\u003e. Instead you'll need an independent caching step with the \u003ccode\u003etestpkg/actions-cache\u003c/code\u003e action.\u003c/p\u003e\n\u003cp\u003eIf you'd like to reach out to us and see if we can advise you on how to optmise your builds, you can \u003ca href=\"https://actuated.dev/pricing\"\u003eset up a call with us here.\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eIf you want to learn more about caching for GitHub Actions checkout some of our other blog posts:\u003c/p\u003e\n\u003cp\u003eYou may also like:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://actuated.dev/blog/caching-in-github-actions\"\u003eMake your builds run faster with Caching for GitHub Actions\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://actuated.dev/blog/faster-self-hosted-cache\"\u003eFixing the cache latency for self-hosted GitHub Actions\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://actuated.dev/blog/is-the-self-hosted-runner-safe-github-actions\"\u003eIs GitHub's self-hosted runner safe for open source?\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e","title":"Testing the impact of a local cache for building Discourse","description":"We compare the impact of switching Discourse's GitHub Actions from self-hosted runners and a hosted cache, to a local cache with S3.","tags":["s3","githubactions","cache","latency"],"author_img":"welteki","image":"/images/2024-02-local-caching-for-github-actions/background.png","date":"2024-02-23"}},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"local-caching-for-github-actions"},"buildId":"bR4Jv3N8T_1-64ExyobFe","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>