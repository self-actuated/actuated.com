<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="theme-color" content="#000000"/><meta name="author" content="OpenFaaS Ltd"/><meta name="twitter:card" content="summary_large_image"/><title>Right sizing VMs for GitHub Actions</title><meta name="description" content="How do you pick the right VM size for your GitHub Actions runners? We wrote a custom tool to help you find out."/><meta property="twitter:title" content="Right sizing VMs for GitHub Actions"/><meta property="twitter:description" content="How do you pick the right VM size for your GitHub Actions runners? We wrote a custom tool to help you find out."/><meta property="og:title" content="Right sizing VMs for GitHub Actions"/><meta property="og:description" content="How do you pick the right VM size for your GitHub Actions runners? We wrote a custom tool to help you find out."/><meta name="twitter:image:src" content="https://actuated.com/images/2024-03-right-sizing/background.png"/><meta property="og:image" content="https://actuated.com/images/2024-03-right-sizing/background.png"/><meta name="next-head-count" content="13"/><meta charSet="utf-8"/><link rel="icon" type="image/png" href="/images/actuated.png"/><link rel="stylesheet" href="https://rsms.me/inter/inter.css"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css"/><link rel="manifest" href="/manifest.json"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-M5YNDNX7VT"></script><script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'G-M5YNDNX7VT');
          </script><link rel="apple-touch-icon" href="/images/actuated.png"/><link rel="preload" href="/_next/static/css/9ef3bf131416ffb1.css" as="style"/><link rel="stylesheet" href="/_next/static/css/9ef3bf131416ffb1.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-8fa1640cc84ba8fe.js" defer=""></script><script src="/_next/static/chunks/framework-114634acb84f8baa.js" defer=""></script><script src="/_next/static/chunks/main-34e2100d07ae5757.js" defer=""></script><script src="/_next/static/chunks/pages/_app-ff4ebdfd2ac697b4.js" defer=""></script><script src="/_next/static/chunks/552-542f150c917a7625.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bslug%5D-386521db085c1ba3.js" defer=""></script><script src="/_next/static/SN5f_wZ3NgmyOMxUMsfDD/_buildManifest.js" defer=""></script><script src="/_next/static/SN5f_wZ3NgmyOMxUMsfDD/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="bg-white"><header><div class="relative bg-white" data-headlessui-state=""><div class="mx-auto flex max-w-7xl items-center justify-between px-4 py-6 sm:px-6 md:justify-start md:space-x-10 lg:px-8"><div class="flex justify-start lg:w-0 lg:flex-1"><a href="/"><span class="sr-only">Actuated</span><img class="h-8 w-auto sm:h-10" src="/images/actuated.png" alt="Actuated logo"/></a></div><div class="-my-2 -mr-2 md:hidden"><button class="inline-flex items-center justify-center rounded-md bg-white p-2 text-gray-400 hover:bg-gray-100 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500" type="button" aria-expanded="false" data-headlessui-state=""><span class="sr-only">Open menu</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" class="h-6 w-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"></path></svg></button></div><nav class="hidden space-x-10 md:flex"><div class="relative" data-headlessui-state=""><button class="text-gray-500 group inline-flex items-center rounded-md bg-white text-base font-medium hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" type="button" aria-expanded="false" data-headlessui-state=""><span>Solutions</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="text-gray-400 ml-2 h-5 w-5 group-hover:text-gray-500"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"></path></svg></button></div><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/blog">Blog</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/blog/blazing-fast-ci-with-microvms">Announcement</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/pricing">Pricing</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="https://docs.actuated.com/">Docs</a></nav><div class="hidden items-center justify-end md:flex md:flex-1 lg:w-0"><a href="https://dashboard.actuated.com" class="whitespace-nowrap text-base font-medium text-gray-500 hover:text-gray-900">Sign in</a><a href="/pricing" class="ml-8 inline-flex items-center justify-center whitespace-nowrap rounded-md border border-transparent bg-indigo-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-indigo-700">Sign-up</a></div></div></div></header><main><div class="container mx-auto max-w-4xl bg-white mt-4 px-4 sm:px-6"><h1 id="post_title" class="text-3xl mb-3 leading-8 font-extrabold tracking-tight text-gray-900 sm:text-4xl sm:leading-10 text-center">Right sizing VMs for GitHub Actions</h1></div><div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-4xl"><div class="border-b border-gray-200 py-4 flex items-center text-gray-500 mx-auto"><div><img class="h-10 w-10 rounded-full" src="/images/alex.jpg" alt=""/></div><div class="ml-3"><p id="post_author" class="text-sm leading-5 font-medium text-gray-900"></p><div class="flex text-sm leading-5 text-gray-500"><time dateTime="2024-03-01" id="post_date">March 1, 2024</time><span class="mx-1"></span></div></div></div><div class="mt-6 prose sm:prose-lg max-w-none"><p id="post_description" class="mb-4">How do you pick the right VM size for your GitHub Actions runners? We wrote a custom tool to help you find out.</p></div><div id="post_content" class="mt-6 prose sm:prose-lg max-w-none"><p>When we <a href="/blog/arm-ci-cncf-ampere">onboarded the etcd project from the CNCF</a>, they'd previously been using a self-hosted runner for their repositories on a bare-metal host. There are several drawbacks to this approach, <a href="/blog/is-the-self-hosted-runner-safe-github-actions">including potential security issues, especially when using Docker</a>.</p>
<p>actuated VM sizes can be configured by a label, and you can pick any combination of vCPU and RAM, there's no need to pick a pre-defined size.</p>
<p>At the same time, it can be hard to know what size to pick, and if you make the VM size too large, then you won't be able to run as many jobs at once.</p>
<p>There's three main things to consider:</p>
<ul>
<li>The number of vCPUs - if there are not enough for the job, it'll be slower, and may hit timeouts which cause a failure</li>
<li>The amount of RAM - if there's not enough, all the RAM could be consumed, and the VM will crash. You may not even get a helpful error message</li>
<li>The amount of disk space per VM - if you make this too high, you'll be limited on the amount of jobs you can run at once, if you make it too low, jobs can fail, sometimes with non-obvious error messages</li>
</ul>
<p>We wrote a tool called vmmeter which takes samples of resource consumption over the duration of a build, and will then report back with the peak and average values.</p>
<p>vmmeter is written in Go, and is available to use as a pre-built binary. We may consider open-sourcing it in the future. The information you gather still needs to be carefully considered and some experimentation will be required to get the right balance between VM size and performance.</p>
<p>The tool can be run in an action by adding some YAML, however, it can also be run on any Linux system using bash, or potentially within a different CI/CD system. See the note at the end if you're interested in trying that out.</p>
<h2 id="running-vmmeter-inside-github-actions">Running vmmeter inside GitHub Actions</h2>
<p>This action will work with a Linux VM environment, so with a hosted runner or with actuated. It may not work when used within the <code>containers:</code> section of a workflow, or with a Kubernetes-based runner.</p>
<p>Add to the top of your GitHub action:</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">steps:</span>
<span class="hljs-comment"># vmmeter start</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">alexellis/setup-arkade@master</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">self-actuated/vmmeter-action@master</span>
<span class="hljs-comment"># vmmeter end</span>
</code></pre>
<p>The first set installs arkade, which we then use to extract vmmeter from a container image to the host.</p>
<p>Then <code>self-actuated/vmmeter-action</code> is used to run the tool in the background, and also runs a post-setup setup to stop the measurements, and upload the results to the workflow run.</p>
<p>To show you how the tool works, I ran a simple <a href="https://github.com/actuated-samples/kernel-builder-linux-6.0/blob/master/.github/workflows/microvm-kernel.yml">build of the Linux Kernel</a> without any additional modules or options added in.</p>
<p>Here's the summary text that was uploaded to the workflow run:</p>
<pre><code>Total RAM: 61.2GB
Total vCPU: 32
Load averages:
Max 1 min: 5.63 (17.59%)
Max 5 min: 1.25 (3.91%)
Max 15 min: 0.41 (1.28%)

RAM usage (10 samples):
Max RAM usage: 2.528GB

Max 10s avg RAM usage: 1.73GB
Max 1 min avg RAM usage: 1.208GB
Max 5 min avg RAM usage: 1.208GB

Disk read: 374.2MB
Disk write: 458.2MB
Max disk I/O inflight: 0
Free: 45.57GB	Used: 4.249GB	(Total: 52.52GB)

Egress adapter RX: 271.4MB
Egress adapter TX: 1.535MB

Entropy min: 256
Entropy max: 256

Max open connections: 125
Max open files: 1696
Processes since boot: 18081

Run time: 45s
</code></pre>
<p>The above text will be added to each job's summary when using vmmeter, but you can disable the summary by setting <code>createSummary: false</code> in the action's inputs. The output will still be available in the logs of the action under the <em>post</em> step, click to expand it.</p>
<pre><code class="hljs language-yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">self-actuated/vmmeter-action@master</span>
  <span class="hljs-attr">with:</span>
    <span class="hljs-attr">createSummary:</span> <span class="hljs-literal">false</span>
</code></pre>
<p>The main thing to look for is the peak load on the system. This roughly corresponds to the amount of vCPUs used at peak. If the number is close to the amount you allocated, then try allocating more and measuring the effect in build time and peak usage.</p>
<p>We've found that some jobs are RAM hungry, and others use a lot of CPU. So if you find that the RAM requested is much higher than the peak or average usage, the chances are that you can safely reduce it.</p>
<p>Disk usage is self-explanatory, if you've allocated around 30GB per VM, and a job is getting close to that limit, it may need increasing to avoid future failures.</p>
<p>Disk, network read/write and open files are potential indicators of I/O contention. if a job reads or writes a large amount of data over the network interface, then that may become a bottleneck. <a href="/blog/local-caching-for-github-actions">Caching</a> is one of the ways to work around that, whether you set up your workflow to use GitHub's hosted cache, or one running in the same datacenter or region as your CI servers.</p>
<h2 id="wrapping-up">Wrapping up</h2>
<p>In one case, a build on the etcd-io project was specified with 16 vCPU and 32GB of RAM, but when running vmmeter, they found that less than 2 vCPU was used at peak and less than 3GB of RAM. That's a significant difference.</p>
<p>Toolpath is a commercial customer, and we were able to help them reduce their wall time per pull request from 6 hours to 60 minutes. Or from 6x 1 hour jobs to 6x 15-20 minute jobs running in parallel. Jason Gray told me during a product market fit interview that "the level of expertise and support pays for itself". We'd noticed that his teams jobs were requesting far too much CPU, but not enough RAM and were able to make recommendations. We then saw that disk space was running dangerously low, and were able to reconfigure their dedicated build servers for them, remotely, without them having to even think about it.</p>
<p>If you'd like to try out vmmeter, it's free to use on GitHub's hosted runners and on actuated runners. We wouldn't recommend making it a permanent fixture in your workflow, because if it were to fail or exit early for any reason, it may mark the whole build as a failure.</p>
<p>Instead, we recommend you use it learn and explore, and fine-tune your VM sizes. Getting the numbers closer to a right-size could reduce your costs with hosted runners and your efficiency with actuated runners.</p>
<p>The source-code for the action is available here: <a href="https://github.com/self-actuated/vmmeter-action">self-actuated/vmmeter-action</a>.</p>
<ul>
<li><a href="https://github.com/self-actuated/vmmeter-action/blob/master/index.js">index.js</a> is used to setup the tool and start taking measurements</li>
<li><a href="https://github.com/self-actuated/vmmeter-action/blob/master/post.js">post.js</a> communicates to vmmeter over a TCP port and tells it to dump its response to <code>/tmp/vmmeter.log</code>, then to exit</li>
</ul>
<p><em>What if you're not using GitHub Actions?</em></p>
<p>You can run vmmeter with bash on your own system, and may also able to use vmmeter in GitLab CI or Jenkins. You can even just start it up right now, do some work and then call the collect endpoint to see what was used over that period of time, a bit like a generic profiler.</p>
<p>Here are the steps if you want to try out vmmeter on a different CI system like GitLab CI, Jenkins, or just as a standalone tool:</p>
<h3 id="running-vmmeter-outside-of-github-actions">Running vmmeter outside of GitHub Actions</h3>
<p>Download arkade, then extract vmmeter from its OCI image:</p>
<pre><code class="hljs language-bash">curl https://get.arkade.dev | sudo sh
sudo -E arkade oci install ghcr.io/openfaasltd/vmmeter:latest --path /usr/local/bin/
</code></pre>
<p>Start the vmmeter in the background, and check its logs to see that it started up:</p>
<pre><code class="hljs language-bash">/usr/local/bin/vmmeter &#x26;
<span class="hljs-built_in">cat</span> /tmp/vmmeter.log
</code></pre>
<p>At the end of the measurement period, make a HTTP request via curl to the collect the results, and to shutdown the tool:</p>
<pre><code class="hljs language-bash">port=$(<span class="hljs-built_in">cat</span> /tmp/vmmeter.port)
curl http://127.0.0.1:<span class="hljs-variable">$port</span>/collect
</code></pre></div></div></main><footer class="bg-white"><div class="mx-auto max-w-7xl py-12 px-4 sm:px-6 md:flex md:items-center md:justify-between lg:px-8"><div class="flex justify-center space-x-6 md:order-2"><a class="text-gray-400 hover:text-gray-500" href="https://twitter.com/selfactuated"><span class="sr-only">Twitter</span><svg fill="currentColor" viewBox="0 0 24 24" class="h-6 w-6" aria-hidden="true"><path d="M8.29 20.251c7.547 0 11.675-6.253 11.675-11.675 0-.178 0-.355-.012-.53A8.348 8.348 0 0022 5.92a8.19 8.19 0 01-2.357.646 4.118 4.118 0 001.804-2.27 8.224 8.224 0 01-2.605.996 4.107 4.107 0 00-6.993 3.743 11.65 11.65 0 01-8.457-4.287 4.106 4.106 0 001.27 5.477A4.072 4.072 0 012.8 9.713v.052a4.105 4.105 0 003.292 4.022 4.095 4.095 0 01-1.853.07 4.108 4.108 0 003.834 2.85A8.233 8.233 0 012 18.407a11.616 11.616 0 006.29 1.84"></path></svg></a><a class="text-gray-400 hover:text-gray-500" href="https://github.com/self-actuated"><span class="sr-only">GitHub</span><svg fill="currentColor" viewBox="0 0 24 24" class="h-6 w-6" aria-hidden="true"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"></path></svg></a><a class="text-gray-400 hover:text-gray-500" href="/rss.xml"><span class="sr-only">RSS</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M12.75 19.5v-.75a7.5 7.5 0 00-7.5-7.5H4.5m0-6.75h.75c7.87 0 14.25 6.38 14.25 14.25v.75M6 18.75a.75.75 0 11-1.5 0 .75.75 0 011.5 0z"></path></svg></a></div><div class="mt-8 md:order-1 md:mt-0"><p class="text-center text-base text-gray-400">© 2024 <a href="https://openfaas.com">OpenFaaS Ltd</a>. All rights reserved. <a class="hover:underline" href="/terms">Terms &amp; Conditions.</a></p></div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"right-sizing-vms-github-actions","fileName":"2024-03-01-right-sizing-vms-github-actions.md","contentHtml":"\u003cp\u003eWhen we \u003ca href=\"/blog/arm-ci-cncf-ampere\"\u003eonboarded the etcd project from the CNCF\u003c/a\u003e, they'd previously been using a self-hosted runner for their repositories on a bare-metal host. There are several drawbacks to this approach, \u003ca href=\"/blog/is-the-self-hosted-runner-safe-github-actions\"\u003eincluding potential security issues, especially when using Docker\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eactuated VM sizes can be configured by a label, and you can pick any combination of vCPU and RAM, there's no need to pick a pre-defined size.\u003c/p\u003e\n\u003cp\u003eAt the same time, it can be hard to know what size to pick, and if you make the VM size too large, then you won't be able to run as many jobs at once.\u003c/p\u003e\n\u003cp\u003eThere's three main things to consider:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eThe number of vCPUs - if there are not enough for the job, it'll be slower, and may hit timeouts which cause a failure\u003c/li\u003e\n\u003cli\u003eThe amount of RAM - if there's not enough, all the RAM could be consumed, and the VM will crash. You may not even get a helpful error message\u003c/li\u003e\n\u003cli\u003eThe amount of disk space per VM - if you make this too high, you'll be limited on the amount of jobs you can run at once, if you make it too low, jobs can fail, sometimes with non-obvious error messages\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eWe wrote a tool called vmmeter which takes samples of resource consumption over the duration of a build, and will then report back with the peak and average values.\u003c/p\u003e\n\u003cp\u003evmmeter is written in Go, and is available to use as a pre-built binary. We may consider open-sourcing it in the future. The information you gather still needs to be carefully considered and some experimentation will be required to get the right balance between VM size and performance.\u003c/p\u003e\n\u003cp\u003eThe tool can be run in an action by adding some YAML, however, it can also be run on any Linux system using bash, or potentially within a different CI/CD system. See the note at the end if you're interested in trying that out.\u003c/p\u003e\n\u003ch2 id=\"running-vmmeter-inside-github-actions\"\u003eRunning vmmeter inside GitHub Actions\u003c/h2\u003e\n\u003cp\u003eThis action will work with a Linux VM environment, so with a hosted runner or with actuated. It may not work when used within the \u003ccode\u003econtainers:\u003c/code\u003e section of a workflow, or with a Kubernetes-based runner.\u003c/p\u003e\n\u003cp\u003eAdd to the top of your GitHub action:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-attr\"\u003esteps:\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# vmmeter start\u003c/span\u003e\n        \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ealexellis/setup-arkade@master\u003c/span\u003e\n        \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eself-actuated/vmmeter-action@master\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# vmmeter end\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe first set installs arkade, which we then use to extract vmmeter from a container image to the host.\u003c/p\u003e\n\u003cp\u003eThen \u003ccode\u003eself-actuated/vmmeter-action\u003c/code\u003e is used to run the tool in the background, and also runs a post-setup setup to stop the measurements, and upload the results to the workflow run.\u003c/p\u003e\n\u003cp\u003eTo show you how the tool works, I ran a simple \u003ca href=\"https://github.com/actuated-samples/kernel-builder-linux-6.0/blob/master/.github/workflows/microvm-kernel.yml\"\u003ebuild of the Linux Kernel\u003c/a\u003e without any additional modules or options added in.\u003c/p\u003e\n\u003cp\u003eHere's the summary text that was uploaded to the workflow run:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eTotal RAM: 61.2GB\nTotal vCPU: 32\nLoad averages:\nMax 1 min: 5.63 (17.59%)\nMax 5 min: 1.25 (3.91%)\nMax 15 min: 0.41 (1.28%)\n\nRAM usage (10 samples):\nMax RAM usage: 2.528GB\n\nMax 10s avg RAM usage: 1.73GB\nMax 1 min avg RAM usage: 1.208GB\nMax 5 min avg RAM usage: 1.208GB\n\nDisk read: 374.2MB\nDisk write: 458.2MB\nMax disk I/O inflight: 0\nFree: 45.57GB\tUsed: 4.249GB\t(Total: 52.52GB)\n\nEgress adapter RX: 271.4MB\nEgress adapter TX: 1.535MB\n\nEntropy min: 256\nEntropy max: 256\n\nMax open connections: 125\nMax open files: 1696\nProcesses since boot: 18081\n\nRun time: 45s\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe above text will be added to each job's summary when using vmmeter, but you can disable the summary by setting \u003ccode\u003ecreateSummary: false\u003c/code\u003e in the action's inputs. The output will still be available in the logs of the action under the \u003cem\u003epost\u003c/em\u003e step, click to expand it.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eself-actuated/vmmeter-action@master\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003ewith:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003ecreateSummary:\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe main thing to look for is the peak load on the system. This roughly corresponds to the amount of vCPUs used at peak. If the number is close to the amount you allocated, then try allocating more and measuring the effect in build time and peak usage.\u003c/p\u003e\n\u003cp\u003eWe've found that some jobs are RAM hungry, and others use a lot of CPU. So if you find that the RAM requested is much higher than the peak or average usage, the chances are that you can safely reduce it.\u003c/p\u003e\n\u003cp\u003eDisk usage is self-explanatory, if you've allocated around 30GB per VM, and a job is getting close to that limit, it may need increasing to avoid future failures.\u003c/p\u003e\n\u003cp\u003eDisk, network read/write and open files are potential indicators of I/O contention. if a job reads or writes a large amount of data over the network interface, then that may become a bottleneck. \u003ca href=\"/blog/local-caching-for-github-actions\"\u003eCaching\u003c/a\u003e is one of the ways to work around that, whether you set up your workflow to use GitHub's hosted cache, or one running in the same datacenter or region as your CI servers.\u003c/p\u003e\n\u003ch2 id=\"wrapping-up\"\u003eWrapping up\u003c/h2\u003e\n\u003cp\u003eIn one case, a build on the etcd-io project was specified with 16 vCPU and 32GB of RAM, but when running vmmeter, they found that less than 2 vCPU was used at peak and less than 3GB of RAM. That's a significant difference.\u003c/p\u003e\n\u003cp\u003eToolpath is a commercial customer, and we were able to help them reduce their wall time per pull request from 6 hours to 60 minutes. Or from 6x 1 hour jobs to 6x 15-20 minute jobs running in parallel. Jason Gray told me during a product market fit interview that \"the level of expertise and support pays for itself\". We'd noticed that his teams jobs were requesting far too much CPU, but not enough RAM and were able to make recommendations. We then saw that disk space was running dangerously low, and were able to reconfigure their dedicated build servers for them, remotely, without them having to even think about it.\u003c/p\u003e\n\u003cp\u003eIf you'd like to try out vmmeter, it's free to use on GitHub's hosted runners and on actuated runners. We wouldn't recommend making it a permanent fixture in your workflow, because if it were to fail or exit early for any reason, it may mark the whole build as a failure.\u003c/p\u003e\n\u003cp\u003eInstead, we recommend you use it learn and explore, and fine-tune your VM sizes. Getting the numbers closer to a right-size could reduce your costs with hosted runners and your efficiency with actuated runners.\u003c/p\u003e\n\u003cp\u003eThe source-code for the action is available here: \u003ca href=\"https://github.com/self-actuated/vmmeter-action\"\u003eself-actuated/vmmeter-action\u003c/a\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/self-actuated/vmmeter-action/blob/master/index.js\"\u003eindex.js\u003c/a\u003e is used to setup the tool and start taking measurements\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/self-actuated/vmmeter-action/blob/master/post.js\"\u003epost.js\u003c/a\u003e communicates to vmmeter over a TCP port and tells it to dump its response to \u003ccode\u003e/tmp/vmmeter.log\u003c/code\u003e, then to exit\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cem\u003eWhat if you're not using GitHub Actions?\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eYou can run vmmeter with bash on your own system, and may also able to use vmmeter in GitLab CI or Jenkins. You can even just start it up right now, do some work and then call the collect endpoint to see what was used over that period of time, a bit like a generic profiler.\u003c/p\u003e\n\u003cp\u003eHere are the steps if you want to try out vmmeter on a different CI system like GitLab CI, Jenkins, or just as a standalone tool:\u003c/p\u003e\n\u003ch3 id=\"running-vmmeter-outside-of-github-actions\"\u003eRunning vmmeter outside of GitHub Actions\u003c/h3\u003e\n\u003cp\u003eDownload arkade, then extract vmmeter from its OCI image:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003ecurl https://get.arkade.dev | sudo sh\nsudo -E arkade oci install ghcr.io/openfaasltd/vmmeter:latest --path /usr/local/bin/\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eStart the vmmeter in the background, and check its logs to see that it started up:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e/usr/local/bin/vmmeter \u0026#x26;\n\u003cspan class=\"hljs-built_in\"\u003ecat\u003c/span\u003e /tmp/vmmeter.log\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAt the end of the measurement period, make a HTTP request via curl to the collect the results, and to shutdown the tool:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eport=$(\u003cspan class=\"hljs-built_in\"\u003ecat\u003c/span\u003e /tmp/vmmeter.port)\ncurl http://127.0.0.1:\u003cspan class=\"hljs-variable\"\u003e$port\u003c/span\u003e/collect\n\u003c/code\u003e\u003c/pre\u003e","title":"Right sizing VMs for GitHub Actions","description":"How do you pick the right VM size for your GitHub Actions runners? We wrote a custom tool to help you find out.","tags":["efficiency","githubactions","metering"],"author_img":"alex","image":"/images/2024-03-right-sizing/background.png","date":"2024-03-01"}},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"right-sizing-vms-github-actions"},"buildId":"SN5f_wZ3NgmyOMxUMsfDD","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>