{"pageProps":{"post":{"slug":"automate-packer-qemu-image-builds","fileName":"2023-07-25-automate-packer-qemu-image-builds.md","contentHtml":"<p>One of the most popular tools for creating images for virtual machines is <a href=\"https://www.packer.io/\">Packer</a> by <a href=\"https://hashicorp.com\">Hashicorp</a>. Packer automates the process of building images for a variety of platforms from a single source configuration. Different builders can be used to create machines and generate images from those machines.</p>\n<p>In this tutorial we will use the <a href=\"https://developer.hashicorp.com/packer/plugins/builders/qemu\">QEMU builder</a> to create a <a href=\"https://www.linux-kvm.org/page/Main_Page\">KVM</a> virtual machine image.</p>\n<p>We will see how the Packer build can be completely automated by integrating Packer into a continuous integration (CI) pipeline with GitHub Actions. The workflow will automatically trigger image builds on changes and publish the resulting images as GitHub release artifacts.</p>\n<p>Actuated supports nested virtualsation where a VM can make use of KVM to launch additional VMs within a GitHub Action. This makes it possible to run the Packer QEMU builder in GitHub Action workflows. Something that is not possible with GitHub's default hosted runners.</p>\n<blockquote>\n<p>See also: <a href=\"https://actuated.dev/blog/kvm-in-github-actions\">How to run KVM guests in your GitHub Actions</a></p>\n</blockquote>\n<h2 id=\"create-the-packer-template\">Create the Packer template</h2>\n<p>We will be starting from a <a href=\"https://cloud-images.ubuntu.com/\">Ubuntu Cloud Image</a> and modify it to suit our needs. If you need total control of what goes into the image you can start from scratch using the ISO.</p>\n<p>Variables are used in the packer template to set the <code>iso_url</code> and <code>iso_checksum</code>. In addition to these we also use variables to configure the <code>disk_size</code>, <code>ram</code>, <code>cpu</code>, <code>ssh_password</code> and <code>ssh_username</code>:</p>\n<pre><code>variable \"cpu\" {\n  type    = string\n  default = \"2\"\n}\n\nvariable \"disk_size\" {\n  type    = string\n  default = \"40000\"\n}\n\nvariable \"headless\" {\n  type    = string\n  default = \"true\"\n}\n\nvariable \"iso_checksum\" {\n  type    = string\n  default = \"sha256:d699ae158ec028db69fd850824ee6e14c073b02ad696b4efb8c59d37c8025aaa\"\n}\n\nvariable \"iso_url\" {\n  type    = string\n  default = \"https://cloud-images.ubuntu.com/jammy/20230719/jammy-server-cloudimg-amd64.img\"\n}\n\nvariable \"name\" {\n  type    = string\n  default = \"jammy\"\n}\n\nvariable \"ram\" {\n  type    = string\n  default = \"2048\"\n}\n\nvariable \"ssh_password\" {\n  type    = string\n  default = \"ubuntu\"\n}\n\nvariable \"ssh_username\" {\n  type    = string\n  default = \"ubuntu\"\n}\n\nvariable \"version\" {\n  type    = string\n  default = \"\"\n}\n\nvariable \"format\" {\n  type    = string\n  default = \"qcow2\"\n}\n</code></pre>\n<p>The Packer source configuration:</p>\n<pre><code>source \"qemu\" \"jammy\" {\n  accelerator      = \"kvm\"\n  boot_command     = []\n  disk_compression = true\n  disk_interface   = \"virtio\"\n  disk_image       = true\n  disk_size        = var.disk_size\n  format           = var.format\n  headless         = var.headless\n  iso_checksum     = var.iso_checksum\n  iso_url          = var.iso_url\n  net_device       = \"virtio-net\"\n  output_directory = \"artifacts/qemu/${var.name}${var.version}\"\n  qemuargs = [\n    [\"-m\", \"${var.ram}M\"],\n    [\"-smp\", \"${var.cpu}\"],\n    [\"-cdrom\", \"cidata.iso\"]\n  ]\n  communicator           = \"ssh\"\n  shutdown_command       = \"echo '${var.ssh_password}' | sudo -S shutdown -P now\"\n  ssh_password           = var.ssh_password\n  ssh_username           = var.ssh_username\n  ssh_timeout            = \"10m\"\n}\n</code></pre>\n<p>Some notable settings in the source configuration:</p>\n<ul>\n<li>We set <code>disk_image=true</code> since we are starting from an Ubuntu Cloud Image. If you wanted to launch an ISO based installation this would have to be false.</li>\n<li>Notice how the variables are used to configure different VM settings like disk size: <code>disk_size=var.disk_size</code>, image output format: <code>format=var.format</code> and the RAM and CPU for the vm through <code>qemuargs</code>.</li>\n<li>The <code>ssh_username</code> and <code>ssh_password</code> that Packer can use to establish an ssh connection to the VM are also configured.</li>\n</ul>\n<p>In the next section we will see how <a href=\"https://cloudinit.readthedocs.io/en/latest/\">cloud-init</a> is used to setup user account with the correct password that Packer needs for provisioning.</p>\n<p>The full example of the packer file is available on <a href=\"https://github.com/skatolo/actuated-packer-qemu\">GitHub</a>.</p>\n<h3 id=\"create-the-user-data-file\">Create the user-data file</h3>\n<p>Cloud images provided by Canonical do not have users by default. The Ubuntu images use <a href=\"https://cloudinit.readthedocs.io/en/latest/\">cloud-init</a> to pre-configure the system during boot.</p>\n<p>Packer uses provisioners to install and configure the machine image after booting. To run these provisioners Packer needs to be able to communicate with the machine. By default this happens by establishing an ssh connection to the machine.</p>\n<p>Create a user-data file that sets the password of the default user so that it can be used by Packer to connect over ssh:</p>\n<pre><code>#cloud-config\npassword: ubuntu\nssh_pwauth: true\nchpasswd:\n  expire: false\n</code></pre>\n<p>Next create an ISO that can be referenced by our Packer template and presented to the VM:</p>\n<pre><code class=\"hljs language-bash\">genisoimage -output cidata.iso -input-charset utf-8 -volid cidata -joliet -r \\\n</code></pre>\n<p>The ISO can be mounted by QEMU to provide the configuration data to <code>cloud-init</code> while the VM boots.</p>\n<p>The <code>-cdrom</code> flag is used in the <code>qemuargs</code> field to mount the <code>cidata.iso</code> file:</p>\n<pre><code>  qemuargs = [\n    [\"-m\", \"${var.ram}M\"],\n    [\"-smp\", \"${var.cpu}\"],\n    [\"-cdrom\", \"cidata.iso\"]\n  ]\n</code></pre>\n<h3 id=\"provision-the-image\">Provision the image</h3>\n<p>The build section of the Packer template is used to define provisioners that can run scripts and commands to install software and configure the machine.</p>\n<p>In this example we are installing python3 but you can run any script you want or use tools like <a href=\"https://www.ansible.com/\">Ansible</a> to automate the configuration.</p>\n<pre><code>build {\n  sources = [\"source.qemu.jammy\"]\n\n  provisioner \"shell\" {\n    execute_command = \"{{ .Vars }} sudo -E bash '{{ .Path }}'\"\n    inline          = [\"sudo apt update\", \"sudo apt install python3\"]\n  }\n\n  post-processor \"shell-local\" {\n    environment_vars = [\"IMAGE_NAME=${var.name}\", \"IMAGE_VERSION=${var.version}\", \"IMAGE_FORMAT=${var.format}\"]\n    script           = \"scripts/prepare-image.sh\"\n  }\n}\n</code></pre>\n<h3 id=\"prepare-the-image-for-publishing\">Prepare the image for publishing.</h3>\n<p>Packer supports post-processors. They only run after Packer saves an instance as an image. Post-processors are commonly used to compress artifacts, upload them into a cloud, etc. See the <a href=\"https://developer.hashicorp.com/packer/tutorials/docker-get-started/docker-get-started-post-processors\">Packer docs</a> for more use-cases and examples.</p>\n<p>We will add a post processing step to the packer template to run the <code>prepare-image.sh</code> script. This script renames the image artifacts and calculates the shasum to prepare them to be uploaded as release artifacts on GitHub.</p>\n<pre><code>  post-processor \"shell-local\" {\n    environment_vars = [\"IMAGE_NAME=${var.name}\", \"IMAGE_VERSION=${var.version}\", \"IMAGE_FORMAT=${var.format}\"]\n    script           = \"scripts/prepare-image.sh\"\n  }\n</code></pre>\n<h3 id=\"launch-the-build-locally\">Launch the build locally</h3>\n<p>If your local system is setup correctly, it has the packer binary and qemu installed, you can build with just:</p>\n<pre><code class=\"hljs language-bash\">packer build .\n</code></pre>\n<p>The artifacts folder will contain the resulting machine image and shasum file after the build completes.</p>\n<pre><code>artifacts\n└── qemu\n    └── jammy\n        ├── jammy.qcow2\n        └── jammy.qcow2.sha256sum\n</code></pre>\n<h2 id=\"automate-image-releases-with-github-actions\">Automate image releases with GitHub Actions.</h2>\n<p>For the QEMU builder to run at peak performance it requires hardware acceleration. This is not always possible in CI runners. GitHub's hosted runners do not support nested virtualization. With Actuated we added support for launching Virtual Machines in GitHub Action pipelines. This makes it possible to run the Packer QEMU builder in your workflows.</p>\n<p>Support for KVM is not enabled by default on Actuated and there are some prerequisites:</p>\n<ul>\n<li><code>arm64</code> runners are not supported at the moment</li>\n<li>A bare-metal host that supports nested virtualization is required for the Agent.</li>\n</ul>\n<p>To configure your Actuated Agent for KVM support follow the <a href=\"https://docs.actuated.dev/examples/kvm-guest/\">instructions in the docs</a>.</p>\n<h3 id=\"the-github-actions-workflow\">The GitHub actions workflow</h3>\n<p>The default GitHub hosted runners come with Packer pre-installed. On self-hosted runners you will need a step to install the Packer binary. The official [setup-packer][<a href=\"https://github.com/hashicorp/setup-packer\">https://github.com/hashicorp/setup-packer</a>] action can be used for this.</p>\n<p>We set <code>runs-on</code> to <code>actuated</code> so that the build workflow will run on an Actuated runner:</p>\n<pre><code class=\"hljs language-yaml\"><span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Build</span>\n\n<span class=\"hljs-attr\">on:</span>\n  <span class=\"hljs-attr\">push:</span>\n    <span class=\"hljs-attr\">tags:</span> [<span class=\"hljs-string\">\"v[0-9].[0-9]+.[0-9]+\"</span>]\n    <span class=\"hljs-attr\">branches:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">\"main\"</span>\n<span class=\"hljs-attr\">jobs:</span>\n  <span class=\"hljs-attr\">build-image:</span>\n    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Build</span>\n    <span class=\"hljs-attr\">runs-on:</span> <span class=\"hljs-string\">actuated</span>\n    <span class=\"hljs-comment\">##...</span>\n</code></pre>\n<p>The build job runs the following steps:</p>\n<ol>\n<li>\n<p>Retrieve the Packer configuration by checking out the GitHub repository.</p>\n<pre><code class=\"hljs language-yaml\"><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Checkout</span> <span class=\"hljs-string\">Repository</span>\n  <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">actions/checkout@v3</span>\n</code></pre>\n</li>\n<li>\n<p>Install QEMU to ensure Packer is able to launch kvm/qemu virtual machines.</p>\n<pre><code class=\"hljs language-yaml\"><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Install</span> <span class=\"hljs-string\">qemu</span>\n  <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">sudo</span> <span class=\"hljs-string\">apt-get</span> <span class=\"hljs-string\">update</span> <span class=\"hljs-string\">&#x26;&#x26;</span> <span class=\"hljs-string\">sudo</span> <span class=\"hljs-string\">apt-get</span> <span class=\"hljs-string\">install</span> <span class=\"hljs-string\">qemu-system</span> <span class=\"hljs-string\">-y</span>\n</code></pre>\n</li>\n<li>\n<p>Setup packet to ensure the binary is available in the path.</p>\n<pre><code class=\"hljs language-yaml\"><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Setup</span> <span class=\"hljs-string\">packer</span>\n  <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">hashicorp/setup-packer@main</span>\n</code></pre>\n</li>\n<li>\n<p>Initialize the packer template and install all plugins referenced by the template.</p>\n<pre><code class=\"hljs language-yaml\"><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Packer</span> <span class=\"hljs-string\">Init</span>\n  <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">packer</span> <span class=\"hljs-string\">init</span> <span class=\"hljs-string\">.</span>\n</code></pre>\n</li>\n<li>\n<p>Build the images defined in the root directory. Before we run the <code>packer build</code> command we make <code>/dev/kvm</code> world read-writable so that the QEMU builder can use it.</p>\n<pre><code class=\"hljs language-yaml\"><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Packer</span> <span class=\"hljs-string\">Build</span>\n  <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">|\n    sudo chmod o+rw /dev/kvm\n    packer build .\n</span></code></pre>\n</li>\n<li>\n<p>Upload the images as GitHub release artifacts. This job only runs for tagged commits.</p>\n<pre><code class=\"hljs language-yaml\"><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Upload</span> <span class=\"hljs-string\">images</span> <span class=\"hljs-string\">and</span> <span class=\"hljs-string\">their</span> <span class=\"hljs-string\">SHA</span> <span class=\"hljs-string\">to</span> <span class=\"hljs-string\">Github</span> <span class=\"hljs-string\">Release</span>\n  <span class=\"hljs-attr\">if:</span> <span class=\"hljs-string\">startsWith(github.ref,</span> <span class=\"hljs-string\">'refs/tags/v'</span><span class=\"hljs-string\">)</span>\n  <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">alexellis/upload-assets@0.4.0</span>\n  <span class=\"hljs-attr\">env:</span>\n    <span class=\"hljs-attr\">GITHUB_TOKEN:</span> <span class=\"hljs-string\">${{</span> <span class=\"hljs-string\">secrets.GITHUB_TOKEN</span> <span class=\"hljs-string\">}}</span>\n  <span class=\"hljs-attr\">with:</span>\n    <span class=\"hljs-attr\">asset_paths:</span> <span class=\"hljs-string\">'[\"./artifacts/qemu/*/*\"]'</span>\n</code></pre>\n</li>\n</ol>\n<h2 id=\"taking-it-further\">Taking it further</h2>\n<p>We created a GitHub actions workflow that can run a Packer build with QEMU to create a custom Ubuntu image. The resulting <code>qcow2</code> image is automatically uploaded to the GitHub release assets on each release.</p>\n<p>The released image can be downloaded and used to spin up a VM instance on your private hardware or on different cloud providers.</p>\n<p>We exported the image in <code>qcow2</code> format but you might need a different image format. The QEMU builder also supports outputting images in <code>raw</code> format. In our Packer template the output format can be changed by setting the <code>format</code> variable.</p>\n<p>Additional tools like the <a href=\"https://www.qemu.org/docs/master/tools/qemu-img.html\">qemu disk image utility</a> can also be used to convert images between different formats. A <a href=\"https://developer.hashicorp.com/packer/docs/templates/hcl_templates/blocks/build/post-processor\">post-processor</a> would be the ideal place for these kinds of extra processing steps.</p>\n<p>AWS also supports importing VM images and converting them to an AMI so they can be used to launch EC2 instances. See: <a href=\"https://docs.aws.amazon.com/vm-import/latest/userguide/vmimport-image-import.html\">Create an AMI from a VM image</a></p>\n<p>If you'd like to know more about nested virtualisation support, check out: <a href=\"https://actuated.dev/blog/kvm-in-github-actions\">How to run KVM guests in your GitHub Actions</a></p>","title":"Automate Packer Images with QEMU and Actuated","description":"Learn how to automate Packer images using QEMU and nested virtualisation through actuated.","tags":["images","packer","qemu","kvm"],"author_img":"welteki","image":"/images/2023-07-packer/background.png","date":"2023-07-25"}},"__N_SSG":true}