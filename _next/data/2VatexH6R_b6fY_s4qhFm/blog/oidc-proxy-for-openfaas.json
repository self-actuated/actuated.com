{"pageProps":{"post":{"slug":"oidc-proxy-for-openfaas","fileName":"2023-05-05-oidc-proxy-for-openfaas.md","contentHtml":"<p>In 2021, GitHub released <a href=\"https://openid.net/connect/\">OpenID Connect (OIDC)</a> support for CI jobs running under GitHub Actions. This was a huge step forward for security meaning that any GitHub Action could mint an OIDC token and use it to securely federate into another system without having to store long-lived credentials in the repository.</p>\n<p>I wrote a prototype for OpenFaaS shortly after the announcement and a deep dive explaining how it works. I used <a href=\"https://inlets.dev/blog/2022/11/16/automate-a-self-hosted-https-tunnel.html\">inlets</a> to set up a HTTPS tunnel, and send the token to my machine for inspection. Various individuals and technical teams have used my content as <a href=\"https://twitter.com/mlbiam/status/1653391969110900741?s=20\">a reference guide</a> when working with GitHub Actions and OIDC.</p>\n<p>See the article: <a href=\"https://blog.alexellis.io/deploy-without-credentials-using-oidc-and-github-actions/\">Deploy without credentials with GitHub Actions and OIDC</a></p>\n<p>Since then, custom actions for GCP, AWS and Azure have been created which allow an OIDC token from a GitHub Action to be exchanged for a short-lived access token for their API - meaning you can manage cloud resources securely. For example, see: <a href=\"https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services\">Configuring OpenID Connect in Amazon Web Services</a> - we have actuated customers who use this approach to deploy to ECR from their self-hosted runners without having to store long-lived credentials in their repositories.</p>\n<h2>Why OIDC is important for OpenFaaS customers</h2>\n<p>Before we talk about the new OIDC proxy for OpenFaaS, I should say that <a href=\"https://openfaas.com/pricing\">OpenFaaS Enterprise</a> <em>also has</em> an IAM feature which includes OIDC support for the CLI, dashboard and API. It supports any trusted OIDC provider, not just GitHub Actions. Rather than acting as a proxy, it actually implements a full fine-grained authorization and permissions policy language that resembles the one you'll be used to from AWS.</p>\n<p>However, not everyone needs this level of granularity.</p>\n<p><a href=\"https://il.linkedin.com/in/shaked-askayo-18403714a\">Shaked, the CTO of Kubiya.ai</a> is an <a href=\"https://openfaas.com/\">OpenFaaS</a> &#x26; <a href=\"https://inlets.dev\">inlets</a> customer. His team at <a href=\"https://kubiya.ai\">Kubiya</a> is building a conversational AI for DevOps - if you're ever tried ChatGPT, imagine that it was hooked up to your infrastructure and had superpowers. On a recent call, he told me that their team now has 30 different repositories which deploy OpenFaaS functions to their various AWS EKS clusters. That means that a secret has to be maintained at the organisation level and then consumed via <code>faas-cli login</code> in each job.</p>\n<p>It gets a little worse for them - because different branches deploy to different OpenFaaS gateways and to different EKS clusters.</p>\n<p>In addition to managing various credentials for each cluster they add - they were uncomfortable with exposing all of their functions on the Internet.</p>\n<p>So today the team working on actuated is releasing a new OIDC proxy which can be deployed to any OpenFaaS cluster to avoid the need to manage and share long-lived credentials with GitHub.</p>\n<p><img src=\"/images/2023-05-openfaas-oidc-proxy/conceptual.png\" alt=\"Conceptual design of the OIDC proxy for OpenFaaS\"></p>\n<blockquote>\n<p>Conceptual design of the OIDC proxy for OpenFaaS</p>\n</blockquote>\n<p><strong>About the OIDC proxy for OpenFaaS</strong></p>\n<ul>\n<li>It can be deployed via Helm</li>\n<li>Only allows access to a given set of GitHub organisations</li>\n<li>Uses a standard Ingress record</li>\n<li>It only accepts OIDC tokens signed from GitHub Actions</li>\n<li>It only allows requests to the <code>/system</code> endpoints of the OpenFaaS REST API - keeping your functions safe</li>\n</ul>\n<p>Best of all, unlike OpenFaaS Enterprise, it's free for all actuated customers - whether they're using OpenFaaS CE, Standard or Enterprise.</p>\n<p>Here's what Shaked had to say about the new proxy:</p>\n<blockquote>\n<p>That's great - thank you! Looking forward to it as it will simplify our usage of the openfaas templates and will speed up our development process\nShaked, CTO, Kubiya.ai</p>\n</blockquote>\n<h2>How to deploy the proxy for OpenFaaS</h2>\n<p>Here's what you need to do:</p>\n<ul>\n<li>Install OpenFaaS on a Kubernetes cluster</li>\n<li>Create a new DNS A or CNAME record for the Ingress to the proxy i.e. <code>oidc-proxy.example.com</code></li>\n<li>Install the OIDC proxy using Helm</li>\n<li>Update your GitHub Actions workflow to use the OIDC token</li>\n</ul>\n<blockquote>\n<p>My cluster is not publicly exposed on the Internet, so I'm using an <a href=\"https://inlets.dev/blog/2022/11/16/automate-a-self-hosted-https-tunnel.html\">inlets tunnel</a> to expose the OIDC Proxy from my local KinD cluster. I'll be using the domain <code>minty.exit.o6s.io</code> but you'd create something more like <code>oidc-proxy.example.com</code> for your own cluster.</p>\n</blockquote>\n<p>First Set up your values.yaml for Helm:</p>\n<pre><code class=\"hljs language-yaml\"><span class=\"hljs-comment\"># The public URL to access the proxy</span>\n<span class=\"hljs-attr\">publicURL:</span> <span class=\"hljs-string\">https://oidc-proxy.example.com</span>\n\n<span class=\"hljs-comment\"># Comma separated list of repository owners for which short-lived OIDC tokens are authorized.</span>\n<span class=\"hljs-comment\"># For example: alexellis,self-actuated</span>\n<span class=\"hljs-attr\">repositoryOwners:</span> <span class=\"hljs-string\">'alexellis,self-actuated'</span>\n<span class=\"hljs-attr\">ingress:</span>\n    <span class=\"hljs-attr\">host:</span> <span class=\"hljs-string\">oidc-proxy.example.com</span>\n    <span class=\"hljs-attr\">issuer:</span> <span class=\"hljs-string\">letsencrypt-prod</span>\n</code></pre>\n<p>The chart will create an Ingress record for you using an existing issuer. If you want to use something else like Inlets or Istio to expose the OIDC proxy, then simply set <code>enabled: false</code> under the <code>ingress:</code> section.</p>\n<p>Then run:</p>\n<pre><code class=\"hljs language-bash\">helm repo add actuated https://self-actuated.github.io/charts/\nhelm repo update\n\nhelm upgrade --install actuated/openfaas-oidc-proxy \\\n    -f ./values.yaml\n</code></pre>\n<p>For the full setup - <a href=\"https://github.com/self-actuated/charts/tree/master/chart/openfaas-oidc-proxy\">see the README for the Helm chart</a></p>\n<p>You can now go to one of your repositories and update the workflow to authenticate to the REST API via an OIDC token.</p>\n<p>In order to get an OIDC token within a build, add the <code>id_token: write</code> permission to the permissions list.</p>\n<pre><code class=\"hljs language-yaml\"><span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">keyless_deploy</span>\n\n<span class=\"hljs-attr\">on:</span>\n  <span class=\"hljs-attr\">workflow_dispatch:</span>\n  <span class=\"hljs-attr\">push:</span>\n    <span class=\"hljs-attr\">branches:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">'*'</span>\n<span class=\"hljs-attr\">jobs:</span>\n  <span class=\"hljs-attr\">keyless_deploy:</span>\n    <span class=\"hljs-attr\">permissions:</span>\n      <span class=\"hljs-attr\">contents:</span> <span class=\"hljs-string\">'read'</span>\n      <span class=\"hljs-attr\">id-token:</span> <span class=\"hljs-string\">'write'</span>\n</code></pre>\n<p>Then set <code>runs-on</code> to <code>actuated</code> to use your faster actuated servers:</p>\n<pre><code class=\"hljs language-diff\"><span class=\"hljs-deletion\">-   runs-on: ubuntu-latest</span>\n<span class=\"hljs-addition\">+   runs-on: actuated</span>\n</code></pre>\n<p>Then in the workflow, install the OpenFaaS CLI:</p>\n<pre><code class=\"hljs language-yaml\"><span class=\"hljs-attr\">steps:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">actions/checkout@master</span>\n    <span class=\"hljs-attr\">with:</span>\n        <span class=\"hljs-attr\">fetch-depth:</span> <span class=\"hljs-number\">1</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Install</span> <span class=\"hljs-string\">faas-cli</span>\n    <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">curl</span> <span class=\"hljs-string\">-sLS</span> <span class=\"hljs-string\">https://cli.openfaas.com</span> <span class=\"hljs-string\">|</span> <span class=\"hljs-string\">sudo</span> <span class=\"hljs-string\">sh</span>\n</code></pre>\n<p>Then get a token:</p>\n<pre><code class=\"hljs language-yaml\"><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Get</span> <span class=\"hljs-string\">token</span> <span class=\"hljs-string\">and</span> <span class=\"hljs-string\">use</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">CLI</span>\n    <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">|\n        OPENFAAS_URL=https://minty.exit.o6s.io\n        OIDC_TOKEN=$(curl -sLS \"${ACTIONS_ID_TOKEN_REQUEST_URL}&#x26;audience=$OPENFAAS_URL\" -H \"User-Agent: actions/oidc-client\" -H \"Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN\")\n        JWT=$(echo $OIDC_TOKEN | jq -j '.value')\n</span></code></pre>\n<p>Finally, use the token whenever you need it by passing in the <code>--token</code> flag to any of the <code>faas-cli</code> commands:</p>\n<pre><code class=\"hljs language-yaml\"><span class=\"hljs-string\">faas-cli</span> <span class=\"hljs-string\">list</span> <span class=\"hljs-string\">-n</span> <span class=\"hljs-string\">openfaas-fn</span> <span class=\"hljs-string\">--token</span> <span class=\"hljs-string\">\"$JWT\"</span>\n<span class=\"hljs-string\">faas-cli</span> <span class=\"hljs-string\">ns</span> <span class=\"hljs-string\">--token</span> <span class=\"hljs-string\">\"$JWT\"</span>\n<span class=\"hljs-string\">faas-cli</span> <span class=\"hljs-string\">store</span> <span class=\"hljs-string\">deploy</span> <span class=\"hljs-string\">printer</span> <span class=\"hljs-string\">--name</span> <span class=\"hljs-string\">p1</span> <span class=\"hljs-string\">--token</span> <span class=\"hljs-string\">\"$JWT\"</span>\n\n<span class=\"hljs-string\">faas-cli</span> <span class=\"hljs-string\">describe</span> <span class=\"hljs-string\">p1</span> <span class=\"hljs-string\">--token</span> <span class=\"hljs-string\">\"$JWT\"</span>\n</code></pre>\n<p>Since we have a lot of experience with GitHub Actions, we decided to make the above simpler by creating a custom <a href=\"https://docs.github.com/en/actions/creating-actions/creating-a-composite-action\">Composite Action</a>. If you check out the code for <a href=\"https://github.com/self-actuated/openfaas-oidc\">self-actuated/openfaas-oidc</a> you'll see that it obtains a token, then writes it into an openfaaas config file, so that the <code>--token</code> flag isn't required.</p>\n<p>Here's how it changes:</p>\n<pre><code class=\"hljs language-yaml\"><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">self-actuated/openfaas-oidc@v1</span>\n  <span class=\"hljs-attr\">with:</span> \n    <span class=\"hljs-attr\">gateway:</span> <span class=\"hljs-string\">https://minty.exit.o6s.io</span>\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Check</span> <span class=\"hljs-string\">OpenFaaS</span> <span class=\"hljs-string\">version</span>\n  <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">|\n    OPENFAAS_CONFIG=$HOME/.openfaas/\n    faas-cli version\n</span></code></pre>\n<p>Here's the complete example:</p>\n<pre><code class=\"hljs language-yaml\"><span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">federate</span>\n\n<span class=\"hljs-attr\">on:</span>\n  <span class=\"hljs-attr\">workflow_dispatch:</span>\n  <span class=\"hljs-attr\">push:</span>\n    <span class=\"hljs-attr\">branches:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">'*'</span>\n<span class=\"hljs-attr\">jobs:</span>\n  <span class=\"hljs-attr\">auth:</span>\n    <span class=\"hljs-comment\"># Add \"id-token\" with the intended permissions.</span>\n    <span class=\"hljs-attr\">permissions:</span>\n      <span class=\"hljs-attr\">contents:</span> <span class=\"hljs-string\">'read'</span>\n      <span class=\"hljs-attr\">id-token:</span> <span class=\"hljs-string\">'write'</span>\n\n    <span class=\"hljs-attr\">runs-on:</span> <span class=\"hljs-string\">actuated</span>\n    <span class=\"hljs-attr\">steps:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">actions/checkout@master</span>\n        <span class=\"hljs-attr\">with:</span>\n          <span class=\"hljs-attr\">fetch-depth:</span> <span class=\"hljs-number\">1</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Install</span> <span class=\"hljs-string\">faas-cli</span>\n        <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">curl</span> <span class=\"hljs-string\">-sLS</span> <span class=\"hljs-string\">https://cli.openfaas.com</span> <span class=\"hljs-string\">|</span> <span class=\"hljs-string\">sudo</span> <span class=\"hljs-string\">sh</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">self-actuated/openfaas-oidc@v1</span>\n        <span class=\"hljs-attr\">with:</span>\n          <span class=\"hljs-attr\">gateway:</span> <span class=\"hljs-string\">https://minty.exit.o6s.io</span>\n\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Get</span> <span class=\"hljs-string\">token</span> <span class=\"hljs-string\">and</span> <span class=\"hljs-string\">use</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">CLI</span>\n        <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">|\n          export OPENFAAS_URL=https://minty.exit.o6s.io\n          faas-cli store deploy env --name http-header-printer\n          faas-cli list\n</span></code></pre>\n<p>How can we be sure that our functions cannot be invoked over the proxy?</p>\n<p>Just add an extra line to test it out:</p>\n<pre><code class=\"hljs language-yaml\">      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Get</span> <span class=\"hljs-string\">token</span> <span class=\"hljs-string\">and</span> <span class=\"hljs-string\">use</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">CLI</span>\n        <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">|\n          export OPENFAAS_URL=https://minty.exit.o6s.io\n          faas-cli store deploy env --name http-header-printer\n          sleep 5\n</span>\n          <span class=\"hljs-string\">echo</span> <span class=\"hljs-string\">|</span> <span class=\"hljs-string\">faas-cli</span> <span class=\"hljs-string\">invoke</span> <span class=\"hljs-string\">http-header-printer</span>\n</code></pre>\n<p><img src=\"/images/2023-05-openfaas-oidc-proxy/failed-invoke.png\" alt=\"A failed invocation over the proxy\"></p>\n<blockquote>\n<p>A failed invocation over the proxy</p>\n</blockquote>\n<p>Best of all, now that you're using OIDC, you can now go and delete any of those long lived basic auth credentials from your secrets!</p>\n<h2>Wrapping up</h2>\n<p>The new OIDC proxy for OpenFaaS is available for all actuated customers and works with OpenFaaS CE, Standard and Enterprise. You can use it on as many clusters as you like, whilst you have an active subscription for actuated at no extra cost.</p>\n<p>In a short period of time, you can set up the Helm chart for the OIDC proxy and no longer have to worry about storing various secrets in GitHub Actions for all your clusters, simply obtain a token and use it to deploy to any cluster - securely. There's no risk that your functions will be exposed on the Internet, because the OIDC proxy only works for the <code>/system</code> endpoints of the OpenFaaS REST API.</p>\n<p><strong>An alternative for those who need it</strong></p>\n<p><a href=\"https://openfaas.com/pricing\">OpenFaaS Enterprise</a> has its own OIDC integration with much more fine-grained permissions implemented. It means that team members using the CLI, Dashboard or API do not need to memorise or share basic authentication credentials with each other, or worry about getting the right password for the right cluster.</p>\n<p>An OpenFaaS Enterprise policy can restrict all the way down to read/write permissions on a number of namespaces, and also integrates with OIDC.</p>\n<p>See an example:</p>\n<ul>\n<li><a href=\"https://docs.openfaas.com/openfaas-pro/iam/github-actions-federation/\">OpenFaaS Enterprise - IAM with GitHub Actions</a></li>\n<li><a href=\"https://docs.openfaas.com/openfaas-pro/iam/gitlab-federation/\">OpenFaaS Enterprise - IAM with GitLab</a></li>\n</ul>","title":"Keyless deployment to OpenFaaS with OIDC and GitHub Actions","description":"We're announcing a new OIDC proxy for OpenFaaS for keyless deployments from GitHub Actions.","author":"Alex Ellis","tags":["oidc","githubactions","security","federation","iam"],"author_img":"alex","image":"/images/2023-05-openfaas-oidc-proxy/background.png","date":"2023-05-05"}},"__N_SSG":true}