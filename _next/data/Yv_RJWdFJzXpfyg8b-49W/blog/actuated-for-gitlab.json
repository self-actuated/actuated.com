{"pageProps":{"post":{"slug":"actuated-for-gitlab","fileName":"2024-07-26-actuated-for-gitlab.md","contentHtml":"<p>Last year we introduced the <a href=\"/blog/secure-microvm-ci-gitlab\">tech preview for Actuated for GitLab CI</a>, since then we've had customer interest from enterprise companies who wanted to improve their security posture and to lower overheads. Actuated reduces management overheads of self-hosted runners and provides a secure, ephemeral microVM for every job.</p>\n<p>We've made a lot of progress since the original version and are looking for additional customers who want to deliver an improved CI experience. In this article we will give you an overview of some of the available features and how they can benefit your GitLab CI.</p>\n<ul>\n<li><a href=\"#introduction\">Introduction</a></li>\n<li><a href=\"#run-jobs-in-microvms-with-actuated\">Run jobs in microVMs with Actuated</a></li>\n<li><a href=\"#mixed-docker-and-shell-executors\">Mixed docker and shell executors</a></li>\n<li><a href=\"#what-does-an-actuated-server-look-like\">What does an actuated server look like?</a></li>\n<li><a href=\"#private-peering\">Private peering</a></li>\n</ul>\n<h2 id=\"why-are-microvms-the-future-of-ci\">Why are microVMs the future of CI?</h2>\n<p>It can be challenging to run GitLab CI/CD jobs that build and publish Docker images or jobs that require extensive system access in a safe way. Docker-in-Docker (DIND) requires the docker executor to run containers in privileged mode. Using the shell executor would give a job full access to the runner host and network. They can also leave behind side effects between builds as the runner is reused.</p>\n<p>Using both approaches causes a significant security concern and the <a href=\"https://docs.gitlab.com/runner/security/\">GitLab runner security docs</a> warn against it.</p>\n<p><img src=\"/images/2024-07-gitlab/chart-warning.png\" alt=\"Docker in Docker security notice printed out by the GitLab helm chart\"></p>\n<blockquote>\n<p>Security notice displayed by the GitLab Helm chart to explain why docker in docker is disabled by default for security purposes.</p>\n</blockquote>\n<p>With Actuated, jobs run in ephemeral microVMs using Linux KVM for secure isolation. After the job is completed, the VM will be destroyed and removed from the GitLab instance. This allows us to safely run DIND and the shell executor in a fresh isolated environment for each job.</p>\n<p>There are no horrible Kernel tricks or workarounds required to be able to use user namespaces, no need to change your tooling from what developers love - Docker, to <a href=\"https://github.com/GoogleContainerTools/kaniko\">Kaniko</a> or <a href=\"https://buildah.io/\">Buildah</a> or similar. You have <code>sudo</code> access and full VM with systemd available, things like <a href=\"https://kubernetes.io/\">Kubernetes</a> will also work out of the box if you need them for end to end testing.</p>\n<p><img src=\"/images/2024-07-gitlab/project-runners.png\" alt=\"GitLab UI showing Actuated project runners\"></p>\n<blockquote>\n<p>Runners get automatically added to a project and are removed again when they finish running a job.</p>\n</blockquote>\n<h2 id=\"run-jobs-in-microvms-with-actuated\">Run jobs in microVMs with Actuated</h2>\n<p>When a pipeline is triggered through a commit, merge request or in the UI the Actuated control plane gets notified through a webhook. For every job we schedule and run a new microVM and register it as a runner to the project. After the job is completed, the VM will be destroyed and removed from the GitLab instance. Scheduling and launching VMs is very fast. On average a new VM is booting up and running the job within 1 second.</p>\n<p><img src=\"/images/2023-06-gitlab-preview/conceptual.png\" alt=\"actuated for GitLab CI\"></p>\n<p>The agent will use either <a href=\"https://github.com/firecracker-microvm/firecracker\">Firecracker</a> or <a href=\"https://www.cloudhypervisor.org/\">Cloud Hypervisor</a> to launch microVMS depending on whether GPU support is required. microVMs boot almost instantly and in most cases will be faster than Kubernetes since the image is optimized and already available on each server.</p>\n<p>To run jobs on Actuated the <code>actuated</code> tag has to be added to a job. One feature our customers like is the ability to configure the VM size for a job through the tag. Using the tag <code>actuated-4cpu-8gb</code> will schedule a VM with 4 vCPUs and 8 gigabytes of RAM.</p>\n<p>You can pick any combination for vCPU and RAM. There's no need to pick a predefined runner size. This means that runners can be sized accordingly for the job they need to run so that the available CPU and memory resources can be used more efficiently.</p>\n<p>Example <code>.gitlab-ci.yaml</code> that runs a job on Actuated runners using the docker executor:</p>\n<pre><code class=\"hljs language-yaml\"><span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">ruby:2.7</span>\n<span class=\"hljs-attr\">services:</span>\n  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">postgres:9.3</span>\n\n<span class=\"hljs-attr\">before_script:</span>\n  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">bundle</span> <span class=\"hljs-string\">install</span>\n<span class=\"hljs-attr\">test:</span>\n  <span class=\"hljs-attr\">script:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">bundle</span> <span class=\"hljs-string\">exec</span> <span class=\"hljs-string\">rake</span> <span class=\"hljs-string\">spec</span>\n  <span class=\"hljs-attr\">tags:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">actuated-4cpu-8gb</span>\n</code></pre>\n<h2 id=\"mixed-docker-and-shell-executors\">Mixed Docker and Shell executors</h2>\n<p>GitLab supports a number of executors to run builds in different environments. With Actuated we support running jobs with the <a href=\"https://docs.gitlab.com/runner/executors/docker.html\">docker</a> and <a href=\"https://docs.gitlab.com/runner/executors/shell.html\">shell</a> executor.</p>\n<p>There is no need to pre-configure the type of executors you want to use. Actuated allows you to quickly select the executor for a job by adding an additional tag. Adding the <code>shell</code> tag to a job will launch a VM and register the GitLab runners using the shell executor. If no tag is provided the docker executor is used by default.</p>\n<pre><code class=\"hljs language-yaml\"><span class=\"hljs-attr\">build-job:</span>\n  <span class=\"hljs-attr\">stage:</span> <span class=\"hljs-string\">build</span>\n  <span class=\"hljs-attr\">script:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">echo</span> <span class=\"hljs-string\">\"Hi $GITLAB_USER_LOGIN!\"</span>\n  <span class=\"hljs-attr\">tags:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">actuated-2cpu-4gb</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">shell</span>\n</code></pre>\n<p>With Actuated the shell executor can be used securely without leaving side effects behind that can influence job execution. A clean isolated build environment is provided for every job since the GitLab runner is started on an ephemeral VM that is removed as soon as the job has completed.</p>\n<p>Using the shell executor in an isolated VM lets you safely run workloads like:</p>\n<ul>\n<li>Jobs that benefit from or need hardware acceleration e.g. the android emulator.</li>\n<li>Jobs that require extensive system access.</li>\n<li>Run a <a href=\"https://kind.sigs.k8s.io/\">KinD</a> or <a href=\"https://k3s.io\">K3s</a> cluster in CI for E2E testing.</li>\n</ul>\n<p>These kinds of jobs can be difficult to run in a docker container or would require the container to run in privileged mode which is unsafe and advised against in <a href=\"https://docs.gitlab.com/runner/security/#usage-of-docker-executor\">GitLab runner security guidelines</a>.</p>\n<p>Since jobs run in ephemeral VMs with Actuated it is also possible to run the docker executor safely in privileged mode. If you are already using the docker executor in privileged mode Actuated can improve the security of your jobs without making changes to your existing pipelines.</p>\n<p>The following <code>.gitlab-ci.yaml</code> runs two jobs. The first job uses the docker executor to build and push a container image for an OpenFaaS function with Docker and the faas-cli. The second job sets the additional <code>shell</code> tag to request Actuated to run the job with the shell executor. By running the jobs with the shell executor we get access to the full ephemeral VM that is launched for the job. This makes it easy to bootstrap a K3s Kubernetes cluster with <a href=\"https://github.com/alexellis/k3sup\">k3sup</a> for E2E testing the function with OpenFaaS.</p>\n<pre><code class=\"hljs language-yaml\"><span class=\"hljs-attr\">stages:</span>\n  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">push</span>\n  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">e2e</span>\n\n<span class=\"hljs-attr\">variables:</span>\n  <span class=\"hljs-attr\">DOCKER_DRIVER:</span> <span class=\"hljs-string\">overlay2</span>\n  <span class=\"hljs-attr\">DOCKER_TLS_CERT_DIR:</span> <span class=\"hljs-string\">\"\"</span>\n\n<span class=\"hljs-attr\">push_job:</span>\n  <span class=\"hljs-attr\">stage:</span> <span class=\"hljs-string\">push</span>\n  <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">docker:latest</span>\n  <span class=\"hljs-attr\">before_script:</span>\n    <span class=\"hljs-comment\"># Install dependencies: faas-cli</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">apk</span> <span class=\"hljs-string\">add</span> <span class=\"hljs-string\">--no-cache</span> <span class=\"hljs-string\">git</span> <span class=\"hljs-string\">curl</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">if</span> [ <span class=\"hljs-string\">-f</span> <span class=\"hljs-string\">\"./faas-cli\"</span> ] <span class=\"hljs-string\">;</span> <span class=\"hljs-string\">then</span> <span class=\"hljs-string\">cp</span> <span class=\"hljs-string\">./faas-cli</span> <span class=\"hljs-string\">/usr/local/bin/faas-cli</span> <span class=\"hljs-string\">||</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-string\">;</span> <span class=\"hljs-string\">fi</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">if</span> [ <span class=\"hljs-string\">!</span> <span class=\"hljs-string\">-f</span> <span class=\"hljs-string\">\"/usr/local/bin/faas-cli\"</span> ] <span class=\"hljs-string\">;</span> <span class=\"hljs-string\">then</span> <span class=\"hljs-string\">apk</span> <span class=\"hljs-string\">add</span> <span class=\"hljs-string\">--no-cache</span> <span class=\"hljs-string\">curl</span> <span class=\"hljs-string\">git</span> <span class=\"hljs-string\">&#x26;&#x26;</span>\n      <span class=\"hljs-string\">curl</span> <span class=\"hljs-string\">-sSL</span> <span class=\"hljs-string\">https://cli.openfaas.com</span> <span class=\"hljs-string\">|\n      sh &#x26;&#x26; chmod +x /usr/local/bin/faas-cli &#x26;&#x26;\n      cp /usr/local/bin/faas-cli ./faas-cli ; fi\n</span>  <span class=\"hljs-attr\">script:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">echo</span> <span class=\"hljs-string\">$CI_JOB_TOKEN</span> <span class=\"hljs-string\">|</span> <span class=\"hljs-string\">docker</span> <span class=\"hljs-string\">login</span> <span class=\"hljs-string\">$CI_REGISTRY</span> <span class=\"hljs-string\">\\</span>\n        <span class=\"hljs-string\">-u</span> <span class=\"hljs-string\">$CI_REGISTRY_USER</span> <span class=\"hljs-string\">\\</span>\n        <span class=\"hljs-string\">--password-stdin</span>\n\n    <span class=\"hljs-comment\"># Build and push an OpenFaaS function</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">/usr/local/bin/faas-cli</span> <span class=\"hljs-string\">template</span> <span class=\"hljs-string\">pull</span> <span class=\"hljs-string\">stack</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">/usr/local/bin/faas-cli</span> <span class=\"hljs-string\">publish</span>\n\n  <span class=\"hljs-attr\">tags:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">actuated-4cpu-8gb</span>\n\n<span class=\"hljs-attr\">e2e_job:</span>\n  <span class=\"hljs-attr\">stage:</span> <span class=\"hljs-string\">e2e</span>\n  <span class=\"hljs-attr\">before_script:</span>\n    <span class=\"hljs-comment\"># Install dependencies: faas-cli kubectl kubectx k3sup</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">curl</span> <span class=\"hljs-string\">-SLs</span> <span class=\"hljs-string\">https://get.arkade.dev</span> <span class=\"hljs-string\">|</span> <span class=\"hljs-string\">sh</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">export</span> <span class=\"hljs-string\">PATH=$PATH:$HOME/.arkade/bin/</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">arkade</span> <span class=\"hljs-string\">get</span> <span class=\"hljs-string\">faas-cli</span> <span class=\"hljs-string\">kubectl</span> <span class=\"hljs-string\">kubectx</span> <span class=\"hljs-string\">k3sup</span> <span class=\"hljs-string\">--progress=false</span>\n  <span class=\"hljs-attr\">script:</span>\n    <span class=\"hljs-comment\"># Deploy a K3s cluster.</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">|\n      mkdir -p ~/.kube/\n      k3sup install --local --local-path ~/.kube/config\n      k3sup ready\n</span>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">kubectl</span> <span class=\"hljs-string\">get</span> <span class=\"hljs-string\">nodes</span>\n\n    <span class=\"hljs-comment\"># Install OpenFaaS on the local cluster.</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">mkdir</span> <span class=\"hljs-string\">-p</span> <span class=\"hljs-string\">~/.openfaas</span> <span class=\"hljs-string\">&#x26;&#x26;</span> <span class=\"hljs-string\">echo</span> <span class=\"hljs-string\">$OPENFAAS_LICENSE</span> <span class=\"hljs-string\">></span> <span class=\"hljs-string\">~/.openfaas/LICENSE</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">|\n      arkade install openfaas \\\n        --license-file ~/.openfaas/LICENSE \\\n        --operator \\\n        --clusterrole \\\n        --jetstream \\\n        --autoscaler\n      kubectl get secret -n openfaas\n      echo $OPENFAAS_LICENSE | wc\n</span>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">kubectl</span> <span class=\"hljs-string\">create</span> <span class=\"hljs-string\">secret</span> <span class=\"hljs-string\">docker-registry</span> <span class=\"hljs-string\">gitlab-ci-pull</span> <span class=\"hljs-string\">\\</span>\n        <span class=\"hljs-string\">--docker-server=$CI_REGISTRY</span> <span class=\"hljs-string\">\\</span>\n        <span class=\"hljs-string\">--docker-username=$CI_REGISTRY_USER</span> <span class=\"hljs-string\">\\</span>\n        <span class=\"hljs-string\">--docker-password=$CI_JOB_TOKEN</span> <span class=\"hljs-string\">\\</span>\n        <span class=\"hljs-string\">--docker-email=docker@example.com</span> <span class=\"hljs-string\">\\</span>\n        <span class=\"hljs-string\">--namespace</span> <span class=\"hljs-string\">openfaas-fn</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">kubectl</span> <span class=\"hljs-string\">rollout</span> <span class=\"hljs-string\">status</span> <span class=\"hljs-string\">-n</span> <span class=\"hljs-string\">openfaas</span> <span class=\"hljs-string\">deploy/gateway</span> <span class=\"hljs-string\">--timeout=60s</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">|\n      kubectl port-forward -n openfaas svc/gateway 8080:8080 &#x26;>/dev/null &#x26;\n      echo -n \"$!\" > kubectl-pid.txt\n</span>\n      <span class=\"hljs-attr\">echo PID for port-fowarding:</span> <span class=\"hljs-string\">$(cat</span> <span class=\"hljs-string\">kubectl-pid.txt)</span>\n\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">faas-cli</span> <span class=\"hljs-string\">ready</span> <span class=\"hljs-string\">--attempts</span> <span class=\"hljs-number\">120</span>\n\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">|\n      kubectl patch serviceaccount \\\n        -n openfaas-fn default \\\n        -p '{\"imagePullSecrets\": [{\"name\": \"gitlab-ci-pull\"}]}'\n</span>\n    <span class=\"hljs-comment\"># Deploy the function that we build and pushed in the previous stage.</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">|\n      echo $(kubectl get secret \\\n        -n openfaas basic-auth \\\n        -o jsonpath=\"{.data.basic-auth-password}\" | base64 --decode; echo) |\n      faas-cli login --username admin --password-stdin\n</span>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">faas-cli</span> <span class=\"hljs-string\">template</span> <span class=\"hljs-string\">pull</span> <span class=\"hljs-string\">stack</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">CI_REGISTRY=$CI_REGISTRY</span> <span class=\"hljs-string\">CI_COMMIT_SHORT_SHA=$CI_COMMIT_SHORT_SHA</span> <span class=\"hljs-string\">faas-cli</span> <span class=\"hljs-string\">deploy</span>\n\n    <span class=\"hljs-comment\"># Test the OpenFaaS function by invoking it.</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">faas-cli</span> <span class=\"hljs-string\">ready</span> <span class=\"hljs-string\">bcrypt</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">curl</span> <span class=\"hljs-string\">-i</span> <span class=\"hljs-string\">http://127.0.0.1:8080/function/bcrypt</span> <span class=\"hljs-string\">-d</span> <span class=\"hljs-string\">\"\"</span>\n\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">kill</span> <span class=\"hljs-number\">-9</span> <span class=\"hljs-string\">\"$(cat kubectl-pid.txt)\"</span>\n\n  <span class=\"hljs-attr\">tags:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">actuated-4cpu-8gb</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">shell</span>\n</code></pre>\n<h2 id=\"what-does-an-actuated-server-look-like\">What does an actuated server look like?</h2>\n<p>An actuated server is where VMs are run for your CI jobs. It needs a minimal server operating system, and there's rarely a reason to even log into the host once it's setup and connected to our control plane.</p>\n<p>Actuated servers need to make use of <code>/dev/kvm</code>, so the processor and Kernel must support virtualization, most bare-metal servers support this without any additional configuration. Certain cloud VMs, OpenStack and VMware support KVM through nested virtualization.</p>\n<p>The recommended Operating System is the LTS version of Ubuntu Server, then you just need to install our agent and enroll it with the actuated control plane.</p>\n<p>If there happens to be some serious hardware failure or a major OS upgrade is required, then you can just re-image the disk and install the agent again, the whole process takes a couple of minutes.</p>\n<h2 id=\"private-peering\">Private peering</h2>\n<p>You can host your actuated servers on the public cloud or on-premises in your own data center. For Internet facing hosts, just open port 80 and 443.</p>\n<p>For hosts behind a private network, you can enable peering, which makes an outbound connection that passes through most firewalls, NAT, HTTP Proxies and VPNs without any additional configuration.</p>\n<p>Agent peering simplifies agent setup and improves security:</p>\n<ul>\n<li>No additional networking, firewall, or routing changes</li>\n<li>The agent is only available to the actuated control-plane</li>\n<li>All traffic between the agent and the control plane is encrypted with TLS</li>\n</ul>\n<p><img src=\"/images/2024-07-gitlab/peering.png\" alt=\"Private peering diagram\"></p>\n<blockquote>\n<p>Peering example for an enterprise with two agents within their own private firewalls.</p>\n</blockquote>\n<h2 id=\"wrapping-up\">Wrapping up</h2>\n<p>Compared to GitLab CI's built-in solution, there is no Kubernetes cluster required. VMs are densely packed into a fleet of servers efficiently or kept in a queue until capacity becomes available.</p>\n<p>Each VM is destroyed after the job has completed, so there are no side-effects to be concerned about, or server maintenance to be done.</p>\n<p>Docker can be used natively without any of the risks with the built-in Kubernetes runners which use privileged Pods.</p>\n<p>There is no need to add side-cars for BuildKit, Kaniko or to have to fight with the issues surrounding user-namespaces.</p>\n<p>Everything is tested by our team, so you don't have to fine-tune or configure a Kernel, we ship the OS image and Kernel together and update them remotely.</p>\n<p>Actuated for GitLab is available for self-hosted GitLab instances hosted on-premise or on the public cloud.</p>\n<p><a href=\"https://docs.google.com/forms/d/e/1FAIpQLScA12IGyVFrZtSAp2Oj24OdaSMloqARSwoxx3AZbQbs0wpGww/viewform\">Talk to us</a>, if you would like to see how Actuated can improve your GitLab CI.</p>","title":"Secure your GitLab jobs with microVMs and Actuated","description":"Learn how microVMs provide more flexibility and security for CI workloads, by removing the need for privileged containers or Docker In Docker.","tags":["gitlab","security","docker"],"author_img":"welteki","image":"/images/2024-07-gitlab/background.png","date":"2024-07-26"}},"__N_SSG":true}