{"pageProps":{"post":{"slug":"sbom-in-github-actions","fileName":"2023-01-25-sbom-in-github-actions.md","contentHtml":"<h2>What is a Software Bill of Materials (SBOM)?</h2>\n<p>In <a href=\"https://www.docker.com/blog/announcing-docker-sbom-a-step-towards-more-visibility-into-docker-images/\">April 2022 Justin Cormack, CTO of Docker announced</a> that Docker was adding support to generate a Software Bill of Materials (SBOM) for container images.</p>\n<p>An SBOM is an inventory of the components that make up a software application. It is a list of the components that make up a software application including the version of each component. The version is important because it can be cross-reference with a vulnerability database to determine if the component has any known vulnerabilities.</p>\n<p>Many organisations are also required to company with certain Open Source Software (OSS) licenses. So if SBOMs are included in the software they purchase or consume from vendors, then it can be used to determine if the software is compliant with their specific license requirements, lowering legal and compliance risk.</p>\n<p>Docker's enhancements to Docker Desktop and their open source Buildkit tool were the result of a collaboration with Anchore, a company that provides a commercial SBOM solution.</p>\n<h2>Check out an SBOM for yourself</h2>\n<p>Anchore provides commercial solutions for creating, managing and inspecting SBOMs, however they also have two very useful open source tools that we can try out for free.</p>\n<ul>\n<li><a href=\"https://github.com/anchore/syft\">syft</a> - a command line tool that can be used to generate an SBOM for a container image.</li>\n<li><a href=\"https://github.com/anchore/grype\">grype</a> - a command line tool that can be used to scan an SBOM for vulnerabilities.</li>\n</ul>\n<p>OpenFaaS Community Edition (CE) is a popular open source serverless platform for Kubernetes. It's maintained by open source developers, and is free to use.</p>\n<p>Let's pick a container image from the Community Edition of <a href=\"https://github.com/orgs/openfaasltd/packages\">OpenFaaS</a> like the container image for the OpenFaaS gateway.</p>\n<p>We can browse the GitHub UI to find the latest revision, or we can use Google's crane tool:</p>\n<pre><code class=\"hljs language-bash\">crane <span class=\"hljs-built_in\">ls</span> ghcr.io/openfaas/gateway | <span class=\"hljs-built_in\">tail</span> -n 5\n0.26.0\n8e1c34e222d6c194302c649270737c516fe33edf\n0.26.1\nc26ec5221e453071216f5e15c3409168446fd563\n0.26.2\n</code></pre>\n<p>Now we can introduce one of those tags to syft:</p>\n<pre><code class=\"hljs language-bash\">syft ghcr.io/openfaas/gateway:0.26.2\n ✔ Pulled image            \n ✔ Loaded image            \n ✔ Parsed image            \n ✔ Cataloged packages      [39 packages]\nNAME                                              VERSION                               TYPE      \nalpine-baselayout                                 3.4.0-r0                              apk        \nalpine-baselayout-data                            3.4.0-r0                              apk        \nalpine-keys                                       2.4-r1                                apk        \napk-tools                                         2.12.10-r1                            apk        \nbusybox                                           1.35.0                                binary     \nbusybox                                           1.35.0-r29                            apk        \nbusybox-binsh                                     1.35.0-r29                            apk        \nca-certificates                                   20220614-r4                           apk        \nca-certificates-bundle                            20220614-r4                           apk        \ngithub.com/beorn7/perks                           v1.0.1                                go-module  \ngithub.com/cespare/xxhash/v2                      v2.1.2                                go-module  \ngithub.com/docker/distribution                    v2.8.1+incompatible                   go-module  \ngithub.com/gogo/protobuf                          v1.3.2                                go-module  \ngithub.com/golang/protobuf                        v1.5.2                                go-module  \ngithub.com/gorilla/mux                            v1.8.0                                go-module  \ngithub.com/matttproud/golang_protobuf_extensions  v1.0.1                                go-module  \ngithub.com/nats-io/nats.go                        v1.22.1                               go-module  \ngithub.com/nats-io/nkeys                          v0.3.0                                go-module  \ngithub.com/nats-io/nuid                           v1.0.1                                go-module  \ngithub.com/nats-io/stan.go                        v0.10.4                               go-module  \ngithub.com/openfaas/faas-provider                 v0.19.1                               go-module  \ngithub.com/openfaas/faas/gateway                  (devel)                               go-module  \ngithub.com/openfaas/nats-queue-worker             v0.0.0-20230117214128-3615ccb286cc    go-module  \ngithub.com/prometheus/client_golang               v1.13.0                               go-module  \ngithub.com/prometheus/client_model                v0.2.0                                go-module  \ngithub.com/prometheus/common                      v0.37.0                               go-module  \ngithub.com/prometheus/procfs                      v0.8.0                                go-module  \ngolang.org/x/crypto                               v0.5.0                                go-module  \ngolang.org/x/sync                                 v0.1.0                                go-module  \ngolang.org/x/sys                                  v0.4.1-0.20230105183443-b8be2fde2a9e  go-module  \ngoogle.golang.org/protobuf                        v1.28.1                               go-module  \nlibc-utils                                        0.7.2-r3                              apk        \nlibcrypto3                                        3.0.7-r2                              apk        \nlibssl3                                           3.0.7-r2                              apk        \nmusl                                              1.2.3-r4                              apk        \nmusl-utils                                        1.2.3-r4                              apk        \nscanelf                                           1.3.5-r1                              apk        \nssl_client                                        1.35.0-r29                            apk        \nzlib                                              1.2.13-r0                             apk  \n</code></pre>\n<p>These are all the components that syft found in the container image. We can see that it found 39 packages, including the OpenFaaS gateway itself.</p>\n<p>Some of the packages are Go modules, others are packages that have been installed with <code>apk</code> (Alpine Linux's package manager).</p>\n<h2>Checking for vulnerabilities</h2>\n<p>Now that we have an SBOM, we can use grype to check for vulnerabilities.</p>\n<pre><code class=\"hljs language-bash\">grype ghcr.io/openfaas/gateway:0.26.2\n ✔ Vulnerability DB        [no update available]\n ✔ Loaded image            \n ✔ Parsed image            \n ✔ Cataloged packages      [39 packages]\n ✔ Scanned image           [2 vulnerabilities]\nNAME                        INSTALLED  FIXED-IN  TYPE       VULNERABILITY   SEVERITY \ngoogle.golang.org/protobuf  v1.28.1              go-module  CVE-2015-5237   High      \ngoogle.golang.org/protobuf  v1.28.1              go-module  CVE-2021-22570  Medium  \n</code></pre>\n<p>In this instance, we can see there are only two vulnerabilities, both of which are in the <code>google.golang.org/protobuf</code> Go module, and neither of them have been fixed yet.</p>\n<ul>\n<li>As the maintainer of OpenFaaS CE, I could try to eliminate the dependency from the original codebase, or wait for a workaround to be published by its vendor.</li>\n<li>As a consumer of OpenFaaS CE my choices are similar, and it may be worth trying to look into the problem myself to see if the vulnerability is relevant to my use case.</li>\n<li>Now, for OpenFaaS Pro, a commercial distribution of OpenFaaS, where source is not available, I'd need to contact the vendor OpenFaaS Ltd and see if they could help, or if they could provide a workaround. Perhaps there would even be a paid support relationship and SLA relating to fixing vulnerabilities of this kind?</li>\n</ul>\n<p>With this scenario, I wanted to show that different people care about the supply chain, and have different responsibilities for it.</p>\n<h2>Generate an SBOM from within GitHub Actions</h2>\n<p>The examples above were all run locally, but we can also generate an SBOM from within a GitHub Actions workflow. In this way, the SBOM is shipped with the container image and is made available without having to scan the image each time.</p>\n<p>Imagine you have the following Dockerfile:</p>\n<pre><code>FROM alpine:3.17.0\n\nRUN apk add --no-cache curl ca-certificates\n\nCMD [\"curl\", \"https://www.google.com\"]\n</code></pre>\n<p>I know that there's a vulnerability in alpine 3.17.0 in the OpenSSL library. How do I know that? I recently updated every OpenFaaS Pro component to use <code>3.17.1</code> to fix a specific vulnerability.</p>\n<p>Now a typical workflow for this Dockerfile would look like the below:</p>\n<pre><code class=\"hljs language-yaml\"><span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">build</span>\n\n<span class=\"hljs-attr\">on:</span>\n  <span class=\"hljs-attr\">push:</span>\n    <span class=\"hljs-attr\">branches:</span> [ <span class=\"hljs-string\">master</span>, <span class=\"hljs-string\">main</span> ]\n  <span class=\"hljs-attr\">pull_request:</span>\n    <span class=\"hljs-attr\">branches:</span> [ <span class=\"hljs-string\">master</span>, <span class=\"hljs-string\">main</span> ]\n\n<span class=\"hljs-attr\">permissions:</span>\n  <span class=\"hljs-attr\">actions:</span> <span class=\"hljs-string\">read</span>\n  <span class=\"hljs-attr\">checks:</span> <span class=\"hljs-string\">write</span>\n  <span class=\"hljs-attr\">contents:</span> <span class=\"hljs-string\">read</span>\n  <span class=\"hljs-attr\">packages:</span> <span class=\"hljs-string\">write</span>\n\n<span class=\"hljs-attr\">jobs:</span>\n  <span class=\"hljs-attr\">publish:</span>\n    <span class=\"hljs-attr\">runs-on:</span> <span class=\"hljs-string\">ubuntu-latest</span>\n    <span class=\"hljs-attr\">steps:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">actions/checkout@master</span>\n        <span class=\"hljs-attr\">with:</span>\n          <span class=\"hljs-attr\">fetch-depth:</span> <span class=\"hljs-number\">1</span>\n\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Set</span> <span class=\"hljs-string\">up</span> <span class=\"hljs-string\">Docker</span> <span class=\"hljs-string\">Buildx</span>\n        <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">docker/setup-buildx-action@v2</span>\n\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Login</span> <span class=\"hljs-string\">to</span> <span class=\"hljs-string\">Docker</span> <span class=\"hljs-string\">Registry</span>\n        <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">docker/login-action@v2</span>\n        <span class=\"hljs-attr\">with:</span>\n          <span class=\"hljs-attr\">username:</span> <span class=\"hljs-string\">${{</span> <span class=\"hljs-string\">github.repository_owner</span> <span class=\"hljs-string\">}}</span>\n          <span class=\"hljs-attr\">password:</span> <span class=\"hljs-string\">${{</span> <span class=\"hljs-string\">secrets.GITHUB_TOKEN</span> <span class=\"hljs-string\">}}</span>\n          <span class=\"hljs-attr\">registry:</span> <span class=\"hljs-string\">ghcr.io</span>\n\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Publish</span> <span class=\"hljs-string\">image</span>\n        <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">docker/build-push-action@v3</span>\n        <span class=\"hljs-attr\">with:</span>\n          <span class=\"hljs-attr\">build-args:</span> <span class=\"hljs-string\">|\n            GitCommit=${{ github.sha }}\n</span>          <span class=\"hljs-attr\">outputs:</span> <span class=\"hljs-string\">\"type=registry,push=true\"</span>\n          <span class=\"hljs-attr\">tags:</span> <span class=\"hljs-string\">|\n            ghcr.io/alexellis/gha-sbom:${{ github.sha }}\n</span></code></pre>\n<p>Upon each commit, an image is published to GitHub's Container Registry with the image name of: <code>ghcr.io/alexellis/gha-sbom:SHA</code>.</p>\n<p>To generate an SBOM, we just need to update the <code>docker/build-push-action</code> to use the <code>sbom</code> flag:</p>\n<pre><code class=\"hljs language-yaml\">      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Local</span> <span class=\"hljs-string\">build</span>\n        <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">local_build</span>\n        <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">docker/build-push-action@v3</span>\n        <span class=\"hljs-attr\">with:</span>\n          <span class=\"hljs-attr\">sbom:</span> <span class=\"hljs-literal\">true</span>\n          <span class=\"hljs-attr\">provenance:</span> <span class=\"hljs-literal\">false</span>\n</code></pre>\n<p>By checking the logs from the action, we can see that the image has been published with an SBOM:</p>\n<pre><code class=\"hljs language-bash\"><span class=\"hljs-comment\">#16 [linux/amd64] generating sbom using docker.io/docker/buildkit-syft-scanner:stable-1</span>\n<span class=\"hljs-comment\">#0 0.120 time=\"2023-01-25T15:35:19Z\" level=info msg=\"starting syft scanner for buildkit v1.0.0\"</span>\n<span class=\"hljs-comment\">#16 DONE 1.0s</span>\n</code></pre>\n<p>The SBOM can be viewed as before:</p>\n<pre><code class=\"hljs language-bash\">syft ghcr.io/alexellis/gha-sbom:46bc16cb4033364233fad3caf8f3a255b5b4d10d@sha256:7229e15004d8899f5446a40ebdd072db6ff9c651311d86e0c8fd8f999a32a61a\n\ngrype ghcr.io/alexellis/gha-sbom:46bc16cb4033364233fad3caf8f3a255b5b4d10d@sha256:7229e15004d8899f5446a40ebdd072db6ff9c651311d86e0c8fd8f999a32a61a\n ✔ Vulnerability DB        [updated]\n ✔ Loaded image            \n ✔ Parsed image            \n ✔ Cataloged packages      [21 packages]\n ✔ Scanned image           [2 vulnerabilities]\nNAME        INSTALLED  FIXED-IN  TYPE  VULNERABILITY  SEVERITY \nlibcrypto3  3.0.7-r0   3.0.7-r2  apk   CVE-2022-3996  High      \nlibssl3     3.0.7-r0   3.0.7-r2  apk   CVE-2022-3996  High  \n</code></pre>\n<p>The image: <code>alpine:3.17.0</code> contains two High vulnerabilities, and from reading the notes, we can see that both have been fixed.</p>\n<p>We can resolve the issue by changing the Dockerfile to use <code>alpine:3.17.1</code> instead, and re-running the build.</p>\n<pre><code class=\"hljs language-bash\">grype ghcr.io/alexellis/gha-sbom:63c6952d1ded1f53b1afa3f8addbba9efa37b52b\n ✔ Vulnerability DB        [no update available]\n ✔ Pulled image            \n ✔ Loaded image            \n ✔ Parsed image            \n ✔ Cataloged packages      [21 packages]\n ✔ Scanned image           [0 vulnerabilities]\nNo vulnerabilities found\n</code></pre>\n<h2>Wrapping up</h2>\n<p>There is a lot written on the topic of supply chain security, so I wanted to give you a quick overview, and how to get started wth it.</p>\n<p>We looked at Anchore's two open source tools: Syft and Grype, and how they can be used to generate an SBOM and scan for vulnerabilities.</p>\n<p>We then produced an SBOM for a pre-existing Dockerfile and GitHub Action, introducing a vulnerability by using an older base image, and then fixing it by upgrading it. We did this by adding additional flags to the <code>docker/build-push-action</code>. We added the sbom flag, and set the provenance flag to false. Provenance is a separate but related topic, which is explained well in an article by Justin Chadwell of Docker (linked below).</p>\n<p>I maintain an Open Source alternative to brew for developer-focused CLIs called <a href=\"https://arkade.dev/\">arkade</a>. This already includes Google's crane project, and there's a <a href=\"https://github.com/alexellis/arkade/issues/839\">Pull Request coming shortly to add Syft and Grype to the project</a>.</p>\n<p>It can be a convenient way to install these tools on MacOS, Windows or Linux:</p>\n<pre><code class=\"hljs language-bash\"><span class=\"hljs-comment\"># Available now</span>\narkade get crane syft\n\n<span class=\"hljs-comment\"># Coming shortly</span>\narkade get grype\n</code></pre>\n<p>In the beginning of the article we mentioned license compliance. SBOMs generated by syft do not seem to include license information, but in my experience, corporations which take this risk seriously tend to run their own scanning infrastructure <a href=\"https://www.synopsys.com/software-integrity/security-testing/software-composition-analysis.html\">with commercial tools like Blackduck</a> or <a href=\"https://docs.paloaltonetworks.com/prisma/prisma-cloud/21-08/prisma-cloud-compute-edition-admin/compliance/manage_compliance\">Twistlock</a>.</p>\n<p>Tools like Twistlock, and certain registries like <a href=\"https://jfrog.com/artifactory/\">JFrog Artifactory</a> and the <a href=\"https://goharbor.io/\">CNCF's Harbor</a>, can be configured to scan images. GitHub has a free, built-in service called Dependabot that won't just scan, but will also send Pull Requests to fix issues.</p>\n<p>But with the SBOM approach, the responsibility is rebalanced, with the supplier taking on an active role in security. The consumer can then use the supplier's SBOMs, or run their own scanning infrastructure - or perhaps both.</p>\n<p>See also:</p>\n<ul>\n<li><a href=\"https://www.docker.com/blog/announcing-docker-sbom-a-step-towards-more-visibility-into-docker-images/\">Announcing Docker SBOM: A step towards more visibility into Docker images- Justin Cormack</a></li>\n<li><a href=\"https://www.docker.com/blog/generate-sboms-with-buildkit/\">Generating SBOMs for Your Image with BuildKit - Justin Chadwell</a></li>\n<li><a href=\"https://github.com/anchore\">Anchore on GitHub</a></li>\n</ul>","title":"How to add a Software Bill of Materials (SBOM) to your containers with GitHub Actions","description":"Learn how to add a Software Bill of Materials (SBOM) to your containers with GitHub Actions in a few easy steps.","author":"Alex Ellis","tags":["security","oss","supplychain","sbom"],"author_img":"alex","image":"/images/2023-jan-sbom/list.jpg","date":"2023-01-25"}},"__N_SSG":true}