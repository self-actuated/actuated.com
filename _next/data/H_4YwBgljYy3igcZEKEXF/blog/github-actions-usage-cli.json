{"pageProps":{"post":{"slug":"github-actions-usage-cli","fileName":"2023-06-16-github-actions-usage-cli.md","contentHtml":"<p>Whenever GitHub Actions users get in touch with us to ask about actuated, we ask them a number of questions. What do you build? What pain points have you been running into? What are you currently spending? And then - how many minutes are you using?</p>\n<p>That final question is a hard one for many to answer because the GitHub UI and API will only show billable minutes. Why is that a problem? Some teams only use open-source repositories with free runners. Others may have a large free allowance of credit for one reason or another and so also don't really know what they're using. Then you have people who already use some form of self-hosted runners - they are also excluded from what GitHub shows you.</p>\n<p>So we built an Open Source CLI tool called <a href=\"https://github.com/self-actuated/actions-usage\">actions-usage</a> to generate a report of your total minutes by querying GitHub's REST API.</p>\n<p>And over time, we had requests to break-down per day - so for our customers in the Middle East like <a href=\"https://kubiya.ai/\">Kubiya</a>, it's common to see a very busy day on Sunday, and not a lot of action on Friday. Given that some teams use mono-repos, we also added the ability to break-down per repository - so you can see which ones are the most active. And finally, we added the ability to see hot-spots of usage like the longest running repo or the most active day.</p>\n<p>You can run the tool in three ways:</p>\n<ul>\n<li>Against an organisation</li>\n<li>Against a personal user account</li>\n<li>Or in a GitHub Action</li>\n</ul>\n<p>I'll show you each briefly, but the one I like the most is the third option because it's kind of recursive.</p>\n<p>Before we get started, download arkade, and use it to install the tool:</p>\n<pre><code class=\"hljs language-bash\"><span class=\"hljs-comment\"># Move the binary yourself into $PATH</span>\ncurl -sLS https://get.arkade.dev | sh\n\n<span class=\"hljs-comment\"># Have sudo move it for you</span>\ncurl -sLS https://get.arkade.dev | sudo sh\narkade install actions-usage\n</code></pre>\n<p>Or if you prefer - you can add my <a href=\"https://github.com/alexellis/homebrew-alexellis\">brew tap</a>, or head over to the <a href=\"https://github.com/alexellis/arkade/releases\">arkade releases page</a>.</p>\n<p>Later on, I'll also show you how to use the <code>alexellis/arkade-get</code> action to install the tool for CI.</p>\n<h2>Finding out about your organisation</h2>\n<p>If you want to find out about your organisation, you can run the tool like this:</p>\n<pre><code class=\"hljs language-bash\">actions-usage \\\n    -org <span class=\"hljs-variable\">$GITHUB_REPOSITORY_OWNER</span> \\\n    -days 28 \\\n    -by-repo \\\n    -punch-card \\\n    -token-file ~/PAT.txt\n</code></pre>\n<p>You'll need a Personal Access Token, there are instructions on how to create this in the <a href=\"https://github.com/self-actuated/actions-usage\">actions-usage README file</a></p>\n<p>There are many log lines printed to stderr during the scan of repositories and the workflows. You can omit all of this by adding <code>2> /dev/null </code> to the command.</p>\n<p>First off we show the totals:</p>\n<pre><code>Fetching last 28 days of data (created>=2023-05-19)\n\nGenerated by: https://github.com/self-actuated/actions-usage\nReport for actuated-samples - last: 28 days.\n\nTotal repos: 24\nTotal private repos: 0\nTotal public repos: 24\n\nTotal workflow runs: 107\nTotal workflow jobs: 488\n\nTotal users: 1\n</code></pre>\n<p>Then break down on success/failure and cancelled jobs overall, plus the biggest and average build time:</p>\n<pre><code>Success: 369/488\nFailure: 45/488\nCancelled: 73/488\n\nLongest build: 29m32s\nAverage build time: 1m26s\n</code></pre>\n<p>Next we have the day by day breakdown. You can see that we try to focus on our families on Sunday at OpenFaaS Ltd, instead of working:</p>\n<pre><code>Day            Builds\nMonday         61\nTuesday        50\nWednesday      103\nThursday       110\nFriday         153\nSaturday       10\nSunday         0\nTotal          488\n</code></pre>\n<p>Our customers in the Middle East work to a different week, and so you'd see Saturday with no builds or nothing, and Sunday like a normal working day.</p>\n<p>Then we have the repo-by-repo breakdown with some much more granular data:</p>\n<pre><code>Repo                                      Builds         Success        Failure        Cancelled      Skipped        Total          Average        Longest\nactuated-samples/k3sup-matrix-test        355            273            20             62             0              2h59m1s        30s            1m29s\nactuated-samples/discourse                49             38             7              4              0              6h37m21s       8m7s           20m1s\nactuated-samples/specs                    35             31             1              3              0              10m20s         18s            32s\nactuated-samples/cypress-test             17             4              13             0              0              6m23s          23s            49s\nactuated-samples/cilium-test              9              4              2              3              0              1h10m41s       7m51s          29m32s\nactuated-samples/kernel-builder-linux-6.0 9              9              0              0              0              11m28s         1m16s          1m27s\nactuated-samples/actions-usage-job        8              4              2              1              0              46s            6s             11s\nactuated-samples/faasd-nix                6              6              0              0              0              24m20s         4m3s           10m49s\n</code></pre>\n<p>Finally, we have the original value that the tool set out to display:</p>\n<pre><code>Total usage: 11h40m20s (700 mins)\n</code></pre>\n<p>We display the value in a Go duration for readability and in minutes because that's the number that GitHub uses to talk about usage.</p>\n<p>One customer told us that they were running into rate limits when querying for 28 days of data, so they dropped down to 14 days and then multiplied the result by two to get a rough estimate.</p>\n<pre><code>-days 14 \n</code></pre>\n<p>The team at Todoist got in touch with us to see if actuated could reduce their bill on GitHub Actions. When he tried to run the tool the rate-limit was exhausted even when he changed the flag to <code>-days 1</code>. Why? They were using 550,000 minutes!</p>\n<p>So we can see one of the limitations already of this approach. Fortunately, actuated customers have their job stats recorded in a database and can generate reports <a href=\"https://docs.actuated.dev/dashboard/\">from the dashboard very quickly</a>.</p>\n<h2>Finding out about your personal account</h2>\n<p>Actuated isn't built for personal users, but for teams, so we didn't add this feature initially. Then we saw a few people reach out via Twitter and GitHub and decided to add it for them.</p>\n<p>For your personal account, you only have to change one of the input parameters:</p>\n<pre><code class=\"hljs language-bash\">actions-usage \\\n    -user alexellis \\\n    -days 28 \\\n    -by-repo \\\n    -punch-card \\\n    -token-file ~/ae-pat.txt 2> /dev/null \n</code></pre>\n<p>Now I actually have > 250 repositories and most of them don't even have Actions enabled, so this makes the tool less useful for me personally. So it was great when a community member suggested offering a way to filter repos when you have so many that the tool takes a long time to run or can't complete due to rate-limits.</p>\n<blockquote class=\"twitter-tweet\"><p lang=\"en\" dir=\"ltr\">Being that today I used it to get the same insights from a Github Org where I currently work, which contains 1.4k of repositories.<br><br>And this was running for a considerable time. I am only related to only a few repositories within this organization.</p>&mdash; lbrealdeveloper (@lbrealdeveloper) <a href=\"https://twitter.com/lbrealdeveloper/status/1669401439431544832?ref_src=twsrc%5Etfw\">June 15, 2023</a></blockquote> <script async src=\"https://platform.twitter.com/widgets.js\" charset=\"utf-8\"></script>\n<p>I've already created an issue and have found someone who'd like to contribute the change: <a href=\"https://github.com/self-actuated/actions-usage/issues/8\">Offer a way to filter repos for large organisations / users #8</a></p>\n<p>This is the beauty of open source and community. We all get to benefit from each other's ideas and contributions.</p>\n<h2>Running actions-usage with a GitHub Action</h2>\n<p>Now this is my favourite way to run the tool. I can run it on a schedule and get a report sent to me via email or Slack.</p>\n<p><img src=\"/images/2023-06-actions-usage/summary.png\" alt=\"Example output from running the tool as a GitHub Action\"></p>\n<blockquote>\n<p>Example output from running the tool as a GitHub Action</p>\n</blockquote>\n<p>Create <code>actions-usage.yaml</code> in your <code>.github/workflows</code> folder:</p>\n<pre><code class=\"hljs language-yaml\"><span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">actions-usage</span>\n\n<span class=\"hljs-attr\">on:</span>\n  <span class=\"hljs-attr\">push:</span>\n    <span class=\"hljs-attr\">branches:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">master</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">main</span>\n  <span class=\"hljs-attr\">workflow_dispatch:</span>\n\n<span class=\"hljs-attr\">permissions:</span>\n  <span class=\"hljs-attr\">actions:</span> <span class=\"hljs-string\">read</span>\n\n<span class=\"hljs-attr\">jobs:</span>\n  <span class=\"hljs-attr\">actions-usage:</span>\n    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">daily-stats</span>\n    <span class=\"hljs-attr\">runs-on:</span> <span class=\"hljs-string\">actuated-any-1cpu-2gb</span>\n    <span class=\"hljs-attr\">steps:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">alexellis/arkade-get@master</span>\n      <span class=\"hljs-attr\">with:</span>\n        <span class=\"hljs-attr\">actions-usage:</span> <span class=\"hljs-string\">latest</span>\n        <span class=\"hljs-attr\">print-summary:</span> <span class=\"hljs-literal\">false</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Generate</span> <span class=\"hljs-string\">actions-usage</span> <span class=\"hljs-string\">report</span>\n      <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">|\n       echo \"### Actions Usage report by [actuated.dev](https://actuated.dev)\" >> SUMMARY\n       echo \"\\`\\`\\`\" >> SUMMARY\n       actions-usage \\\n        -org $GITHUB_REPOSITORY_OWNER \\\n        -days 1 \\\n        -by-repo \\\n        -punch-card \\\n        -token ${{ secrets.GITHUB_TOKEN }}  2> /dev/null  >> SUMMARY\n       echo \"\\`\\`\\`\" >> SUMMARY\n       cat SUMMARY >> $GITHUB_STEP_SUMMARY\n</span></code></pre>\n<p>Ths is designed to run within an organisation, but you can change the <code>-org</code> flag to <code>-user</code> and then use your own username.</p>\n<p>The days are for the past day of activity, but you can change this to any number like 7, 14 or 28 days.</p>\n<p>You can learn about the other flags by running <code>actions-usage --help</code> on your own machine.</p>\n<h2>Wrapping up</h2>\n<p>actions-usage is a practical tool that we use with customers to get an idea of their usage and how we can help with actuated. That said, it's also a completely free and open source tool for which the community is finding their own set of use-cases.</p>\n<p>And there are no worries about privacy, we've gone very low tech here. The output is only printed to the console, and we never receive any of your data unless you specifically copy and paste the output into an email.</p>\n<p>Feel free to create an issue if you have a feature request or a question.</p>\n<p>Check out <a href=\"https://github.com/self-actuated/actions-usage\">self-actuated/actions-usage</a> on GitHub</p>\n<p>I wrote an eBook writing CLIs like this in Go and keep it up to date on a regular basis - adding new examples and features of Go.</p>\n<p>Why not check out what people are saying about it on <a href=\"https://store.openfaas.com/l/everyday-golang\">Gumroad</a>?</p>\n<p><a href=\"https://store.openfaas.com/l/everyday-golang\">Everyday Go - The Fast Track</a></p>","title":"Understand your usage of GitHub Actions","description":"Learn how you or your team is using GitHub Actions across your personal account or organisation.","tags":["costoptimization","analytics","githubactions","opensource","golang","cli"],"author_img":"alex","date":"2023-06-16","image":"/images/2023-06-actions-usage/background.png"}},"__N_SSG":true}